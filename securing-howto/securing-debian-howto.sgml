<!doctype debiandoc system>

<!--
# TODO list:
# - Shorten overlong lines - there are lots of sections (by jfs?) where
#   lines are routinely longer than 80 characters. Actually it makes sense
#   to author SGML with much shorter lines, because it makes editing simpler
#   (while the internal line length of the SGML source is obviously not
#   visible in any way to the end user).
#   (occur (make-string 80 ?.))   ;  C-x C-e here
# - Remove gratuitous trailing whitespace; M-x occur " +$"
-->

<book>

<titlepag>
<!-- Title information -->
<title>Securing Debian Manual
<author>
<name>Javier Fernández-Sanguino Peña</name>
<email>jfs@computer.org</email>
</author>
<version>2.5 
<date>Mon,  2 Sep 2002 13:25:36 +0200

<abstract>
This document describes the process of securing and hardening the
default Debian installation. It covers some of the common tasks to
setup a secure network environment using Debian GNU/Linux and also
gives additional information on the security tools available
as well as the work done by the Debian security team.
</abstract>

<copyright> 
<copyrightsummary>Copyright &copy;  2002 Javier Fernández-Sanguino Peña
<p>Copyright &copy;  2001  Alexander Reelsen, Javier Fernández-Sanguino Peña
<p>Copyright &copy;  2000  Alexander Reelsen

<p>Permission is granted to copy, distribute and/or modify this document under
the terms of the <url id="http://www.fsf.org/copyleft/fdl.html" name="GNU Free
Documentation License, Version 1.1"> or any later version published by the
Free Software Foundation. It is distributed in the hope that it will be
useful, but WITHOUT ANY WARRANTY.
</copyright>

</titlepag>

<!-- Table of contents -->
<toc>

<!-- Begin the document -->

<chapt>Introduction
<p>
One of the hardest things about writing security documents is that every case
is unique. Two things you have to pay attention to are the threat environment
and the security needs of the individual site, host, or network. For instance,
the security needs of a home user are completely different from a network in a
bank. While the primary threat a home user needs to face is the script kiddie
type of cracker, a bank network has to worry about directed attacks. 
Additionally, the bank has to protect their customer's data with arithmetic 
precision. In short, every user has to consider the tradeoff between
usability and security/paranoia.
<!-- Is this metaphor really appropriate? Sounds like rounding errors to me, era -->
<p>
Note that this manual only covers issues relating to software. 
The best software in the world can't protect you if someone can physically
access the machine. You can place it under your desk, or you can place
it in a hardened bunker with an army in front of it. Nevertheless the
desktop computer can be much more secure (from a software point of view)
than a physically protected one if the desktop is configured properly and
the software on the protected machine is full of security holes.
Obviously, you must consider both issues.

<p>This document just gives an overview of what you can do 
to increase the security of your Debian GNU/Linux
system. If you have read other documents regarding Linux security, you
will find that there are common issues which might overlap with this
document. However, this document does not try to be the ultimate source
of information you will be using, it only tries to adapt this same
information so that it is meaningful to a Debian GNU/Linux system.
Different distributions do some things in different ways (startup of
daemons is an usual example); here, you will find material which is
appropriate for Debian's procedures and tools.
<!-- 
# Does this approximate the intent of the original author? (FIXME: check)
# Original text said: "you will find here [sic] a different approach,
# using Debian's tools, regarding security." era
-->
<!-- IMHO yes, jfs -->

<p>If you have comments, additions or suggestions, please mail them to 
<!-- <url name="Alexander Reelsen" id="mailto:ar@rhwd.de"> and  -->
<url name="Javier Fernández-Sanguino" id="mailto:jfs@computer.org">
(alternate address: jfs@debian.org)
and they will be incorporated into this manual.

<sect>Download the manual
<p>
You can download or view the newest version of the Securing Debian
Manual from the <url name="Debian Documentation Project"
id="http://www.debian.org/doc/manuals/securing-debian-howto/">.  Feel
free to check out the version control system through its <url
name="CVS server"
id="http://cvs.debian.org/ddp/manuals.sgml/securing-howto/?cvsroot=debian-doc">.

<p>You can download also a <url
id="http://www.debian.org/doc/manuals/securing-debian-howto/securing-debian-howto.txt"
name="text version"> from the Debian Documentation's Project site.
Other formats, like PDF, are not (yet) provided.  However, you can
download or install the <url
id="http://packages.debian.org/harden-doc" name="harden-doc"> package
which provides this same document in HTML, txt and PDF formats.

<!-- 
<p>
Previous (out of date) versions of this HOWTO can be found here:

<list>
<item><url name="Text-only"
id="http://joker.rhwd.de/doc/Securing-Debian-HOWTO/Securing-Debian-HOWTO.txt">
<item><url name="HTML"
id="http://joker.rhwd.de/doc/Securing-Debian-HOWTO/Securing-Debian-HOWTO.html">
<item><url name="HTML, tarred and gzipped"
id="http://joker.rhwd.de/doc/Securing-Debian-HOWTO/Securing-Debian-HOWTO.tar.gz">
<item><url name="SGML"
id="http://joker.rhwd.de/doc/Securing-Debian-HOWTO/Securing-Debian-HOWTO.sgml">
</list>
-->
<!-- TODO: remove these stale links rather than leave references to -->
<!-- the old versions hanging around? era -->


<sect>Organizational Notes/Feedback
<p>
Now to the official part. At the moment I (Alexander Reelsen) wrote
most paragraphs of this manual, but in my opinion this should not stay
the case. I grew up and live with free software, it is part of my
everyday use and I guess yours, too. I encourage everybody to send me
feedback, hints additions or any other suggestions, you might have.

<p>
If you think, you can maintain a certain section or paragraph better,
then write to the document maintainer and you are welcome to do it.
Especially if you find a section marked as FIXME, that means the
authors did not have the time yet or the needed knowledge about the
topic, drop them a mail immediately.

<p>
The topic of this manual makes it quite clear that it is important to
keep it up to date, and you can do your part.  Please contribute.

<sect>Prior knowledge
<p>
The installation of Debian GNU/Linux is not very difficult and you
should have been able to install it. If you already have some
knowledge about Linux or other Unices and you are a bit familiar with
basic security, it will be easier to understand this manual, as this
document cannot explain every little detail of a feature (otherwise
this would have been a book instead of a manual). If you are not that
familiar, however, you might want to take a look at <ref
id="references"> for where to find more in-depth information.


<sect>Things that need to be written (FIXME/TODO)
<p>
<list>

<item>Write about remote monitoring tools (to check for system
availability) such as monit, daemontools and mon. See <url
id="http://linux.oreillynet.com/pub/a/linux/2002/05/09/sysadminguide.html">.

<item>Consider writting a section on how to build Debian-based network
appliances (with information such as the base system,
<package>equivs</package> and FAI).

<item>Check if <url id="http://rr.sans.org/linux/hardening.php"> has
relevant info not yet covered here.

<item>Add Information on how to setup a laptop with Debian
<url id="http://rr.sans.org/linux/debian_laptop.php">.

<item>Add information on how to setup a firewall using Debian
GNU/Linux. The section regarding firewalling is oriented currently
towards a single system (not protecting others...) also talk on how
to test the setup.

<item>Add information on setting up a proxy firewall with
Debian GNU/Linux stating specifically which packages provide
proxy services
(like <package>xfwp</package>,
<package>xproxy</package>, <package>ftp-proxy</package>, 
<package>redir</package>,
<package>smtpd</package>, <package>nntp-cache</package>, <package>dnrd</package>,
<package>jftpgw</package>,<package>oops</package>,<package>pnsd</package>,
<package>perdition</package>,<package>transproxy</package>,
<package>tsocks</package>). Should point to the manual for any
other info. Also note that zorp is not (yet) available as a Debian
package but <em>is</em> a proxy firewall (they provide Debian packages
upstream).

<item>Information on service configuration with file-rc

<item>Check all the reference URLs and remove/fix those no longer available.

<item>Add information on available replacements (in Debian) for common
servers which are useful for limited functionality. Examples: 

	<list>
	<item>local lpr with cups (package)?

	<item>remote lrp with lpr

	<item>bind with dnrd/maradns

	<item>apache with dhttpd/thttpd/wn (tux?)

	<item>exim/sendmail with ssmtpd/smtpd/postfix

	<item>squid with tinyproxy

	<item>ftpd with oftpd/vsftp

	<item>...

	</list>


<item>More information regarding security-related kernel patches in
Debian, including the ones show above and talking
specifically on how to enable these patches in a Debian system.

<list>

<item>Linux Intrusion Detection (<package>lids-2.2.19</package>)

<item>Linux Trustees (in package <package>trustees</package>)

<item><url name="NSA Enhanced Linux"
id="http://www.coker.com.au/selinux/">

<item><url name="kernel-patch-2.2.18-openwall"
id="http://packages.debian.org/kernel-patch-2.2.18-openwall">

<item><package>kernel-patch-2.2.19-harden</package>

<item>Linux capabilities (in package <package>lcap</package>

<item><package>kernel-patch-freeswan,kernel-patch-int</package>

</list>

<item>Details of turning off unnecessary network services (besides
inetd), it is partly in the hardening procedure but could be broadened
a bit.

<item>Information regarding password rotation which is closely related
to policy.

<item>Policy, and educating users about policy.

<item>More about tcpwrappers, and wrappers in general?

<item><file>hosts.equiv</file> and other major security holes.

<item>Issues with file sharing servers such as Samba and NFS? 

<item>suidmanager/dpkg-statoverrides.

<item>lpr and lprng.

<item>Switching off the gnome IP things.

<item>Talk about pam_chroot (see <url
id="http://http://lists.debian.org/debian-security/2002/debian-security-200205/msg00011.html">)
and its usefulness to limit users.  Introduce information related to
<url id="http://online.securityfocus.com/infocus/1575">.
<package>Pdmenu</package>, for example is available in Debian (while as
flash is not).

<item>Talk about chrooting services, some more info on
<url id="http://www.linuxfocus.org/English/January2002/aritcle225.shtml">,
<url id="http://www.networkdweebs.com/chroot.html"> and
<url id="http://www.linuxsecurity.com/feature_stories/feature_story-99.html">

<item>Talk about programs to make chroot jails. <package>Compartment</package>
and <package>chrootuid</package> are waiting in incoming. Some others
(makejail, jailer) could also be introduced.

<item>Add information provided by Karl Hegbloom regarding chrooting
Bind 9, see <url id="http://people.pdxlinux.org/~karlheg/Secure_Bind9_uHOWTO/Secure_Bind_9_uHOWTO.xhtml">.

<item>Add information provided by Pedro Zornenon to chrooting Bind 8
only for potato though :(, see <url id="http://people.debian.org/~pzn/howto/chroot-bind.sh.txt"> (include the whole script?).

<item>More information regarding log analysis software (i.e. logcheck
and logcolorise).

<item>'advanced' routing (traffic policing is security related)

<item>limiting ssh access to running certain commands.

<item>using dpkg-statoverride.

<item>secure ways to share a CD burner among users.

<item>secure ways of providing networked sound in addition to network
  display capabilities (so that X clients' sounds are played on the X
  server's sound hardware)

<item>securing web browsers.

<item>setting up ftp over ssh.

<item>using crypto loopback filesystems.

<item>encrypting the entire filesystem.

<item>steganographic tools.

<item>setting up a PKA for an organization.

<item>using LDAP to manage users. There is a HOWTO of ldap+kerberos
for Debian at www.bayour.com written by Turbo Fredrikson.

<item>How to remove information of reduced utility in production systems
such as /usr/share/doc, /usr/share/man (yes, security by obscurity).

</list>

<sect id="changelog">Changelog/History
 <p>
<sect1>Version 2.5 (august 2002)

<p>Changes by Javier Fernández-Sanguino Peña (me). There were many
things waiting on my inbox (as far back as february) to be included,
so I'm going to tag this the <em>back from honeymoon</em> release :)

<list>

<item>Applied a patch contributed by Philipe Gaspar regarding the
Squid which also kills a FIXME.

<item>Yet another FAQ item regarding service banners taken from the
debian-security mailing list (thread "Telnet information" started 26th
july 2002).

<item>Added a note regarding use of CVE cross references in the
<em>How much time does the Debian security team...</em> FAQ item.


<item>Added a new section regarding ARP attacks contributed by Arnaud
"Arhuman" Assad.

<item>New FAQ item regarding dmesg and console loggin by the kernel. 

<item>Small tidbits of information to the signature-checking issues in
packages (it seems to not have gotten past beta release).

<item>New FAQ item regarding vulnerability assesment tools false
positives.

<item>Added new sections to the chapter that contains information on
package signatures and reorganised it as a new <em>Debian Security
Infraestructure</em> chapter.

<item>New FAQ item regarding Debian vs. other Linux distributions.

<item>New section on mail user agents with GPG/PGP functionality in the
security tools chapter.

<item>Clarified how to enable MD5 passwords in woody, added a pointer
to PAM as well as a note regarding the max definition in PAM.

<item>Added a new appendix on how to create chroot environments (after
fiddling a bit with makejail and fixing, as well, some of its bugs),
integrated duplicate information in all the appendix. 

<item>Written some more information regarding SSH chrooting and its
impact on secure file transfers.  Some information has been retrieved
from the debian-security mailing list (june 2002 thread: <em>secure
file transfers</em>).

<item>New sections on how to do automatic updates on Debian systems as
well as the caveats of using testing or unstable regarding security updates.

<item>New section regarding keeping up to date with security patches
in the <em>Before compromise</em> section as well as a new section
about the debian-security-announce mailing list.

<item>Added information on how to automatically generate strong passwords.

<item>New section regarding login off idle users.

<item>Reorganised the securing mail server section based on the
<em>Secure/hardened/minimal Debian (or "Why is the base system the way
it is?")</em> thread on the debian-security mailing list (may 2002).

<item>Reorganised the section on kernel network parameters, with
information provided in the debian-security mailing list (may 2002,
<em>syn flood attacked?</em> thread) and added a new FAQ item as well.

<item>New section on how to check users passwords and which packages
to install for this.

<item>New section on PPTP encryption with Microsoft clients discussed
in the debian-security mailing list (april 2002).

<item>Added a new section describing what problems are there when
binding to a specific IP address any given service, this information
was written based on the bugtraq mailing list in the thread:
<em>Linux kernel 2.4 "weak end host" issue (previously discussed here
+as "arp problem")</em> (started on may 9th 2002 by Felix von Leitner).

<item>Added information on ssh protocol version 2.

<item>Added two subsections related to Apache secure configuration
(the things specific to Debian, that is).

<item>Added a new FAQ related to raw sockets, one related to /root, an
item related to users' groups and another one related to log and
configuration files permissions.

<item>Added a pointer to a bug in libpam-cracklib that might still be
open... (need to check)

<item>Added more information regarding forensics analysis (pending more 
information on packet inspection tools such as <prgn>tcpflow</prgn>).

<item>Change the "what should I do regarding compromise" into a bullet
list and included some more stuff.

<item>Added some information on how to setup the Xscreensaver to lock
automatically the screen after the configured timeout.

<item>Add a note related to the utilities you should not install in
the system. Including a note regarding Perl and why it cannot be
easily removed in Debian. The idea came after reading Intersect's
documents regarding Linux hardening.

<item>Added information on lvm and journaling filesystems, ext3
recommended. The information there might be too generic, however. 

<item>Added a link to the online text version (check).

<item>Added some more stuff to the information on firewalling the
local system triggered by a comment made by Hubert Chan in the mailing list.

<item>Added more information on PAM limits and pointers to Kurt
Seifried's documents (related to a post by him to bugtraq on April 4th
2002 answering a person that had ``discovered'' a vulnerability in
Debian GNU/Linux related to resource starvation)

<item>As suggested by Julián Muñoz, provided more information on the
default Debian umask and what a user can access if he has been given a
shell in the system (scary, huh?)

<item>Included a note in the BIOS password section due to a comment
from from Andreas Wohlfeld.

<item>Included patches provided by Alfred E. Heggestad fixing many of
the typos still present in the document.

<item>Added a pointer to the changelog in the Credits section since
most people who contribute are listed here (and not there)

<item>Added a few more notes to the chattr section and a new section
after installation talking about system snapshots. Both ideas were
contributed by Kurt Pomeroy.

<item>Added a new section after installation just to remember users to
change the boot-up sequence.

<item>Added some more TODO items provided by Korn Andras.

<item>Added a pointer to the NIST's guidelines on how to secure DNS
provided by Daniel Quinlan.

<item>Added a small paragraph regarding Debian's SSL certificates
infraestructure.

<item>Added Daniel Quinlan's suggestions regarding ssh authentication
and exim's relay configuration.

<item>Added more information regarding securing bind including changes
suggested by Daniel Quinlan and an appendix with a scrip to make some of the
changes commented on that section.

<item>Added a pointer to another item regarding Bind chrooting (needs to be merged)

<item>Added a one liner contributed by Cristian Ionescu-Idbohrn to
retrieve packages with tcpwrappers support.

<item>Added a little bit more info on Debian's default PAM setup.

<item>Included a FAQ question about using PAM to give services w/o
shell accounts.

<item>Moved two FAQ items to another section and added a new FAQ
regarding attack detection (and compromised systems).

<item>Included information on how to setup a bridge firewall
(including a sample Appendix). Thanks go to Francois Bayar who sent
me this on march.

<item>Added a FAQ regarding the syslogd's <em>MARK</em>
<em>heartbeat</em> from a question answered by Noah Meyerhans and
Alain Tesio on December 2001.

<item>Included information on buffer overflow protection as well as
some information on kernel patches.

<item>Added more information (and reorganised) the firewall
section. Updated the information regarding the iptables package and
the firewall generators available.

<item>Reorganized the information regarding logchecking, moved
logcheck information from host intrusion detection to that section.

<item>Added some information on how to prepare a static package for
bind for chrooting (untested).

<item>Added a FAQ item (could be expanded with some of the
recomendations from the debian-security list regarding some specific servers/services).

<item>Added some information on RPC services (and when it's necessary).

<item>Added some more information on capabilities (and what lcap does). Is there any
good documentation on this? I haven't found any on my 2.4 kernel.

<item>Fixed some typos.

</list>

<sect1>Version 2.4
<p>Changes by Javier Fernández-Sanguino Peña.
<list>
<item>Rewritten part of the BIOS section.
</list>

<sect1>Version 2.3
<p>Changes by Javier Fernández-Sanguino Peña.
<list>
<item>Wrapped most file locations with the file tag.
<item>Fixed typo noticed by Edi Stojicevi.
<item>Slightly changed the remote audit tools section.
<item>Added some todo items.
<item>Added more information regarding printers and cups config file
(taken from a thread on debian-security).
<item>Added a patch submitted by Jesus Climent regarding access of
valid system users to Proftpd when configured as anonymous server.
<item>Small change on partition schemes for the special case of mail
servers.
<item>Added Hacking Linux Exposed to the books section.
<item>Fixed directory typo noticed by Eduardo Pérez Ureta.
<item>Fixed /etc/ssh typo in checklist noticed by Edi Stojicevi.
</list>
<sect1>Version 2.3
<p>Changes by Javier Fernández-Sanguino Peña.
<list>
<item>Fixed location of dpkg conffile.
<item>Remove Alexander from contact information.
<item>Added alternate mail address.
<item>Fixed Alexander mail address (even if commented out).
<item>Fixed location of release keys (thanks to Pedro Zorzenon for pointing this out).
</list>
<sect1>Version 2.2
<p>Changes by Javier Fernández-Sanguino Peña.
<list>
<item>Fixed typos, thanks to Jamin W. Collins.
<item>Added a reference to apt-extracttemplate manpage
(documents the APT::ExtractTemplate config).
<item>Added section about restricted SSH. Information based on that
posted by  Mark Janssen, Christian G. Warden and Emmanuel Lacour on
the debian-security mailing list.
<item>Added information on anti-virus software.
<item>Added a FAQ: su logs due to the cron running as root.
</list>
<sect1>Version 2.1
<p>Changes by Javier Fernández-Sanguino Peña.
<list>
<item>Changed FIXME from lshell thanks to Oohara Yuuma.
<item>Added package to sXid and removed comment since it *is* available.
<item>Fixed a number of typos discovered by Oohara Yuuma.
<item>ACID is now available in Debian (in the acidlab package)
 thanks to Oohara Yuuma for noticing.
<item>Fixed LinuxSecurity links (thanks to Dave Wreski for telling).
</list>
<sect1>Version 2.0
<p>Changes by Javier Fernández-Sanguino Peña. I wanted to 
change to 2.0 when all the FIXMEs were, er, fixed but I run out
of 1.9X numbers :(
<list>
<item>Converted the HOWTO into a Manual (now I can properly say RTFM)

<item>Added more information regarding tcp wrappers and Debian (now
many services are compiled with support for them so it's no longer
an inetd issue).

<item>Clarified the information on disabling services to make it more
consistent (rpc info still referred to update-rc.d)

<item>Added small note on lprng.

<item>Added some more info on compromised servers (still very rough)

<item>Fixed typos reported by Mark Bucciarelli.

<item>Added some more steps in password recovery to cover the cases
when the admin has set paranoid-mode=on.

<item>Added some information to set paranoid-mode=on when login in
console.

<item>New paragraph to introduce service configuration.

<item>Reorganised the <em>After installation</em> section so it is
more broken up into several issues and it's easier to read.

<item>Written information on howto setup firewalls with the standard
Debian 3.0 setup (iptables package).

<item>Small paragraph explaining why installing connected to the
Internet is not a good idea and how to avoid this using Debian tools.

<item>Small paragraph on timely patching referencing to IEEE paper.

<item>Appendix on how to setup a Debian snort box, based on what Vladimir
sent to the debian-security mailing list (September 3rd 2001)

<item>Information on how logcheck is setup in Debian and how it can be
used to setup HIDS.

<item>Information on user accounting and profile analysis.

<item>Included apt.conf configuration for read-only /usr copied from Olaf
Meeuwissen's post to the debian-security mailing list

<item>New section on VPN with some pointers and the packages available
in Debian (needs content on how to setup the VPNs and Debian-specific
issues), based on Jaroslaw Tabor's and Samuli Suonpaa's post to
debian-security.

<item>Small note regarding some programs to automatically build chroot jails

<item>New FAQ item regarding identd based on a discussion in the
debian-security mailing list (February 2002, started by Johannes Weiss).

<item>New FAQ item regarding inetd based on a discussion in the
debian-security mailing list (February 2002).

<item>Introduced note on rcconf in the "disabling services" section.

<item>Varied the approach regarding LKM, thanks to Philipe Gaspar 

<item>Added pointers to CERT documents and Counterpane resources
</list>

<sect1>Version 1.99
<p>Changes by Javier Fernández-Sanguino Peña.
<list>
<item>Added a new FAQ item regarding time to fix security vulnerabilities.
<item>Reorganised FAQ sections.
<item>Started writing a section regarding firewalling in Debian GNU/Linux
(could be broadened a bit)
<item>Fixed typos sent by Matt Kraai
<item>Fixed DNS information
<item>Added information on whisker and nbtscan to the auditing section.
<item>Fixed some wrong URLs
</list>
<sect1>Version 1.98
<p>Changes by Javier Fernández-Sanguino Peña.
<list>
<item>Added a new section regarding auditing using Debian GNU/Linux.
<item>Added info regarding finger daemon taken from the security mailing list.
</list>
<sect1>Version 1.97
<p>Changes by Javier Fernández-Sanguino Peña.
<list>
<item>Fixed link for Linux Trustees
<item>Fixed typos (patches from Oohara Yuuma and Pedro Zorzenon)
</list>

<sect1>Version 1.96
<p>Changes by Javier Fernández-Sanguino Peña.
<list>

<item>Reorganized service installation and removal and added some new notes.

<item>Added some notes regarding using integrity checkers as intrusion
detection tools.

<item>Added a chapter regarding package signatures.

</list>

<sect1>Version 1.95
<p>Changes by Javier Fernández-Sanguino Peña.
<list>

<item>Added notes regarding Squid security sent by Philipe Gaspar.

<item>Fixed rootkit links thanks to Philipe Gaspar.

</list>

<sect1>Version 1.94
<p>Changes by Javier Fernández-Sanguino Peña.
<list>

<item>Added some notes regarding Apache and Lpr/lpng.

<item>Added some information regarding noexec and read-only partitions.

<item>Rewritten how can users help in Debian security issues (FAQ item).
</list>

<sect1>Version 1.93
<p>Changes by Javier Fernández-Sanguino Peña.
<list>

<item>Fixed location of mail program.

<item>Added some new items to the FAQ.
</list>

<sect1>Version 1.92
<p>Changes by Javier Fernández-Sanguino Peña.
<list>

<item>Added a small section on how Debian handles security

<item>Clarified MD5 passwords (thanks to `rocky')

<item>Added some more information regarding harden-X from Stephen van Egmond

<item>Added some new items to the FAQ

</list>

<sect1>Version 1.91
<p>Changes by Javier Fernández-Sanguino Peña.
<list>

<item>Added some forensics information sent by Yotam Rubin.

<item>Added information on how to build a honeynet using Debian GNU/Linux.

<item>Added some more TODOS.

<item>Fixed more typos (thanks Yotam!)

</list>

<sect1>Version 1.9
<p>Changes by Javier Fernández-Sanguino Peña.
<list>

<item>Added patch to fix misspellings and some new information (contributed
by Yotam Rubin)

<item>Added references to other online (and offline) documentation both in a section (see <ref id="references">) by itself and inline in some sections.

<item>Added some information on configuring Bind options to restrict
access to the DNS server.

<item>Added information on how to automatically harden a Debian system
(regarding the harden package and bastille).

<item>Removed some done TODOs and added some new ones.

</list>

<sect1>Version 1.8
<p>Changes by Javier Fernández-Sanguino Peña.
<list>

<item>Added the default user/group list provided by Joey Hess to the
debian-security mailing list.

<item>Added information on  LKM  root-kits (<ref id="LKM">)
 contributed by Philipe Gaspar.

<item>Added information on Proftp contributed by Emmanuel Lacour. 

<item>Recovered the checklist Appendix from Era Eriksson.

<item>Added some new TODO items and removed other fixed ones.

<item>Manually included Era's patches since they were not all included in 
the previous version.

</list>
<sect1>Version 1.7
<p>Changes by Era Eriksson.
<list>
<item>Typo fixes and wording changes <!-- FIXME: new checklist has not
been included yet, era, please send it back -->
</list>
<p>Changes by Javier Fernández-Sanguino Peña.
<list>
<item>Minor changes to tags in order to keep on removing the tt tags
and substitute them for prgn/package tags.
</list>

<sect1>Version 1.6 
<p>Changes by Javier Fernández-Sanguino Peña.
<list>
<item>Added pointer to document as published in the DDP (should
supersede the original in the near future) 
<item>Started a mini-FAQ
(should be expanded) with some questions recovered from my mailbox.
<item>Added general information to consider while securing.
<item>Added a paragraph regarding local (incoming) mail delivery.
<item>Added some pointers to more information.  
<item>Added information regarding the printing service.  
<item>Added a security hardening checklist.  
<item>Reorganized NIS and RPC information.
<item>Added some notes taken while reading this document on my new
Visor :) 
<item>Fixed some badly formatted lines.  
<item>Fixed some typos.  
<item>Added a Genius/Paranoia idea contributed by Gaby
Schilders.
</list>
<sect1>Version 1.5 

<p>Changes by Josip Rodin and Javier Fernández-Sanguino Peña.

<list>
<item>Added paragraphs related to BIND and some FIXMEs.  <!-- Removed
this because I found no evidence for it in the diffs. // era Rewrote
style in order to make it more formal.  -->
</list>
<sect1>Version 1.4
    <p>
    <list>
    <item>Small setuid check paragraph <item>Various minor cleanups
    <item>Found out how to use <tt>sgml2txt -f</tt> for the txt
    version</item>
    </list>
<sect1>Version 1.3
    <p>
    <list>
    <item>Added a security update after installation paragraph
    <item>Added a proftpd paragraph <item>This time really wrote
    something about XDM, sorry for last time
    </list>
<sect1>Version 1.2
    <p>
    <list>
    <item>Lots of grammar corrections by James Treacy, new XDM
    paragraph
    </list>
<sect1>Version 1.1
    <p>
    <list>
    <item>Typo fixes, miscellaneous additions
    </list>
<sect1>Version 1.0
    <p>
    <list>
    <item>Initial release
    </list>



<sect>Credits and Thanks!
<p>
<list>
<item>Alexander Reelsen wrote the original document. 

<item>Javier Fernández-Sanguino added more info to the original doc.

<item>Robert van der Meulen provided the quota paragraphs and many good ideas

<item>Ethan Benson corrected the PAM paragraph and had some good ideas.

<item>Dariusz Puchalak contributed some information to several
chapters.

<item>Gaby Schilders contributed a nice Genius/Paranoia idea.

<item>Era Eriksson smoothed out the language in a lot of
places and contributed the checklist appendix.

<item>Philipe Gaspar wrote the LKM information.

<item>Yotam Rubin contributed fixes for many typos as well
as information regarding bind versions and md5 passwords.

<item>All the people who made suggestions for improvement that
(eventually) got included here (see <ref id="changelog">)

<item>(Alexander) All the folks who encouraged me to write this HOWTO
(which was later turned into a Manual).

<item>The whole Debian project.
</list>



<chapt>Before you begin 


<sect>What do you want this system for?

<p>Securing Debian is not very different from securing any other
system; in order to do it properly, you must first decide what do you
intend to do with it. After this, you will have to consider that the
following tasks need to be taken care of if you want a really secure
system.  

<p>You will find that this manual is written from the bottom
up, that is, you will read some information on tasks to do before,
during and after the installation of your Debian system is made. The
tasks can also be thought of as:

<list>

<item>Decide which services you need and limit your system to those.
This includes deactivating/uninstalling unneeded services, and adding
firewall-like filters, or tcpwrappers.  

<item>Limit users and permissions in your system. 

<item>Harden offered services so that, in
the event of a service compromise, the impact to your system is
minimized.  

<item>Use appropriate tools to guarantee that unauthorized
use is detected so that you can take appropriate measures.

</list>

<sect id="references">Be aware of general security problems

<p>The following manual does not (usually) go into the details on why
some issues are considered security risks. However, you might want to
have a better background regarding general UNIX and (specific) Linux
security. Take some time to read over security related documents in
order to take informed decisions when you are encountered with
different choices. Debian GNU/Linux is based on the Linux kernel, so
much of the information regarding Linux, as well as from other
distributions and general UNIX security also apply to it (even if the
tools used, or the programs available, differ).

<p>Some useful documents include:

<list>

<item>The <url name="Linux Security HOWTO"
id="http://www.linuxdoc.org/HOWTO/Security-HOWTO.html">
(also available at <url id="http://www.linuxsecurity.com/docs/LDP/Security-HOWTO.html" name="LinuxSecurity">) is one of the
best references regarding general Linux Security.

<!-- FIXME: change this poiner to the LDP -->
<item>The <url name="Security Quick-Start HOWTO for Linux" 
id="http://www.linuxsecurity.com/docs/LDP/Security-Quickstart-HOWTO/">
is also a very good starting point for novice users (both to Linux
and security).

<!-- FIXME verify seifried's links -->

<item>
The <url id="http://seifried.org/lasg/" name="Linux Security
  Administrator's Guide"> (provided in Debian through the
  <package>lasg</package> package) is a complete guide that touches
  all the issues related to security in Linux, from kernel security to
  VPNs. It is somewhat obsolete (not updated since 1999) and has been
  superseded by the <url id="http://seifried.org/lskb" name="Linux
  Security Knowledge Base ">. This documentation is also provided in
  Debian through the <package>lskb</package> package.

<item> Kurt Seifried's <url
id="http://seifried.org/security/os/linux/20020324-securing-linux-step-by-step.html"
name="Securing Linux Step by Step">.

<item>In <url name="Securing and Optimizing Linux: RedHat Edition"
id="http://www.linuxdoc.org/links/p_books.html#securing_linux"> you
can find a similar document to this manual but related to RedHat, some
of the issues are not distribution-specific and also apply to Debian.

<item>IntersectAlliance has published some documents that can be used
as references cards on how to harden linux servers (and their
services), the documents are available at <url
id="http://www.intersectalliance.com/projects/index.html" name="their
site">.

<item>For network administrators, a good reference for building a
 secure network is the <url name="Securing your Domain HOWTO"
 id="http://www.linuxsecurity.com/docs/LDP/Securing-Domain-HOWTO/">.


<item>If you want to evaluate the programs you are going to use (or want to build up some new ones) you 
should read the <url name="Secure Programs HOWTO"
id="http://www.linuxdoc.org/HOWTO/Secure-Programs-HOWTO.html">.

<!-- FIXME: check URLs --> 

<item>If you are considering installing Firewall capabilities, you
should read the <url name="Firewall HOWTO"
id="http://www.linuxdoc.org/HOWTO/Firewall-HOWTO.html"> and the <url
name="IPCHAINS HOWTO"
id="http://www.linuxdoc.org/HOWTO/IPCHAINS-HOWTO.html"> (for kernels
previous to 2.4).

<item>Finally, a good card to keep handy is the
<url name="Linux Security RefenceCard"
 id="http://www.linuxsecurity.com/docs/QuickRefCard.pdf">

</list>

<p>In any case, you have more information regarding the services here
explained (NFS, NIS, SMB...) in many of the HOWTOs of the <url
name="Linuxdoc Project" id="http://www.linuxdoc.org/">, some of these
documents speak on the security side of a given service, so be sure to
take a look there too.

<p>The HOWTO documents from the Linux Documentation Project are
available in Debian GNU/Linux through the installation of the
<package>doc-linux-text</package> (text version) or
<package>doc-linux-html</package> (html version). After installation
these documents will be available at the
<file>/usr/share/doc/HOWTO/en-txt</file> and
<file>/usr/share/doc/HOWTO/en-html</file> directories, respectively.

<p>Other recommended Linux books:

<list>

<item>Maximum Linux Security : A Hacker's Guide to Protecting Your Linux
  Server and Network.  Anonymous. Paperback - 829 pages. Sams Publishing.
  ISBN: 0672313413. July 1999.

<item>Linux Security By John S. Flowers. New Riders; ISBN: 0735700354.
March 1999

<item><url id="http://www.linux.org/books/ISBN_0072127732.html" name="Hacking Linux Exposed"> By Brian Hatch. McGraw-Hill Higher Education.
ISBN 0072127732. April, 2001

</list>

<p>Other books (which might be related to general issues
regarding UNIX and security and not Linux specific):

<list>

<item><url id="http://www.ora.com/catalog/puis/noframes.html"
        name="Practical Unix and Internet Security (2nd Edition)">
        Garfinkel, Simpson, and Spafford, Gene; O'Reilly Associates;
        ISBN 0-56592-148-8; 1004pp; 1996.

<item>Firewalls and Internet Security Cheswick, William R. and Bellovin,
        Steven M.; Addison-Wesley; 1994; ISBN 0-201-63357-4; 320pp.

</list>

<p>Some useful Web sites to keep uptodate regarding security:

<list>

<item><url name="NIST Security Guidelines"
id="http://csrc.nist.gov/fasp/index.html">.

<item><url name="Security Focus" id="http://www.securityfocus.com">
	the server that hosts the Bugtraq vulnerability database and
	list, and provides general security information, news and
	reports.

<item> <url name="Linux Security"
	id="http://www.linuxsecurity.com/">. General information
	regarding Linux security (tools, news...). Most useful is the
	<url name="main documentation"
	id="http://www.linuxsecurity.com/resources/documentation-1.html">
	page.

<item> <url name="Linux firewall and security site" id="
	http://www.linux-firewall-tools.com/linux/">. General
	information regarding Linux firewalls and tools to control and
	administrate them.

</list>

<sect>How does Debian handle security?
<p>Just so you have a general overview of security in Debian GNU/Linux
you should take note of the different issues that Debian tackles in
order to provide an overall secure system:

<list>

<item>Debian problems are always handled openly, even security related.
As the <url name="Debian Social Contract" id="http://www.debian.org/social_contract"> states:
<em>
We Won't Hide Problems

We  will  keep our entire bug-report database open for public view
at  all  times.  Reports  that users file on-line will immediately
become visible to others.
</em>
Security issues are discussed
openly on the debian-security mailing list. Debian Security
Advisories are sent to public mailing lists (both internal an external)
and published on the public server.

<item>Debian follows security issues closely. The security team 
checks many security related sources, the most important being
<url name="Bugtraq" id="http://www.securityfocus.com/cgi-bin/vulns.pl">,
on the lookout for packages with security issues that might be
included in Debian.

<item>Security updates are the first priority. When a security problem
arises in a Debian package, the security update is prepared as fast
as possible and distributed for our stable and unstable releases, including
all architectures.

<item>Information regarding security is centralized in a single point,
<url id="http://security.debian.org/">.

<item>Debian is always trying to improve the overall security of the
distribution starting out new projects, like automatic package signature 
verification mechanisms.

<item>Debian tries to provide a useful number of security related tools
for system administration and monitoring. Developers try to tightly
integrate this tools with the distribution in order to make them better
suite to enforce local security policies. Tools include: integrity checkers, 
auditing tools, hardening tools, firewall tools, intrusion detection tools,
etc..

<item>Package maintainers are aware of security issues. This leads
to many "secure by default" service installations which might put some
limits, sometimes, to its normal use. However, Debian does try to balance
security issues and ease of administration, systems are not installed
de-activated, for example, like on the BSD family distributions. In any
case, some special security issues, like setuid programs, are part of
the <url id="http://www.debian.org/doc/debian-policy/" name="Debian Policy">.

</list>

<p>This same document tries to enforce, as well a better 
distribution security-wise, by publishing 
security information specific to Debian which complements other 
information-security documents related to the tools used by Debian
or the operating system itself (see <ref id="references">.


<chapt>Before and during the installation


<sect id="bios-passwd">Choose a BIOS password
<p>
Before you install any operating system on your computer, set up a
BIOS password. After installation (once you have enabled bootup
from the hard disk) you should go back to the BIOS and change the 
boot sequence to disable booting from floppy, cdrom and other 
devices that shouldn't boot.  Otherwise a cracker only needs 
physical access and a boot disk to access your entire system.

<p>Disabling booting without a password is even better. This can be very
effective if you run a server, because it is not rebooted very often.
The downside to this tactic is that rebooting requires human
intervention which can cause problems if the machine is not easily
accessible.

<p>Note: many BIOSes have well known default master passwords, and
there also exist applications to retrieve the passwords from the
BIOS. Corollary: don't depend on this measure to secure console access
to system.

<sect>Partitioning the system

<sect1>Choose an intelligent partition scheme
<p>
An intelligent partition scheme depends on the how the machine is
used.  A good rule of thumb is to be fairly liberal with your
partitions and to pay attention to the following factors:

<list>
<item>Any directory tree which a user has write permissions to, such
as e.g. <file>/home</file> and <file>/tmp</file>, should be on
a separate partition.  This reduces the risk of a user DoS by 
filling up your "/" mount point and
rendering the system unusable. (Note: this is not strictly true, since
there is always some space reserved for root which a normal user cannot fill)

<item>Any partition which can fluctuate, e.g. <file>/var</file>
(especially <file>/var/log</file>) should also be on a separate
partition.  On a Debian system, you should create <file>/var</file> a
little bit bigger than normal, because downloaded packages (the apt
cache) are stored in <file>/var/cache/apt/archives</file>. 

<item>Any partition where you want to install non-distribution
software should be on a separate partition.  According to the File
Hierarchy Standard, this is <file>/opt</file> or <file>/usr/local</file>.
If these are separate partitions, they will not be erased if you 
(have to) reinstall Debian itself.

<item>From a security point of view, it makes sense to try to move
static data to its own partition, and then mount that partition
read-only. Better yet, put the data on read-only media. See below for
more details.
</list>

<p>In the case of mail server it is important to have a separate
partition for the mail spool. Remote users (either knowingly or
unknowingly) can fill the mail spool (<file>/var/mail</file> and/or
<file>/var/spool/mail</file>). If the spool is in a separate
partition, this situation will not render the system
unusable. Otherwise (if the spool directory is in the same place
partition as <file>/var</file>) the system might have important
problems: log entries will not be created, packages can not be
installed, and some programs might even have problems starting up (if
they use <file>/var/run</file>).

<p>Also, for partitions in which you cannot be sure of the needed
space, installing Logical Volume Manager
(<package>lvm-common</package> and the needed binaries for your
kernel, this might be either <package>lvm10</package>,
<package>lvm6</package>, or <package>lvm5</package>). Using
<tt>lvm</tt> you can create volume groups that expand multiple
physical volumes.

<sect2>Selecting the appropiate filesystems

<p>During the system partitioning you also have to decide which
filesystem you want to use. The default filesystem selected in the
Debian installation for Linux partitions is <tt>ext2</tt>. However, it
is recommended you swith to the a journaling filesystem, such as
<tt>ext3</tt>, <tt>reiserfs</tt>, <tt>jfs</tt> or <tt>xfs</tt>, to
minimize the problems derived from a system crash in the following
cases:

<list>

<item>for laptops in all the filesystems installed. That way if you
run out of battery unexpectedly or the system freezes due to a
hardware issue (such as X configuration which is somewhat common) you
can do a hardware reboot with less chances of losing data.

<item>for production systems which store big amounts of data (like
mail servers, ftp servers, network filesystems...) it is recommended
on these partitions. That way, in the event of a system crash, the
server will take less time to recover and check the filesystems, and
decrease the chances of data loss.

</list>

<p>Leaving aside the performance issues regarding journaling
filesystems (since this sometimes can turn into a religious war), it
is usually better to use the <tt>ext3</tt> filesystem. The reason for
this is that it is backwards compatible with <tt>ext2</tt>, so if
there are any issues with the journaling you can disable it and still
have a working filesystem. Also, if you need to recover the system
with a bootdisk (or CDROM) you do not use a custom kernel. If the
kernel in it is 2.4 <tt>ext3</tt> support is already available, if it
is a 2.2 kernel you will be able to boot the filesystem even if you
lose journaling capabilities.  If you are using other journaling
filesystems you will find that you might not be able to recover unless
you have a 2.4 kernel with the needed modules compiled built-in. Also,
if you are stuck with a 2.2 kernel in the rescue disk it might even be
more difficult to have it access <tt>reiserfs</tt> or <tt>xfs</tt>.

<p>In any case, <tt>ext3</tt> might cause less data loss since it does
file-data journaling whileas others do only meta-data journaling, see
<url id="http://lwn.net/2001/0802/a/ext3-modes.php3">.


<sect>Do not plug to the Internet until ready

<p>The system you are going to install should not be immediately
connected to the Internet during installation. This could sound stupid
but is usually done. Since the system will install and activate
services immediately, if the system is connected to the Internet and
the services are not properly configured you are opening it to
attack. 

<p>Also note that some services might have new security
vulnerabilities not fixed in the packages you are using for
installation. This is usually true if you are installing from old
media (like CD-ROMs). In this case, it could even be compromised
before you even finished installation!

<p>Since Debian installation and upgrades can be done over the
Internet you might think it is a good idea to use this feature on
installation. If the system is going to be directly connected to the
Internet (and not protected by a firewall or NAT), it is best to
install without connection to the Internet and using a local packages
mirror from both the Debian package sources and the security
updates. You can setup package mirrors by using another system
connected to the Internet and Debian-specific (if it's a Debian
system) tools like <package>apt-move</package> or
<package>apt-proxy</package> or other common mirroring tools to
provide the archive to the installed system. If you cannot do this,
you can setup firewall rules to limit access to the system while doing
the update (see <ref id="fw-security-update">).

<sect>Set a root password
<p>
Setting a good root password is the most basic requirement for having
a secure system. See <manref section="1" name="passwd"> for some hints on how to create good passwords, you can, also, use an automatica password generation program to do this for you (see <ref id="user-pwgen">).

<p>FIXME: Add pointers to information about good passwords.


<sect>Activate shadow passwords and MD5 passwords
<p>
At the end of the installation, you will be asked if shadow passwords
should be enabled. Answer yes to this question, so passwords will be
kept in the file <file>/etc/shadow</file>. Only the root user and the
group shadow have read access to this file, so no users will be able
to grab a copy of this file in order to run a password cracker against
it. You can switch between shadow passwords and normal passwords at
any time by using <tt>shadowconfig</tt>.


<p>Read more on Shadow passwords in
<url
name="Shadow Password"
id="http://www.linuxdoc.org/HOWTO/Shadow-Password-HOWTO.html">
(<file>/usr/share/doc/HOWTO/en-txt/Shadow-Password.txt.gz</file>).

<p>Furthermore, you are queried during installation whether you want
to use MD5 hashed passwords. This is generally a very good idea since
it allows longer passwords and better encryption. MD5 allows for
passwords longer than 8 characters. This, if used wisely, can make it
more difficult for attackers to brute-force the system's
passwords. Regarding MD5 passwords, this the default option when
installing latest <package>password</package>. You can change this
anytime after installation by doing <prgn>dpkg-reconfigure -plow
passwd</prgn>. You can recognize md5 passwords in the
<file>/etc/shadow</file> file by their $1$ prefix.

<p>This, as a matter of fact, modifies all files under <file>/etc/pam.d</file> by subsituting the password line and include md5 in it:
<example>
      password required pam_unix.so md5 nullok obscure min=6 max=16
</example>
<p>If <tt>max</tt> is not set over 8 the change will not be useful at
all. For more information on this read <ref id="auth-pam">.

<p>Note: the default configuration in Debian, even when activating MD5
passwords, does not modify the <tt>max</tt> value previously set on
upgrades.

<sect>Run the minimum number of services required

<p>Services are programmes such as ftp servers and web servers. Since
they have to be <em>listening</em> for incoming connections that
request the service external computers can connect to yours. Services
are sometimes vulnerable (i.e. can be compromised under a given
attack) and are hence a security risk.

<p>You should not install services which are not needed on your
machine. Every installed service might introduce new, perhaps not
obvious (or known), security holes on your computer.

<p>As you may already know, when you install a given service the
default behavior is to activate it. In a default Debian installation,
with no services installed, the footprint of running services is quite
low and it's even lower when talking about services offered in the
network. The footprint in Debian 2.1 wasn't as tight as in Debian 2.2
(some inetd services were enabled by default) and in Debian 2.2 the
rpc portmapper is enabled upon installation. Rpc is installed by
default because it is needed for many services, for example NFS, to
run on a given system. It can be easily removed, however, see <ref
id="disableserv"> on how to disable it.

<p>When you install a new network-related service (daemon) in your
Debian GNU/Linux system it can be enabled in two ways: through the
inetd superdaemon (i.e. a line will be added to
<file>/etc/inetd.conf</file>) or through a standalone program that
binds itself to your network interfaces. Standalone programs are
controlled through the <file>/etc/init.d</file> files, which are
called at boot time through the SysV mechanism (or an alternative one)
by using symlinks in <file>/etc/rc?.d/*</file> (for more information
on how this is done read
<file>/usr/share/doc/sysvinit/README.runlevels.gz</file>).

<p>If you still want to have some services but you use these rarely,
use the update-commands, e.g. 'update-inetd' and 'update-rc.d' for
removing them from the startup process.


<sect1 id="disableserv">Disabling daemon services

<p>Disabling a daemon service is quite simple. There are different
methods:
<list>

<item>remove links from <file>/etc/rc${runlevel}.d/</file> or rename
the links (so that they do not begin with 'S')

<item>move the script file (<file>/etc/init.d/_service_name_</file>)
to another name (for example <file>/etc/init.d/OFF._service_name_</file>)

<item>remove the execution bit from the
<file>/etc/init.d/_service_name_</file> file.


<item>editing the <file>/etc/init.d/_service_name_</file> script to
have it stop immediately.

</list>

<p>You can remove the links from <file>/etc/rc${runlevel}.d/</file> manually or
using <tt>update-rc.d</tt> (see <manref section="8"
name="update-rc.d">). For example, you can disable a service from
executing in the multi-user runlevels by doing:

<example>
update-rc.d stop XX 2 3 4 5 .
</example>

<p>Please note that, if you are <em>not</em> using
<package>file-rc</package>, <tt>update-rc.d -f _service_ remove</tt>
will not work properly, since <em>all</em> links are removed, upon
re-installation or upgrade of the package this links will be
re-generated (probably not what you wanted). If you think this is not
intuitive you are probably right (see <url
id="http://bugs.debian.org/67095" name="Bug 67095">). From the
manpage:

<example>
 If any files /etc/rcrunlevel.d/[SK]??name already exist then
  update-rc.d does nothing.  This is so that the system administrator 
  can rearrange the  links,  provided that  they  leave  at  least one
  link remaining, without having their configuration overwritten.
</example>

<p>If you are using <package>file-rc</package> all the information
regarding services bootup is handled by a common configuration file
and is maintained even if packages are removed from the system.

<p>You can use the TUI (Text User Interface) provided by
<package>rcconf</package> to do all this changes easily
(<prgn>rcconf</prgn> works both for file-rc and normal System V
runlevels).

<p>Other (not recommended) methods of disabling services are:
<tt>chmod 644 /etc/init.d/daemon</tt> (but that gives an error message
when booting), or modifying the <file>/etc/init.d/daemon</file> script (by
adding an <prgn>exit 0</prgn> line at the beginning
or commenting out the <tt>start-stop-daemon</tt> part in it). Since
init.d files are configfiles, they will not get overwritten upon upgrade.

<p>Unfortunately, unlike other (UNIX) operating systems, services in
Debian cannot be disabled by modifying files in
<file>/etc/default/_servicename_</file>.

<p>FIXME: Add more information on handling daemons using file-rc

<sect1 id="inetd">Disabling inetd services
<p>
You should stop all unneeded services on your system, like
echo, chargen, discard, daytime, time, talk, ntalk and  r-services 
(rsh, rlogin and rcp) which are considered HIGHLY
insecure (use ssh instead). 
After disabling those, you should check if you really need
the inetd daemon.  Many people prefer to use daemons instead of
calling services via inetd. Denial of Service possibilities exist
against inetd, which can increase the machine's load tremendously. If
you still want to run some kind of inetd service, switch to a more
configurable inet daemon like xinetd or rlinetd.

<p>
You can disable services by editing <file>/etc/inetd.conf</file>
directly, but Debian provides a better alternative to do this:
<tt>update-inetd</tt> (which comments the services in a way that it
can easily be turned on again). You could remove the telnet daemon by
executing this commands to change the config file and to restart the
daemon (in this case the telnet service is disabled):

<example>
/usr/sbin/update-inetd --disable telnet
</example>
<!-- # /etc/init.d/inetd restart Not needed since the manpage says update-inetd
sends a SIGHUP, commented out as suggested by Dariusz Puchalak -->

<p>If you do want services listening, but do not want to have them
listen on all IP addresses of your host, you might want to use some
undocumented feature on inetd. <!-- FIXME write the information sent
by Alexander to the debian-security mailing list -->. Or use an
alternate inetd daemon like <prgn>xinetd</prgn>.

<sect>Install the minimum number of software required

<p>Debian comes with <em>a lot</em> of software, for example the
Debian 3.0 <em>woody</em> release includes almost 6 CD-ROMs of
software and thousands of packages. With so many software, and even if
the base system installation is quite reduced
<footnote>For example, in Debian woody it is around 40Mbs, try this:
<example>
$ size=0
$ for i in `grep -A 1 -B 1 "^Section: base" /var/lib/dpkg/available |
grep -A 2 "^Priority: required" |grep "^Installed-Size" |cut -d : -f 2
`; do size=$(($size+$i)); done
$ echo $size
34234
</example>
</footnote>
you might get carried away and install more than it is really needed
for your system.

<p>Since you already know what the system is for (don't you?) you
should only install software that is really needed for it to work. Any
unnecesary tool that is installed might be used by a user that wants
to compromise the system or by an external intruder that has gotten
shell access (or remote code execution through a exploitable
service).

<p>The presence, for example, of development utilities (a C compiler)
or interpreted languages (such as perl - but see below -, python,
tcl..) may help an attacker compromise the system even further:

<list>
<item>allowing him to do privilege escalation. It's easier, for
example, to run local exploits in the system if there is a debugger
and compiler ready to compile and test them!

<item>providing tools that could help the attacker to use the
compromised system as a <em>base of attack</em> against other systems
<footnote>
Many intrusions are just made to get access to resources to do
ilegitimate activity (denial of service attacks, spam, rogue ftp
servers, dns pollution...) rather than to just obtain confidential
data from the compromised system.
</footnote>

</list>

<p>Of course, an intruder with local shell access can download his own
set of tools and execute them, and even the shell itself can be used
to make complex programs. Removing unnecesary software will not help
<em>prevent</em> the problem but will make it slightly more difficult
for an attacker to proceed (and some might give up in this situation
looking for easier targets). So, if you leave in a production system
tools that could be used to remotely attack systems (see <ref
id="vuln-asses">) you can expect an intruder to use them too if
available.

<sect1>Removing Perl

<p>You must take into account that removing <prgn>perl</prgn> might not be
too easy (as a matter of fact it can be quite difficult) in a Debian
system since it is used by many system utilities. Also, the
<package>perl-base</package> is <em>Priority: required</em> (that
about says it all). It's still doable, you just have to consider you
will not be able to run any perl aplication in the system and you will
also have to fool the package management system to think that the
<package>perl-base</package> is installed even if it's
not. <footnote>You can make (on another system) a dummy package with
<package>equivs</package></footnote>

<p>Which utilities use perl? You can see it for yourself doing:

<example>
$ for i in /bin/* /sbin/* /usr/bin/* /usr/sbin/*; do [ -f $i ] && {
type=`file $i | grep -il perl`; [ -n "$type" ] && echo $i; }; done
</example>

<p>These includes the following utilities in packages with priority
<em>required</em> or <em>important</em>:

<list>
<item><file>/usr/bin/chkdupexe</file> of package
<package>util-linux</package>.

<item><file>/usr/bin/replay</file> of package
<package>bsdutils</package>.

<item><file>/usr/sbin/cleanup-info</file> of package
<package>dpkg</package>.

<item><file>/usr/sbin/dpkg-divert</file> of package
<package>dpkg</package>.

<item><file>/usr/sbin/dpkg-statoverride</file> of package
<package>dpkg</package>.

<item><file>/usr/sbin/install-info</file> of package
<package>dpkg</package>.

<item><file>/usr/sbin/update-alternatives</file> of package
<package>dpkg</package>.

<item><file>/usr/sbin/update-rc.d</file> of package
<package>sysvinit</package>.

<item><file>/usr/bin/grog</file> of package
<package>groff-base</package>.

<item><file>/usr/sbin/adduser</file> of package
<package>adduser</package>.

<item><file>/usr/sbin/debconf-show</file> of package
<package>debconf</package>.

<item><file>/usr/sbin/deluser</file> of package
<package>adduser</package>.

<item><file>/usr/sbin/dpkg-preconfigure</file> of package
<package>debconf</package>.

<item><file>/usr/sbin/dpkg-reconfigure</file> of package
<package>debconf</package>.

<item><file>/usr/sbin/exigrep</file> of package
<package>exim</package>.

<item><file>/usr/sbin/eximconfig</file> of package
<package>exim</package>.

<item><file>/usr/sbin/eximstats</file> of package
<package>exim</package>.

<item><file>/usr/sbin/exim-upgrade-to-r3</file> of package
<package>exim</package>.

<item><file>/usr/sbin/exiqsumm</file> of package
<package>exim</package>.

<item><file>/usr/sbin/keytab-lilo</file> of package
<package>lilo</package>.

<item><file>/usr/sbin/liloconfig</file> of package
<package>lilo</package>.

<item><file>/usr/sbin/lilo_find_mbr</file> of package
<package>lilo</package>.

<item><file>/usr/sbin/syslogd-listfiles</file> of package
<package>sysklogd</package>.

<item><file>/usr/sbin/syslog-facility</file> of package
<package>sysklogd</package>.

<item><file>/usr/sbin/update-inetd</file> of package
<package>netbase</package>.

</list>

<p>So, without Perl and, unless you remake these utilities in shell
script, you will probably not be able to manage any packages (so you
will not be able to upgrade the system, which is <em>not a good
thing</em>).

<p>If you are determined to remove Perl from the Debian base system,
and you have spare time, submit bug reports to the previous packages
including (as a patch) replacements for the utilities above written in
shell script.

<sect>Read the debian security mailing lists

<p>It is never wrong to take a look at either the
debian-security-announce mailing list, where advisories and fixes to
released packages are announced by the Debian security team, or at
debian-security@lists.debian.org, where you can participate in
discussions about things related to Debian security.

<p>In order to receive important security update alerts, send an email
to <url name="debian-security-announce-request@lists.debian.org"
id="mailto:debian-security-announce-request@lists.debian.org"> with
the word "subscribe" in the subject line.  You can also subscribe to
this moderated email list via the web page at
<url name="http://www.debian.org/MailingLists/subscribe"
id="http://www.debian.org/MailingLists/subscribe">

<p>This mailing list has very low volume, and by subscribing to it you
will be immediately alerted of security updates for the Debian
distribution.  This allows you to quickly download new packages with
security bug fixes, which is very important in maintaining a secure
system.  (See <ref id="security-update"> for details on how to do this.)




<chapt>After Installation

<p>Once the system is installed you can still secure the system more,
some of the steps described in this chapter can be taken. Of course
this really depends on your setup but for physical access prevention
you should read <ref id="bios-boot">,<ref id="lilo-passwd">,<ref
id="kernel-root-prompt">, <ref id="floppy-boot">, <ref
id="restrict-console-login">, and <ref id="restrict-reboots">.

<p>Before connecting to any network, specially if it's a public one
you should, at the very least: execute a security update (see 
<ref id="security-update">). Optionally, you could take a snapshot of your
system (see <ref id="snapshot">).

<sect id="bios-boot">Change the BIOS (again)

<p>Remember <ref id="bios-passwd">? Well, then you should now, once
you do not need to boot from removable media, to change the default
BIOS setup so that it <em>only</em> boots from the hard drive. Make
sure you will not lose the BIOS password, otherwise, in the event of a
hard disk failure you will not be able to return to the BIOS and
change the setup so you can recover it using, for example, a CD-ROM.

<p>Another less secure but more convenient setup would change the
setup to have the system boot up from the hard disk and, if it fails,
try removable media. By the way, this is often done because since few
people use the BIOS password that much often it's easily forgotten.

<sect id="lilo-passwd">Set a LILO or GRUB password
<p>
Anybody can easily get a root-shell and change your passwords by
entering "&lt;name-of-your-bootimage&gt; init=/bin/sh" at the boot
prompt. After changing the passwords and rebooting the system, the
person has unlimited root-access and can do anything he/she wants to the
system.  After this procedure you will not have root access to your
system, as you do not know the root password.
<p>
To make sure that this can not happen, you should set a password for
the boot loader. You can choose between a global password or a
password for a certain image.
<p>
For LILO you need to edit the config file <file>/etc/lilo.conf</file> and add a
"password" and "restricted" line as in the example below.

<example>
image=/boot/2.2.14-vmlinuz
   label=Linux
   read-only
   password=hackme
   restricted
</example>

<p>
When done, rerun lilo.  Omitting the "restricted" line causes lilo to
always prompt for a password, regardless of whether LILO was passed
parameters. The default permissions for <file>/etc/lilo.conf</file>
grant root read and
write permissions, and enable read-only access for lilo.conf's group, root.

<p>
If you use GRUB instead of LILO, edit <file>/boot/grub/menu.lst</file>
and add the following two lines at the top (substituting, of course
'hackme' with the desired password). This prevents users from editing
the boot items. 'timeout 3' specifies a 3 second delay before grub boots
the default item.

<example>
timeout 3
password hackme
</example>

<p>To further harden the integrity of the password, you may store the password
in a encrypted form. The utility grub-md5-crypt generates a hashed password
which is compatible with grub's encrypted password algorithm (md5).
To specify in grub that md5 format password will be used, use the following 
directive:
<example>
timeout 3
password --md5 $1$bw0ez$tljnxxKLfMzmnDVaQWgjP0
</example>

The --md5 parameter was added to instruct grub to perform the md5 
authentication process. The provided password is the md5 en crypted version of 
hackme. Using the md5 password method is preferable to choosing its 
cleartext counterpart. More information about grub passwords may be
found in the grub-doc package.

<sect id="kernel-root-prompt">Remove root prompt on the kernel

<p>Linux 2.4 kernels provide a way to access a root shell while
booting which will be presented just after loading the cramfs
filesystem. A message will appear to permit the administrator to enter
an executable shell with root permissions, this shell can be used to
manually load modules when autodetection fails. This behavior is the
default for initrd's linuxrc. The following message will appear:
<example>
Press ENTER to obtain a shell (waits 5 seconds)
</example>

<p>In order to remove this behavior you need to change 
<file>/etc/mkinitrd/mkinitrd.conf</file> and set:
<example>
# DELAY  The  number  of seconds the linuxrc script should wait to
# allow the user to interrupt it before the system is brought up
DELAY=0
</example>
<p>Then regenerate your ramdisk image. You can do this for example with:
<example>º
# cd /boot
# mkinitrd -o initrd.img-2.4.18-k7 /lib/modules/2.4.18-k7
</example>
<p>or doing (preferred):
<example>
# dpkg-reconfigure -plow kernel-image-2.4.x-yz
</example>
<p>Note that Debian 3.0 woody allows users to install 2.4 kernels
(selecting <em>flavors</em>), <em>however</em> the default kernel
is 2.2 (save for some architectures for which kernel 2.2 was not
ported to). If you consider this a bug consider
<url id="http://bugs.debian.org/145244" name="Bug 145244"> before sending it.

<sect id="floppy-boot">Disallow floppy booting
<p>
The default MBR in Debian before version 2.2 did not act as a usual
master boot record and left open a method to easily break into a
system:

<list>
<item>Press shift at boot time, and an MBR prompt appears 

<item>Then press F, and your system will boot from floppy disk. This
can be used to get root access to the system.
</list>

<p>This behavior can be changed by entering:

<example>
lilo -b /dev/hda
</example>

<p>Now LILO is put into the MBR. This can also be achieved by adding
"boot=/dev/hda" to lilo.conf. There is another solution which will
disable the MBR prompt completely:

<example>
install-mbr -i n /dev/hda
</example>

<p>On the other hand, this "back door", of which many people are just not
aware, may save your skin as well if you run into deep trouble with your
installation for whatever reasons.

<p>FIXME check whether this really is true as of 2.2 or was it 2.1?
INFO: The bootdisks as of Debian 2.2 do NOT install the mbr, but only LILO


<sect id="restrict-console-login">Restricting console login access 

<p>Some security policies might want to force administrators to log in
the system through the console with their user/password and then
become superuser (with <prgn>su</prgn> or <prgn>sudo</prgn>). This
policy is implemented in Debian by editing the
<file>/etc/login.defs</file> file or <file>/etc/securetty</file> when
using PAM. In:

<list>

<item><file>login.defs</file>, editing the CONSOLE variable which
defines a file or list of terminals on which root logins are allowed

<item><file>securetty</file> by adding/removing the terminals to which
root access will be allowed.

</list>

<p>When using PAM other changes to the login process, which might
include restrictions to users and groups at given times, can be
configured at <file>/etc/pam.d/login</file>. An interesting feature
that can be disabled is the possibility to login with null (blank)
passwords. This feature can be limited by removing <em>nullok</em>
from the line:

<example>
auth       required   pam_unix.so nullok
</example>

<sect id="restrict-reboots">Restricting system reboots through the console

<p>If you system has a keyboard attached to it anyone (yes
<em>anyone</em>) can reboot the system through it without login in the
system. This might, or might not, adhere to your security policy. If
you want to restrict this, you must check the
<file>/etc/inittab</file> so that the line that includes
<tt>ctrlaltdel</tt> calls <prgn>shutdown</prgn> with the <tt>-a</tt>
switch (remember to run <tt>init q</tt> after making any changes to
this file). The default in Debian includes this switch:

<example>
ca:12345:ctrlaltdel:/sbin/shutdown -t1 -a -r now
</example>

<p>Now, in order to allow <em>some</em> users to shutdown the system,
as the manpage <manref section="8" name="shutdown"> describes, you must
create the file <file>/etc/shutdown.allow</file> and include there the
name of users which can boot the system. When the <em>three finger
salute</em> (a.k.a. <em>ctrl+alt+del</em>) is given the program will
check if any of the users listed in the file are logged in. If none of
them is <prgn>shutdown</prgn> will <em>not</em> reboot the system.
 

<sect>Mounting partitions the right way
<p>
When mounting an ext2 partition, you have several additional options
you apply to the mount call or to <file>/etc/fstab</file>. For
instance, this my fstab entry for the <file>/tmp</file> partition:

<example>
/dev/hda7    /tmp    ext2    defaults,nosuid,noexec,nodev    0    2
</example>

<p>
You see the difference in the options sections. The option
<tt>nosuid</tt> ignores the setuid and setgid bits completely, while
<tt>noexec</tt> forbids execution of any program on that mount point,
and <tt>nodev</tt>, ignores devices. This sounds great, but it
<list>
<item>only applies to ext2 filesystems
<item>can be circumvented easily
</list>

<p>The <tt>noexec</tt> option prevents binaries from being executed
directly, but is easily circumvented:

<example>
alex@joker:/tmp# mount | grep tmp
/dev/hda7 on /tmp type ext2 (rw,noexec,nosuid,nodev)
alex@joker:/tmp# ./date
bash: ./date: Permission denied
alex@joker:/tmp# /lib/ld-linux.so.2 ./date
Sun Dec  3 17:49:23 CET 2000
</example>

<p>
However, many script kiddies have exploits which try to create and
execute files in <file>/tmp</file>. If they do not have a clue, they will fall into
this pit. In other words, a user cannot be tricked into executing a
trojanized binary in <file>/tmp</file> e.g. when he incidentally adds 
<file>/tmp</file> into his PATH.

<p>Also be forewarned, some script might depend on <file>/tmp</file> begin
executable. Most notably, Debconf has (had?) some issues regarding
this, for more information see Bug <url
id="http://bugs.debian.org/116448" name="116448">.

<p>
The following is a more thorough example. A note, though: <file>/var</file> could
be set noexec, but some software like Smartlist keeps its programs in
/var. The same applies to the nosuid option.

<example>
/dev/sda6       /usr            ext2    defaults,ro,nodev       0       2
/dev/sda12      /usr/share      ext2    defaults,ro,nodev,nosuid        0       2
/dev/sda7       /var            ext2    defaults,nodev,usrquota,grpquota          0       2
/dev/sda8       /tmp            ext2    defaults,nodev,nosuid,noexec,usrquota,grpquota    0       2
/dev/sda9       /var/tmp        ext2    defaults,nodev,nosuid,noexec,usrquota,grpquota    0       2
/dev/sda10      /var/log        ext2    defaults,nodev,nosuid,noexec    0       2
/dev/sda11      /var/account    ext2    defaults,nodev,nosuid,noexec    0       2
/dev/sda13      /home           ext2    rw,nosuid,nodev,exec,auto,nouser,async,usrquota,grpquota                0       2
/dev/fd0        /mnt/fd0        ext2    defaults,users,nodev,nosuid,noexec      0       0
/dev/fd0        /mnt/floppy     vfat    defaults,users,nodev.nosuid,noexec      0       0
/dev/hda        /mnt/cdrom      iso9660 ro,users,nodev.nosuid,noexec            0       0
</example>

<sect1>Setting /tmp noexec
<p>
Be careful if setting <file>/tmp</file> noexec and you want to install new software, since 
some might use it for installation. Apt is one such program
(see <url id="http://bugs.debian.org/116448">) if not configured properly
<tt>APT::ExtractTemplates::TempDir</tt> (see <manref name="apt-extracttemplates" section="1">). 
You can set this variable in <file>/etc/apt/apt.conf</file> to another 
directory with exec privileges other
than <file>/tmp</file>

<p>Regarding noexec, please be aware that it might not offer you that much security. 
Consider this:
<example>
$ cp /bin/date /tmp
$ /tmp/date
(does not execute due to noexec)
$/lib/ld-linux.so.2 /tmp/date
(works since date is not executed directly)
</example>

<sect1>Setting /usr read-only
<p>
If you set <file>/usr</file> read-only you will not be able to install
new packages on your Debian GNU/Linux system. You will have, first to
remount it read-write, install the packages and then remount it
read-only. The latest apt version (in Debian 3.0 'woody') can be
configured to run commands before and after installing packages, so
you might want to configure it properly.

<p>To do this modify <file>/etc/apt/apt.conf</file> and add:
<example>
  DPkg
  {
      Pre-Invoke  { "mount /usr -o remount,rw" };
      Post-Invoke { "mount /usr -o remount,ro" };
  };
</example>

<p>Note that the Post-Invoke may fail with a "/usr busy" error message.
This happens mainly when you are using files during the update that
got updated.  Annoying but not really a big deal.  Just make sure
these are no longer used and run the Post-Invoke manually.

<sect id="security-update">Execute a security update

<p>As soon as new security bugs are detected in packages, Debian
maintainers and upstream authors generally patch them within days or
even hours. After the bug is fixed, a new package is provided on <url
name="http://security.debian.org" id="http://security.debian.org">.

<p>If you are installing a Debian release you must take in account
that since the release was made there might have been security updates
after it has been determined that a given package is vulnerable. Also,
there might have been minor releases (there were up to seven in Debian
2.2 <em>potato</em> release) which include these package updates. 

<p>You need to note down the date the removable media (if you are
using it) was made and check the security site in order to see if
there are security updates. If there are and you cannot download the
packages from the security site on another system (you are not
connected to the Internet yet? aren't you?) before connecting to the
network you could consider (if not protected by a firewall for
example) adding firewall rules so that you system could only connect
to security.debian.org and then run the update. A sample configuration
is shown in <ref id="fw-security-update">.

<p>To update the system, put the following line in your
<file>sources.list</file> and you will get security updates
automatically, whenever you update your system.

<example>
deb http://security.debian.org/ stable/updates main contrib non-free
</example>

<p>
Most people, who don't live in a country which prohibits importing
or using strong cryptography, should add this line as well:

<example>
deb http://security.debian.org/debian-non-US stable/non-US main contrib non-free
</example>

<p>If you like, you can add the deb-src lines to apt as well. See
<manref name="apt" section="8"> for further details.

<p>FIXME: Add info on how the signature of packages is done so that this
can be done automatically through a cron job (big warning: DNS spoofing).

<sect id="debian-sec-announce">Subscribe to the Debian Security Announce mailing List

<p>In order to receive information on security updates available you
should subscribe yourself to the debian-security-announce mailing list
in order to receive the Debian Security Advisories (DSAs). See <ref
id="debian-sec-team"> for more information on how the Debian security
team works. For information on how to subscribe to the Debian mailing
lists read <url id="http://lists.debian.org">.

<p>DSAs are signed with the Debian Security Team's signature which can
be retrieved from <url id="http://security.debian.org">.

<p>You should consider, also, subscribing to the debian-security
mailing list for general discussion on security issues in the Debian
operating system.

<p>FIXME: add the key here too?

<sect>Providing secure user's access

<sect1 id="auth-pam">User authentication: PAM

<p>PAM (Pluggable Authentication Modules) allows system administrators
to choose how applications authenticate users. Note that PAM can do
nothing unless an application is compiled with support for PAM. Most
of the applications that are shipped with Debian 2.2 have this support
built in. Furthermore, Debian did not have PAM support before 2.2. The
current default configuration for any PAM-enabled service is to
emulate UNIX authentication (read
<file>/usr/share/doc/libpam0g/Debian-PAM-MiniPolicy.gz</file> for more
information on how PAM services <em>should</em> work in Debian).


<p>Each application with PAM support provides a configuration file
in <file>/etc/pam.d/</file> which can be used to modify its behavior:

<list>
<item>what backend is used for authentication.
<item>what backend is used for sessions.
<item>how do password checks behave.
</list>

<p>
The following description is far from complete, for more information
you might want to read the <url
id="http://www.kernel.org/pub/linux/libs/pam/Linux-PAM-html/pam.html"
name="The Linux-PAM System Administrator's Guide"> (at the <url
id="http://www.kernel.org/pub/linux/libs/pam/" name="primary PAM
distribution site">), this document is also provided in the
<package>libpam-doc</package>.

<p>PAM offers you the possibility to go through several authentication steps at
once, without the user's knowledge. You could authenticate against a Berkeley
database and against the normal passwd file,
and the user only logs in if he authenticates correct in both.
You can restrict a lot with PAM, just as you can open your system
doors very wide. So be careful. A typical configuration line has a control
field as its second element. 
<!-- Second in mine (old Debian v2.0 though), check this! (FIXME) (era) -->
Generally it should be set to "requisite", which
returns a login failure if one module fails.
<!-- Lots of fields in mine are "required", please elaborate? (FIXME) (era) -->

<p>The first thing I like to do, is to add MD5 support to PAM
applications, since this helps protects against dictionary cracks
(passwords can be longer if using MD5). The following two lines should
be added to all files in <file>/etc/pam.d/</file> that grant access to the machine,
like <tt>login</tt> and <tt>ssh</tt>.

<example>
# Be sure to install libpam-cracklib first or you will not be able to log in
password   required     pam_cracklib.so retry=3 minlen=12 difok=3
password   required     pam_unix.so use_authtok nullok md5
</example>


<p>So, what does this incantation do? The first line loads the
cracklib PAM module, which provides password strength-checking,
prompts for a new password with a minimum length of 12 characters, a
difference of at least 3 characters from the old password, and allows
3 retries. The second line introduces the standard authentication
module with MD5 passwords and allows a zero length password.  The
use_authtok directive is necessary to hand over the password from the
previous module.

<p>FIXME: Check if <url name="http://bugs.debian.org/112965" id="Bug
#112965"> still stands (i.e. you can run into problems if you do not
have a wordlist (such as <package>wenglish</package>,
<package>wspanish</package>, <package>wbritish</package>...). It does
not seem to have a dependancy to <package>wordlist</package> in woody.

<p>To make sure that the user root can only log into the system from
local terminals, the following line should be enabled in
<file>/etc/pam.d/login</file>:

<example>
auth     requisite  pam_securetty.so
</example>

<p>Then you should add the terminals from which the user root can log
into the system into <file>/etc/security/access.conf</file>.  Last but not
least the following line should be enabled if you want to set up user
limits.

<!-- FIXME: This is pam.d/login you're talking about, still? Elaborate? era -->
<example>
session  required   pam_limits.so
</example>

<p>This restricts the system resources that users are allowed (see
below in <ref id="user-limits"> ).  For example, you could restrict the
number of concurrent logins (of a given group of users, or
system-wide) you may have, the number of processes, the memory size...

<p>Now edit <file>/etc/pam.d/passwd</file> and change the first line. You
should add the option "md5" to use MD5 passwords, change the minimum
length of password from 4 to 6 (or more) and set a maximum length, if
you desire. The resulting line will look something like:

<example>
password   required   pam_unix.so nullok obscure min=6 max=11 md5
</example>

<p>If you want to protect su, so that only some people can use it to
become root on your system, you need to add a new group "wheel" to your
system (that is the cleanest way, since no file has such a group
permission yet). Add root and the other users that should be able to
<prgn>su</prgn> to the root user to this group.  Then add the following line to
<file>/etc/pam.d/su</file>:

<example>
auth        requisite   pam_wheel.so group=wheel debug
</example>

<p>This makes sure that only people from the group wheel can use
<prgn>su</prgn> to become root. Other users will not be able to become
root. In fact they will get a denied message if they try to become
root.

<p>If you want only certain users to authenticate at a PAM service,
this is quite easy to achieve by using files where the users who are
allowed to login (or not) are stored. Imagine you only want to allow
user 'ref' to login via ssh. So you put him into
<file>/etc/sshusers-allowed</file> and write the following into
<file>/etc/pam.d/ssh</file>:

<example>
auth        required    pam_listfile.so item=user sense=allow file=/etc/sshusers-allowed onerr=fail
</example>

<p>Last, but not least, create <file>/etc/pam.d/other</file> and enter
the following lines:

<example>
auth     required       pam_securetty.so
auth     required       pam_unix_auth.so
auth     required       pam_warn.so
auth     required       pam_deny.so
account  required       pam_unix_acct.so
account  required       pam_warn.so
account  required       pam_deny.so
password required       pam_unix_passwd.so
password required       pam_warn.so
password required       pam_deny.so
session  required       pam_unix_session.so
session  required       pam_warn.so
session  required       pam_deny.so
</example>

<p>These lines will provide a good default configuration for all
applications that support PAM (access is denied per default).


<sect1 id="user-limits">Limiting resource usage: the limits.conf file

<p>
You should really take a serious look into this file. Here you can
define user resource limits. If you use PAM, the file
<file>/etc/limits.conf</file> is ignored and you should use
<file>/etc/security/limits.conf</file> instead.

<p>If you do not restrict resource usage, <em>any</em> user with a
valid shell in your system (or even an intruder who compromised the
system through a service) can use up as much CPU, memory, stack,
etc. the system can provide. This <em>resource exhaustion</em>
problem can only be fixed by the use of PAM. Note that there is a way
to add resource limits to some shells (for example, bash has
<prgn>ulimit</prgn>, see <manref section="1" name="bash">), but since not
all of them provide the same limits and since the user can change
shells (see <manref section="1" name="chsh">) it is better to place
the limits on the PAM modules.

<p>For more information read:
<list>

<item><url
id="http://www.samag.com/documents/s=1161/sam0009a/0009a.htm"
name="PAM configuration article">.

<item> <url
id="http://seifried.org/security/os/linux/20020324-securing-linux-step-by-step.html"
name="Seifried's Securing Linux Step by Step"> on the <em>Limiting
users overview</em> section.

<item><url id="http://seifried.org/lasg/users/" name="LASG"> in the 
<em>Limiting and monitoring users</em> section.

</list>

<p>FIXME: Get a good limits.conf up here

<sect1>User Login actions: edit /etc/login.defs
<p>
The next step is to edit the basic configuration and action upon user login.

<example>
FAIL_DELAY          10
</example>

<p>This variable should be set to a higher value to make it harder to
use the terminal to log in using brute force. If a wrong password is
typed in, the possible attacker (or normal user!) has to wait for 10
seconds to get a new login prompt, which is quite time consuming when
you test passwords (manually). Pay attention to the fact that this
setting is useless if using program other than getty, such as mingetty
for example.

<example>
FAILLOG_ENAB        yes
</example>

If you enable this variable, failed logins will be logged. It is important to
keep track of them to catch someone who tries a brute force attack.

<example>
LOG_UNKFAIL_ENAB    yes
</example>

<p>If you set the variable "FAILLOG_ENAB" to yes, then you should also
set this variable to yes. This will record unknown usernames if the
login failed. If you do this, make sure the logs have to the proper
permissions (640 for example, with an appropriate group setting such
as adm), because users often accidentally enter their password as the
username and you do not want others to see it.

<example>
SYSLOG_SU_ENAB      yes
</example>

<p>This one enables logging of <prgn>su</prgn> attempts to syslog. Quite
important on serious machines but note that this can create privacy
issues as well.

<example>
SYSLOG_SG_ENAB      yes
</example>

<p>The same as SYSLOG_SU_ENAB but applies to the <prgn>sg</prgn> program.

<example>
MD5_CRYPT_ENAB      yes
</example>

<p>As stated above, MD5 sum passwords greatly reduce the problem of
dictionary attacks, since you can use longer passwords.
If you are using slink, read the docs about MD5 before enabling this
option.  Otherwise this is set in PAM.

<example>
PASS_MAX_LEN        50
</example>

<p>If MD5 passwords are activated in your PAM configuration, then this
variable should be set to the same value as used there.


<sect1>Restricting ftp: editing /etc/ftpusers
<p>
The <file>/etc/ftpusers</file> file contains a list of users who are
not allowed to log into the host using ftp. Only use this file if you
really want to allow ftp (which is not recommended in general, because
it uses cleartext passwords). If your daemon supports PAM, you can
also use that to allow and deny users for certain services.

<p>FIXME (BUG): Is it a bug that the default ftpusers in Debian does
<em>not</em> include all the administrative users (in
<package>base-passwd</package>).

<sect1>Using su

<p>
If you really need users to become the super user on your system,
e.g. for installing packages or adding users, you can use the command
<prgn>su</prgn> to change your identity. You should try to avoid any
login as user root and instead use <prgn>su</prgn>.  Actually, the
best solution is to remove su and switch to <prgn>sudo</prgn>, as it
has more features than <prgn>su</prgn>. However, <prgn>su</prgn> is
more common as is used on many other Unices.


<sect1>Using sudo

<p>
<prgn>sudo</prgn> allows the user to execute defined commands under
another user's identity, even as root. If the user is added to
<file>/etc/sudoers</file> and authenticates himself correctly, he is
able to run commands which have been defined in
<file>/etc/sudoers</file>. Violations, such as incorrect passwords or
trying to run a program you don't have permission for, are logged and
mailed to root.

<sect1>Disallow remote adminitrative access
<p>You should modify <file>/etc/security/access.conf</file> also so
that remote administrative login is disallowed. This way the users
need to use <prgn>su</prgn> (or <prgn>sudo</prgn>) so that there is
always an audit trace whenever a local user wants to use
administrative powers. 

<p>You need to add the following line to
<file>/etc/security/access.conf</file>, the default Debian
configuration file has a sample line commented out:
<example>
   -:wheel:ALL EXCEPT LOCAL
</example>


<sect1 id="user-restrict">Restricting users's access

<p>Sometimes you might think you need to have users created in your
local system in order to provide a given service (pop3 mail service or
ftp). Before doing so, first remember that the PAM implementation in
Debian GNU/Linux allows you to validate users with a wide variety of
external directory services (radius, ldap, etc.) provided by the
libpam packages.

<p>If users need to be created and the system can be accessed remotely
take into account that users will be able to login to the system. You
can fix this by giving users a null (<file>/dev/null</file>) shell (it
would need to be listed in <file>/etc/shells</file>). If you want to
allow users to access the system but limit their movements, you can
use the <file>/bin/rbash</file>, equivalent to adding the <tt>-r</tt>
option in bash (<em>RESTRICTED SHELL</em> see <manref name="bash"
section="1">). Please note that even with restricted shell, a user
that access an interactive program (that might allow execution of a
subshell) could be able to bypass the limits of the shell.

<p>Debian currently provides in the unstable release (and might be
included in the next stable releases) the <file>pam_chroot</file>
module (in the <package>libpam-chroot</package>). An alternative to it
is to chroot the service that provides remote logging (ssh, telnet).
<footnote><package>Libpam-chroot</package> has not been yet thoroughly
tested, it does work for <prgn>login</prgn> but it might not be easy
to setup the environment for other programs</footnote>

<p>If you wish to restrict <em>when</em> users can access the system you will
have to customize <file>/etc/security/access.conf</file> for your
needs.

<p>Information on how to chroot ssh for users is described in <ref
id="chroot-ssh-env">.

<sect1>Hand-made user auditing

<p>If you are paranoid you might want to add users a defined
<file>.profile</file> that sets the environment in a way such that
they cannot remove audit capabilities from the shell (commands are
dumped to <tt>$HISTFILE</tt>. The <file>.profile</file> could be set
as follows:

<example>
HISTFILE=/home/_user_/.bash_history
HISTSIZE=100000000000000000
HISTFILESIZE=10000000000000000
set -o HISTFILE
set -o HISTSIZE
set -o HISTFILESIZE
export HISTFILE HISTSIZE HISTFILESIZE
</example>

<p>Note: the -o attribute sets a variable read-only in bash.

<p>For this to work the user cannot modify the <file>.profile</file>
or <file>.bash_history</file> but must be able to read the first one
and write in the second one. You can do this easily by changing these
files and the directory where they reside to be owned by another user
(root), and give write permissions to the user's group to the history
file. Another option is through the use of the <prgn>chattr</prgn>
program.
     
<p>If you are completely paranoid and want to audit every user's
command, you could take bash source code, edit it and have it send all
that the user typed into another file. Or have
<package>ttysnoop</package> constantly monitor any new ttys and dump
the output into a file.  Other useful program is
<url name="Snoopy" id="http://sourceforge.net/project/?group_id=2091">
which is a user-transparent program that hooks in as a library
providing a wrapper around execve() calls, any command execute is
logged to syslogd using the <tt>authpriv</tt> facility (usually
stored at <file>/var/log/auth.log</file>.
<!-- FIXME: Debian package for snoopy??? --> 

<p>Note that you cannot use the <prgn>script</prgn>
command for this since it will not work as a shell (even if you add it
to <file>/etc/shells</file>.

<sect1>Complete user audit

<p>The previous example is a simple way to configure user auditing
which might be not useful for complex systems. If this is your case,
you need to look at <package>acct</package>, the accounting
utilities. These will log all the commands run by users or processes
in the system, at the expense of disk space.

<p>When activating accounting, all the information on processes and
user is kept under <file>/var/account/</file>, more specifically in
the <file>pacct</file>. The accounting package includes some tools
(<prgn>sa</prgn> and <prgn>ac</prgn>) to analyse this data.

<sect1>Reviewing user profiles

<p>If you want to <em>see</em> what are users usually doing, when are
they connecting you can use the <file>wtmp</file> database that
includes all login information. This file can be processed with
several utilities, amongst them <prgn>sac</prgn> which can output a
profile on each user showing in which timeframe they usually log on to
the system.

<p>In case you have accounting activated, you can also use the tools
provided by it in order to determine when the users access to the
system and what do they execute. 

<sect1>Setting users umasks

<p>Depending on your user policy you might want to change how
information is shared between users, that is, what are the default
permissions of new files created by users. This change is set by
defining a proper <tt>umask</tt> setting for all users. You can change
the UMASK setting in <file>/etc/limits.conf</file>,
<file>/etc/profile</file>, <file>/etc/csh.cshrc</file>,
<file>/etc/csh.login</file>, <file>/etc/zshrc</file> and probably some
others (depeding on the shells you have installed on your system). Of
all of these the last one that gets loaded takes precedence. The order
is: PAM's limits.conf, the default system configuration for the user's
shell, the user's shell (his <file>~/.profile</file>,
<file>~/.bash_profile</file>...)

<p>Debian's default <tt>umask</tt> setting is <em>022</em> this means
that files (and directories) can be read and accessed by the user's
group and by any other users in the system. If this is too permissive
for your system you will have to change the umask setting for all the
shells (and for PAM). Don't forget to modify the files under
<file>/etc/skel/</file> since these will be a user's defaults when it
gets created with the <prgn>adduser</prgn> command.

<p>Note, however that users can modify their own umask setting if they
want too, making it more permissive or more restricted.

<sect1>Limiting what users can see/access

<P>FIXME: Content needed. Tell of consequences of changing packages
permissions when upgrading (and admin this paranoid should chroot his
users BTW).

<p>If you need to grant users acces to the system with a shell think
it very carefully. A user can, by default, and unless a severely
restricted environment (like a <tt>chroot</tt> jail) can retrieve
quite a lot of information from your system including:

<list>

<item>some configuration files in <file>/etc</file>. However, Debian's default
permissions for some sensitive files (which might, for example,
contain passwords), will prevent access to critical information. To
see which files are only accesible by the root user
for example <tt>find /etc -type f -a -perm 600 -a -uid 0</tt> as
superuser.

<item>your installed packages, either by looking at the package
database, at the <file>/usr/share/doc</file> directory or by guessing
by looking at the binaries and libraries installed in your system.

<item>some logfiles at <file>/var/log</file>. Note also that some
logfiles are only accesible to root and the <tt>adm</tt> group (try
<tt>find /var/log -type f -a -perm 640</tt>) and some even are only
available to the root user (try <tt>find /var/log -type f -a -perm
600 -a -uid 0</tt>).

</list>


<p>What can a user see in your system? Probably quite a lot of things,
try this (take a deep breath):
<example>
find / -type f -a -perm +006 2>/dev/null  
find / -type d -a -perm +007 2>/dev/null  
</example>

<p>The output is the list of files that a user can <em>see</em> and
the directories he has access to.

<sect2 id="limit-user-perm">Limiting access to other user's information

<p>If you still grant shell access to users you might want to limit
what information they can view from other users. Users with shell
access have a tendency to create quite a number of files under their
$HOMEs: mailboxes, personal documents, configuration of X/GNOME/KDE
applications... 

<p>In Debian each user is created with one group associated with it,
no two users belong to their main group. This is the default behavior:
when the userX is created a group with name userX is created and the
user is assigned to it. This avoids the concept of a <em>users</em>
group which might make it more difficult for users to hide information
to other users while sharing other.

<p>However, user's $HOME directories are created with 0755 permissions
(group-readable and world-readable). The group permissions is not an
issue since only the user belongs to the group, however the world
permissions might (or might not) be an issue depending on your local
policy.

<p>You can change this behaviour so that user creation provides
different $HOME permissions. To change the behaviour <em>new</em>
users when they get created, change <em>DIR_MODE</em> in the
configuration file <file>/etc/adduser.conf</file> to 0750 (no world-readable access).

<p>Users can still share information, but not directly in their $HOME
directories unless they change its permissions.

<p>Notice that this will prevent users from being able to setup
personal pages (~userX) if a web server is present, since the web
server will not be able to read the $HOME directory and thus, the
public_html directory under it.

<sect1 id="user-pwgen">Generating user passwords

<p>There are many cases when an administrator needs to create many
user accounts and provide passwords for all of them. Of course, the
administrator could easily just set the password to be the same as the
user's account name, but that would not be very sensitive
security-wise. A better approach is to use a password generating
program. Debian provides <package>makepasswd</package>,
<package>apg</package> and <package>pwgen</package> packages which
provide programs (the name is the same as the package) that can be
used for this purpose. <prgn>Makepasswd</prgn> will generate true
random passwords with an emphasis on security over pronounceability
whileas <prgn>pwgen</prgn> will try to make meaningless but
pronounceable passwords (of course this might depend on your mother
language). <prgn>Apg</prgn> has algorithms to provide for both (there
is a client/server version for this program but it is not included in
the Debian package).

<p><prgn>Passwd</prgn> does not allow non-interactive assignation of
passwords (since it uses direct tty access). If you want to change
passwords when creating a large number of users you can create them
using <prgn>adduser</prgn> with the <tt>--disabled-login</tt> option
and then use <prgn>chpasswd</prgn>
<footnote>
<prgn>Chpasswd</prgn> cannot handle MD5 password generation so it need
to be given in encrypted form before using it, with the <tt>-e</tt>
option.
</footnote>
(in the <package>passwd</package> package so you already have it
installed). If you want to use a file with all the information to make
users as a barch process you might be better off using
<prgn>newusers</prgn>.

<sect1>Checking user passwords

<p>User passwords can sometimes become the <em>weakest link</em> in
the security of a given system. This is due to some users choosing
weak passwords for their accounts (and the more of them that have
access to it the greater the chances of this happening). Even if you
established checks with the cracklib PAM module and password limits as
described in <ref id="auth-pam"> users will still be able to use weak
passwords. Since user access might include remote shell access (over
ssh, hopefully) it's important that a remote attacker is not able to
guess user passwords (after he has been able to do user enumeration by
other means).

<p>A system administrator must, given a big number of users, check if
the passwords they have are consistent with the local security
policy. How to check? Try to crack them as an attacker would if he had
access to the hashed passwords (the <file>/etc/shadow</file> file). 

<p>An administrator can use <package>john</package> together with
appropiate wordlist 
<footnote>Try <prgn>apt-cache search wordlist</prgn> for a list of
available packages which might provide wordlists. You can also
retrieve wordlists for many ftp sites over the Internet. FIXME: add
links</footnote>
to check user's passwords and take appropiate action when a weak
password is detected.

<sect1 id="idle-logoff">Loggin off idle users

<p>Idle users are usually a security problem, an user might be idle
maybe because he's out to lunch or because a remote connection was
broken and not re-established. For whatever the reason, idle users
might lead to a compromise:

<list>
<item>because the user's console might not be locked and can be
accessed by an intruder.  

<item>because an attacker might be able to re-attach himself to a
closed network connection and send commands to the remote shell (this
is fairly easy if the remote shell is not encrypted as in the case of
<prgn>telnet</prgn>).
</list>

<p>There have even been the case of some remote systems being compromised
through idle (detached) <prgn>screen</prgn>'s.

<p>Automatic disconnection of idle users is usually a part of the local security policy that must be enforced. There are several ways to do this:

<list>
<item>If the user's shells are <prgn>bash</prgn> a system administrator 
can set a default <tt>TMOUT</tt> value (see <manref section="1" name="bash">) 
which will make the shell automatically remote idle users. Note that it 
must be set with the <tt>-o</tt> option or users will be able to 
change (or unset) it.

<item>Install <package>timeoutd</package> and configure
<file>/etc/timeouts</file> according to your local security
policy. The daemon will watch for idle users and timeout their shells
accordingly.

<item>Install <package>autolog</package> and configure it to remove idle users.

</list>

<p>The <prgn>timeoutd</prgn> or <prgn>autolog</prgn> daemons are the
prefered method since, after all, user's can change their default shell
or can, after running their default shell, swith to another
(uncontrolled) shell.


<sect>Using tcpwrappers 

<p>TCP wrappers were developed when there were no real packet filters
available and access control was needed. The TCP wrappers allow you to
allow or deny a service for a host or a domain and define a default
allow or deny rule.  If you want more informations take a look at
<manref name="hosts_access" section="5">.

<p>Many services installed in Debian are either:

<list>
<item>launched through the tcpwrapper service (<file>tcpd</file>)
<item>compiled with libwrapper support built-in.
</list>

<p>On the first hand, of services are configured in
<file>/etc/inetd.conf</file>, this includes telnet, ftp, netbios, swat
and finger (you will see that the configuration file executes first
<prgn>/usr/sbin/tcpd</prgn>. On the other hand, even if a
service is not launched by the <prgn>inetd</prgn> superdaemon
can, in any case, subjected to the tcp wrappers rules by compiling its
support in it. Services compiled with tcp wrappers in Debian include
ssh, portmap, in.talk, rpc.statd, rpc.mountd, gdm, oaf (the GNOME
activator daemon), nessus and many others. 

<p>To see which packages use tcpwrappers try:

<example>
$ apt-cache showpkg libwrap0 | egrep '^[[:space:]]' | sort -u | \
        sed 's/,libwrap0$//;s/^[[:space:]]\+//'
</example>


<p>Take this into account when running <prgn>tcpchk</prgn>.
You can add services that are linked to the wrapper library into
the <file>host.deny</file> and <file>hosts.allow</file> files but
<prgn>tcpchk</prgn> will warn that he is not able to find
those services since it looks for them in <file>/etc/inetd.conf</file>
(the manpage is not totally accurate here).

<p>Now, here comes a small trick, and probably the smallest intrusion
detection system available. In general, you should have a decent
firewall policy as a first line, and tcp wrappers as the second line
of defense.  One little trick is to set up a SPAWN <footnote>beware of
the case here since <em>spawn</em> will not work</footnote> command in
/etc/hosts.deny that sends mail to root whenever a denied service
triggers wrappers:

<example>
ALL: ALL: SPAWN ( \
  echo -e "\n\
  TCP Wrappers\: Connection refused\n\
  By\: $(uname -n)\n\
  Process\: %d (pid %p)\n\
  User\: %u\n\
  Host\: %c\n\
  Date\: $(date)\n\
" | /usr/bin/mail -s "Connection to %d blocked" root) &
</example>

<p><em>Beware</em>: The above printed example can easily be DoSed by
doing lots of connections in a short period of time. Many emails mean
a lot of file I/O by sending only a few packets.

<!--
# Could this example be more interesting? 
# It also relates to the next section (jfs)
#
# era: cf hosts_access(5) manual page,
# and why are you not using logger(1) here? (FIXME?)
#
#&lt;example&gt;
#ALL: ALL: SPAWN ( \
#  /usr/local/sbin/send_syslog %u %c %d )
#&lt;example&gt;

#  With send_syslog as:
##!/usr/bin/perl -w
#
#use Sys::Syslog qw(:DEFAULT setlogsock);
#
#$user=shift(@ARGV) || 'unkown';
#$host=shift(@ARGV) || 'unkown';
#$service=shift(@ARGV) || 'unkown';
#setlogsock('unix');
#openlog("alert",'', 'user');
#syslog('warning', 'Connection from %s at %s to %s blocked.', ($user, $host, $service) );
#closelog();
#
#exit 0;
-->

<sect id="log-alerts">The importance of logs and alerts

<p>How log and alerts are treated is an important issue in a secure
system.  It is easily to see that, even if the system is perfectly
configured and, supposedly, 99% secure. If the 1% comes to happen, and
there are no security measures in place to, first, detect this and,
second, raise alarms, the system is not secure at all.

<p>Debian GNU/Linux provides some tools to make loganalysis, most
notably <package>logcheck</package> or <package>loganalysis</package>
(both will need some customisation to remove unnecessary things from
the report). It might be also useful, if the system is nearby, to have
the system logs printed on a virtual console. This is useful since you
can (from a distance) see if the system is behaving properly. Debian's
<file>/etc/syslog.conf</file> comes with a commented default
configuration, to enable it uncomment the lines and restart syslog
(<tt>/etc/init.d/syslogd restart</tt>):

<example>
daemon,mail.*;\
        news.=crit;news.=err;news.=notice;\
        *.=debug;*.=info;\
        *.=notice;*.=warn       /dev/tty8
</example>


<!-- FIXME: Talk about logcolorise? Is it in Debian? -->

<p>There is a lot regarding log analysis that cannot be fully covered
here, a good resource for information is <url name="Counterpane's Log
Analysis Resources"
id="http://www.counterpane.com/log-analysis.html">.
In any case, even automated tools are no match for the best
analysis tool: your brain. 

<!-- FIXME: Check information on SHARP, the 'syslog heuristic analysis
and response program'.  The paper is at
http://www.csis.gvsu.edu/sharp/. Is it free-software? packaged? -->

<sect1 id="custom-logcheck">Using and customising logcheck.

<p>The <prgn>logcheck</prgn> package in Debian is divided into two
packages <package>logcheck</package> (the main program) an
<package>logcheck-database</package> (a database of regular
expressions for the program). The Debian default (at
<file>/etc/cron.d/logcheck</file>) is that <prgn>logcheck</prgn> is run
daily at 2 am and once after each reboot.

<p>This tool can be quite useful if properly customised to alert the
administrator on unusual events in the system. <prgn>Logcheck</prgn>
can be fully customised so that it can send mails from events
recovered from the logs that are worthy of attention. The default
installation includes profiles for ignored events and policy
violations for three different setups (workstation, server and
paranoid). The Debian package includes a configuration file
<file>/etc/logcheck/logcheck.conf</file>, sourced by the program, that
defines which user are the checks send to. It also provides a way for
packages that provide services to implement new policies in the
directories: <file>/etc/logcheck/hacking.d/_packagename_</file>,
<file>/etc/logcheck/violations.d/_packagename_</file>,
<file>/etc/logcheck/violations.ignore.d/_packagename_</file>,
<file>/etc/logcheck/ignore.d.paranoid/_packagename_</file>,
<file>/etc/logcheck/ignore.d.server/_packagename_</file>, and
<file>/etc/logcheck/ignore.d.workstation/_packagename_</file>. However,
not many packages currently do so. If you have a policy that can be
useful for other users, please send it as a bug report for the
appropiate package (as a <em>wishlist</em> bug). See For more information read
<file>/usr/share/doc/logcheck/README.Debian</file>

<p>The best way to configure <prgn>logcheck</prgn> is to install it
(it will ask for the user to mail reports to and generate
<file>/etc/logcheck/logcheck.logfiles</file> from syslog entries). If
you wish to add new logfiles just change
<file>/etc/logcheck/logcheck.logfiles</file> adding them there. The
package dependancy will make the <package>logcheck-database</package>
package get installed too, during installation it will ask which
security level is desired: workstation, server or paranoid. This will
make <file>/etc/logcheck/ignore.d</file> point to the appropiate
directories (through symbolic links). To change this run
<tt>dpkg-reconfigure -plow logcheck-database</tt>.  Then create the
<file>/etc/ignore.d/local</file>, this file will hold all the rules to
exclude messages that should not be reported. Leave it empty for the
moment (a simple <tt>cp /dev/null /etc/ignore.d/local</tt> will
work). 

<p>Once this is done you might want to check the mails that are sent,
for the first few days/weeks/months, if you find are sent messages you
do not wish to recive you just have to add to the
<file>/etc/ignore.d/local</file> the regular expressions (see <manref
name="regex" section="7">) that correspond to these messages. It's an
ongoing tuning process, once the messages that are sent are always
relevant you can consider the tuning finished. Note that if logcheck
does not find anything relevant in your system it will not mail you
even if it does run (so you might get only a mail once a week, if you
are lucky).


<sect1>Configuring where alerts are sent

<p>Debian comes with a standard syslog configuration (in
/etc/syslog.conf) that logs messages to the appropriate files depending
on the system facility.  You should be familiar with this; have a look
at the <file>syslog.conf</file> file and the documentation if not.  If
you intend to maintain a secure system you should be aware of where log
messages are sent so they do not go unnoticed.  

<p>For example, sending messages to the console also is an interesting
setup useful for many production-level systems. But for many such
systems it is important to also add a new machine that will serve as
loghost (i.e. it receives logs from all other systems).

<p>Root's mail should be considered also, many security controls (like
<package>snort</package>) send alerts to root's mailbox. This 
mailbox usually points to
the first user created in the system (check <file>/etc/aliases</file>).
Take care to send root's mail to some place where it will be read (either
locally or remotely).

<p>There are other role accounts and aliases on your system.  On a
small system, it's probably simplest to make sure that all such
aliases point to the root account, and that mail to root is forwarded
to the system administrator's personal mailbox.

<p>FIXME: it would be interesting to tell how a Debian system can
send/receive SNMP traps related to security problems (jfs). Check:
<package>snmptraglogd</package>, <package>snmp</package> and
<package>snmpd</package>.


<sect1>Using a loghost

<p>A loghost is a host which collects syslog data remotely over the
network. If one of your machines is cracked, the intruder is not able
to cover his tracks, unless he hacks the loghost as well.  So, the
loghost should be especially secure.  Making a machine a loghost is
simple. Just start the syslogd with 'syslogd -r' and a new loghost is
born. In order to do this permanently in Debian, edit
<file>/etc/init.d/sysklogd</file> and change the line

<example>
SYSLOGD=""
</example>
to 
<example>
SYSLOGD="-r"
</example>

Next, configure the other machines to send data to the loghost.  Add
an entry like the following to <file>/etc/syslog.conf</file>:

<example>
facility.level            @your_loghost
</example>

See the documentation for what to use in place of <em>facility</em>
and <em>level</em> (they should not be entered verbatim like this).
If you want to log everything remotely, just write:

<example>
*.*                       @your_loghost
</example>

into your syslog.conf. Logging remotely as well as locally is the best
solution (the attacker might presume to have covered his tracks after
deleting the local log files). See the <manref name="syslog"
section="3">, <manref name="syslogd" section="8"> and <manref
name="syslog.conf" section="5"> manpages for additional information.


<sect1>Logfile permissions

<p>It is not only important to decide how alerts are used, but also
who has access to them, i.e. can read or modify the logfiles (if not
using a remote loghost).  Security alerts which the attacker can
change or disable are not much worth in the event of an intrusion.
Also, you have to take into account that logfiles might reveal an
intruder quite a lot of information about your system and it's normal
(or abnormal) operations if he has access to them.

<!--  It should be explained why after installation this is not
 already done, jfs -->

<p>
Some logfile permissions are not perfect after the installation (but
of course this really depends on your local security policy). First
<file>/var/log/lastlog</file> and <file>/var/log/faillog</file> do not
need to be readable by normal users. In the lastlog file you can see
who logged recently, and in the faillog you see a summary of failed
logins. The author recommends chmod'ing both to 660. Take a brief look
over your log files and decide very carefully which logfiles you make
readable/writeable for a user with an UID other than 0 and a group
other than 'adm' or 'root'. You can easily check this in your system
with:

<example>
#  find /var/log -type f -exec ls -l {} \; | cut -c 17-35 |sort -u
(see to what users do files in /var/log belong to)
#  find /var/log -type f -exec ls -l {} \; | cut -c 26-34 |sort -u
(see to what groups do files in /var/log belong to)
# find /var/log -perm +004
(files which are readable by any user)
#  find /var/log \! -group root \! -group adm -exec ls -ld {} \;
(files which belong to groups not root or adm)
</example>

<p>To customize how logfiles are created you will probably have to
customize the program that generates them. If the logfile gets
rotated, however, you can customize the behavior of creation and rotation

<!-- This is no longer true, check apache's logrotate
<p>
I want to emphasize that the apache logfile permissions are really
screwed due to the fact that the apache user owns the apache log
files. If a user gets a shell with a back door in apache, they can
easily remove the logfiles.
-->

<!--
# This is quite personal, IMHO, since this is due to the fact that 
# root priviledges are dropped on startup. I prefer an attacker to erase
# a service's logfiles than to erase all of my system's logs. Anyhow, this
# can be improved by changing user permissions after rotation
-->


<sect id="chroot">Using chroot

<p><prgn>chroot</prgn> is one of the most powerful possibilities to
restrict a daemon or a user or another service. Just imagine a jail
around your target, which the target cannot escape from (normally, but
there are still a lot of conditions that allow one to escape out of
such a jail). If you do not trust a user, you can create a change root
environment for him. This can use quite a bit of disk space as you
need to copy all needed executables, as well as libraries, into the
jail. Even if the user does something malicious, the scope of the
damage is limited to the jail.  

<p>A good example for this case is, if you do not authenticate against
<file>/etc/passwd</file> but use LDAP or MySQL instead. So your
ftp-daemon only needs a binary and perhaps a few libraries. A chrooted
environment would be an excellent security improvement; if a new
exploit is known for this ftp-daemon, then attackers can only exploit
the UID of the ftp-daemon-user and nothing else. 

<p>Of course, many other daemons could benefit from this sort of
arrangement as well.

<p>However, be forewarned that a <prgn>chroot</prgn> jail can be
broken if the user running in it is the superuser. So, you need to
make the service run as a non-privileged user. By limiting its
environment you are limiting the world readable/executable files the
service can access, thus, you limit the possibilities of a privilege
escalation by use of local system security vulnerabilities.  Even in
this situation you cannot be completely sure that there is no way for
a clever attacker to somehow break out of the jail.  Using only server
programs which have a reputation for being secure is a good additional
safety measure.  Even minuscule holes like open file handles can be
used by a skilled attacker for breaking into the system. After all,
<prgn>chroot</prgn> was not designed as a security tool but as a
testing tool.

<!-- FIXME: this information should be checked when woody gets released -->

<p>As an additional note, the Debian default BIND (the Internet name
service) is not shipped chrooted per default; in fact, no daemons come
chrooted. 
<!-- FIXME: Is this true? This might change in the woody (3.0) release. -->
<!-- jfs: this is still true for woody -->

<p>There is also some software (not currently in Debian but which
 might be packaged in the future) that can help setup chroot
 environments. See

<sect>Kernel configuration
<sect id="kernel-patch">Adding kernel patches
<p>FIXME: More content

<p>Debian GNU/Linux provides some of the patches for the Linux kernel
that enhace its security. These include:

<list>

<item>Linux Intrusion Detection (in package <package>lids-2.2.19</package>)

<item>Linux Capabilities (in package <package>lcap</package>)

<item>Linux Trustees (in package <package>trustees</package>)

<item>NSA Enhanced Linux (in package <package>selinux</package> also 
available from <url id="http://www.coker.com.au/selinux/" name="the developer's website">)

<item><url name="kernel-patch-2.2.18-openwall"
id="http://packages.debian.org/kernel-patch-2.2.18-openwall">.

<item><package>kernel-patch-2.2.19-harden</package>

<item>Linux capabilities (in package <package>lcap</package>

<item>IPSEC kernel support (in package <package>kernel-patch-freeswan</package>)

<item><package>kernel-patch-int</package>

</list>

<p>However, some patches have not been provided in Debian yet. If you
feel that some of these should be included please ask for it at the
<url name="Work Needing and Prospective Packages"
id="http://wnpp.debian.org">.  Some of these are:


<list>

<item><url id="http://pageexec.virtualave.net/" name="
PaX patch">

<item>
<url name="HAP patch"
id="http://www.theaimsgroup.com/~hlein/hap-linux/">

<item>
<url name="Stealth patch"
id="http://www.energymech.net/madcamel/fm/">

</list>


<sect>Protecting against buffer overflows

<p><em>Buffer overflow</em> is the name of a common attack to software
which makes use of insufficient boundary checking (a common
programming error) in order to execute machine code through a
program's inputs. These attacks, against server software which listens
to connections remotely and against local software which grant higher
priviledges to users (setuid or setgid) can result in the compromise
of any given system.

<p>There are mainly four methods to protect against buffer overflows:

<list>

<item>patch the kernel to prevent stack execution.

<!-- FIXME: add a link to libsafe to the main place -->

<item>using a library, such as libsafe, to overwrite vulnerable
functions and introduce proper checking (for information 
on how to install libsafe read 
<url id="http://www.Linux-Sec.net/harden/libsafe.uhow2.txt" name="this">).

<item>recompile code to introduce proper checks that prevent
overflows, using, for example, stackguard.

<item>use tools to find and fix code that might introduce this
vulnerability.

</list>

<p>Debian GNU/Linux, as of the 3.0 release, only provides software to
implement the first and last of these methods (kernel patches and
tools to detect possible buffer overflows). The use of tools to detect
buffer overflows requires, in any case, of programming experience in
order to fix (and recompile) the code. Debian provides, for example:
<package>bfbtester</package> (a buffer overflow tester that
brute-forces binaries through command line and environment overflows)
and <package>njamd</package>.

<p>As for kernel patches (described in the section <ref
id="kernel-patch">), the openwall patch provides protection against
buffer overflows in 2.2 linux kernels. However, for 2.4 kernels, you
need to use the Grsecurity patch (in the <package>
kernel-patch-2.4-grsecurity</package> which includes the Openwall
patch and many more <url id="http://www.grsecurity.net/features.htm"
name="features"> (including ACLs and network randomness to make it
more difficult to remote OS fingerprinting), or the Linux Security
Modules (in the <package>kernel-patch-2.4-lsm</package> and
<package>kernel-patch-2.5-lsm</package> packages).

<p>In any case, be aware, that even these workarounds might not
prevent buffer overflows since there are ways to circumvent these, as
described in phrack's magazine <url name="issue 58"
id="http://packetstorm.linuxsecurity.com/mag/phrack/phrack58.tar.gz">.


<sect>Secure file transfers 

<p>During normal system administration one usually needs to transfer
files in and out from the installed system. Copying files in a secure
manner from a host to another can be achieved by using the
<package>sshd</package> server package. Another possibility is the use
of <package>ftpd-ssl</package>, a ftp server which uses the <em>Secure
Socket Layer</em> to encrypt the transmissions.

<p>Any of these methods needs, of course, special clients. Debian
provides clients, for example the <package>ssh</package> provides
<prgn>scp</prgn>.  It works like <prgn>rcp</prgn> but is encrypted
completely, so the <em>bad guys</em> cannot even find out WHAT you
copy. There is also a <package>ftp-ssl</package> client package for
the equivalent server. You can find clients for these software even
for other operating systems (non-UNIX), <prgn>putty</prgn> and
<prgn>winscp</prgn> provide secure copy implementations for any
version of Microsoft's operating system.

<p>Note that using <prgn>scp</prgn> provides access to the users to
all the filesystem unless chrooted as described in <ref
id="ssh-chroot">. FTP access can be chrooted, probably easier
depending on you chosen daemon, as described in <ref
id="ftp-secure">. If you are worried about users browsing your local
files and want to have encrypted communication you can either use an
ftp daemon with SSL support or combine cleartext ftp and a VPN setup
(see <ref id="vpn">).

<sect>Filesystem limits and control

<sect1>Using quotas

<p>
Having a good quota policy is important, as it keeps users from
filling up the hard disk(s).
<p>
You can use two different quota systems: user quota and group
quota. As you probably figured out, user quota limits the amount of
space a user can take up, group quota does the equivalent for
groups. Keep this in mind when you're working out quota sizes.

<p>There are a few important points to think about in setting up a
quota system:

<list>
<item>Keep the quotas small enough, so users do not eat up your disk
space.

<item>Keep the quotas big enough, so users do not complain or their mail quota
keeps them from accepting mail over a longer period.

<item>Use quotas on all user-writable areas, on <file>/home</file> as well 
as on <file>/tmp</file>.
</list>

<p>Every partition/directory which users have full write access should
be quota enabled.  Find out those partitions and directories and
calculate a workable quota size, which combines usability and
security.

<p>So, now you want to use quotas. First of all you need to check
whether you enabled quota support in your kernel. If not, you will
need to recompile it. After this, control whether the package 'quota'
is installed. If not you will need this one as well.

<!-- FIXME: how to check for quota support? What to tweak when
recompiling? -->

<p>
Enabling quota for the respective filesystems is as easy as modifying
the <tt>defaults</tt> setting to <tt>defaults,usrquota</tt> in your
<file>/etc/fstab</file> file. If you need group quota, substitute
<tt>usrquota</tt> to <tt>grpquota</tt>.  You can also use them both.
Then create empty quota.user and quota.group files in the roots of the
filesystems you want to use quotas on (e.g.  <tt>touch
/home/quota.user /home/quota.group</tt> for a <file>/home</file> filesystem).

<p>
Restart quota by doing <tt>/etc/init.d/quota stop;/etc/init.d/quota
start</tt>. Now quota should be running, and quota sizes can be set.

<p>
Editing quotas for a specific user (say 'ref') can be done by
<tt>edquota -u ref</tt>. Group quotas can be modified with <tt>edquota -g
&lt;group&gt;</tt>. Then set the soft and hard quota and/or inode quotas 
as needed.

<p>
For more information about quotas, read the quota man page, and the quota
mini-howto(<file>/usr/share/doc/HOWTO/en-html/mini/Quota.html</file>).

<p>You might or might not like <package>lshell</package>, since it
violates the FHS. Also take into account that pam_limits.so might
provide the same functionality and <package>lshell</package>
is currently <url id="http://bugs.debian.org/93894" name="orphaned">
<!-- Duplicated section "Logfile permissions" removed (era) -->
<!-- Duplicated section "Setting up setuid check" removed (era) -->

<sect1>chattr/lsattr

<p>
These two commands are very useful, but they only work for the ext2
filesystem.  With 'lsattr' you can list the attributes of a file and
with 'chattr' you can change them. Note that attributes are not the
same thing as permissions.  There are many attributes, but only the
most important for increasing security are mentioned here. There are
two flags which can only be set by the superuser.

<p>
First there is the 'a' flag. If set on a file, this file can only be
opened for appending. This attribute is useful for some of the files
in <file>/var/log/</file>, though you should consider they get moved 
sometimes due to the log rotation scripts.

<p>
The second flag is the 'i' flag, short for immutable. If set on a
file, it can neither be modified nor deleted or renamed and no link be
created to it.  If you do not want users to look into your config
files you could set this flag and remove readability. Furthermore it
can give you a little bit more security against intruders, because the
cracker might be confused by not being able to remove a
file. Nevertheless, you should never assume that the cracker is
blind. After all, he got into your system.

<p>You can, also, remove the <prgn>chattr</prgn> and <prgn>lsattr</prgn>
programs from the system so that an intruder with root access cannot
change (or list) this attributes. Since they are part of the
<package>e2fsprogs</package> and it's <em>Required</em> priority you
cannot simply remove it. However, you can safely delete these two
applications (and probably some others) from the filesystem. Copy them
before to a removable media (floppy disk?) along with they md5sums.

<p>An intruder in the system would have to download his own copies of
the binaries in the system (probably even compile them in it) which
might give you a littler more time to detect and recover from the
compromise before the whole system is overrun.

<p>FIXME: This is a bug that could be reported, are any of the binaries
provided by the program useful in production systems? If not, and
since the libraries are needed by many packages a new package
<package>e2fsprogs-utils</package> could be included with less than
<em>Required</em> priority.

<p>Remember: lsattr and chattr are only available on ext2 filesystems.

<sect1 id="check-integ">Checking filesystem integrity

<p>Are you sure <file>/bin/login</file> on your hard drive is still the binary you
installed there some months ago? What if it is a hacked version, which
stores the entered password in a hidden file or mails it in cleartext
version all over the internet?

<p>
The only method to have some kind of protection is to check your files
every hour/day/month (I prefer daily) by comparing the actual and the
old md5sum of this file. Two files cannot have the same md5sum (the
MD5 digest is 128 bits, so the chance that two different files will
have the same md5sum is roughly one in 3.4e3803), so you're on the
safe site here, unless someone has also hacked the algorithm that
creates md5sums on that machine. This is, well, extremely difficult
and very unlikely. You really should consider this auditing of your
binaries as very important, since it is an easy way to recognize
changes at your binaries. Common tools used for this are <package>sXid</package>,
<package>AIDE</package> (Advanced Intrusion Detection Environment),
<package>TripWire</package> (non-free; the new version will be GPL),
<package>integrit</package> and <package>samhain</package>.

<p>Installing <prgn>debsums</prgn> will help to check the filesystem
integrity, by comparing the md5sums of every file against the md5sums
used in the Debian package archive. But beware, those files can easily
be changed.

<p>Furthermore you can replace <package>locate</package> with
<package>slocate</package>. slocate is a security enhanced version of
GNU locate. When using slocate, the user only sees the files he really
has access to and you can exclude any files or directories on the
system.

<p>FIXME: put references to the snapshot taken after installation.
<p>FIXME: Add a note regarding packages not providing debsums for all
apps installed (not mandatory).

<sect1>Setting up setuid check

<p>
Debian provides a cron job that runs daily in
<file>/etc/cron.daily/standard</file>. This cron job will run the
<prgn>/usr/sbin/checksecurity</prgn> script that will store
information of this changes.

<!-- FIXME: What is the defaul for this in cron package? jfs -->

<p>In order for this check to be made you must set
<tt>CHECKSECURITY_DISABLE="FALSE"</tt> in
<file>/etc/checksecurity.conf</file>. Note, this is the default, so
unless you have changed something, this option will already be set to
"FALSE".

<p>The default behavior does not send this information to the superuser
but, instead keeps daily copies of the changes in
<file>/var/log/setuid.changes</file>. You should set the
CHECKSECURITY_EMAIL (in <file>/etc/checksecurity.conf</file>) to 'root' to
have this information mailed to him.  .  See <manref
name="checksecurity" section="8"> for more configuration info.

<sect id="network-secure">Securing network access

<p>FIXME. More (Debian-specific) content needed


<sect1 id="kernel-conf">Configuring kernel network features

<p>FIXME: Content missing

<p>Many features of the kernel can be modified while running by
echoing something into the <file>/proc</file> file system or by using
<prgn>sysctl</prgn>. By entering <tt>/sbin/sysctl -A</tt> you can see
what you can configure and what the options are, and it can be
modified running <tt>/sbin/sysctl -w variable=value</tt> (see <manref
section="8" name="sysctl">). Only in rare cases do you need to edit
something here, but you can increase security that way as well. For
example:

<!-- FIXME: Should the prefix on all of these be /proc/sys/? era -->

<example>
net/ipv4/icmp_echo_ignore_broadcasts = 1
</example>

<p>This is a <em>Windows emulator</em> because it acts like Windows on
broadcast ping if this option is set to 1. That is, ICMP_ECHO request
sent to the broadcast address will be ignored. Otherwise, it does
nothing.

<p>If you want to block any ICMP echo requests on your system, enable this
configuration option:

<example>
net/ipv4/icmp_echo_ignore_all = 0
</example>

<p>To log packets with impossible addresses (due to wrong routes) on your
network use:

<example>
/proc/sys/net/ipv4/conf/all/log_martians = 1
</example>

<p>For more information on what things can be done with
<file>/proc/sys/net/ipv4/*</file> read
<file>/usr/src/linux/Documentation/filesystems/proc.txt</file>. All
the options are describe thoroughly under
<file>/usr/src/linux/Documentation/networking/ip-sysctl.txt</file>
<footnote>In Debian the <package>kernel-image</package> package
installs the sources under <file>/usr/src/kernel-souce-2.X.X</file>,
just substitute <em>linux</em> to whatever kernel is
installed</footnote>.

<sect2 id="tcp-syncookies">Configuring Syncookies


<p>This option is a double-edged sword. On the one hand it protects
your system against syn flooding; on the other hand it violates
defined standards (RFCs).

<!-- What does this mean? (jfs)
This option is quite dumb as it floods the
other side like it floods you, so the other side is also busy. 
-->

<example>
net/ipv4/tcp_syncookies = 1
</example>

<p>If you want to change this option you each time the kernel is
working you need to change it in <tt>/etc/network/options</tt> by
setting <tt>syncookies=yes</tt>. This will take effect whener
<tt>/etc/init.d/networking</tt> is run (which is done at boot time)
whileas this will only work with the current running kernel:

<example>
echo 1 > /proc/sys/net/ipv4/tcp_syncookies 
</example>

<p>This option will only be available if the kernel is compiled with
the <tt>CONFIG_SYNCOOKIES</tt>. All Debian kernels are compiled with
this option builtin but you can verify it running:

<example>
$ sysctl -A |grep syncookies
net/ipv4/tcp_syncookies = 1
</example>

<p>For more information  on TCP syncookies read
<url id="http://cr.yp.to/syncookies.html">.

<sect1 id="net-harden">Securing the network on boot-time

<p>When setting configuration options for the kernel networking you need configure it so that it's loaded every time the system is restarted. The following example enables many of the previous options as well as other useful options. 

<p>Create the script in <file>/etc/network/interface-secure</file>
(the name is given as an example) and call it from
<file>/etc/network/interfaces</file> like this:

<example>
auto eth0
iface eth0 inet static
        address xxx.xxx.xxx.xxx
        netmask 255.255.255.xxx
        broadcast xxx.xxx.xxx.xxx
        gateway xxx.xxx.xxx.xxx
        pre-up /etc/network/interface-secure

</example>

<example>
# Script-name: /etc/network/interface-secure
# Modifies some default behaviour in order to secure against 
# some TCP/IP spoofing & attacks
#
# Contributed by Dariusz Puchalak  
#
echo 1 > /proc/sys/net/ipv4/icmp_echo_ignore_broadcasts 
                                           # broadcast echo protection enabled
echo 0 > /proc/sys/net/ipv4/ip_forward     # ip forwarding disabled
echo 1 > /proc/sys/net/ipv4/tcp_syncookies # TCP syn cookie protection enabled
echo 1 >/proc/sys/net/ipv4/conf/all/log_martians 
                                           # Log packets with impossible addresses
                         # but be careful with this on heavy loaded web servers
echo 1 > /proc/sys/net/ipv4/ip_always_defrag 
                                           #  defragging protection always enabled
echo 1 > /proc/sys/net/ipv4/icmp_ignore_bogus_error_responses 
                                           # bad error message protection enabled

# now ip spoofing protection
for f in /proc/sys/net/ipv4/conf/*/rp_filter; do
        echo 1 > $f
done

# and finally some more things:
# Disable ICMP Redirect Acceptance
for f in /proc/sys/net/ipv4/conf/*/accept_redirects; do
        echo 0 > $f
done

for f in /proc/sys/net/ipv4/conf/*/send_redirects; do
      echo 0 > $f
done

# Disable Source Routed Packets
for f in /proc/sys/net/ipv4/conf/*/accept_source_route; do
        echo 0 > $f
done

# Log Spoofed Packets, Source Routed Packets, Redirect Packets
for f in /proc/sys/net/ipv4/conf/*/log_martians; do
        echo 1 > $f
done
</example>

<p>You can also create a <tt>init.d</tt> script and have it run on
bootup (using <prgn>update-rc.d</prgn> to create the appropiate
<tt>rc.d</tt> links).

<sect1 id="kernel-fw">Configuring firewall features 

<p>In order to have firewall capabilities, either to protect the local
system or others <em>behind</em> it, the kernel needs to be compiled
with firewall capabilities. The standard Debian 2.2 kernel (also 2.2)
provides the packet filter <prgn>ipchains</prgn> firewall, Debian 3.0
standard kernel (kernel 2.4) provides the <em>stateful</em> packet
filter <prgn>iptables</prgn> (netfilter) firewall. Older Debian
distributions would need the appropiate kernel patch (Debian 2.1 uses
kernel 2.0.34).

<p>In any case, it is pretty easy to use a kernel different from the
one provided by Debian. You can find pre-compiled kernels as packages
you can easily install in the Debian system. You can also download the
kernel sources using the <package>kernel-source-X</package> and build
custom kernel packages using <package>make-kpkg</package>.

<p>Setting up firewalls in Debian is discussed more thoroughly in <ref
id="firewall-setup">.


<sect1 id="limit-bindaddr">Disabling week-end hosts issues

<p>Systems with more than one interface on different networks
can have services configured son that they will bind only to 
a given IP address. This usually prevents services when requested
through a given address. However, this does not mean (although
it's a common misconception even I had) that the service is
bound to a given <em>hardware</em> address (interface card).
<footnote>
To reproduce this (example provided by Felix von Leitner on the
bugtraq mailing list):
<example>
   host a (eth0 connected to eth0 of host b):
     ifconfig eth0 10.0.0.1
     ifconfig eth1 23.0.0.1
     tcpserver -RHl localhost 23.0.0.1 8000 echo fnord

   host b:
     ifconfig eth0 10.0.0.2
     route add 23.0.0.1 gw 10.0.0.1
     telnet 23.0.0.1 8000
</example>
<p>It seems, however, not to work with services bound to
127.0.0.1, you might need to write the tests using raw sockets.</p>
</footnote>

<p>This is not an ARP issue and it's not an RFC violation (it's 
called <em>weak end host</em> in RFC1122, section 3.3.4.2). 
Remember, IP addresses have nothing to do with physical interfaces.

<p>On 2.2 (and previous) kernels this can be fixed with:
<example>
# echo 1 > /proc/sys/net/ipv4/conf/all/hidden
# echo 1 > /proc/sys/net/ipv4/conf/eth0/hidden
# echo 1 > /proc/sys/net/ipv4/conf/eth1/hidden
.....
</example>
<p>On later kernels this can be fixed either with:
<list>
<item>iptables rules.
<item>properly configured routing.
<footnote>
The fact that this behaviour can be changed through routing
was described by Matthew G. Marsh in the bugtraq thread:
<example>
eth0 = 1.1.1.1/24
eth1 = 2.2.2.2/24

ip rule add from 1.1.1.1/32 dev lo table 1 prio 15000
ip rule add from 2.2.2.2/32 dev lo table 2 prio 16000

ip route add default dev eth0 table 1
ip route add default dev eth1 table 2
</example>
</footnote>
<item>kernel patching.
<footnote>
There are some patches available for this behaviour as
described in bugtraq's thread at
<url id="http://www.linuxvirtualserver.org/~julian/#hidden">
and <url id="http://www.fefe.de/linux-eth-forwarding.diff">.
</footnote>
</list>
<p>Along this text there will be many ocasions in which it
is shown how to configure some services (sshd server, apache, printer
service...) in order to have them listening on any given
address, the reader should take into account that, without 
the fixes given here, the fix would not prevent accesses from 
within the same (local) network.
<footnote>
An attacker might have many problems pulling the access through
after configuring the IP-address binding if he is not on the same
broadcast domain (same network) as the attacked host. If the attack
goes through a router it might be quite difficult for the answers
to return somewhere.
</footnote>

<p>FIXME: comments on bugtraq indicate there is a Linux
specific method to bind to a given interface.

<p>FIXME: Submit a bug against netbase so that the routing fix
is standard behaviour in Debian?


<sect1>Protecting against ARP attacks

<p>When you don't trust the other boxes on your LAN (which should
always be the case, because it's the safest attitude) you should
protect yourself from the various existing ARP attacks.

<p>As you know the ARP protocol is used to link IP addresses to MAC
addresses.  (see <url name="RFC826"
id="http://www.q-linux.com/Rfc/rfc826.txt"> for all the
details). Every time you send a packet to an IP address an arp
resolution is done (first by looking into the local ARP cache then if
the IP isn't present in the cache by broadcasting an arp query) to
find the target's hardware address.  All the ARP attacks aim to fool
your box into thinking that box B's IP address is associated to the
intruder's box's MAC address; Then every packet that you want to send
to the IP associated to box B will be send to the intruder's box...

<p>
Those Attacks (Cache poisonning, ARP spoofing...) allow the attacker
to sniff the traffic even on switched networks, to easily hijack
connections, to disconnect any host from the network...  Arp attack
are powerful and simple to implement, several tools exists : arpspoof
(present in package <package>dsniff</package>), <url name="arpmim"
id="http://www.team-teso.net/releases/arpmim-0.2.tar.gz">, <url
name="arpoison" id="http://web.syr.edu/~sabuer/arpoison/">...

<p>However, there is always a solution:

<list>

<item>Use a static arp cache.  You can setup "static" entries in your
arp cache :

<example>
arp -s host_name hdwr_addr </example> 

<p>By setting static entries for each important host in your network
you ensure that nobody will create/modify a (fake) entry for these
hosts (static entries don't expire and can't be modified) and spoofed
arp replies will be ignored.


<item>Detect suspicious ARP traffic. You can use
<package>arpwatch</package>, <package>karpski</package> or more
general IDS that can also detect suspicious arp traffic
(<package>snort</package>, <url name="prelude"
id="http://www.mandrakelinux.com/prelude">...).

<item>Implement IP traffic filtering validating the the MAC address.
</list>


<sect id="snapshot">Taking a snapshot of the system

<p>Before putting the system into production system you culd take a
snapshot of the whole system. This snapshot could be used in the event
of a compromise (see <ref id="after-compromise">). You should remake
this upgrade whenever the system is upgraded, specially if you upgrade
to a new Debian release.

<p>For this you can use a writable removable-media that can be setup
read-only, this could be a floppy disk (read protected after use) or a
CD on a CD-ROM unit (you could use a rewriteable CD-ROM so you could
even keep backups of md5sums in different dates).

<p>The following script creates such a snapshot:

<example>
#!/bin/bash
/bin/mount /dev/fd0 /mnt/floppy
/bin/cp /usr/bin/md5sum /mnt/floppy
echo "Calculating md5 database"
>/mnt/floppy/md5checksums.txt
for dir in /bin/ /sbin/ /usr/bin/ /usr/sbin/ /lib/ /usr/lib/
do
   find $dir -type f | xargs /usr/bin/md5sum >>/mnt/floppy/md5checksums-lib.txt
done
/bin/umout /dev/fd0
echo "post installation md5 database calculated"
</example>

<p>Note that the md5sum binary is placed on the floppy drive so it can
be used later on to check the binaries of the system (just in case it
gets trojaned). 

<p>The snapshot does not include the files under
<file>/var/lib/dpkg/info</file> which includes the md5 hashes of
installed packages (in files ended with <file>.md5sums</file>). You
could copy this information along too, however you should notice:

<list>
<item>the md5sums provided by the Debian packages include all the
files provided by them, which makes the database bigger (5 Mbs versus
600kbs in a Debian GNU/Linux system with graphical system and around
2.5 Gbs of software installed)

<item>not all Debian packages provide md5sums for the files installed
since it is not (currently) mandated policy.

</list>

<p>Once the snapshot is done you should make sure to set the medium
read-only. You can then store it for backup or place it in the drive
and use it to drive a cron check nightly comparing the original
md5sums against those on the snapshot.


<sect>Other recommendations
<sect1>Do not use software depending on svgalib

<p>
SVGAlib is very nice for console lovers like me, but in the past it
has been proven several times that it is very insecure. Exploits
against <prgn>zgv</prgn> were released, and it was simple to become
root. Try to prevent using SVGAlib programs wherever possible.  

<!-- FIXME: move this to policy section if there ever is one? -->



<chapt id="sec-services">Securing services running on your system

<p>Services can be secured in a running system in two ways:

<list>

<item>Making them only accessible in the access points (interfaces)
they need to be in.

<item>Configuring them properly so that they can only be used by
legitimate users in an authorised manner.

</list>

<p>Restricting services so that they can only be accessed from a given
place can be done by restricting access to them at the kernel
(i.e. firewall) level, configure them to listen only on a given
interface (some services might not provide this feature) or using some
other methods, for example the linux vserver patch (for 2.4.16) can be
used to force processes to use only one interface.

<p>Regarding the services running from <prgn>inetd</prgn> (telnet,
ftp, finger, pop3...) it is worth noting that inetd cannot be
configured so that services only listen on a given interface. However,
its substitute, the <prgn>xinetd</prgn> meta-daemon includes a
<tt>bind</tt> just for this matter. See <manref name="xinetd.conf"
section="5">.


<example>
service nntp
{
        socket_type     = stream
        protocol        = tcp
        wait            = no
        user            = news
        group           = news
        server          = /usr/bin/env
        server_args     = POSTING_OK=1 PATH=/usr/sbin/:/usr/bin:/sbin/:/bin
+/usr/sbin/snntpd logger -p news.info
        bind            = 127.0.0.1
} 
</example>

<p>The following sections detail how determined services can be
configured properly depending on their intented use.


<sect>Securing ssh
<p>
If you are still running telnet instead of ssh, you should take a
break from this manual and change this. Ssh should be used for all
remote logins instead of telnet. In an age where it is easy to sniff
internet traffic and get cleartext passwords, you should use only
protocols which use cryptography. So, perform an <tt>apt-get install
ssh</tt> on your system now.  

<p>Encourage all the users on your system to use ssh instead of
telnet, or even better, uninstall telnet/telnetd. In addition you
should avoid logging into the system using ssh as root and use
alternative methods to become root instead, like <prgn>su</prgn> or
<prgn>sudo</prgn>. Finally, the <file>sshd_config</file> file, in
<file>/etc/ssh</file>, should be modified to increase security as
well:

<list>
<item><tt>ListenAddress 192.168.0.1</tt> <p>Have ssh listen only on a
given interface, just in case you have more than one (and do not want
ssh available on it) or in the future add a new network card (and
don't want ssh connections from it).

<item><tt>PermitRootLogin No</tt>

<p>Try not to permit Root Login wherever possible. If anyone wants to
become root via ssh, now two logins are needed and the root password
cannot be brute forced via SSH.

<item><tt>Listen 666</tt>

<p>Change the listen port, so the intruder cannot be completely sure
whether a sshd daemon runs (be forewarned, this is security by
obscurity).

<item><tt>PermitEmptyPasswords no</tt>
<p>Empty passwords make a mockery of system security.

<item><tt>AllowUsers alex ref me@somewhere</tt>
<p>Allow only certain users to have access via ssh to this
machine. <tt>user@host</tt> can also be used to restrict a given user
from accessing only at a given host.

<item><tt>AllowGroups wheel admin</tt>
<p>Allow only certain group members to have access via ssh to this
machine.  AllowGroups and AllowUsers have equivalent directives for
denying access to a machine. Not surprisingly they are called
"DenyUsers" and "DenyGroups".

<item><tt>PasswordAuthentication yes</tt>

<p>It is completely your choice what you want to do. It is more secure
only to allow access to machine from users with ssh-keys placed in the
~/.ssh/authorized_keys file. If you want so, set this one to "no".
<!-- FIXME: what does this mean? Is it "more secure" to set this to
"no"? (era) --> <!-- jfs, IMHO yes since you place the key of the
incoming host in your server and the authentication is done against
the key -->

<item>Disable any forms of authentication you do not really need, if
you do not use, for example <tt>RhostsRSAAuthentication</tt>,
<tt>HostbasedAuthenticatio</tt>, <tt>KerberosAuthentication</tt> or
<tt>RhostsAuthentication</tt> (for exaple) you should disable them,
even if they are already by default (see the manpage <manref
name="sshd_config" section="5">).

<item><tt>Protocol 2</tt>
<p>Disable the protocol version 1, since it has some design
flaws that make it easier to crack passwords. For more information
read <url id="http://paris.cs.berkeley.edu/~dawnson/papers/ssh-timing.pdf"
name="a paper regarding ssh protocol problems"> or the 
<url id="http://xforce.iss.net/static/6449.php" name="Xforce advisory">.

<item><tt>Banner /etc/some_file</tt>
<p>Add a banner (it will retrieved from the file) to users connecting
to the ssh server, in some countries sending a warning before access
to a given system warning about unauthorised access or user monitoring
should be added to have legal protection.

</list>

<p>You can also restrict access to the ssh server using
<tt>pam_listfile</tt> or <tt>pam_wheel</tt> in the PAM control file
for ssh to restrict ssh logins. For example, you could keep anyone not
listed in <file>/etc/loginusers</file> by adding this line to
<file>/etc/pam.d/ssh</file>:

<example>
auth       required     pam_listfile.so sense=allow onerr=fail item=user file=/etc/loginusers
</example>

<p>As a final note, be aware that these directives are from a OpenSSH
configuration file. Right now, there are three commonly used SSH
daemons, ssh1, ssh2, and OpenSSH by the OpenBSD people. Ssh1 was the
first ssh daemon available and it is still the most commonly used
(there are rumors that there is even a Windows port). Ssh2 has many
advantages over ssh1 except it is released under an closed-source
license. OpenSSH is completely free ssh daemon, which supports both
ssh1 and ssh2. OpenSSH is the version installed on Debian when the
package <package>ssh</package> is chosen.

<p>You can read more information on how to setup SSH with PAM support
in the <url
id="http://lists.debian.org/debian-security/2001/debian-security-200111/msg00395.html"
name="security mailing list archives">.

<sect1 id="ssh-chroot">Chrooting ssh
<p>

<p>Currently OpenSSH does not provide a way to chroot automatically
users upon connection (the commercial version does provide this
functionality). However there is a project to provide this
functionality for OpenSSH too, see <url
id="http://chrootssh.sourceforge.net">, it is not currently packaged
for Debian, though. You could use, however, the
<file>pam_chroot</file> module as described in <ref
id="user-restrict">.

<p>In <ref id="chroot-ssh-env"> you can several options to make
chroot environment for SSH.

<sect1>Ssh clients

<p>If you are using an SSH client against the SSH server you must make sure 
that it supports the same protocols that are enforced on the server.
For example, if you use the <package>mindterm</package> package, it
only supports protocol version 1. However, the sshd server is, by 
default, configured to only accept version 2 (for security reasons).

<sect1>Disallowing file transfers

<p>If you do <em>not</em> want users to transfer files to and from the
ssh server you need to restrict access to the <prgn>sftp-server</prgn>
<em>and</em> the <prgn>scp</prgn> access. You can restrict
<prgn>sftp-server</prgn> by configuring the proper <tt>Subsystem</tt>
in the <file>/etc/ssh/sshd_config</file>. However, to restrict
<prgn>scp</prgn> access, however, you must either:

<list>

<item>disallow users from login to the ssh server (as described
above either through the configuration file or PAM configuration).

<item>do not give valid shells to users which are not allowed secure
transfers. The shells provided, however, should be programs that would
make connecting to the ssh server was useful at all, such as menu
programs (ala BBS). Otherwise the previous option is preferred.

</list>

<sect>Securing Squid

<p>
Squid is one of the most popular proxy/cache server, and there are
some security issues that should be taken into account.  Squid's
default configuration file denies all users requests.  However the
Debian package allows access from 'localhost', you just need to
configure your browser properly.  You should configure Squid to allow
access to trusted users, hosts or networks defining an Access Control
List on <file>/etc/squid.conf</file>, see the <url name="Squid User's
Guide" id="http://squid-docs.sourceforge.net/latest/html/book1.htm">
for more information about defining ACLs rules.

<p>Also, if not properly configured, someone may relay a mail message 
through Squid, since the HTTP and SMTP protocols are designed similarly.
Squid's default configuration file denies access to port 25. If you wish 
to allow connections to port 25 just add it to Safe_ports
lists. However, this is <em>NOT</em> recommended.

<p>Setting and configuring the proxy/cache server properly is only part
of keeping your site secure. Another necessary task is to 
analyse Squid's logs to assure that all things are working as they should 
be working. There are some packages in Debian GNU/Linux that can help
an administrator to do this.
The following packages are available in woody (Debian 3.0):

<list>
<item><package>calamaris</package> - Log analyzer for Squid or Oops proxy log files.
<item><package>modlogan</package>  - A modular logfile analyzer.
<!-- This one is no longer available?
<item><package>sarg</package> - Squid Analysis Report Generator.
-->
<item><package>squidtaild</package> - Squid log monitoring program.
</list>

<p>When using Squid in Accelerator Mode it acts as a web server
too. Turning on this option code complexity increases, making it less
reliable. By default Squid is not configured to act as a web server,
so you don't need to worry about this. Note that if you want to use
this feature be sure that it is really necessary. Too find more
information about Accelerator Mode on Squid see the <url name="Squid
User's Guide #Chapter9"
id="http://squid-docs.sourceforge.net/latest/html/c2521.htm">.

<sect id="ftp-secure">Securing FTP

<p>
If you really have to use FTP (without wrapping it with sslwrap or
inside a SSL or SSH tunnel), you should chroot ftp into the ftp users'
home directory, so that the user is unable to see anything else than
their own directory. Otherwise they could traverse your root
filesystem just like if they had a shell in it. You can add the
following line in your <file>proftpd.conf</file> in your global
section to enable this chroot feature:

<example>
DefaultRoot ~
</example>

<p>Restart proftpd by <tt>/etc/init.d/proftpd restart</tt> and check
whether you can escape from your homedir now.

<P>To prevent Proftp DoS attacks using ../../.., add the following line in <file>/etc/proftpd.conf</file>:

<tt>DenyFilter \*.*/</tt>

<p>Always remember that FTP sends login and authentication passwords
in clear text (this is not an issue if you are providing an anonymous
public service) and there are better alternatives in Debian for
this. For example, <prgn>sftp</prgn> (provided by
<package>ssh</package>). There are also free implementations of SSH
for other operating systems: <url
id="http://www.chiark.greenend.org.uk/~sgtatham/putty/" name="putty">
and <url id="http://www.cygwin.com" name="cygwin"> for example.

<!-- contributed by Jesus Climent --> 
<p>However, if you still maintain the FTP server while making users
access through SSH you migh encounter a typical problem.  Users
accessing Anonymous FTP servers inside SSH-secured systems might try
to log in the <em>FTP server</em>. While the access will be refused,
the password will nevertheless be sent through the net in clear
form. To avoid that, ProFTPd developer TJ Saunders has created a patch
that prevents users feeding the anonymous FTP server with valid SSH
acounts.  More information and patch available at: <url
id="http://www.castaglia.org/proftpd/#Patches" name="ProFTPD
Patches">.

<sect>Securing access to the X Window System
<p>
Today, X terminals are used by more and more companies where one
server is needed for a lot of workstations. This can be dangerous,
because you need to allow the file server to connect to the the
clients (X server from the X point of view. X switches the definition
of client and server).  If you follow the (very bad) suggestion of
many docs, you type <tt>xhost +</tt> on your machine. This allows any
X client to connect to your system. For slightly better security, you
can use the command <tt>xhost +hostname</tt> instead to only allow
access from specific hosts.

<p>
A much more secure solution, though, is to use ssh to tunnel X and
encrypt the whole session. This is done automatically when you ssh to
another machine. This has to be enabled in <file>/etc/ssh/ssh_config</file> by
setting <tt>X11Forwarding</tt> to <tt>yes</tt>. In times of SSH, you
should drop the xhost based access control completely.  <!-- FIXME:
check. The text said "has to be disabled" [sic] -->

<p>
For best security, if you do not need X access from other machines, is
to switch off the binding on tcp port 6000 simply by typing:

<example>$ startx -- -nolisten tcp</example>


<p>This is the default behavior in Xfree 4.1.0 (the Xserver provided in
Debian 3.0). If you are running Xfree 3.3.6 (i.e. you have Debian 2.2
installed) you can edit <file>/etc/X11/xinit/xserverrcc</file> to have
it something along the lines of:

<example>
#!/bin/sh
exec /usr/bin/X11/X -dpi 100 -nolisten tcp
</example>

<p>If you are using XDM set <file>/etc/X11/xdm/Xservers</file> to:
<tt>:0 local /usr/bin/X11/X vt7 -dpi 100 -nolisten tcp</tt>. If you
are using Gdm make sure that the <tt>-nolisten tcp</tt> option is set
in the <file>/etc/gdm/gdm.conf</file> (which is the default in Debian)
such as this:

<example>
[server-Standard]
name=Standard Server
command=/usr/bin/X11/X -nolisten tcp
</example>

<p>You can also set the default's system timeout for
<prgn>xscreensaver</prgn> locks. Even if the user can override it, you
should edit the <file>/etc/X11/app-defaults/XScreenSaver</file>
configuration file and change the lock line:
<example>
*lock:                  False
</example>
<p>(which is the default in Debian) to:
<example>
*lock:                  True
</example>

<p>FIXME: add information on how to disable the screensavers which
show the user desktop (which might have sensitive information).

<p>Read more on X Window security in
<url
name="XWindow-User-HOWTO"
id="http://www.linuxdoc.org/HOWTO/XWindow-User-HOWTO.html">
(<file>/usr/share/doc/HOWTO/en-txt/XWindow-User-HOWTO.txt.gz</file>).


<p>FIXME: Add info on thread of debian-security on how to change config files
of XFree 3.3.6 to do this.  

<sect1>Check your display manager
<p>
If you only want to have a display manager installed for local usage
(having a nice graphical login, that is), make sure the XDMCP (X
Display Manager Control Protocol) stuff is disabled. In XDM you can do
this with this line in <tt>/etc/X11/xdm/xdm-config</tt>:

<example>
DisplayManager.requestPort:     0
</example>

<p>Normally, all display managers are configured not to start XDMCP services
per default in Debian.


<sect>Securing printing access (The lpd and lprng issue)

<p>Imagine, you arrive at work, and the printer is spitting out
endless amounts of paper because someone is DoSing your line printer
daemon. Nasty, isn't it?  

<!-- Info based on Dale Southard's post to debian-security april 11th 2002-->
<p>In any unix printing architecture, there has to be a way to get the
client's data to the host's print server.  In traditional <prgn>lpr</prgn> 
and <prgn>lp</prgn>, the client command copies or symlinks the data 
into the spool directory (which is why these programs is usually SUID or SGID).

<p>In order to avoid any issues you should keep your printer servers specially
secure. This means you need to configure your printer service so it
will only allow connections from a set of trusted servers.  In order
to do this, add the servers you want to allow printing to your
<file>/etc/hosts.lpd</file>.

<p>However, even if you do this, the <prgn>lpr</prgn> daemon accepts incoming
connections on port 515 of any interface. You should consider
firewalling connections from networks/hosts which are not allowed
printing (the <prgn>lpr</prgn> daemon cannot be limited to listen only on 
a given IP address). 

<!-- FIXME
<p>Of course, you could also take the lpr/lprng sources
and change them so that the connect function is only done to "127.0.0.1".
apt-get source lpr
and patch the bind (finet) call
-->

<p><prgn>Lprng</prgn> should be preferred over <prgn>lpr</prgn>
since it can be configured to do IP access control. And you 
can specify which interface to bind to (although somewhat weirdly).

<!-- FIXME: ask Craig Small about his post in debian-private 19th october 2001 -->

<p>If you are using a printer in your system, but only locally, you 
will not want to share this service over a network. You can consider
using other printing systems, like the one provided by <package>cups</package>
or <url name="PDQ"
id="http://pdq.sourceforge.net/"> which is based on user
permissions of the <file>/dev/lp0</file> device.

<p>In <package>cups</package>, the print data is transferred to the server 
via the http protocol.  This means the client program doesn't need any special
privileges, but does require that the server be listening on a port
somewhere.

<p>However, if you want to use <prgn>cups</prgn>, but only locally,
you can configure it to bind to the
loopback interface by changing <file>/etc/cups/cupsd.conf</file>:

<example>
Listen 127.0.0.1:631
</example>

<P>There are many other security options like allowing or denying 
networks and hosts in this config file. However, if you do not need
them you might be better off just limiting the listening port.
<prgn>Cups</prgn> also serves documentation through the HTTP port,
if you do not want to disclose potential useful information to
outside attackers (and the port is open) add also:

<example>
&lt;Location /&gt;
  Order Deny,Allow
   Deny From All
    Allow From 127.0.0.1
&lt;/Locationi&gt;
</example>

<p>This configuration file can be modified to add some more features
including SSL/TLS certificates and crypto.  The manuals are available 
at http://localhost:631/ or at <url id="cups.org">.  

<P>FIXME: Add more content (the article on <url name="Amateur Fortress
Building" id="http://www.rootprompt.org"> provides some very
interesting views).  

<p>FIXME: Check if PDG is available in Debian, and if so,
suggest this as the preferred printing system.

<p>FIXME: Check if Farmer/Wietse has a replacement for printer daemon
and if it's available in Debian.

<sect>Securing the mail service

<p>If your server is not a mailing system, you do not really need to
have a mail daemon listening for incoming connections, but you might
want local mail delivered in order, for example, to receive mail for
the root user from any alert systems you have in place.

<p>If you have <prgn>exim</prgn> you do not need the daemon to be
working in order to do this since the standard cron job flushes the
mail queue. See <ref id="disableserv"> on how to do this.

<sect1>Configuring a Nullmailer

<p>However you might want to have a local mailer daemon so that it can
relay the mails sent locally to a realy system. This is common when
you have to administer a number of systems and do not want to connect
to each of them to read the local mail sent, it is usual to relay the
local mail to a remote system that consolidates all of it (similarly
to what should be done to logging for those systems).

<p>Such a <em>relay-only</em> system should be configured properly for
this. The daemon could, as well, be configured to only listen on the
loopback address.

<p>To do this in a Debian system, you will have to remove the smtp
daemon from <prgn>inetd</prgn>:
<example>
$ update-inetd --disable smtp
</example>

<p>and configure the mailer daemon to only listen on the loopback
interface.  In <prgn>exim</prgn> (the default MTA) you can do this by
editing the file <file>/etc/exim.conf</file> and adding the following
line:

<example>
local_interfaces = "127.0.0.1"
</example>

<p>Restart both daemons (inetd and exim) and you will have exim
listening on the 127.0.0.1:25 socket only. Be careful, and first
disable inetd, otherwise, exim will not start since the inetd daemon
is already handling incoming connections.

<p>For <prgn>postfix</prgn> edit <file>/etc/postfix/main.conf</file>:

<example>
inet_interfaces = localhost
</example>

<p>If you only want local mail, this approach is better than
tcp-wrapping the mailer daemon or adding firewalling rules to limit
anybody accessing it.  However, if you do need it to listen on other
interfaces, you might consider launching it from inetd and adding a
tcp wrapper so incoming connections are checked against
<file>/etc/hosts.allow</file> and <file>/etc/hosts.deny</file>.  Also,
you will be aware of when an unauthorized access is attempted against
your mailer daemon, if you set up proper logging for any of the
methods above.

<p>In any case, to reject mail relay attempts at the SMTP level, you
can change <file>/etc/exim/exim.conf</file> to include:

<example>
receiver_verify = true
</example>

<p>Even if you mail server will not relay the message, this kind of
configuration is needed for the relay tester at <url
id="http://www.abuse.net/relay.html"> to determine that your server is
<em>not</em> relay capable.

<p>If you want a relay-only setup, however, you can consider changing
the mailer daemon to programs that can <em>only</em> be configured to
forward the mail to a remote mail server. Debian provides currently
both <package>ssmtp</package> and <package>nullmailer</package> for
this purpose. In any case, you can evaluate for yourself any of the
mail transport agents 
<footnote>
To retrieve the list of mailer daemons available in Debian try:
<example>
$ apt-cache search mail-transport-agent
</example>
<p>The list will not include <prgn>qmail</prgn>, which is distributed
only as source code in the <package>qmail-src</package> package.
</footnote>
provided by Debian and see which one suits best to the system's
purposes.

<sect1>Providing secure access to mailboxes

<p>If you want to give remote access to mailboxes there are a number
of POP3 and IMAP daemons available
<footnote>A list of servers/daemons which support these
protocols in Debian can be retrieved with:
<example>
$ apt-cache search pop3-server
$ apt-cache search imap-server
</example>
</footnote>
. However, if you provide IMAP access note that it is a general file
access protocol, it can become the equivalent of a shell access
because users might be able to retrieve any file that they can
through it.

<p>Try, for example, to configure as your inbox path
<tt>{server.com}/etc/passwd</tt> if it succeeds your IMAP daemon is
not properly configured to prevent this kind of access.

<p>Of the IMAP servers in Debian the <prgn>cyrus</prgn> server (in the
<package>cyrus-imapd</package> package) gets around this by having all
access be to a database in a restricted part of the filesystem. Also,
<prgn>uw-imapd</prgn> (either installing the
<package>uw-imapd</package> or, better if your IMAP clients support
it, <package>uw-imapd-ssl</package>) can be configured to chroot the
users mail directory but this is not enabled by default. The
documentation provided gives more information on how to configure it.

<p>Also, you might want to run an IMAP server that does not need valid
users to be created on the local system (which would might grant shell
access too), both <package>courier-imap</package> (for IMAP) and
<package>courier-pop</package> <package>teapop</package> (for POP3)
and <package>cyrus-imapd</package> (for both POP3 and IMAP) provide
servers with authentication methods beside the local user
accounts. <prgn>cyrus</prgn> can use any authentication method that
can be configured through PAM whileas <prgn>teapop</prgn> might use
databases (such as <package>postgresql</package> and
<package>mysql</package>) for user authentication.


<p>FIXME: Check: <package>uw-imapd</package> might be configured with
user authentication through PAM too..

<sect1>Receiving mail securely
<p>
Reading/receiving mail is the most common cleartext protocol. If you
use either POP3 or IMAP to get your mail, you send your cleartext
password across the net, so almost anyone can read your mail from now
on. Instead, use SSL (Secure Sockets Layer) to receive your mail. The
other alternative is ssh, if you have a shell account on the box which
acts as your POP or IMAP server.  Here is a basic <file>fetchmailrc</file> to
demonstrate this:

<example>
poll my-imap-mailserver.org via "localhost"
  with proto IMAP port 1236
      user "ref" there with password "hackme" is alex here warnings 3600
    folders
      .Mail/debian
    preconnect 'ssh -f -P -C -L 1236:my-imap-mailserver.org:143 -l ref
     my-imap-mailserver.org sleep 15 &lt;/dev/null &gt; /dev/null'
</example>

<p>The preconnect is the important line. It fires up a ssh session and
creates the necessary tunnel, which automatically forwards connections
to localhost port 1236 to the IMAP mail server, but encrypted. Another
possibility would be to use fetchmail with the ssl feature.

<p>If you want to provide encrypted mail services like POP and IMAP,
<tt>apt-get install stunnel</tt> and start your daemons this way:

<example>
stunnel -p /etc/ssl/certs/stunnel.pem -d pop3s -l /usr/sbin/popd
</example>


<p>This command wraps the provided daemon (-l) to the port (-d) and uses the
specified ssl cert (-p).



<sect id="sec-bind">Securing BIND

<p>There are different issues that can be tackled in order to secure the 
Domain server daemon, which are similar to the ones considered when securing any given service:

<list>

<item>configure the daemon itself properly so it cannot be misused
from the outside. This includes limiting possible queries from
clients: zone transfers and recursive queries.

<item>limit the access of the daemon to the server itself so if it is
used to break in, the damage to the system is limited. This includes
running the daemon as a non-privileged user and chrooting it.

</list>

<p>You should restrict some of the information that is served from the
DNS server to outside clients so that it cannot be used to retrieve
valuable information from your organization that you do not want to
give away. This includes adding the following options:
<em>allow-transfer</em>, <em>allow-query</em>,
<em>allow-recursive</em> and <em>version</em>. You can either limit this on 
the global section (so it applies to all the zones served) or on a per-zone
basis. This information is documented on the
<package>bind-doc</package> package, read more on this on
<file>/usr/share/doc/bind/html/index.html</file> once the package is
installed.

<p>Imagine that your server is connected to the Internet and to your
internal (your internal IP is 192.168.1.2) network (a basic
multi-homed server), you do not want to give any service to the
Internet and you just want to enable DNS lookups from your internal
hosts. You could restrict it by including in
<file>/etc/bind/named.conf</file>:

<example>
options {
	    allow-query { 192.168.1/24; } ;
	    allow-transfer { none; } ; 
	    allow-recursive { 192.168.1/24; } ;
	    listen-on { 192.168.1.2; } ;
	    forward { only; } ;
	    forwarders { A.B.C.D; } ;
};
</example>

<p>The <em>listen-on</em> option makes the DNS bind to only the
interface that has the internal address, but, even if this interface
is the same as the interface that connects to the Internet (if you are
using NAT, for example), queries will only be accepted if coming from
your internal hosts. If the system has multiple interfaces and the
<em>listen-on</em> is not present, only internal users could query,
but, since the port would be accessible to outside attackers, they
could try to crash (or exploit buffer overflow attacks) on the DNS
server. You could even make it listen only on 127.0.0.1 if you are not
giving DNS service for any other systems than yourself.
</p>

<p>
The version.bind record in the chaos class contains the version of the 
of the currently running bind process. This information is often used
by automated scanners and malicious individuals who wish to determine if
one's bind is vulnerable to a specific attack. By providing false or
no information in the version.bind record, one limits the probability
that one's server will be attacked based on its publicized version.
To provide your own version, use the <em>version</em> directive in the 
following manner:
<example>
options {
	... various options here ...
	version "Not available.";
};
</example>

<p>Changing the version.bind record does not provide actual protection
against attacks, but it might be considered a useful safeguard.
</p>

<p>A sample <file>named.conf</file> configuration file might be the
following:

<example>
acl internal {
        127.0.0.1/32;           // localhost
        10.0.0.0/8;             // internal
        aa.bb.cc.dd;            // eth0 IP
};

acl friendly {
        ee.ff.gg.hh;            // slave DNS
        aa.bb.cc.dd;            // eth0 IP
        127.0.0.1/32;           // localhost
        10.0.0.0/8;             // internal
};

options {
        directory "/var/cache/bind";
        allow-query { internal; };
        allow-recursive { internal; };
        allow-transfer { none; };
};
// From here to the mysite.bogus zone 
// is basically unmodified from the debian default
logging {
        category lame-servers { null; };
        category cname { null; };   
};

zone "." {
        type hint;
        file "/etc/bind/db.root";
};

zone "localhost" {
        type master;
        file "/etc/bind/db.local";
};

zone "127.in-addr.arpa" {
        type master;
        file "/etc/bind/db.127";
};

zone "0.in-addr.arpa" {
        type master;
        file "/etc/bind/db.0";
};

zone "255.in-addr.arpa" {
        type master;
        file "/etc/bind/db.255";
};

// zones I added myself
zone "mysite.bogus" {
        type master;
        file "/etc/bind/named.mysite";
        allow-query { any; };
        allow-transfer { friendly; };
};
</example>

<P>Please (again) check the Bug Tracking System regarding Bind,
specifically <url name="Bug #94760 (regarding ACLs on zone transfers)"
id="http://bugs.debian.org/94760">. Feel free to contribute to the bug
report if you think you can add useful information.

<sect1 id="user-bind">Changing BIND's user

<p>Regarding limiting BIND's privileges you must be aware that if a
non-root user runs BIND, then BIND cannot detect new interfaces
automatically. For example, if you stick a PCMCIA card into your
laptop.  Check the README.Debian file in your named documentation
(<file>/usr/share/doc/bind/README.Debian</file>) directory for more
information about this issue.  There have been many recent security
problems concerning BIND, so switching the user is useful when
possible. We will detail here the steps needed in order to do this,
however, if you want to do this in an automatic way you might try the
script provided in <ref id="bind-chuser">.

<p>To run BIND under a different user, first create a separate user and
group for it (it is <em>not</em> a good idea to use nobody or nogroup
for every service not running as root). In this example, the user and
group <tt>named</tt> will be used. You can do this by entering:
<example>
addgroup named
adduser --system --home /home/named --no-create-home --ingroup named \
      --disabled-password --disabled-login named
</example>

<p>Notice that the user <tt>named</tt> will be quite restricted. If you want, for whatever reason, to have a less restrictive setup use:
<example>
adduser --system --ingroup named named
</example>


<p>Now edit <tt>/etc/init.d/bind</tt> with your favorite editor and change the
line beginning with
<example>
start-stop-daemon --start
</example>

to

<example>
start-stop-daemon --start --quiet --exec /usr/sbin/named -- -g named -u named
</example>

<p>Also, in order to avoid running anything as root, change the
<tt>reload</tt> line commenting out:

<example>
reload)
       /usr/sbin/ndc reload
</example>

<p>And change it to:
<example>
reload)
        $0 stop
        sleep 1
        $0 start
</example>

<p>Note: Depending on your Debian version you might have to change the
<tt>restart</tt> line too. This was fixed in Debian's bind version
<tt>1:8.3.1-2</tt>.

<p>
All you need to do now is to restart bind via '/etc/init.d/bind
restart', and then check your syslog for two entries like this:
<p>
<example>
Sep  4 15:11:08 nexus named[13439]: group = named
Sep  4 15:11:08 nexus named[13439]: user = named
</example>


<p>Voilá! Your named now <em>does not</em> run as root.  If you want
to read more information on why BIND does not run as non-root user on
Debian systems, please check the Bug Tracking System regarding Bind,
specifically <url name="Bug #50013: bind should not run as root"
id="http://bugs.debian.org/50013"> and
<url name="Bug #132582: Default install is potentially insecure"
id="http://bugs.debian.org/132582">, 
<url name="Bug #53550" id="http://bugs.debian.org/53550">, 
<url name="Bug #128120" id="http://bugs.debian.org/52745">, and
<url name="Bug #128120" id="http://bugs.debian.org/128129">. 
Feel free to contribute to the bug
reports if you think you can add useful information.


<sect1 id="chroot-bind">Chrooting the name server

<p>To achieve maximum BIND security, now build a chroot jail (see <ref
id="chroot">) around your daemon.  There is an easy way to do this:
the <tt>-t</tt> option (see the <manref name="named" section="8">
manpage). This will make Bind chroot itself into the given directory
without you needing to setup a chroot jail and worry about dynamic
libraries. The only files there needs to be in these chroot jail:

<example>
dev/null
etc/bind/       - should hold named.conf and all the server zones
sbin/named-xfer - if you do name transfers
var/run/named/  - should hold the pid and the name server cache (if
                 any) this directory needs to be writable by named
                  user
var/log/named   - if you setup logging to a file, needs to be writable
                  for the named user
dev/log         - syslogd should be listening here if named is configure to
                  log through it
</example>


<p>In order for your Bind daemon to work properly it needs permission
in the named files. This is an easy task since the configuration
files are always at <tt>/etc/named/</tt>. Take in account that
it only needs read-only access to the zone files, unless it is
a secondary or cache name server. If this is your case you will have
to give read-write permissions to the necessary zones (so that
zone transfers from the primary server work).

<p>Also, you can find more information regarding Bind chrooting in the
<url name="Chroot-BIND-HOWTO"
id="http://www.linuxdoc.org/HOWTO/Chroot-BIND-HOWTO.html"> (regarding
Bind 9) and <url name="Chroot-BIND8-HOWTO"
id="http://www.linuxdoc.org/HOWTO/Chroot-BIND8-HOWTO.html"> (regarding
Bind 8). This same documents should be available through the
installation of the <package>doc-linux-text</package> (text version)
or <package>doc-linux-html</package> (html version). Another useful
document is <url id="http://www.psionic.com/papers/dns/dns-linux">.

<p>If you are setting up a full chroot jail (i.e. not just
<tt>-t</tt>) for Bind 8.2.3 in Debian (potato), make sure you have the
following files in it:

<example>
dev/log - syslogd should be listening here
dev/null
etc/bind/named.conf 
etc/localtime
etc/group - with only a single line: "named:x:GID:"
etc/ld.so.cache - generated with ldconfig   
lib/ld-2.1.3.so
lib/libc-2.1.3.so
lib/ld-linux.so.2 - symlinked to ld-2.1.3.so  
lib/libc.so.6 - symlinked to libc-2.1.3.so
sbin/ldconfig - may be deleted after setting up the chroot
sbin/named-xfer - if you do name transfers
var/run/
</example>

<p>And modify also <prgn>syslogd</prgn> listen on $CHROOT/dev/log so
the named server can write syslog entries into the local system log.

<p>If you want to avoid problems with dynamic libraries, you can
compile bind statically. You can use <prgn>apt-get</prgn> for this,
with the <tt>source</tt> option. It can even download the packages you
need to properly compile it. You would need to do someting similar to:

<!-- FIXME: Does bind use autoconf? -->
<example>
$ apt-get --download-only source bind build-dep bind
$ cd bind-8.2.5-2
(edit the Makefile.in so CFLAGS includes the '-static' option 
before the @CFLAGS@ definition substituted by autoconf)
$ dpkg-buildpackage -rfakeroot
$ cd ..
$ dpkg  -i bind-8.2.5-2*deb
</example>

<p>After installation, you will need to move around the files to the
chroot jail 
<footnote>unless you use the <tt>instdir</tt> option when calling
<prgn>dpkg</prgn> but then the chroot jail might be a little more
complex</footnote>
you can keep the <tt>init.d</tt> scripts in <file>/etc/init.d</file>
so that the system will automatically start the name server, but edit
them to add <tt>--chroot /location_of_chroot</tt> in the calls to
<prgn>start-stop-daemon</prgn> in those scripts.

<p>For more information on how to setup chroots seee <ref id="gen-chroot">.

<p>FIXME, merge info from
<url id="http://people.debian.org/~pzn/howto/chroot-bind.sh.txt">,
<url id="http://people.pdxlinux.org/~karlheg/"> (Bind9 on Debian),
<url id="http://www.cryptio.net/~ferlatte/config/"> (Debian-specific),
<url id="http://www.psionic.com/papers/whitep01.html">, 
<url id="http://csrc.nist.gov/fasp/FASPDocs/NISTSecuringDNS.htm">
and
<url id="http://www.acmebw.com/papers/securing.pdf">.

<sect>Securing Apache

<p>FIXME: Add content: modules provided with the normal Apache installation
(under /usr/lib/apache/X.X/mod_*) and modules that can be installed 
separately in libapache-mod-XXX packages.

<p>You can limit access to the Apache server if you only want to use
it internally (for testing purposes, to access the <package>doc-central</package>
archive, etc..) and do not want outsiders to access it. To do this use the 
<tt>Listen</tt> or <tt>BindAddress</tt> directives in <file>/etc/apache/http.conf</file>.

<p>Using Listen:
<example>
Listen 127.0.0.1:80
</example>
<p>Using BindAddress:
<example>
BindAddress 127.0.0.1
</example>

<p>Then restart apache with <tt>/etc/init.d/apache restart</tt> and you will see
that it is only listening on the loopback interface. 

<p>In any case, if you are not using all the functionality provided by 
Apache, you might want to take a look at other web servers provided in Debian
like <package>dhttpd</package>.

<p>The <url name="Apache Documentation"
id="http://httpd.apache.org/docs/misc/security_tips.html"> provides
information regarding security measures to be taken on Apache webserver
(this same information is provided in Debian by the
<package>apache-doc</package> package).

<p>FIXME: Add pointer to Intersect's Alliance.

<sect1>Disabling users from publishing web contents

<p>The default Apache installation in Debian permits users to publish
contents under the <file>$HOME/publish_html</file>. These contents can
be retrieved remotely using an URL such as:
http://your_apache_server/~user.

<p>If you do not want to permit this you must change the <file>/etc/apache/http.conf</file> configuration file which includes:

<example>
&lt;Directory /home/*/public_html&gt;
    AllowOverride FileInfo AuthConfig Limit
    Options MultiViews Indexes SymLinksIfOwnerMatch IncludesNoExec
    &lt;Limit GET POST OPTIONS PROPFIND&gt;
        Order allow,deny
        Allow from all
    &lt;/Limit&gt;
    &lt;Limit PUT DELETE PATCH PROPPATCH MKCOL COPY MOVE LOCK UNLOCK&gt;
        Order deny,allow
        Deny from all
    &lt;/Limit&gt;
&lt;/Directory&gt;
</example>

Change it to:

<example>
&lt;Directory /home/*/public_html&gt;
    AllowOverride None
    Order deny,allow
    Deny from all
&lt;/Directory&gt;
</example>

<p>Note: An attacker might still do user enumeration, since the answer
of the web server will be a <em>403 Permission Denied</em> and not a
<em>404 Not available</em>.

<sect1>Logfiles permissions

<p>Apache logfiles, since 1.3.22-1, are owned by user 'root' and group
'adm' with permissions 640 this permissions are changed after
rotation. An intruder that accesed the system through the web server
would not be able (without priviledge escalation) to remove old log
file entries.

<sect1>Published web files

<p>Apache files are located under <file>/var/www</file>. Just after
installation the default file provides some information on the system
(mainly that it's a Debian system running Apache).  The default
webpages are owned by user root and group root by default, whileas the
Apache process runs as user www-data and group www-data. This should
make attackers that compromise the system through the web server
harder to deface the site. You should, of course, substitute the
default web pages (which might provide information you do not want to
show to outsiders) with your own.


<p>


<sect>Securing finger
<p>If you want to run the finger service first ask
yourself if you need to do so. If you do, you will find out that
Debian provides many finger daemons 
(output from <prgn>apt-cache search fingerd</prgn>): 
<list>
<item>cfingerd - Configurable finger daemon
<item>efingerd - Another finger daemon for unix capable of fine-tuning your output.
<item>ffingerd - a secure finger daemon
<item>fingerd - Remote user information server.
<item>BSD-like finger daemon with qmail support.
</list>
<p><package>ffingerd</package> is the recommended finger daemon if you are
going to use it for a public service. In any case, you are encouraged to,
when setting it up through inetd, xinetd or tcpserver to: limit the number of 
processes that will be running at the same time, limit access to the finger
daemon from a given number of hosts (using tcp wrappers) and having it
only listening to the interface you need it to be in.

<sect id="gen-chroot">General chroot and suid paranoia

<p>It is probably fair to say that the complexity of BIND is the
reason why it has been exposed to a lot of attacks in recent years.
(see <ref id="sec-bind">)

<p>Other programs with complex features and a large installed user
base include Sendmail and some ftp daemons (e.g. WUftpd).  (Of course,
a program with no features and no satisfied users can be just as
insecure, besides being useless.)

<p>Anyway, if you run any of these, consider similar arrangements for
them &mdash; revoking root privileges, running in a chroot jail
&mdash; or replacing them with a more secure equivalent.

<sect1 id="auto-chroot">Automaking chrooting programs

<p>There are several programs to chroot automatically servers and
services. Debian currently (accepted in may 2002) provides Wietse
Venema's <prgn>chrootuid</prgn> in the <package>chrootuid</package>
package. This program can be used to setup a restricted environment
for executing a command (including running it as a restricted
user). However, you must setup the chroot environment yourself.

<p>In the near future Debian will provide tools to setup the chroot
environment easily. The <prgn>makejail</prgn> program for example, can
create and update a chroot jail with short configuration files (it
provides sample configuration files for <prgn>bind</prgn>,
<prgn>apache</prgn>, <prgn>postgresql</prgn> and
<prgn>mysql</prgn>). It attempts to guess and install into the jail
all files required by the daemon using <prgn>strace</prgn>,
<prgn>stat</prgn> and Debian's package dependancies. More information
at <url id="http://www.floc.net/makejail/">. <prgn>Jailer</prgn> is a
similar tool which can be retrieved from <url
id="http://www.balabit.hu/downloads/jailer/">.

<p>FIXME: I have packages ready for makejail and jailer, update this
when they get accepted.

<p>Also useful to create chroots (or jails) is
<package>deb.pl</package>, a script that analyses dependencies of a
set of files.

<sect>General cleartext password paranoia
<p>
You should try to avoid any network service which sends and receives
passwords in cleartext over a net like FTP/Telnet/NIS/RPC. The author
recommends the use of ssh instead of telnet and ftp to everybody.

<p>Keep in mind that migrating from telnet to ssh, but using other
cleartext protocols does not increase your security in ANY way! Best
would be to remove ftp, telnet, pop, imap, http and to supersede them
with their respective encrypted services.  You should consider moving
from these services to their SSL versions, ftp-ssl, telnet-ssl,
pop-ssl, https ...

<p>Most of these above listed hints apply to every Unix system (you
will find them if reading any other hardening-related document related
to Linux and other Unices).

<sect>Disabling NIS 

<p>You should not use NIS, the Network Information Service, if it is
possible, because it allows password sharing. This can be highly
insecure if your setup is broken.

<p>If you need password sharing between machines, you might want to
consider using other alternatives. For example, you can set a LDAP
server and configure PAM on your system in order to contact the LDAP
server for user authentication. You can find a detailed setup in the
<url
name="LDAP-HOWTO" id="http://www.linuxdoc.org/HOWTO/LDAP-HOWTO.html">
(<file>/usr/share/doc/HOWTO/en-txt/LDAP-HOWTO.txt.gz</file>).

<p>Read more on NIS security in
<url
name="NIS-HOWTO" id="http://www.linuxdoc.org/HOWTO/NIS-HOWTO.html">
(<file>/usr/share/doc/HOWTO/en-txt/NIS-HOWTO.txt.gz</file>).


<p>FIXME (jfs): Add info on how to setup this in Debian

<sect id="rpc">Disabling RPC services

<p>You should disable RPC wherever possible, that is, when you do not need it.
<footnote>
You only probably need it if using NFS (Network FileSystem), NIS
(Network Information System) or some other RPC-based service.
</footnote>
Many security holes for both the portmapper service and RPC-based
services are known and could be easily exploited.  On the other hand NFS
services are quite important in some networks, so find a balance of
security and usability in your network. Some of the DDoS (distributed
denial of service) attacks use rpc exploits to get into the system and
act as a so called agent/handler. Read more on NFS security in
<url
name="NFS-HOWTO" id="http://www.linuxdoc.org/HOWTO/NFS-HOWTO.html">
(<file>/usr/share/doc/HOWTO/en-txt/NFS-HOWTO.txt.gz</file>).

<p>Disabling portmap is quite simple. There are different methods. The
simplest one in a Debian 3.0 system is to do uninstall the
<package>portmap</package> package. If you are running another version
you will have to disable the service as seen in <ref
id="disableserv">, this is due to the program being a part of the
<package>net-base</package> package (which cannot be de-installed
without breaking the system).

<p>This in fact removes every symlink relating to portmap in
<tt>/etc/rc${runlevel}.d/</tt>, which is something you could also do
manually.  Another possibility is to <tt>chmod 644
/etc/init.d/portmap</tt>, but that gives an error message when
booting. You can also strip off the <tt>start-stop-daemon</tt> part in
<file>/etc/init.d/portmap</file> shell script.

<sect id="firewall-setup">Adding firewall capabilities

<p>The Debian GNU/Linux operating system has the built-in capabilities
provided by the Linux kernel. This means that if you install a potato
(Debian 2.2 release) system (default kernel is 2.2) you will have
<prgn>ipchains</prgn> firewalling available in the kernel, you need to
install the <package>ipchains</package> which will be surely (due to
its priority) be already installed. If you install a woody (Debian 3.0
release) system (default kernel is 2.4) you will have
<prgn>iptables</prgn> (neftfilter) firewalling available. The main 
different between <prgn>ipchains</prgn> and <prgn>iptables</prgn> is
that the later is based on <em>stateful packet inspection</em> which
provides for more secure (and easier to build) filtering configurations.

<sect1>Firewalling the local system

<p>You can use firewall rules as a way to secure the access to your
local system and, even, to limit the outbound communications made by
it. Firewall rules can be used also to protect processes that cannot
be properly configured <em>not</em> to provide services to some
networks, IP addresses, etc..

<p>However, this step is presented last in this manual basically
because it is <em>much</em> better to not depend solely on firewalling
capabilities in order to protect a given system. Security in a system
is made up of layers, firewalling should be the last to include, once
all services have been hardened. You can easily imagine a setup in
which the system is solely protected by a built-in firewall and an
administrator blissfully removes the firewall rules for whatever
reason (problems with the setup, annoyance, human error...), this
system would be wide open to an attack if there were no other
hardening in the system to protect from it.

<p>On the other hand, having firewall rules on the local system also
prevents some bad things from happening. Even if the services provided
are configured securely, a firewall can protect from misconfigurations
or from fresh installed services that have not yet been properly
configured. Also, a tight configuration will prevent trojans
<em>calling home</em> from working unless the firewalling code is
removed. Note that an intruder does <em>not</em> need superuser access
to install a trojan locally that could be remotely controlled (since
binding on ports is allowed if they are not priviledge ports and
capabilities have not been removed).

<p>Thus, a proper firewall setup would be one with a default deny
policy, that is:

<list>

<item>incoming connections are allowed only to local services by allowed
machines.

<item>outgoing connections are only allowed to services used by your
system (DNS, web browsing, pop, email....)  
<footnote>Unlike personal firewalls in other operating systems, Debian
GNU/Linux does not (yet) provide firewall generation interfaces that
can make rules limiting them per process or user. However, the
iptables code can be configured to do this (see the owner module in
the <manref name="iptables" section="8"> manpage)</footnote>

<item>the forward rule denies everything (unless you are protecting
other systems, see below).

<item>all other incoming or outgoing connections are denied.

</list>

<sect1>Using a firewall to protect other systems

<p>A Debian firewall can also be installed in order to protect, with
filtering rules, access to systems <em>behind</em> it, limiting their
exposure to the Internet. The firewall can be configured to prevent
systems outside the local network to access services (ports) that are
not public. For example, on a mail server, only port 25 (where the
mail service is being given) needs to be accesible from the outside. A
firewall can be configured to, even if there are other services
besides the public ones, throw away packets (this is known as
<em>filtering</em>) directed towards them.

<p>You can even setup a Debian GNU/Linux box as a bridge firewall,
i.e. a filtering firewall completely transparent to the network that
lacks an IP address and thus cannot be attacked directly. Depending on
the kernel you have installed, you might need to might to install the
bridge firewall patch and then go to <em>802.1d Ethernet Bridging</em> when
configuring the kernel and a new option <em>netfilter ( firewalling )
suport</em>. See the <ref id="bridge-fw"> for more information on
how to setup this in a Debian GNU/Linux system).

<sect1>Configuring the firewall

<p>Of course, the configuration of the firewall is always system and
network dependant. An administrator must know beforehand what is the
network layout and the systems he wants to protect, the services that
need to be accessed, and wether or not other network considerations
(like NAT or routing) need to be taken into account. Be careful when
configuring your firewall, as Laurence J. Lane says in the
<package>iptables</package> package:

<p><em>The tools can easily be misused, causing enormous amounts of
grief by completely cripple network access to a computer system. It is
not terribly uncommon for a remote system administrator to
accidentally lock himself out of a system hundreds or thousands of
miles away. One can even manage to lock himself out of a computer
who's keyboard is under his fingers. Please, use due caution.</em>

<p>Remember this: just installing the <package>iptables</package> (or
the older firewalling code) does not give you any protection, just
provides the software. In order to have a firewall you need to
<em>configure</em> it!

<p>If you do not know much about firewalling, read the
Firewalling-HOWTO that can be found in
<package>doc-linux-text</package> package (other document formats also
available). See <ref id="references"> for more (general) pointers.

<sect2>Doing it the Debian way 

<p>If you are using Debian 3.0, you will notice that you have the
<package>iptables</package> package installed. This is the support for
the 2.4.4+ kernels netfilter implementation. Since just after
installation the system cannot <em>know</em> any firewall rules
(firewall rules are too system-specific) you have to enable iptables.
However, the scripts have been configured so that the administrator
can setup firewall rules and then have the init scripts <em>learn</em>
them and use them always as the setup for the firewall. 

<p>In order to do so you must:

<list>

<item>Configure the package so that it starts with the system. On
newer versions (since 1.2.6a-1) this is asked for when the package is
installed. You can configure it afterwards with <tt>dpkg-reconfigure
-plow iptables</tt>. <em>Note</em>: on older versions this was done by
editing <file>/etc/default/iptables</file> so that the variable
<tt>enable_iptables_initd</tt> was set to <em>true</em>.

<item>create a firewall setup using iptables, you can use the command
line (see <manref name="iptables" section="8">) or some of the tools
provided by the Debian firewall packages (see <ref
id="firewall-pack">). You need to create one set of firewall rules to
be used when the firewall is in <em>active</em> state and another to
be used when the firewall is in <em>inactive</em> state (these can be
just empty rules).

<item>save the rules you created using <tt>/etc/init.d/iptables
save_active</tt> and <tt>/etc/init.d/iptables save_active</tt> by
running these scripts with the firewall rules you want enabled.

</list>

<p>Once this is done your firewall setup is saved in the
<file>/var/lib/iptables/</file> directory and will be executed when
the system boots (or when running the initd script with <em>start</em>
and <em>stop</em> arguments). Please notice that the default Debian
setups starts the firewalling code in the multiuser runlevels (2 to 5)
pretty soon (10). Also, it is stopped in singleuser runlevel (1),
change this if it does not mach your local policy.

<p>If you do not have a clue on how to setup your firewall rules
manually consult the <em>Packet Filtering HOWTO</em> and <em>NAT
HOWTO</em> provided by <package>iptables</package> for offline reading
at <file>/usr/share/doc/iptables/html/</file>. Also, the configuration
file <file>/etc/default/iptables</file> provides some more information
about the issues regarding this package.

<sect2 id="firewall-pack">Using Firewall packages

<p>Setting up manually a firewall can be complicated for novice (and
sometimes even expert) administrators. However, the free software
community has created a number of tools that can be used to easily
configure a local firewall. Be forewarned that some of this tools are
oriented more towards local-only protection (also known as
<em>personal firewall</em>) and some are more versatile and can be
used to configure complex rules to protect whole networks.

<p>Some software that can be used to setup firewall
rules in a Debian system is:

<list>
<item><package>firestarter</package>, oriented towards end-users
including a wizard to quickly defined the firewall rules.
<item><package>knetfilter</package>
<item><package>fwbuilder</package>, an object oriented GUI which
includes policy compilers for various firewall platforms including
iptables as well as router's access-lists.
<item><package>shorewall</package> which provides support for IPsec as
well as limited support for traffic shaping as well as the definition
of the firewall rules.
<item><package>mason</package>, which can propose firewall rules based on
the network traffic your system "sees".
<item><package>bastille</package> (among the hardening steps that can make
new versions of bastille is the possibility of adding firewall rules to
the system to be executed on startup)
<item><package>ferm</package>
<item><package>fwctl</package>
<item><package>easyfw</package>
<item><package>firewall-easy</package>
<item><package>ipac-ng</package>
<item><package>gfcc</package>
<item><package>lokkit</package> or <package>gnome-lokkit</package>
</list>

<p>The last packages: gfcc,firestarter and knetfilter are
administration GUIs using either GNOME (first two) or KDE (last one)
which are much more user-oriented (i.e. for home users) than the other
packages in the list which might be more administrator-oriented.

<p>Be forewarned that some of the packages outlined previousline will
probably introduce firewalling scripts to be run when the system
boots, this will undoubtedly conflict with the common setup (if
configured) and you might undesireds effects. Usually, the firewalling
script that runs last will be the one that configures the system
(which might not be what you pretend). Consult the package
documentation and use either one of these setups. Generally, other
programs that help you setup the firewalling rules can tweak othe
conriguration files.

<p>FIXME: Add more info regarding this packages

<p>FIXME: Check Information on Debian firewalling and what/how does it
change from other distributions.

<p>FIXME: Where should the custom firewalling code be enabled (common
FAQ in debian-firewall?)

<p>FIXME: Add information on <url
id="http://www.balabit.hu/downloads/zorp/debian/" name="Zorp"> in
Debian (see <url id="http://bugs.debian.org/88347" name="Bug
#88347">. Debian packages are provided but they depend on libglib1.3
which is not yet available in Debian distribution.

<chapt>Automatic hardening of Debian systems

<p>After reading through all the information in the previous chapters
you might be wondering "I have to do quite a lot of things in order to
harden my system, couldn't this things be automated?". The question is
yes, but be careful with automated tools. Some people believe, that a
hardening tool does not eliminate the need for good administration. So
do not be fooled to think that you can automate all the process and
will fix all the related issues. Security is an ever-ongoing process
in which the administrator must participate and cannot just stand away
and let the tools do all the work since no single tool can cope: with
all the possible security policy implementations, all the attacks and
all the environments.

<p>Since woody (Debian 3.0) there are two specific packages that are
useful for security hardening. The <package>harden</package> which
takes an approach based on the package dependencies to quickly install
valuable security packages and remove those with flaws, configuration
of the packages must be done by the administrator. The
<package>bastille</package> that implements a given security policy on
the local system based on previous configuration by the administrator
(the building of the configuration can be a guided process done with
simple yes/no questions).

<sect>Harden

<p>The <package>harden</package> package tries to make it more easy to
install and administer hosts that need good security . This package
should be used by people that want some quick help to enhance the
security of the system. To do this it conflicts with packages with
known flaws, including (but not limited to): known security bugs (like
buffer overflows), use of plaintext passwords, lack of access control,
etc. It also automatically installs some tools that should enhance
security in some way: intrusion detection tools, security analysis
tools, etc. Harden installs the following <em>virtual</em> packages
(i.e. no contents, just dependencies on others):

<list>

<item><package>harden-tools</package>: tools to enhance system
security (integrity checkers, intrusion detection, kernel patches...)

<item><package>harden-doc</package>: provides this same manual and
other security-related documentation packages.

<item><package>harden-environment</package>: helps configure a
hardened environment (currently empty).

<item><package>harden-servers</package>: removes servers considered
insecure for some reason.

<item><package>harden-clients</package>: removes clients considered
insecure for some reason.

<item><package>harden-remoteflaws</package>: removes packages with
known security holes that could be used by a remote attacker to
compromise the system (uses versioned <em>Conflicts:</em>).

<item><package>harden-localflaws</package>: removes packages with known
security holes that could be used by a local attacker to compromise
the system (uses versioned <em>Conflicts:</em>).

<item><package>harden-remoteaudit</package>: tools to remotely audit a
system.

</list>

<p>Be careful because if you have software you need (and which you do
not wish to uninstall for some reason) and it conflicts with some of the
packages above you might not be able to fully use
<package>harden</package>.

The harden packages do not (directly) do a thing. They do have,
however, intentional package conflicts with known non-secure packages.
This way, the Debian packaging system will not approve the installation
of these packages. For example, when you try to install a telnet daemon
with <package>harden-servers</package>, apt will say:

<example>
# apt-get install telnetd 
The following packages will be REMOVED:
	harden-servers
The following NEW packages will be installed:
telnetd 
Do you want to continue (Y/n)
</example>

<p>This should set off some warnings in the administrator head, who should
reconsider his actions.

<sect>Bastille Linux

<p><url name="Bastille Linux" id="http://www.bastille-linux.org"> is
an automatic hardening tool originally oriented towards the RedHat and
Mandrake Linux distributions. However, the <package>bastille</package>
package provided in Debian (since woody) is patched in order to
provide the same functionality for the Debian GNU/Linux system.

<p>Bastille can be used with different frontends (all are documented
in their own manpage in the Debian package) which enables the
administrator to:

<list>

<item>Answer questions step by step regarding the desired security of
your system (using <manref name="InteractiveBastille" section="8">)

<item>Use a default setting for security (amongst three: Lax, Moderate
or Paranoia) in a given setup (server or workstation) and let Bastille
decide which security policy to implement (using <manref
name="BastilleChooser" section="8">)

<item>Take a predefined configuration file (could be provided by
Bastille or made by the administrator) and implement a given security
policy (using <manref name="AutomatedBastille" section="8">)

</list>

<chapt>Debian Security Infraestructure

<sect id="debian-sec-team">The Debian Security Team

<p>Debian has a Security Team, made up of five members and two
secretaries who handle security in the <em>stable</em>
distribution. Handling security means they keep track of
vulnerabilities that arise in software (watching forums such as
bugtraq, or vuln-dev) and determine if the <em>stable</em>
distribution is affected by it.

<p>Also, the Debian Security Team, is the contact point for problems
that are coordinated by upstream developers or organisations such as
<url id="http://www.cert.org" name="CERT"> which might affect multiple
vendors. That is, when problems are not Debian-specific. There are two
contact points with the Security Team:

<list>

<item><url id="mailto:team@security.debian.org"
name="team@security.debian.org"> which only the members of the
security team read. 

<item><url id="mailto:security@debian.org" name="security@debian.org">
which is read by all Debian developers (including the security
team). Mails sent to this list are not published in the Internet (it's
not a public mailing list).

</list>

<p>Sensitive information should be sent to the first address and, in
some cases, should be encrypted with the Debian Security Contact key
(key ID 363CCD95).

<p>Once a probable problem is received by the Security Team it will
investigate if the <em>stable</em> distribution is affected, if it is,
a fix is worked for the source code base. This fix will sometimes
include backporting the patch made upstream (which usually is some
versions ahead of the one distributed by Debian). After testing of the
fix is done, new packages are prepared and published in the <url
id="security.debian.org"> site so they can be retrieved through
<prgn>apt</prgn> (see <ref id="security-update">). At the same time a
<em>Debian Security Advisory</em> (DSA) is published on the web site
and sent to public mailing lists including <url
id="lists.debian.org/debian-security-announce"
name="debian-security-announce"> and bugtraq.

<p>Some other frequently asked questions on the Debian Security Team can be
found at <ref id="debian-sec-team-faq">.


<sect id="dsa">Debian Security Advisories

<p>Debian Security Advisories are made whenever a security
vulnerability is discovered that affects a Debian package. This
advisories, signed by one of the Security Team members, include
information of the versions affected as well as the location of the
updates and their MD5sums. This information is:

<list>
<item>version number for the fix.
<item>problem type.
<item>wether it is remote or locally exploitable.
<item>short description of the package.
<item>description of the problem.
<item>description of the exploit.
<item>description of the fix.
</list>


<p>DSAs are published both in <url id="http://www.debian.org/"
name="Debian's mainserver frontpage"> and in the <url
id="http://www.debian.org/security/" name="Debian security
pages">. Usually this does not happen until the website is rebuilt
(once daily) so they might not be present inmediately, the prefered
channel is the debian-security-announce mailing list.

<p>Interested users can, however (and this is done in some
Debian-related portals) use the RDF channel to download automatically
the DSAs to their desktop. Some applications, such as
<prgn>Evolution</prgn> (an email client and personal information
assistant) and <prgn>Multiticker</prgn> (a GNOME applet), can be used
to retrieve the advisories automatically. The RDF channel is available
at <url id="http://www.debian.org/security/dsa.rdf">.

<p>DSAs published on the website might be updated after being sent to
the public-mailing lists. A common update is adding cross references
to security vulnerability databases such as <url
id="http://cve.mitre.org" name="CVE">, <url id="http://www.cert.org"
name="CERT/CC vulnerability notes"> or <url
id="http://www.securityfocus.com/bid/" name="Bugtraq">. This feature was added to
the website on june 2002.

<p>One of the advantages of adding cross references to these
vulnerability databases is that:

<list>
<item>it makes Debian users easier to see and track which
general (published) advisories have already been covered by Debian. 

<item>system administrators can learn more of the vulnerability and
its impact by following the cross references.

<item>this information can be used to cross-check output from
vulnerability scanners that include references to CVE to remove false
positives (see <ref id="vulnasses-false-positive">).

</list>

<sect>Debian Security Build Infraestructure

<p>Since Debian is currently supported in a large number of
arquitectures, administrators sometimes wonder if a given arquitecture
might take more time to receive security updates than another. As a
matter of fact, except for rare circumstances, updates are available
to all arquitectures at the same time.

<p>While previously the task to build security updates was done by
hand, it is currently not (as Anthony Thowns describes in a mail
sent to the debian-devel-announce mailing list dated 8th june
2002. FIXME: add pointer).

<p>Packages uploaded by the security team (to <url
id="security.debian.org:/org/security.debian.org/queue/unchecked"> or
<url id="ftp://security.debian.org/pub/SecurityUploadQueue">
with an appropiate patch are checked for signatures withing fifteen
minutes of being uploaded, once this is done they get added to the
list of the autobuilders (which no longer do a daily archive
run). Thus, packages can get automatically built for <em>all</em>
arquitectures thirty minutes or an hour or so after they're uploaded.
However, security updates are a little more different than normal
uploads sent by package maintainers since, in some cases, before being
published they need to wait until they can be tested further, an
advisory written, or need to wait for a week or more to avoid
publicising the flaw until all vendors have had a reasonable chance to
fix it. 

<p>Thus, the security upload archive works with the following
procedure (called 
<em>"Accepted-Autobuilding</em>):

<list>

<item>Someone finds a security problem.
     
<item>Someone fixes the problem, and makes an upload to
      security.debian.org's incoming (this <em>someone</em> is usually
      a Security Team member but can be also a package maintainer with
      an appropiate fix that has contacted the Security Team
      previously). The Changelog includes a <em>testing-security</em>
      or <em>stable-security</em> as target distribution.

<item>The upload gets checked and processed by a Debian system and moved
       into queue/accepted, and the buildds are notified. Files in here
       can be accessed by the security team and (somewhat indirectly) by 
       the buildds.

<item>Security-enabled buildds pick up the source package
       (prioritized over normal builds), build it, and send the logs to
       the security team.

<item>The security team reply to the logs, and the newly built
       packages are uploaded to queue/unchecked, where they're processed
       by a Debian system, and moved into queue/accepted.

<item>When the security team find the source package acceptable (i.e.,
       that it's been correctly built for all applicable architectures
       and that it fixes the security hole and doesn't introduce new
       problems of its own) they run a script which:

<list>
<item>installs the package into the security archive.

<item>updates the Packages, Sources and Release files of
security.debian.org in the usual way (<prgn>dpkg-scanpackages</prgn>,
<prgn>dpkg-scansources</prgn>...)

<item>sets up a template advisory that the security team can finish
off.

<item>(optionally) forwards the packages to the appropriate
proposed-updates so that it can be included in the real archive as
soon as possible.

</list>

</list>

<p>This procedure, previously done by hand, was tested and put through
during the freezing stage of Debian 3.0 woody (july 2002). Thanks to this
infraestructure the Security Team was able to have updated packages
ready for the apache and OpenSSH issues for all the supported (almost
twenty) arquitectures in less than a day.

<sect1>Developer's guide to security updates

<p>This mail was sent by Wichert Akkerman to the <url
id="+http://lists.debian.org/debian-devel-announce/2002/debian-devel-announce-200206/msg00004.html"
name="Debian-devel-announce mailing list"> in order to describe Debian
developer's behaviour for handling security problems in their
packages. It is published here both for the benefit of developers as
well as for users to understand better how security is handled in Debian.

<sect2>Coordinating with the security team

<p>If a developer learns of a security problem, either in his package
or someone else's he should always contact the security team (at
team@security.debian.org). They keep track of outstanding security
problems, can help maintainers with security problems or fix them
themselves, are responsible for sending security advisories and
maintaining security.debian.org.

<p>Please note that security advisories are only done for release
distributions, not for testing, unstable (see <ref id="sec-unstable">)
or older distributions (see <ref id="sec-older">).

<sect2>Learning of security problems

<p>There are a few ways a developer can learn of a security problem:

<list>
<item>he notices it on a public forum (mailing list, website, etc.):
<item>someone files a bugreport (the <em>Security</em> tag should be
used, or added by the developer)
<item>someone informs him via private email.
</list>

<p>In the first two cases the information is public and it is important
to have a fix as soon as possible. In the last case however it might
not be public information. In that case there are a few possible options
for dealing with the problem:

<list>

<item>if it is a trivial problem (like insecure temporary files) there is no
  need to keep the problem a secret and a fix should be made and
  released.

<item>if the problem is severe (remote exploitable, possibility to gain root
  privileges) it is preferable to share the information with other
  vendors and coordinate a release. The security team keeps contacts
  with the various organizations and individuals and can take care of
  that.

</list>

<p>In all cases if the person who reports the problem asks to not
disclose the information that should be respected, with the obvious
exception of informing the security team (the developer should make
sure he tells the security team that the information can not be
disclosed).

<p>Please note that if secrecy is needed the developer can also not
upload a fix to unstable (or anywhere else), since the changelog
information for unstable is public information.

<p>There are two reasons for releasing information even though secrecy
is requested/required: the problem has been known for too long, or
the information becomes public.

<sect2>Building a package

<p>The most important guideline when making a new package that fixes a
security problem is to make as few changes as possible. People are
relying on the exact behaviour of a release once it is made, so any
change made to it can possibly break someone's system. This is
especially true of libraries: the developer must make sure he never
changes the API or ABI, no matter how small the change.

<p>This means that moving to a new upstream version is not a good solution,
instead the relevant changes should be backported. Generally upstream
maintainers are willing to help if needed, if not the Debian security
team might be able to help.

<p>In some cases it is not possible to backport a security fix, for
example when large amounts of sourcecode need to be modified or
rewritten. If that happens it might be necessary to move to a new
upstream version, but it should always be coordinated with the security team
beforehand.

<p>Related to this is another import aspect: developers must always
test your change. If their is an exploit the developer should try if
it indeed succeeds on the unpatched package and fails on the fixed
package. The developer should try normal usage as well, sometimes a
security fix can break normal use subtly.

<p>Finally a few technical things for developers to keep in mind:

<list>
<item>Make sure you target the right distribution in your debian/changelog.
  For stable this is stable-security and for testing this is
  testing-security. Do not target &lt;codename&gt;-proposed-updates.

<item>Make sure the version number is proper. It has to be higher than the
  current package, but lower than package versions in later
  distributions. For testing this means there has to be a higher version
  in unstable. If there is none yet (testing and unstable have the same
  version for example) upload a new version to unstable first.

<item>Do not make source-only uploads if your package has any binary-all
  packages. The buildd infrastructure will not build those.

<item>Make sure when compiling a package you compile on a clean system
  which only has package installed from the distribution you are
  building for. If you do not have such a system yourself yourself you
  can try a debian.org machine (see http://db.debian.org/machines.cgi
  or setup a chroot (the <package>pbuilder</package> and
  <package>debootstrap</package> packages can be helpful in that
  case).)

</list>

<sect2>Uploading security fixes

<p>After the developer has created and tested the new package it needs to be
uploaded so it can be installed in the archives. For security uploads
the place to upload to is
ftp://security.debian.org/pub/SecurityUploadQueue/ .

<p>Once an upload to the security queue has been accepted the package will
automatically be rebuilt for all architectures and stored for
verification by the security team.

<p>Uploads waiting for acceptance or verification are only accessible by
the security team. This is necessary since there might be fixes for
security problems that can not be disclosed yet.

<p>If a member of the security team accepts a package it will be installed
on security.debian.org as well as the proper &lt;codename&gt;-proposed-updates
in ftp-master or non-US archive.

<sect2>The security advisory

<p>Security advisories are written and posted by the security team. However
they certainly do not mind if a maintainer can supply (part of) the text
for them. Information that should be in an advisory is described in
<ref id="dsa">.

<sect id="deb-pack-sign">Package signing in Debian

<p>This section could also be titled "how to upgrade/update safely
your Debian GNU/Linux system" and it deserves its own section
basically because it is an important part of the Security
Infraestructure. Package signing is an important issue since it avoids
tampering of packages distributed in mirrors and of downloads with
man-in-the-middle attacks. Automatic software update is an important
feature but it's also important to remove security threats that could
help the distribution of trojans and the compromise of systems during
updates
<footnote>
<p>Some operating systems have already been plagued with
automatic-updates problems such as the
<url name="Mac OS X Software Update vulnerabity"
id="http://www.cunap.com/~hardingr/projects/osx/exploit.html">.
<p>FIXME: probably the Internet Explorer vulnerability handling
certificate chains has an impact on security updates on Microsoft Windows.
</footnote>


<p>As of today (december 2001) Debian does not provide signed packages for
the distribution and the <em>woody</em> release (3.0) does not integrate that
feature. There is a solution for signed packages which will
be, hopefully, provided in the next release (<em>sarge</em>).

<p>This issue is better described in the
<url id="http://www.cryptnet.net/fdp/crypto/strong_distro.html" name="Strong
Distribution HOWTO"> by V. Alex Brennen.

<sect1>The proposed scheme for package signature checks

<p>The current (unimplemented) scheme for package signature checking
using <prgn>apt</prgn> is:

<list>
<item>the Release file includes the md5sum of Packages.gz 
(which contains the md5sums of packages) and will be signed.
The signature is one of a trusted source.

<item>This signed Release file is downloaded by 'apt-get update'
and stored in the HD along with Packages.gz.

<item>When a package is going to be installed, it is first downloaded,
then the md5sum is generated.

<item>The signed Release file is checked (signature ok) and it extracts from
it the md5sum for the Packages.gz file, the Packages.gz checksum is generated
and (if ok) the md5sum of the downloaded package is extracted from it.

<item>If the md5sum from the downloaded package is the same as the one in the
Packages.gz file the package will be 
installed otherwise the administrator will be alerted and the package will
be left in cache (so the administrator can decide wether to install it or not). 
If the package is not in the Packages.gz and the administrator has configured
the system to only install checked packages it will not be installed either.
</list>

<p>By following the chain of MD5 sums <prgn>apt</prgn> is capable of verifying
that a package originates from a a specific release. This is less
flexible than signing each package one by one, but can be combined with
that scheme too (see below).

<p>Package signing has been discussed in Debian for quite some time, for
more information you can read:
<url id="http://www.debian.org/News/weekly/2001/8/"> and
<url id="http://www.debian.org/News/weekly/2000/11/">.

<sect1>Alternative per-package signing scheme

<p>The additional scheme of signing each and every packages allows
packages to be checked when they are no longer referenced by an
existing Packages file, and also third-party packages where no
Packages ever existed for them can be also used in Debian but will not
be default scheme.

<p>This package signing scheme can be implemented using
<package>debsig-verify</package>and <package>debsigs</package>.
These two packages can sign and verify
embeded signatures in the .deb itself. Debian already has the
capability to do this now, but implementing the policy and tools 
won't be started until after woody releases.

<p>Latest dpkg versions (since 1.9.21) incorporate a 
<url
id="http://lists.debian.org/debian-dpkg/2001/debian-dpkg-200103/msg00024.html"
name="patch"> that provides this functionality as soon as 
<package>debsig-verify</package> is installed.

<p>NOTE: Currently <file>/etc/dpkg/dpkg.cfg</file> ships with
"no-debsig" as per default.

<p>NOTE2: Signatures from developers are currently stripped when they
enter off the package archive since the currently preferred method is
release checks as described previously.

<sect1 id="check-releases">Checking distribution releases

<p>In case you want to add now the additional security checks you can
use the script below, provided by Anthony Thown.  This script can
automatically do some new security checks to allow the user to be sure
that the software s/he's downloading matches the software Debian's
distributing.  This stops Debian developers from hacking into
someone's system without the accountability provided by uploading to
the main archive, or mirrors mirroring something almost, but not quite
like Debian, or mirrors providing out of date copies of unstable with
known security problems.

<p>This sample code, renamed as <prgn>apt-check-sigs</prgn>, should be 
used in the following way:
<example>
# apt-get update
# apt-check-sigs
(...results...)
# apt-get dist-upgrade
</example>

<p>First you need to:

<list>

<item>get the keys the archive software uses to to sign Release files,
<url id="http://ftp-master.debian.org/ziyi_key_2002.asc"> and add them
to <file>~/.gnupg/trustedkeys.gpg</file> (which is what
<prgn>gpgv</prgn> uses by default).
<example>
  gpg --no-default-keyring --keyring trustedkeys.gpg --import ziyi_key_2002.asc
</example>

<item>remove any <file>/etc/apt/sources.list</file> lines that don't
 use the normal "dists" structure, or change the script so that it
 works with them.

<item>be prepared to ignore the fact that Debian security updates don't
have signed Release files, and that Sources files don't have
appropriate checksums in the Release file (yet).

<item>be prepared to check that the appropriate sources are signed by
the appropriate keys.

</list>

<p>This is the example code for <prgn>apt-check-sigs</prgn>, the
latest version can be retrieved from <url
id="http://people.debian.org/~ajt/apt-check-sigs">.
This code is currently in beta, for more information read
<url id="http://lists.debian.org/debian-devel/2002/debian-devel-200207/msg00421.html">.

<example>
#!/bin/bash
# This script is copyright (c) 2001, Anthony Towns
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
# 
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

rm -rf /tmp/apt-release-check
mkdir /tmp/apt-release-check || exit 1
cd /tmp/apt-release-check

>OK
>MISSING
>NOCHECK
>BAD

arch=`dpkg --print-installation-architecture`

am_root () {
        [ `id -u` -eq 0 ]
}

get_md5sumsize () {
        cat "$1" | awk '/^MD5Sum:/,/^SHA1:/' | 
          MYARG="$2" perl -ne '@f = split /\s+/; if ($f[3] eq $ENV{"MYARG"}) { print "$f[1] $f[2]\n"; exit(0); }'
}
checkit () {
        local FILE="$1"
        local LOOKUP="$2"

        Y="`get_md5sumsize Release "$LOOKUP"`"
        Y="`echo "$Y" | sed 's/^ *//;s/  */ /g'`"

        if [ ! -e "/var/lib/apt/lists/$FILE" ]; then
                if [ "$Y" = "" ]; then
                        # No file, but not needed anyway
                        echo "OK"
                        return
                fi
                echo "$FILE" >>MISSING
                echo "MISSING $Y"
                return
        fi
        if [ "$Y" = "" ]; then
                echo "$FILE" >>NOCHECK
                echo "NOCHECK"
                return
        fi
        X="`md5sum < /var/lib/apt/lists/$FILE` `wc -c < /var/lib/apt/lists/$FILE`"
        X="`echo "$X" | sed 's/^ *//;s/  */ /g'`"
        if [ "$X" != "$Y" ]; then
                echo "$FILE" >>BAD
                echo "BAD"
                return
        fi
        echo "$FILE" >>OK
        echo "OK"
}

echo
echo "Checking sources in /etc/apt/sources.list:"
echo "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
echo
(echo "You should take care to ensure that the distributions you're downloading"
echo "are the ones you think you are downloading, and that they are as up to"
echo "date as you would expect (testing and unstable should be no more than"
echo "two or three days out of date, stable-updates no more than a few weeks"
echo "or a month)."
) | fmt
echo

cat /etc/apt/sources.list | 
  sed 's/^ *//' | grep '^[^#]' |
  while read ty url dist comps; do
        if [ "${url%%:*}" = "http" -o "${url%%:*}" = "ftp" ]; then
                baseurl="${url#*://}"
        else
                continue
        fi
        echo "Source: ${ty} ${url} ${dist} ${comps}"
        
        rm -f Release Release.gpg
        wget -q -O Release "${url}/dists/${dist}/Release"

        if ! grep -q '^' Release; then
                echo "  * NO TOP-LEVEL Release FILE"
        else
                origline=`sed -n 's/^Origin: *//p' Release | head -1`
                lablline=`sed -n 's/^Label: *//p' Release | head -1`
                suitline=`sed -n 's/^Suite: *//p' Release | head -1`
                codeline=`sed -n 's/^Codename: *//p' Release | head -1`
                dateline=`grep "^Date:" Release | head -1`
                dscrline=`grep "^Description:" Release | head -1`
                echo "  o Origin: $origline/$lablline"
                echo "  o Suite: $suitline/$codeline"
                echo "  o $dateline"
                echo "  o $dscrline"

                if [ "${dist%%/*}" != "$suitline" -a "${dist%%/*}" != "$codeline" ]; then
                        echo "  * WARNING: asked for $dist, got $suitline/$codeline"
                fi

                wget -q -O Release.gpg "${url}/dists/${dist}/Release.gpg"
                sigline="`gpgv --status-fd 3 Release.gpg Release 3>&1 >/dev/null 2>&1 | sed -n "s/^\[GNUPG:\] GOODSIG [0-9A-Fa-f]* //p"`"
                if [ "$sigline" ]; then
                        echo "  o Signed by: $sigline"
                else
                        echo "  * NO VALID SIGNATURE"
                        >Release
                fi
        fi
        okaycomps=""
        for comp in $comps; do
                if [ "$ty" = "deb" ]; then
                        X=$(checkit "`echo "${baseurl}/dists/${dist}/${comp}/binary-${arch}/Release" | sed 's,//*,_,g'`" "${comp}/binary-${arch}/Release")
                        Y=$(checkit "`echo "${baseurl}/dists/${dist}/${comp}/binary-${arch}/Packages" | sed 's,//*,_,g'`" "${comp}/binary-${arch}/Packages")
                        if [ "$X $Y" = "OK OK" ]; then
                                okaycomps="$okaycomps $comp"
                        else
                                echo "  * PROBLEMS WITH $comp ($X, $Y)"
                        fi
                elif [ "$ty" = "deb-src" ]; then
                        X=$(checkit "`echo "${baseurl}/dists/${dist}/${comp}/source/Release" | sed 's,//*,_,g'`" "${comp}/source/Release")
                        Y=$(checkit "`echo "${baseurl}/dists/${dist}/${comp}/source/Sources" | sed 's,//*,_,g'`" "${comp}/source/Sources")
                        if [ "$X $Y" = "OK OK" ]; then
                                okaycomps="$okaycomps $comp"
                        else
                                echo "  * PROBLEMS WITH component $comp ($X, $Y)"
                        fi
                fi
        done
        [ "$okaycomps" = "" ] || echo "  o Okay:$okaycomps"
        echo
  done

echo "Results"
echo "~~~~~~~"
echo

allokay=true

cd /tmp/apt-release-check
diff <(cat BAD MISSING NOCHECK OK | sort) <(cd /var/lib/apt/lists && find . -type f -maxdepth 1 | sed 's,^\./,,g' | grep '_' | sort) | sed -n 's/^> //p' >UNVALIDATED

cd /tmp/apt-release-check
if grep -q ^ UNVALIDATED; then
    allokay=false
    (echo "The following files in /var/lib/apt/lists have not been validated."
    echo "This could turn out to be a harmless indication that this script"
    echo "is buggy or out of date, or it could let trojaned packages get onto"
    echo "your system."
    ) | fmt
    echo
    sed 's/^/    /' < UNVALIDATED
    echo
fi

if grep -q ^ BAD; then
    allokay=false
    (echo "The contents of the following files in /var/lib/apt/lists does not"
    echo "match what was expected. This may mean these sources are out of date,"
    echo "that the archive is having problems, or that someone is actively"
    echo "using your mirror to distribute trojans."
    if am_root; then 
        echo "The files have been renamed to have the extension .FAILED and"
        echo "will be ignored by apt."
        cat BAD | while read a; do
            mv /var/lib/apt/lists/$a /var/lib/apt/lists/${a}.FAILED
        done
    fi) | fmt
    echo
    sed 's/^/    /' < BAD
    echo
fi

if grep -q ^ MISSING; then
    allokay=false
    (echo "The following files from /var/lib/apt/lists were missing. This"
    echo "may cause you to miss out on updates to some vulnerable packages."
    ) | fmt
    echo
    sed 's/^/    /' < MISSING
    echo
fi

if grep -q ^ NOCHECK; then
    allokay=false
    (echo "The contents of the following files in /var/lib/apt/lists could not"
    echo "be validated due to the lack of a signed Release file, or the lack"
    echo "of an appropriate entry in a signed Release file. This probably"
    echo "means that the maintainers of these sources are slack, but may mean"
    echo "these sources are being actively used to distribute trojans."
    if am_root; then 
        echo "The files have been renamed to have the extension .FAILED and"
        echo "will be ignored by apt."
        cat NOCHECK | while read a; do
            mv /var/lib/apt/lists/$a /var/lib/apt/lists/${a}.FAILED
        done
    fi) | fmt
    echo
    sed 's/^/    /' < NOCHECK
    echo
fi

if $allokay; then
    echo 'Everything seems okay!'
    echo
fi

rm -rf /tmp/apt-release-check
</example>

<p>You might need to apply the following patch for <em>sid</em> since
<prgn>md5sum</prgn> adds an '-' after the sum when the input is stdin:

<example>
@@ -37,7 +37,7 @@
        local LOOKUP="$2"

        Y="`get_md5sumsize Release "$LOOKUP"`"
-       Y="`echo "$Y" | sed 's/^ *//;s/  */ /g'`"
+       Y="`echo "$Y" | sed 's/-//;s/^ *//;s/  */ /g'`"

        if [ ! -e "/var/lib/apt/lists/$FILE" ]; then
                if [ "$Y" = "" ]; then
@@ -55,7 +55,7 @@
                return
        fi
        X="`md5sum < /var/lib/apt/lists/$FILE` `wc -c < /var/lib/apt/lists/$FILE`"
-       X="`echo "$X" | sed 's/^ *//;s/  */ /g'`"
+       X="`echo "$X" | sed 's/-//;s/^ *//;s/  */ /g'`"
        if [ "$X" != "$Y" ]; then
                echo "$FILE" >>BAD
                echo "BAD"
</example>

<chapt id="sec-tools">Security tools in Debian

<p>FIXME: More content needed.

<p>Debian provides also a number of security tools that can make a
Debian box suited for security purposes. This purposes include
protection of information systems through firewalls (either packet or
application-level), intrusion detection (both network and host based),
vulnerability assesment, antivirus, private networks, etc.

<p>Since Debian 3.0 (<em>woody</em>), the distribution features
cryptographic software integrated into the main distribution. OpenSSH
and GNU Privacy Guard are included in the default install, and strong
encryption is now present in web browsers and web servers, databases,
and so forth. Further integration of cryptography is planned for
future releases. This software, due to export restrictions in the US,
was not distributed along with the main distribution but included only
in non-US sites.

<sect id="vuln-asses">Remote vulnerability assesment tools
<p>The tools provided by Debian to perform remote vulnerability assesment
are:
<footnote>
Some of them are provided
when installing the <package>harden-remoteaudit</package> package.
</footnote>
<list>
<item>nessus
<item>raccess
<item>whisker 
<item>nikto (whisker's replacement)
<item>bass (non-free)
<item>satan (non-free)
<!-- currently uploaded but not included
<item>saint (non-free)
<item>sara (non-free)
-->
</list>

<p>By far, the most complete and up-to-date tools is <package>nessus</package>
which is composed of a client (<package>nessus</package>) used as a GUI
and a server (<package>nessusd</package>) which launches the programmed
attacks. Nessus includes remote vulnerabilities for quite a number of 
systems including network appliances, ftp servers, www servers, etc. The
latest releases are able even to parse a web site and try to discover
which interactive pages are available which could be attacked. There are
also Java and Win32 clients (not included in Debian) which can be used
to contact the management server.

<p><package>Whisker</package> is a web-only vulnerability assessment scanner
including anti-IDS tactics (most of which are not <em>anti-IDS</em> anymore).
It is one of the best cgi-scanners available, being able to detect 
WWW servers and launch only a given set of attacks against it. The database
used for scanning can be easily modified to provide for new information.

<p><package>Bass</package> (Bulk Auditing Security Scanner) 
and <package>Satan</package> (Security Auditing Tool for Analysing Networks)
must be thought of more like "proof of concept" programs than 
as tools to be used
while performing audits. Both are quite ancient and are not kept up-to-date.
However, SATAN was the first tool to provide vulnerability assesment in
a simple (GUI) way and Bass is still a very high-perfomance assesment tool.

<sect>Network scanner tools
<p>Debian does provide some tools used for remote scanning of hosts 
(but not vulnerability assesment). These tools are, in some cases,
used by vulnerability assesment scanners as the first type of 
"attack" run against remote hosts in an attempt to 
determine remote services available. Currently Debian provides:
<list>
<item>nmap
<item>xprobe
<item>queso
<item>knocker
<item>hping2
<item>isic
<item>icmpush
<item>nbtscan
<item>fragrouter
</list>

<p>Whileas <package>queso</package> and <package>xprobe</package> provide
only remote operating system detection (using TCP/IP fingerprinting),
<package>nmap</package> and <package>knocker</package> do both operating
system detection and port scanning of the remote hosts. On the other
hand, <package>hping2</package> and <package>icmpush</package> can be
used for remote ICMP attack techniques.

<p>Designed specifically for Netbios networks, <package>nbtscan</package>
can be used to scan IP networks and retrieve name information from 
SMB-enabled servers, including: usernames, network names, MAC
addresses...

<p>On the other hand, <package>fragrouter</package> can be used to
test network intrusion detection systems and see if the NIDS can be
eluded by fragmentation attacks.

<p>FIXME: Check <url id="http://bugs.debian.org/153117" name="Bug
#153117"> (ITP fragrouter) to see if it's included.


<p>FIXME add information based on
<url id="http://rr.sans.org/linux/debian_laptop.php"
name="Debian Linux Laptop for Road Warriors"> which describes how to
use Debian and a laptop to scan for wireless (803.1) networks.

<sect>Internal audits
<p>Currently, only the <package>tiger</package> tool used in Debian can
be used to perform internal (also called white box) audit of hosts in
order to determine if the filesystem is properly setup, which processes
are listening on the host, etc.

<sect>Auditing source code
<p>Debian provides two packages that can be used to audit C/C++ source code
programs and find programming errors that might lead to potential security
flaws:
<list>
<item>flawfinder
<item>rats
</list>

<sect id="vpn">Virtual Private Networks

<p>FIXME: Content needed

<p>Debian provides quite a number of package to setup encrypted
 virtual private networks:

<list>

<item><package>vtun</package>
<item><package>tunnelv</package>
<item><package>cipe</package>
<item><package>vpnd</package>
<item><package>tinc</package>
<item><package>secvpn</package>
<item><package>pptpd</package>
<item><package>freeswan</package>

</list>

<p>IPsec (i.e. FreeSWAN) is probably the best choice overall since it
promises to interoperate with most anything that runs IPsec, but these
other packages can help you get a secure tunnel up in a hurry.  PPTP
is a Microsoft protocol for VPN.  It is supported under Linux, but is
known to have serious security issues.

<p>For more information read <url
id="http://www.linuxdoc.org/HOWTO/VPN-Masquerade-HOWTO.html"name="VPN-Masquerade
HOWTO"> (covers IPsec and PPTP) <url
id="http://www.linuxdoc.org/HOWTO/VPN-HOWTO.html"name="VPN HOWTO">
(covers PPP over SSH), and <url
id="http://www.linuxdoc.org/HOWTO/mini/Cipe+Masq.html" name="Cipe
mini-HOWTO">, <url
id="http://www.linuxdoc.org/HOWTO/mini/ppp-ssh/index.html"name="PPP
and SSH mini-HOWTO">.

<sect1>Point to Point tunneling

<p>If you want to provide a tunneling server for a mixed environment
(both Microsoft operating systems and Linux clients) and IPsec is not
an option (since it's only provided for Windows 2000 and Windows XP)
you can use <em>PoPToP</em> (Point to Point Tunneling Server),
provided in the <package>pptpd</package>.

<p>If you want to use Microsoft's authentication and encryption 
with the server provided in the <package>ppp</package> package note
that (from the FAQ):

<example>
It is only necessary to use PPP 2.3.8 if you want Microsoft compatible
MSCHAPv2/MPPE authentication and encryption. The reason for this is that
the MSCHAPv2/MPPE patch currently supplied (19990813) is against PPP
2.3.8. If you don't need Microsoft compatible authentication/encryption
any 2.3.x PPP source will be fine.
</example>

<p>However, you have to apply also the kernel patch provided by the
<package>kernel-patch-mppe</package> package which provides the
pp_mppe module for pppd. 

<p>Take in acount that the encryption in ppptp
forces you to store userpasswords in cleartext. And also, MS-CHAPv2
contains
<url id="http://mopo.informatik.uni-freiburg.de/pptp_mschapv2/"
name="known security holes">.



<sect>Public Key Infraestructure (PKI)

<p>When considering a PKI you are confronted to a wide variety of tools:

<list>
<item>a Certificate Authority that can give out certificates and can
work under a given hierarchy

<item>a Directory to hold user's public certificates

<item>a Database (?) to maintain Certificate Revocation Lists

<item>devices that interoperate with the CA in order to print out
smartcards/usb tokens/whatever to securely store certificates

<item>applications certificate-aware that can use certificates given out by a
CA to enroll in encrypted communication and check given certificates
against CRL (for authentication and full Single Sign On solutions)

<item>a Timestamping authority to digitally sign documents

<item>a management console from which all of this can be properly used
(certificate generation, revocation list control, etc...)

</list>

<p>You can use some of the software available in Debian GNU/Linux to
cover some of this tools, this includes openSSL (for certificate
generation), OpenLDAP (as a directory to hold the certificates), gnupg
and freeswan (with X.509) support. However, the operating system does
not provide (as of the woody release, 3.0) any of the freely availabe
Certificate Authorities available such as pyCA, <url
id="http://www.openca.org" name="OpenCA"> or the CA samples from
OpenSSL. For more information read the <url
id="http://ospkibook.sourceforge.net/" name="Open PKI book">.

<sect>SSL Infraestructure

<p>Debian does provide some SSL certificates with the distribution so
they can be installed locally. SSL certificates are distributed in the
<package>ca-certificates</package>. This package provides a central
repository of certificates that have been submitted to Debian and
approved (that is, verified) by the package maintainer.

<p>FIXME: read debian-devel to see if there was something added to this.


<sect>Anti-virus tools
<p>There are not that many anti-virus tools in Debian, probably
because GNU/Linux users are not that much plagued currently by
virii. There have been, however, worms and virii for GNU/Linux
even if there has not (yet, hopefully) been any virus that
has spread on the wild over any Debian distribution. In any
case, administrators might want to build up anti-virus gateways
or protect themselves against them.

<p>Debian provides currently the following tools for building
anti-virus environments:
<list>
<item><url id="http://packages.debian.org/sanitizer" name="sanitizer">, a tool
that can be used to filter email from procmail and remove virii.
<item><url id="http://packages.debian.org/amavis-postfix" name="amavis-postfix">, a
script that provides an interface from the mail transport agent to one 
or more virus scanners (this package provides the postfix version).
<item><package>scannerdaemon</package> a daemon written in Java that accepts 
incoming requests to scan files for viruses.
</list>

<p>As you can see, Debian does not currently provide any anti-virus
software in the main distribution. There are, however, free software
anti-virus projects which might (in the future) be included in Debian:

<list>
<item><url id="http://sourceforge.net/projects/openantivirus/" name="Open
Antivirus"> (see 
<url
id="http://bugs.debian.org/150698" name="Bug #150698 (ITP oav-scannerdaemon"> and
<url
id="http://bugs.debian.org/150695" name="Bug #150695 (ITP oav-update">).

<item><url id="http://clamav.elektrapro.com/" name="Clam
Antivirus">

<item><url id="http://sourceforge.net/projects/jvirus/"
name="jvirus">.

<item><url id="http://www.sourceforge.net/projects/amavis"
name="Amavis Next Generation">, a mail virus scanner which integrates
with MTA setups and supports multiple virus scanning engines (see <url
id="http://bugs.debian.org/154294" name="Bug #154294">).

</list>

<p>There is also a <package>virussignatures</package> package
which provides signatures for all packages, this package provides a
script to download the latest virus signatures from <url
id="http://www.openantivirus.org/latest.php">.

<p>FIXME: Check to determine which packages are available for
antivirus. Is clamav available? (there seem to be Debian packages for it).
<p>FIXME: check if scannerdaemon is the same as the open antivirus scanner daemon
(read ITPs).

<p>However, Debian will <em>never</em> provide commercial anti-virus
software such as: <url
id="http://www.pandasoftware.com/com/linux/linux.asp" name="Panda
Antivirus">, <url
id="http://www.nai.com/naicommon/buy-try/try/products-evals.asp"
name="NAI Netshield (uvscan)">, <url id="http://www.sophos.com/"
name="Sophos Sweep">, <url id="http://www.antivirus.com/products/"
name="TrendMicro Interscan">, <url id="http://www.ravantivirus.com"
name="RAV">....  For more pointers see the <url
id="http://www.computer-networking.de/~link/security/av-linux_e.txt"
name="Linux anti-virus software mini-FAQ">. This does not mean that
this software can be installed properly in a Debian system.

<p>For more information on how to setup an a virus detection system
read Dave Jones' article
<url id="http://www.linuxjournal.com/article.php?sid=4882"
name="Building an E-mail Virus Detection System for Your Network">.

<sect id="gpg-agent">GPG agent

<p>It is very common nowadays to sign (and sometimes encrypt)
e-mail. You might, for example, find that many people in mailing lists
sign the e-mails being sent to the list. Public key signatures are
currently the only mean to demonstrate that an e-mail was sent by the
sender and not by some other person.

<p>Debian provides a number of e-mail clients with built-in e-mail
signing capabilities that interoperate either with
<package>gnupg</package> or <package>pgp</package>:

<list>
<item><package>Evolution</package>.
<item><package>mutt</package>.
<item><package>kmail</package>.

<item><package>sylpheed</package>, depending on how the stable version
evolves you might need to use the <package>sylpheed-claws</package>
package (<em>bleeding edge version</em>)

<item><package>gnus</package> when installing the
<package>mailcrypt</package> interface.

<item><package>kuvert</package> which provides this functionality
indendently of your chosen mail user agent by interacting with the
mail transport agent.

</list>

<p>If you want to retrieve keys to verify signatures you can use any
keyserver you want. Keyservers allow you to download published public
keys. One such keyserver is <url id="wwwkeys.pgp.net">. To use this
keyserver, edir your <file>.gnupg/options</file> and add the following
line so that <package>gnupg</package> tries to fetch keys when you do
not have them in your public keyring:
<footnote>
For more examples of how to configure <prgn>gnupg</prgn> check
<file>/usr/share/doc/mutt/examples/gpg.rc</file>.
</footnote>
<example>
keyserver wwwkeys.pgp.net
</example>

<p>Most keyservers are linked so that when one key is posted on one of
them it will, after sometime, be available in all of them. There is,
however, a Debian package that provides all the public keys of the
developers involved in the project. Install
<package>debian-keyring</package> to have access to it. Keyrings are
installed under <file>/usr/share/keyrings/</file>.

<p>For more information read 1
<list>

<item><URL ID="http://www.gnupg.org/faq.html" name="GnuPG FAQ">.

<ITEM><URL ID="http://www.gnupg.org/gph/en/manual.html" name="GnuPG
Handbook">.

<ITEM><URL
ID="http://www.dewinter.com/gnupg_howto/english/GPGMiniHowto.html"
name="GnuPG Mini Howto (English)">.

<ITEM><URL ID="http://www.uk.pgp.net/pgpnet/pgp-faq/"
name="comp.security.pgp FAQ">.

<ITEM><URL ID="http://www.cryptnet.net/fdp/crypto/gpg-party.html"
name="Keysigning Party HOWTO">.

</list>


<chapt>Before the compromise

<sect id="keep-up-to-date">Continuously update the system

<p>You should conduct security updates frequently, the vast majority
of exploitations result from known vulnerabilities that have not been
patched in time, as a <url
id="http://www.cs.umd.edu/~waa/vulnerability.html"> name="paper by
Bill Arbaugh"> (presented on the 2001 IEEE Symposium on Security and
Privacy) explains. Updates are described under <ref id="security-update">.

<sect1>Using Tiger to check for security updates 

<p>You might, however, want to check quickly if systems you maintain
need to be updated. You can use the Tiger instrusion detection tool
for this.  Even if it's just slightly documented in the README.Debian
file (and in the manpage <manref section="8" name="tiger"> too) the
<prgn>tiger</prgn> program provided in Debian has been enhanced to
provide quite more functionality that the Tiger provided by TAMU (or
even TARA, a tiger version distributed by ARSC).

<p>One of this enhancements is the <tt>deb_checkadvisories</tt> script. This
script takes a list of DSA's and checks against the installed package base
to see if any of your packages is vulnerable according to the DSA. This is
a little different approach to the one taken on the more general approach
taken by Tiger implemented by the <tt>check_signatures</tt> script which checks
MD5sums of known vulnerable programs.

<p>Since currently Debian does not ship a list of md5sums of known
vulnerable programs (other operating systems, such as Sun's Solaris
do) the <em>check-against-DSA</em> approach is done.  The DSA approach
and the Md5sum approach have problems: the signatures have to be
updated regularly.

<p>This is currently done making new versions of the Tiger package but
the package maintainer might not make a new version every time a DSA
is shipped. A nice addition, which is not yet implemented is to do
this proactively, that is, download the DSAs from the web, make the
list and then check. The DSAs are currently updated from the
maintainer's local CVS update of the WML sources used to built
<url id="security.debian.org"> (the webserver, that is).

<p>A program to parse the published DSAs, either received through
e-mail or available in security.debian.org and generate the file used
by 'deb_checkadvisories' to confirm vulnerabilities would be
appreciated. Send it as a bug report for <package>tiger</package>

<p>The mentioned check is run through the standard program
configuration once installed (see <file>/etc/tiger/cronrc</file>):

<example>
# Check for Debian security measures every day at 1 am
#
1 * *   deb_checkmd5sums deb_nopackfiles deb_checkadvisories
#
</example>

<p>There is one more check that you might want to add which is not
added yet to the standard cron scripts. That check is
<tt>check_patches</tt>. This script works the following way:

<list>
<item>runs <prgn>apt-get update</prgn>
<item>checks if there are new packages available
</list>

<p>If you are running an <em>stable</em> system and add the
security.debian.org apt source line to your
<file>/etc/apt/sources</file> (as described in <ref id="security-update">) this
script will be able to tell you if there are new packages that you
need to install. Since the only packages changing in this setup are
security updates then you have just what you wanted.

<p> Of course this will not work if you are running <em>testing</em> or
<em>sid/unstable</em>. Since probably the new packages are much more than
security updates currently.

<p>You can add this script to the checks done by the cron job (at the
above configuration file) and <prgn>tigercron</prgn> would mail (to
whomever <tt>Tiger_Mail_RCPT</tt> was set to in
<file>/etc/tiger/tigerrc</file>) the new packages:

<example>
# Check for Debian security measures every day at 1 am
#
1 * *   deb_checkmd5sums deb_nopackfiles check_patches
#
</example>

<sect1>Avoid using the unstable branch

<p>Unless you want to dedicate time to patch packages yourself when a
vulnerability arises, you should <em>not</em> use Debian's unstable
branch for production-level systems. The main reason for this is that
there are no security updates for <em>unstable</em> (see <ref
id="sec-unstable">).

<p>The fact is that even some security issues might appear in unstable
and <em>not</em> in the <em>stable</em> distribution. This is due to
new functionality constantily being added to the applications provided
there, as well as new applications being included which might not yet
have been throughly tested.

<p>In order to do security upgrades in the <em>unstable</em> branch
you might have to do full upgrades to new versions (which might update
much more than just the affected package). This is because security
patches are only backported into the <em>stable</em> branch to which
usually (there have been some exceptions however) the main idea
between updates is <em>no new code</em> (i.e. just fixes to important
issues).

<sect1>Avoid using the testing branch

<p>If you are using the <em>testing</em> branch you must take into
account that this branch might be the one that takes more to have
security updates available since

<list>

<item>when a security fix is prepared packages are prepared for
 <em>unstable</em> and the patch is backported to <em>stable</em>
 (since it's usually some minor or major versions behind). Packages
 for the <em>stable</em> distribution are more thoroughly tested than
 <em>unstable</em> since the later might just provide the latest
 upstream release.

<item>security updates are available inmediately for both
 distributions (but not yet for testing).

<item>if no (new) bugs are detected in the package at
 <em>unstable</em> it moves to <em>testing</em> after several days
 (usually over a week). This depends, however, on the release state of
 the distribution.

</list>

<sect1>Automatic updates in a Debian system

<p>First of all, this is not recommended fully since it is recommended
that administrators review the DSAs and understand the impact of any
given security update. 

<p>If you want to update your system automatically you should:

<list>
<item>Configure <prgn>apt</prgn> so that those packages that you do
not want to update get blocked, this is used with the <em>pinning</em>
feature or put them on <em>hold</em> with <prgn>dpkg</prgn>.
<p>To pin the packages under a given release you must edit
<file>/etc/apt/preferences</file> (see <manref section="5"
name="apt_preferences">) and add:
<example>
  Package: *
  Pin: release a=stable
  Pin-Priority: 100
</example>
<p>FIXME: verify if this configuration is ok.

<item>add a cron item so that the update is run daily, you must run:
<example>apt-get update && apt-get -y upgrade</example>. The 
<tt>-y</tt> option will have <prgn>apt</prgn> assume 'yes' for all the
prompts that might arise during the update, in some cases you might
want to use the <tt>--trivial-only</tt> option instead of the
<tt>--assume-yes</tt> (equivalent to <tt>-y</tt>).
<footnote>You might want to use the <tt>--quiet</tt> (<tt>-q</tt>)
option to reduce the output of <prgn>apt-get</prgn> so that it will
not generate any output if no package is going to be installed.</footnote>

<item>Configure cron so that <prgn>debconf</prgn> will not ask for any
issue during upgrades, that way they are done non-interactively.
<footnote>Note that some packages might <em>not</em> use debconf and
updates will stall due to packages asking for input when they get
configured.</footnote>

<item>Check the results of the cron execution, they will be sent by
mail to the superuser (unless you set the <tt>MAILTO</tt> environment
variable in the script first).

</list>

<p>To be on the safe side, and not install the packages you can use
the <tt>-d</tt> (or <tt>--download-only</tt>) option. This will not
install the packages and you can manually do this when results of the
cron execution show that the system needs to be updated.

<p>In order to do this the system must be properly configured to
download security updates as discused on <ref id="security-update">. 

<p>However, this is not recommended for <em>unstable</em> without
careful analysis since you might bring your system into an unusable
state if some serious bug creeps into an important package and gets
installed in your system. <em>Testing</em> is slightly more
<em>secure</em> in this issue since bugs might be detected before the
package gets into this branch (although this might mean that you have
<em>no</em> security update available whatsoever).

<p>If you have a mixed distribution, that is, a <em>stable</em>
installation with some packages updated to <em>testing</em> or
<em>unstable</em> you can fiddle with the pinning preferences as well
as the <tt>--target-release</tt> option in <prgn>apt-get</prgn> to 
update <em>only</em> those packages that you have updated.
<footnote>This is a common issue since many users want to maintain the
stable system while updating some packages to <em>unstable</em> to
have the latest functionality available. The need arises due to some
projects evolving faster than the time it takes to have a new
<em>stable</em> distribution in Debian.</footnote>

<sect id="intrusion-detect">Set up Intrusion Detection.

<p>Debian includes some tools for Intrusion Detection which you might
want to setup to defend you local system (if truly paranoid of if your
system is really critical) or to defend other systems in the same
network.

<p>Always be aware that in order to really improve the system's security
with the introduction of any of these tools, you need to have an
alert+response mechanism, so don't use Intrusion Detection if you are
not going to alert anyone (i.e. don't waste your time configuring
things you will not use later on). 

<p>Most of the intrusion detection tools will either log against
syslog or send emails to the root user (most of them can be configured
to mail instead another user) regarding the particular attack that has
been detected. An administrator has to properly configure them so that
false positives do not send alerts and so that alerts are take proper
care of. Alerts can indicate an ongoing attack and might not be
useful, say, one day later, since the attack might have been already
successful. So be sure that there is a proper policy on handling
alerts and that the technical mechanisms to implement it are in place.

<p>An interesting source of information is
<url id="http://www.cert.org/tech_tips/intruder_detection_checklist.html"
name="CERT's Intrusion Detection Checklist">

<sect1>Network based intrusion detection

<p><package>Snort</package> is a flexible packet sniffer or logger
that detects attacks using an attack signature dictionary. It detects
a variety of attacks and probes, such as buffer overflows, stealth
port scans, CGI attacks, SMB probes, and much more. Snort has a
real-time alerting capability. This is a tool which should be
installed on every router to keep an eye on your network. Just install
it via <tt>apt-get install snort</tt>, follow the questions  and watch
it log.

<p>Snort in Debian is enabled with many security checks which you
might want; however, you should customize the setup to take into
account the particular services you run on your system. You might also
want to retrieve additional checks specific to these services.

<p>You can use <prgn>snort</prgn> both to establish network intrusion
detection for a range of hosts in your network as well as to detect
network attacks against your own host.

<p>There are other tools that can be used to detect network attacks
(albeit more simpler). <package>Portsentry</package> is another
interesting package that can tip you off when a scan is made to your
site. Other tools like <package>ippl</package> or
<package>iplogger</package> will also detect some IP (TCP and ICMP)
attacks, even if they do not provide advanced techniques for detecting
network attacks (like snort does).

<p>You can test any of these tools with the <prgn>idswakeup</prgn>
program, a false-positive generator to alert NIDSs with plenty of
common attack signatures available in Debian.

<sect1>Host based detection 

<p><package>Tiger</package> is an old intrusion detection tool which
has been ported to Debian since the woody distribution.  Tiger
provides check of common issues related to security break-ins, checks
passwords strength, filesystem problems, communicating
processes... The Debian version includes new security checks
Debian-specific: MD5sums of provided binaries, and checks of installed
and vulnerable packages. The default installation makes
<prgn>tiger</prgn> run each day and generate a report that is sent to
the superuser. The generated reports can give away information of a
successful compromise of the system.

<p>Log analysis tools, such as <package>logcheck</package> can
also be used, if customised, to detect intrusion attempts. See
<ref id="custom-logcheck">.
<p>Also, any of the filesystem integrity checkers (see <ref
id="check-integ">) can be quite useful in order to set up detection of
anomalies in a secured environment. An effective intrusion will, most
surely, modify files in the local filesystem in order to circumvent
local security policy, install trojans, create users... this events
can be detected with them.


<sect id="kernel-patches">Useful kernel patches

<p>FIXME: This section needs to cover how these specific patches
can be installed in Debian using the kernel-2.x.x-patch-XXX packages.
</p>

<p>There are some kernel patches, which significantly enhance system
security. Here are a few of them:
<p>
<list>

<item>OpenWall patch by Solar Designer.  This is a useful set of
kernel restrictions, like restricted links, FIFOs in <file>/tmp</file>,
restricted <file>/proc</file>, 
special file descriptor handling, non-executable user stack
area and some more.  Homepage:
<url name="http://www.openwall.com/linux/" id="http://www.openwall.com/linux/">

<item><em>LIDS &mdash; Linux intrusion detection system by Huagang Xie &amp;
Philippe Biondi</em>.  This patch makes the process of creating a
hardened Linux system easier. You can restrict every process, give it
rights to write or read files, or remove, by default, the ability to
read files. Furthermore you can also set capabilities for certain
processes. Even though it is still in the beta phase, it is almost a
must for the paranoid system administrator.  Homepage: <url
name="http://www.lids.org" id="http://www.lids.org">

<item><em>POSIX Access Control Lists (ACLs) for Linux</em> This patch
adds access control lists, an advanced method for restricting access
to files, to the linux kernel.  Homepage: <url
name="http://acl.bestbits.at/" id="http://acl.bestbits.at/">

<item><em>Linux trustees</em>.  This patch adds a decent advanced
permissions system to your Linux kernel. All the objects are stored in
the kernel memory, which allows fast lookup of all permissions.
Homepage: 
<url name="http://trustees.sourceforge.net/" 
id="http://trustees.sourceforge.net/">

<item><em>International kernel patch</em>.  This is a crypt-oriented
kernel patch, therefore you have to pay attention to your local laws
regarding the use of cryptography.  It basically adds the possibility
of using encrypted file systems.  Homepage: <url
name="http://www.kerneli.org" id="http://www.kerneli.org">

<item><em>SubDomain</em>.  A kernel extension to create a more secure
and easier to setup chroot environment. You can specify the files
needed for the chrooted service manually and do not have to compile
the services statically.  Homepage: <url
name="http://www.immunix.org/subdomain.html"
id="http://www.immunix.org/subdomain.html">

<item><em>UserIPAcct</em>.  This is not really a security related
patch, but it allows you to create quotas for the traffic on your
server per user. And you can fetch statistics about the user traffic.
Homepage: <url id="http://ramses.smeyers.be/useripacct">.

<item><em>FreeS/WAN</em>. If you want to use IPSec with Linux, you need
this patch. You can create VPNs with this quite easily, even to
Windows machines, as IPSec is a common standard.  Homepage: <url
id="http://www.freeswan.org">

</list>

<sect>Avoiding root-kits
<p>

<sect1 id="LKM">LKM - Loadable Kernel Modules

<p>LKM (Loadable Kernel Modules) are files containing dynamically 
loadable kernel components. They are dynamically loadable in 
kernel to run assigned tasks. On the GNU/Linux they are used to
expand the functionality of kernel. Several advantages can be 
taken using LKMs, as we saw, they can dynamically be loadabled 
without recompiling the entire kernel, can be used to specify 
devices drivers (or filesystems) and other hardware drivers like
soundcards, networkcards. But some crackers might use LKMs for 
root-kits (knark and adore) to install backdoors  for
GNU/Linux systems.

<p>LKM root-kits can hide processes, files, directories and even 
connections without modifying the source code of binaries.
For example, <prgn>ps</prgn> might have get processes information 
from <file>/proc</file>, a malicious LKM can subvert the kernel 
to hide specific processes from procfs, so not even a known good 
copy of the binary <prgn>ps</prgn> could list all the correct 
proccesses information.

<sect1>Detecting root-kits

<p>The detection work can be simple and painless, or difficult and
tiring, depending the measure that you choose. There are two measure
of defenses regarding LKM (Linux Kernel Modules) security, the
proactive and reactive.

<sect2>Proactive defense

<p>The advantage of this defense is that its prevents that some
lkm root-kit damages the system. The most used proactive defense is
<em>getting there first</em>, that is loading a designed LKM to protect
the system to be damaged by a malicious designed LKM. Another measure
is to remove capabilities in the kernel, making the system more secure.
For example, you can remove the capability to stop the loading and
unloading of kernel modules.

<p>On Debian systems you can find some packages that are a proactive tool:
<list>
<item> <package>kernel-patch-2.4-lsm</package> - LSM is the Linux Security
Modules framework.

<item> <package>lcap</package> - A user friendly interface to remove
<em>capabilities</em> (kernel-based access control) in the kernel,
making the system more secure. Running <tt>lcap CAP_SYS_MODULE</tt>
<footnote>
There are over 28 capabilities including:
<tt>CAP_BSET</tt>,
<tt>CAP_CHOWN</tt>,
<tt>CAP_FOWNER</tt>,
<tt>CAP_FSETID</tt>,
<tt>CAP_FS_MASK</tt>,
<tt>CAP_FULL_SET</tt>,
<tt>CAP_INIT_EFF_SET</tt>,
<tt>CAP_INIT_INH_SET</tt>,
<tt>CAP_IPC_LOCK</tt>,
<tt>CAP_IPC_OWNER</tt>,
<tt>CAP_KILL</tt>,
<tt>CAP_LEASE</tt>,
<tt>CAP_LINUX_IMMUTABLE</tt>,
<tt>CAP_MKNOD</tt>,
<tt>CAP_NET_ADMIN</tt>,
<tt>CAP_NET_BIND_SERVICE</tt>,
<tt>CAP_NET_RAW</tt>,
<tt>CAP_SETGID</tt>, 
<tt>CAP_SETPCAP</tt>,
<tt>CAP_SETUID</tt>,
<tt>CAP_SYS_ADMIN</tt>,
<tt>CAP_SYS_BOOT</tt>,
<tt>CAP_SYS_CHROOT</tt>,
<tt>CAP_SYS_MODULE</tt>,
<tt>CAP_SYS_NICE</tt>,
<tt>CAP_SYS_PACCT</tt>,
<tt>CAP_SYS_PTRACE</tt>,
<tt>CAP_SYS_RAWIO</tt>,
<tt>CAP_SYS_RESOURCE</tt>,
<tt>CAP_SYS_TIME</tt>, and
<tt>CAP_SYS_TTY_CONFIG</tt>. All of them can be activated or de-activated
in or to harden your kernel.
</footnote>
will remove module loading capabilities (even for the root user).
<footnote>
You do not need to install <package>lcap</package> to do this but it's
easier than setting <file>/proc/sys/kernel/cap-bound</file> by hand.
</footnote>
</list>

<p>If you don't really need these many kernel features on your GNU/Linux
system you might want disable loadable modules support during kernel
configuration. It prevents LKM root-kits, but you couldn't use the kernel
module features on your GNU/Linux. Look that disabling loadable modules
you can overload the kernel, sometimes it is not necessary.

<p>To disable loadable module support, just set CONFIG_MODULES=n on
<file>.config</file>.

<sect2>Reactive defense

<p>The advangate of reactive defense is that it has low overload
the system's resources. It works comparing the system call table
with known clean copy in a disk file (System.map). The most
obvius desavantage is that its tell to administrator only when
the system have already be compromised.

<p>Detection of root-kits in Debian can be accomplished with
<package>chkrootkit</package>. The <url name="Chkrootkit"
id="http://www.chkrootkit.org"> program checks for signs of root-kits
on the local system and tells whether the target computer is infected
with a root-kit.

<p>You can also use <url name="KSTAT"
id="http://www.s0ftpj.org/en/site.html"> (Kernel Security Therapy Anti
Trolls) by the S0ftproject group.  KSTAT checks the kernel memory area
(<file>/dev/kmem</file>) for information about the target host, this
information includes the installation of Loadable Kernel Modules.

<P>FIXME: Add info on how to compile the kernel w/o lkm support?


<sect>Genius/Paranoia Ideas &mdash; what you could do

<p>
This is probably the most unstable and funny section, since I hope
that some of the "duh. that sounds crazy" ideas might be
realized. Following here you will find some ideas &mdash; it depends
on the point of view whether you say they are genius, paranoid, crazy
or secure &mdash; to increase your security rapidly but you will not
come unscathed out of it.

<list>
<item>Playing around with PAM.  As said in the phrack 56 PAM article,
the nice thing with PAM is that "You are limited only by what you can
think of." It is true. Imagine root login only possible with
fingerprint or eyescan or cryptocard (why did I do an OR conjunction
and not AND here?).

<item>Fascist Logging.  I would say everything we talked about logging
above is "soft logging". If you want to perform real logging, get a
printer with fanfold paper and log everything hard by printing on
it. Sounds funny, but it's reliable and it cannot be removed.

<item>CD distribution.  This idea is very easy to realize and offers
pretty good security.  Create a hardened Debian distribution, with
proper firewall rules, make an ISO image of it and burn it on CD.
Make it bootable. This is  a read-only distribution with
about 600 MB space for services, and it is impossible for
intruders to get read/write access on this system. Just make sure
every data which should get written, gets written over the
wires. Anyway, the intruder cannot change firewall rules, routing
entries or start own daemons (he can, but reboot and he has to hack
into your system again to change them).

<item>Switch module capability off.  When you disable the usage of
kernel modules at kernel compile time, many kernel based back doors are
impossible to implement, since most of them are based on installing
modified kernel modules.

<item>Logging through serial cable (contributed by Gaby Schilders).
As long as servers still have serial ports, imagine having one
dedicated log-machine disconnected from the net in the middle with a
serial-port multiplexer (cyclades or the like). Now have all your
servers log to their serial ports. Write only. The log-machine only
accepts plain text as input on its serial ports and only writes it to
a log-file. Hook up a cd/dvd-writer. When the log file nears 600MB
it writes it to cd-rom. Now if only they would make writers with
auto-changers... Not as hard-copy as the printer, but it can handle
larger volumes and the cd's don't take as much storage-space.

<item>Set all stuff to immutable (taken from the Tips-HOWTO, written
by Jim Dennis).  Right after you install and configure your system go
through the <file>/bin</file>, <file>/sbin/</file>,
<file>/usr/bin</file>, <file>/usr/sbin</file> and
<file>/usr/lib</file> (and a few of the other usual suspects) and make
liberal use of the <prgn>chattr +i command</prgn>.  Also add that to
the the kernel files in root.  Now <prgn>mkdir /etc/.dist/</prgn> copy
everything from <file>/etc/</file> on down (I do this in two steps
using <file>/tmp/etcdist.tar</file> to avoid recursion) into that directory.
(Optionally you can just create <file>/etc/.dist.tar.gz</file>) 
-- and mark that as immutable.

<p>The reason for all of this is to limit the damage that you can do
  when logged in as root.  You won't overwrite files with a stray
  redirection operator, and you won't make the system unusable with a
  stray space in an <prgn>rm -fr</prgn> command (you might still do
  plenty of damage to your data &mdash; but your libs and bins will be
  safer.

<p>This also makes a variety of security and denial of service
  exploits either impossible or more difficult (since many of them
  rely on overwriting a file through the actions of some SUID program
  that <em>isn't providing an arbitrary shell command</em>).

<p>The only inconvenience of this is when building and doing your
  <prgn>make install</prgn> on various sorts of system binaries.  On
  the other hand it also prevents the <prgn>make install</prgn> from
  over-writing the files.  When you forget to read the Makefile and
  chattr -i the files that are to be overwritten (and the directories
  to which you want to add files) &dash; the make fails, you just use
  the chattr command and rerun it.  You can also take that opportunity
  to move your old bin's, libs, or whatever into a .old/ directory or
  rename or tar them or whatever.

<p>Note that this also prevents you from upgrading your system's
packages. Since the files that they provide cannot be overwritten, so
you might want to have a mechanism to disable the immutable flag on
all binaries right before doing an <prgn>apt-get update</prgn>.

</list>


<sect1>Building a honeypot

<p>FIXME: More Content specific to Debian needed.

<p>If you wish (and can also implement it and dedicate time to it) you can
set a full honeypot using a Debian GNU/Linux system. You have all the
tools needed in order to setup all the honeynet (i.e. the network, the
honeypot is just the fake server): the firewall, 
the network intrusion detector and the fake server. Be careful,
however, you have to be pretty sure that you will be alerted in time
(see <ref id="log-alerts">) so that you can take appropiate measures
and terminate the compromise as soon as you fill you've seen enough.

<list>

<item>the firewalling technology you will need (provided by the Linux
kernel).

<item><package>syslog-ng</package> to send the logs from the honeypot
to a remote syslog server machine.

<item><package>snort</package> to setup capture of all the incoming
network traffic to the honeypot and detect the attacks.


<item><package>osh</package> which could be used to setup a restricted
shell with logging (see Lance Spitzner's article below). 

<item>of course, all the servers for your fake server honeypot
 you can imagine of (but do <em>not</em> harden the honeypot)).

<item>and also fake services, provided by <package>dtk</package> if you
want to use the honeynet also as an intrusion detection service.

<item>Integrity checkers (see <ref id="check-integ">) and 
The Coroner's Toolkit (<package>tct</package>) to do post-attack
audits.

</list>

<p>You can read more about building honeypots in Lanze Spitzner's excellent
article
<url id="http://www.net-security.org/text/articles/spitzner/honeypot.shtml"
name="To Build a Honeypot"> (from the Know your Enemy series), or
David Raikow's
<url id="http://www.zdnetindia.com/techzone/resources/security/stories/7601.htm"
name="Building your own honeypot">.
Also, the <url id="http://project.honeynet.org/" name="Honeynet Project">
is dedicated to building honeypots and auditing attacks made to them,
there is valuable information there on howto setup a honeypot and howto
audit the results of an attack (check out the contest).

<chapt id="after-compromise">After the compromise


<sect>General behavior

<p>If you are physically present when an attack is happening and doing
the following will not adversly affect any bussiness transactions,
simply unplug the NIC until you can figure out what the intruder did
and secure the box.  Disabling the network at layer 1 is the only true
way to keep the attacker out of the compromised box. (Phillip
Hofmeister's wise advice)

<p>However, some rootkits or backdors are able to detect this event and
react to it. Seeing an <tt>rm -rf /</tt> executed when you unplug the
network from the system is not really much fun. If you are unwilling to
take the risk and you are sure that the system is compromised you should
<em>unplug the network cable</em> (all of them if more than one) and
cross your fingers. This might look quite extreme but, in fact, will
avoid any logic-bomb that the intruder might have programmed.
The compromised system <em>should not be booted</em> again by itself 
in this case, either the hard disks should be moved to another system 
for analysis or you should use another media (a CD-ROM) to boot the system
and analyse it. You should <em>not</em> use Debian's rescue disks to boot
the system but <em>can</em> use the shell provided by the installation
disks (remember, Alt+F2 will take you to it) to analyse the system.

<p>The most recommended method is using a live-filesystem on CD with 
all the tools (and modules) you might need to acess the compromised
system. You can use the <package>mkinitrd-cd</package> to build such a
CD<footnote>In fact this is the tool used to build the CDroms for the 
<em>Gibraltar</em> project (a firewall on a live CD based on the Debian
distribution.</footnote>. You might find the <em>Biatchux</em>
CD-ROM useful here too, since it's a live CD with forensic tools that
can be used for this cases. There is not (yet) a Debian-based tool
such as this, nor an easy way to build the CD using your own selection
of Debian packages and <package>mkinitrd-cd</package> (so you'll have
to read the documentation provided with it to make your CDs).

<p>FIXME: add links to Biatchux and Gibraltar

<p>If you really want to fix the compromise quickly, you should remove the
compromised host from your network and re-install the operating system
from scratch.  This might not have any effect if you do not know how
the intruder got root.  In this case you must check everything:
firewall/file integrity/loghost logfiles and so on. For more
information on what to do following a break-in, see <url name="Sans'
Incident Handling Guide" id="http://www.sans.org/y2k/DDoS.htm"> or
<url id="http://www.cert.org/tech_tips/root_compromise.html"
name="CERT's Steps for Recovering from a UNIX or NT System Compromise">.

<p>Some common (Debian-related) questions regarding if your system 
is compromised and how to proceed are also available in 
<ref id="vulnerable-system">.

<sect>Backing up the system

<p>Remember that if you are sure the system has been compromised you
cannot trust the software in it or any information that it gives back
to you. Applications might have been troyanized, kernel modules might
be installed, etc.

<p>The best thing to do is a complete filesystem backup copy (using
<prgn>dd</prgn>) after booting from a safe medium. Debian GNU/Linux
Cds can be handily used for this since they provide a shell in console
2 when the installation is started (jump to it using Alt+2 and
pressing Enter). The shell can be used to backup the information to
another place (maybe a network file server through NFS/FTP...) for
analysis while the system is offline (or reinstalled).

<p>If you are sure that there is only a troyan kernel module you can
try to run the kernel image from the CD in <em>rescue</em> mode. Make
sure to startup also in <em>single</em> mode so no other trojan
processes run after the kernel.

<sect>Forensics analysis
<p>If you wish to gather more information, the <package>tct</package>
(The Coroner's Toolkit from Dan Farmer and Wietse Venema) package
contains utilities which perform a 'post mortem' of a system.
<package>tct</package> allows the user to collect information about
deleted files, running processes and more. See the included
documentation for more information.

<p>Some other tools that can be used for forensic analysis provided
in the Debian distribution are:

<list>
<item><package>Fenris</package>.
<item><package>Strace</package>.
<item><package>Ltrace</package>.
</list>

<p>Any of these can be used to analyse rogue binaries (such as backdoors)
in order to determine how they work and what they do to the system.
Some other common tools include <prgn>ldd</prgn> (in <package>libc6</package>),
<prgn>strings</prgn> and <prgn>objdump</prgn> 
(both in <package>binutils</package>).

<p>If you try to do foensic analsys with backdoors or suspected binaries
retrieved from compromised systems you should do so in a secure environment
(for example in a <package>bochs</package> or <package>flex86</package>
image or a chroot'ed environment using a user with low privileges),
otherwise your own system can be backdoored/r00ted too!

<p>Also remember that forensics analysis should be done always 
on the backup copy of the data, <em>never</em> on the data itself 
since it might be tampered through the analysis (and all evidences lost). 

<p>FIXME: This paragraph will hopefully provide
more information about forensics in a Debian system in the coming future.

<p>FIXME: talk on how to do a debsums on a stable system with the
md5sums on CD and with the recovered filesystem restored on a separate
partition.

<p>FIXME add pointers to forensic analysis papers (like the
Honeynet's reverse challenge or <url id="http://staff.washington.edu/dittrich/" name="David Dittirch's papers">.

<chapt>Frequently asked Questions (FAQ)

<p>This chapter will introduce some of the most common questions that
usually appear in the security mailing list. You should read them
before posting there or else people might tell you just to RTFM.

<sect>Security in the Debian operating system

<sect1>Is Debian more secure than X?
<p>A system is as secure as its administrator is capable of making it.
Debian tries to install services in a <em>secure by default</em> way
and might not try to be as paranoid as other operating systems which
install all the services <em>disabled by default</em>. However, the
system administrator needs to adapt the security of the system to his
local security policy.

<p>For a list of posted vulnerabilities per platform see <url
id="http://securityfocus.com/vulns/stats.shtml">. Is this data useful?
Probably not much since many applications might (or might not be)
provided in Debian (as well as in other operating systems). Also some
vulnerabilities "discovered" in Bugtraq regarding Debian affect the
Debian <em>unstable</em> (i.e. not supported) distribution.
<footnote>
For example, based on the Securityfocus data it might seem that
Windows NT is more secure that Linux which is a questionable
assertion. After all, any Linux distribution provides a lot more
software than the one provided in any operating system provided by
Microsoft.
</footnote>


<sect2>Is Debian more secure than other Linux distributions (such as RedHat, SuSE...)?

<p>There are not really that many differences between Linux
distributions (besides for what is considered the base installation)
since the same applications (but maybe different versions) are shipped
with the distribution's stable version, for example the Kernel, Bind,
Apache, OpenSSH, Xfree, gcc, zlib, etc. are retrieved from the same
sources.

<p>For example, Redhat got unlucky and shipped when foo 1.2.3 was
current, which was later found to have a hole.  Debian, on the other
hand, may have gotten lucky and shipped with foo 1.2.4, which
incorporated the bug fix.  That was the case in the big rpc.statd
problem from a couple years ago.

<p>There is a lot of collaboration between the respective security
teams for the major Linux distributions.  As a result of this, they
all tend to release necessary security updates at the same time.
Known security updates are rarely, if ever, left unfixed by a
distribution vendor.  Knowledge of a security vulnerability is never
kept from another distribution vendor, as fixed to common
vulnerabilities are usually coordinated upstream or by <url
id="http://cert.org" name="CERT"> As a result of all this, the
relative security of the different distributions is very similar.

<p>Probably one of the main advantages of Debian over other Linux
distributions is that <prgn>apt</prgn> makes updates easier. However,
security-wise, there are some aspects that improve security in the
distribution:

<list>
<item>Debian  provides more security tools than other distros, see
<ref id="sec-tools">.

<item>Debian standard installation is smaller (less functionality) and
        thus more secure (this usually
        goes against usability), other distros tend to either install  
        by default a lot of services or do not properly configure them
        (remember the Ramen or Lion worms). It's not as strict as OpenBSD
        (no daemons are active per default) but it's a good
        compromise.
<footnote>
Without diminishing the fact that some distributions such as RedHat or
Mandrake are also taking into account security in their standard
installations by having the user select <em>security profiles</em> or
help with wizard configuration of <em>personal firewalls</em>.
</footnote>

<item>Debian documents security, as you already know since you are
reading <em>this</em> document.

</list>


<p>FIXME: add link to CERT's rpc.statd, and ramen or lion worms.

<sect1>There are many Debian bugs in bugtraq does this mean that it is
very vulnerable?

<p>Debian contains quite a number of packages and
different software, probably more that provided by some propietary
operating systems. This means that there might be lurking more
potential security issues than in systems with less software. 

<p>However, there are many advisories related to source code audits
done to major software components included in Debian. Whenever such
source code audit turn out a major flaw it is fixed and a advisory is
sent to list such as bugtraq.

<p>Bugs that are present in the Debian distribution usually affect
other vendors and other distributions as well.  Check the "Debian
specific: yes/no" part on top of each advisory (DSA).  If there is a
"yes", it only affects Debian, if there is a "no" it probably also
affects other distributions as well.

<p>Debian contains quite a lot of packages, and nowadays there are
many groups looking for security problems in software (for whichever
reasons).



<sect1>Has Debian any certification security-wise?

<p>Simple answer: no. 

<p>Long answer: certification costs money and nobody has dedicated
resources in order to certificate the Debian GNU/Linux distribution to
any level of, for example, the Common Criteria. If you are interested
in having a certified GNU/Linux distribution try to provide resources
in order to make it possible.

<sect1>Is there any hardening program for Debian?

<p>Yes. <url name="Bastille Linux"
id="http://www.bastille-linux.org">, originally oriented towards some
Linux distributions (RedHat and Mandrake) currently works for
Debian. Steps are being taken to integrate the changes made to the
upstream version, in any case the package in Debian is, of course,
name <package>bastille</package>.

<p>Some people believe, however, that a hardening tool does not
eliminate the need for good administration.

<sect1>I want to run XYZ service, which one should I choose?

<p>One of the benefits of Debian, which might confuse the novice
administrator, is that it provides a lot of software to offer the same
service (dns servers, mail servers, ftp servers, web servers...). If
you want information on what server you should be installing there's
no general answer, it really depends on your feature and security
needs (which might need to be balanced). 

<p>Things you should check:

<list>
<item>Is it maintained upstream? (when was the last release?)
<item>Is it mature? (the version number does <em>not</em> tell you,
try to trace it's history)
<item>Is it bug-ridden? Have there been security advisories related to
it?
<item>Does it provide all the functionality you need? Does it provide
more than you really need?
</list>


<sect1>How can I make service XYZ more secure in Debian?
<!-- Changed to XYZ in order to avoid confusion :) jfs -->

<p>You will find information in this document to make some services
(FTP, Bind) more secure in Debian GNU/Linux. For services not covered
here, however, check the program's documentation, or general Linux
information. Most of the security guidelines for Unix systems apply
also to Debian so securing service X in Debian is, most of the time,
like securing the service for any other Linux distribution (or Unix,
for that matter).

<sect1>How can I remove all the banners for services?

<p>If you do not like a user to connect to your, for example, POP3
daemon and retrieve information on your system you might want to
remove (or change) the banner the service shows to users
<footnote>
Note that this is security by obscurity and will probably not be worth
the effort in the long term.
</footnote>
. Doing so depends on the software you are running for a given
 service. For example, for <prgn>postfix</prgn> you can set your
 smtpbanner in <file>/etc/postfix/main.cf</file>:
<example>
smtpd_banner = $myhostname ESMTP $mail_name (Debian/GNU)
</example>

<p>Other software is not so easy to change, for
<package>openssh</package> you need to recompile it to change the
version it prints and need not to be careful not to remove the first
part (<tt>SSH-2.0</tt>) that clients use to identify which protocols
it supports.

<sect1>Are all Debian packages safe?

<p>The Debian security team cannot analise all the packages included
in Debian for potential security vulnerabilities, since there are just
not enough resources to source-code audit all the project. However,
Debian does benefit from the source code audits made by upstream
developers or other projects like the
<url name="Linux Kernel Security Audit Project" id="http://kernel-audit.sourceforge.net/">
or the <url name="Linux Security-Audit Project" 
id="http://www.lsap.org/">.

<p>As a matter of fact, a Debian developer could distribute a trojan
in a package and there is no possible way to check it out. Even if
they would be introduced in Debian it would be impossible to cover all
the possible situations in which the trojan would execute.

<p>This sticks to the <em>no guarantees</em> license clause. In
any case, Debian users can take confidence in that the stable code has
a wide audience and most problems would be uncovered through use. It
is not recommended to install untested software in a valuable system
in any case (if you cannot provide the necessary code audit). And, in
any case, if there were an induced security vulnerability in the
distibution, the process used to include them (using digital
signatures) ensures that the problem can be ultimately traced to the
developer, and the Debian project has not taken this issues lightly.


<sect1>Why are some logfiles/configuration files world-readable, isn't this insecure?  

<p>You can, of course, change the standard Debian setting but, however
the current policy regarding logfiles and configuration files is that
they are world readable <em>unless</em> they provide sensitive
information.

<p>Be careful, however, if you make changes since:
<list>
<item>processes might not be able to write to logfiles if you tighten their permissions.
<item>some applications might not work if the configuration file they depend on cannot be read. For example, if you remove the world-read permission from 
<file>/etc/samba/smb.conf</file> the <prgn>smbclient</prgn> program will not be able to work when run by a normal user.
</list>

<p>FIXME: Check if this is written in the Policy. Some packages
(i.e. ftp daemons) seem to enforce different permissions.

<sect1>Why does /root/ (or UserX) have 755 permissions?  

<p>As a matter of fact the same questions stands for any other
user. Since Debian installation does not place <em>any</em> file under
that directory, there's no sensitive information to protect there. If
you feel these permissions are too broad for your local system
consider tighten them. Probably changing them to 750. For users read 
<ref id="limit-user-perm">.

<p>The thread discussing this on the debian-security mailing list can
be read at <url
id="http://lists.debian.org/debian-devel/2000/debian-devel-200011/msg00783.html">.

<sect1>After installing a grsec/firewall I receive many console messages! How do I remove them?


<p>If you are receiving console messages and have configured
<file>/etc/syslog.conf</file> to not se messages on the console and
redirect them to either files or a special tty you might be seeing
messages sent directly to the console.

<p>The default console log level for any given kernel is 7, that means
that any message with lower priority will appear in the
console. Usually, firewalls (the LOG rule) and some other security
tools log lower that this priority.

<p>To reduce messages sent to the console you can use
<prgn>dmesg</prgn> (<tt>-n</tt> option see <manref section="8"
name="dmesg">) which in fact examines and <em>controls</em> the kernel
ring buffer. To fix this for the next reboot change
<file>/etc/init.d/klogd</file> from

<example>
KLOGD=""
</example>

<p>to

<example>
KLOGD="-c 4"
</example>

<p>You might want to use a lower number if you still see them. A
description of the log levels can be found at
<file>/usr/include/sys/syslog.h</file>:
<example>
#define LOG_EMERG       0       /* system is unusable */
#define LOG_ALERT       1       /* action must be taken immediately */
#define LOG_CRIT        2       /* critical conditions */
#define LOG_ERR         3       /* error conditions */
#define LOG_WARNING     4       /* warning conditions */
#define LOG_NOTICE      5       /* normal but significant condition */
#define LOG_INFO        6       /* informational */
#define LOG_DEBUG       7       /* debug-level messages */
</example>


<sect1>Operating system users and groups

<sect2>Are all system users necessary?

<p>Yes and no. Debian comes with some predefined users (id &lt; 99 as
described in <url name="Debian Policy"
id="http://www.debian.org/doc/debian-policy/"> or
<file>/usr/share/doc/base-passwd/README</file>) for some services so
that installing new services is easy (they are already run by the
appropriate user). If you do not intend to install new services, you
can safely remove those users who do not own any files in your system
and do not run any services. In any case, the default behavior is that
user id from 0 to 99 are built-in to Debian whileas user's id from 100
to 999 are created by packages on install (and deleted when the
package is purged).


<p>You can easily find users not owning any files by executing the
following command (be sure to run it as root, since a common user
might not have enough permissions to go through some sensitive
directories):


<!-- Took the liberty to make this script more secure ... >:^) // era -->
<example>
cut -f 1 -d : /etc/passwd |
while read i; do find / -user "$i" | grep -q . && echo "$i"; done
</example>

<p>These users are provided by <package>base-passwd</package>. You
will find in its documentation more information on how these users are
handled in Debian.

<p>The list of default users (with a corresponding group) follows:

<list>

<item>root:
	Root is (typically) the superuser.

<item>daemon:
	Some unprivileged daemons that need to be able to write to some
	files on disk run as daemon.daemon (portmap, atd, probably others).
	Daemons that don't need to own any files can run as nobody.nogroup
	instead, and more complex or security conscious daemons run as
	dedicated users. The daemon user is also handy for locally
	installed daemons, probably.

<item>bin: 
	   maintained for historic reasons.

<item>sys:
	   same as with bin.
              However, /dev/vcs* and <file>/var/spool/cups</file> are owned by
	      group sys.

<item>sync:
	The shell of user sync is <file>/bin/sync</file>.
	Thus, if its password is set
	to something easy to guess (such as ""), anyone can sync the system 
	at the console even if they have no account on the system.
<item>games:
	Many games are sgid to games so they can write their high score
	files. This is explained in policy.
<item>man:
	The man program (sometimes) runs as user man, so it can write cat
	pages to <file>/var/cache/man</file>

<item>lp:
	Used by printer daemons.

<item>mail:
	Mailboxes in <file>/var/mail</file> are owned by group mail, as is explained in
	policy. The user and group are used for other purposes as well by
	various MTA's.

<item>news:
	Various news servers and other associated programs (such as suck)
	use user and group news in various ways. Files in the news spool
	are often owned by user and group news. Programs such as inews that
	can be used to post news are typically sgid news.

<item>uucp:
	The uucp user and group is used by the UUCP subsystem. It owns
	spool and configuration files. Users in the uucp group may run
	uucico.

<item>proxy:
	Like daemon, this user and group is used by some daemons
	(specifically, proxy daemons) that don't have dedicated user id's
	and that need to own files. For example, group proxy is used by
	pdnsd, and squid runs as user proxy.

<item>majordom:
	Majordomo has a statically allocated uid on Debian systems for
	historical reasons. It is not installed on new systems.

<item>postgres:
	Postgresql databases are owned by this user and group. All
	files in <file>/var/lib/postgresql</file> are owned by this user to
	enforce proper security.

<item>www-data:
	Some web browsers run as www-data. Web content should *not* be
	owned by this user, or a compromised web server would be able to
	rewrite a web site. Data written out by web servers, including
	log files, will be owned by www-data.

<item>backup:
	So backup/restore responsibilities can be locally 
	delegated to someone without full root permissions.
<item>operator:
	Operator is historically (and practically) the only 'user' account
	that can login remotely, and doesn't depend on NIS/NFS.
<item>list:
	Mailing list archives and data are owned by this user and group.
	Some mailing list programs may run as this user as well.
<item>irc:
	Used by irc daemons. A statically allocated user is needed only
	because of a bug in ircd -- it setuid()s itself to a given UID on
	startup.

<item>gnats.

<item>nobody, nogroup:
	Daemons that need not own any files run as user nobody and group
	nogroup. Thus, no files on a system should be owned by this user or
	group.

</list>

<p>Other groups which have no associated user:

<list>

<item>adm:
	Group adm is used for system monitoring tasks. Members of this
	group can read many log files in <file>/var/log</file>,
	and can use xconsole.
	Historically, <file>/var/log</file> was <file>/usr/adm</file>
	(and later <file>/var/adm</file>), thus the name of the group.

<item>tty:
	Tty devices are owned by this group. This is used by write and wall
	to enable them to write to other people's tty's.

<item>disk:

	Raw access to disks. Mostly equivalent to root access.

<item>kmem:
	/dev/kmem and similar files are readably by this group. This is
	mostly a BSD relic, but any programs that need direct read access
	to the system's memory can thus be made sgid kmem.

<item>dialout:
	Full and direct access to serial ports. Members of this group can
	reconfigure the modem, dial anywhere, etc.

<item>dip: The group's name stands for "Dialup IP". Being in group dip
	allows you to use a tool such as <prgn>ppp</prgn>,
	<prgn>dip</prgn>, <prgn>wvdial</prgn>, etc. to dial up a
	connection. The users in this group cannot configure the
	modem, they can just run the programs that make use of it.

<item>fax:
	Allows members to use fax software to send / receive faxes.

<item>voice:
	Voicemail, useful for systems that use modems as answering
	machines.

<item>cdrom:
	This group can be used locally to give a set of users access to a
	cdrom drive.

<item>floppy:
	This group can be used locally to give a set of users access to a
	floppy drive.

<item>tape:
	This group can be used locally to give a set of users access to a
	tape drive.

<item>sudo:
	Members of this group do not need to type their password when using
	sudo. See <file>/usr/share/doc/sudo/OPTIONS</file>.

<item>audio:
	This group can be used locally to give a set of users access to an
	audio device.

<item>src: This group owns source code, including files in
	<file>/usr/src</file>. It can be used locally to give a user
	the ability to manage system source code.

<item>shadow: <file>/etc/shadow</file> is readable by this group. Some
	programs that need to be able to access the file are set gid
	shadow.

<item>utmp: This group can write to <file>/var/run/utmp</file> and
	similar files. Programs that need to be able to write to it
	are sgid utmp.

<item>video:
        This group can be used locally to give a set of users access to an
	video device.

<item>staff: Allows users to add local modifications to the system
	(<file>/usr/local</file>, <file>/home</file>) without needing
	root privileges. Compare with group "adm", which is more
	related to monitoring/security.

<item>users:

	While Debian systems use the user group system by default (each
	user has their own group), some prefer to use a more traditional
	group system. In that system, each user is a member of the 'users'
	group.

</list>

<sect2>What is the difference between the adm and the staff group?
<p>

<p>'adm' are administrators and is mostly useful to allow them to read
logfiles without having to <prgn>su</prgn>. 'staff' is useful for more
helpdesk/junior sysadmins type of people and gives them the ability to
do things in <file>/usr/local</file> and create directories in
<file>/home</file>.

<sect1>Why is there a new group when I add a new user? (or Why does Debian give each user one group?)

<p>The default behavior in Debian is that each user has its own
group. This prevents security problems derived from the concept of a
<em>users</em> group so that users will not (knowingly) share
information with others when a proper umask and directory permission
for their $HOME is set. 

<p>You can, however, change this behavior by modifying
<file>/etc/adduser.conf</file>. Change the <em>USERGROUPS</em>
variable to 'no' so that a new group does not get created when a user
is created. Also set <em>USERS_GID</em> to the GID of the users group
you want all users to be part of.


<sect1>Question regarding services and open ports

<sect2>Why are all services activated on installation?

<p>That's just an approach to the problem of being, on one side,
security conscious and on the other side user friendly. Unlike
OpenBSD, which disables all services unless activated by the
administrator, Debian GNU/Linux will activate all installed services
unless deactivated (see <ref id="disableserv"> for more
information). After all you installed the service, didn't you?

<p>There has been a lot of discussion on Debian mailing lists (both at
debian-devel and at debian-security) regarding which should be the
standard setup. However, there is not a consensus as of this writting
(march 10th 2002) on how it should be tackled.

<sect2>Can I remove inetd?

<p>Inetd is not easy to remove since <package>netbase</package>
depends on the package that provides it
(<package>netkit-inetd</package>. If you want to remove it you can
either disable it (see <ref id="disableserv"> or remove the package by
using the <package>equivs</package> package.

<sect2>Why do I have port 111 open?

<p>Port 111 is sunrpc's portmapper, it is installed by default in all
base installations of a Debian system since there is no need to know
when a user's program might need RPC to work out correctly. In any
case, it is used mostly for NFS. If you do not need it, remove it as
explained in <ref id="rpc">.

<sect2>What use is identd (113) for?

<p>Identd is used for administrators to provide userid details to
remote systems who want to know who's responsible for a given
connection from your machine. Notably this includes mail, FTP and IRC
servers, however, it can also be used to trace down which user in your
local system is attacking a remote system.

<p>There has been extensive discussion for this see the <url
id="http://lists.debian.org/debian-security/2001/debian-security-200108/msg00297.html"
name="mailing list archives">, basicly if you do not know what it is
for, don't activate it. But if you firewall it, <em>please</em> make
it a reject rule and not a deny rule, otherwise communications might
hang until a timeout expires (see <url
id="http://logi.cc/linux/reject_or_deny.php3" name="reject or deny
issues">).

<sect2>I have services using port 1 and 6, what are they and how can I remove them?
<p>If you have run <prgn>netsat -an</prgn> and receive:
<example>
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State
PID/Program name
raw        0      0 0.0.0.0:1               0.0.0.0:*               7
-
raw        0      0 0.0.0.0:6               0.0.0.0:*               7
-
</example>
<p>You are <em>not</em> seeing processes listening on TCP/UDP port 1
and 6. You are, in fact, seeing a process listening on a <em>raw</em>
socket for protocols 1 (ICMP) and 6 (TCP). Such a behavior is common
to both trojans and some intrusion detection systems such as:
<package>iipl</package>, <package>iplogger</package>, and
<package>portsentry</package>. If you have these packages remove them,
if you do not try netstat's -p (process) switch to see which process
is runing these listeners.

<sect2>I have checked I have the following port (XYZ) open, can I close it?

<p>Of course you can, the ports you are leaving open should adhere to
your site's policy regarding public services available to other
systems. Check if they are open by inetd (see <ref id="inetd">) or by
other installed packages and take appropriate measures (configure
inetd, remove the package, avoid it running on bootup...)

<sect2>I have removed services from <file>/etc/services</file>, am I ok?

<p><em>No</em>, <file>/etc/services</file> just provides a mapping
from a virtual name to a given port number, removing names from there
will not (usually) prevent services from being started. Some daemons
might not run if <file>/etc/services</file> is modified but that's not
the norm, and it's not the recommended way to do it, see <ref
id="disableserv">.


<sect1>Common security issues

<sect2>I have lost my password and cannot access the system!!

<p>The steps you need to take in order to recover from this depends on
whether or not you have applied the suggested procedure for limiting
access to Lilo and BIOS.

<p>If you have limited both. You need to disable the BIOS features
(only boot from hard disk) before proceeding, if you also forgot your
BIOS password, you will have to open your system and manually remove
the BIOS battery.

<p>If you have bootup of CD-ROM or diskette enable, you can:
<list>

<item>bootup from a rescue disk and start the kernel

<item>go to the virtual console (Alt+F2)

<item>mount the hard disk where your /root is

<item>edit (Debian 2.2 rescue disk comes with <prgn>ae</prgn>, Debian
3.0 comes with <prgn>nano-tiny</prgn> which is similar to
<prgn>vi</prgn>) <file>/etc/shadow</file> and change the line:

<example>
root:asdfjl290341274075:XXXX:X:XXXX:X::: (X=any number)
</example>

<p>to:

<example>
root::XXXX:X:XXXX:X:::
</example>

</list>

<p>This will remove the root password. You can startup the system and
root from the login: prompt as root (with an empty password). This
will work unless you have configured the system more tightly, i.e. if
you have allowed users with null passwords and root can login from the
console. 

<p>If you have introduced also this features you will need to enter in
single mode. LILO needs not to be restricted, if you have done this
too you will need to rerun <prgn>lilo</prgn> just after the root reset
above. This is quite tricky since your <file>/etc/lilo.conf</file>
will need to be tweaked due to having a / filesystem that is a ramdisk
and not the real harddisk.

<p>Once LILO is not restricted it. You can:

<list>

<item>Press the Alt, shift or Control key just before the system BIOS
finishes, you should get the LILO prompt.

<item>Type 'linux single', 'linux init=/bin/sh' or 'linux 1' in the prompt.

<item>you should get to a shell prompt in singleuser mode (it will ask
for password but you already know it)

<item>remount read/write the / partition
<example>
mount -o remount,rw /
</example>

<item>change the superuser password with <prgn>passwd</prgn> (since
you are superuser it will not ask for the previous password).

</list>

<sect1>I want to setup a service for my users bot not give shell accounts.  

<p>If you want to give a POP service, for example, you do not need to
setup a user account for each user accessing it. It's best to setup a
directory-based authentication through an external service (like
Radius, LDAP or an SQL database). Just install the appropiate PAM
library (<package>libpam-radius-auth</package>,
<package>libpam-ldap</package>, <package>libpam-pgsql</package> or
<package>libpam-mysql</package>), read the documentation (for
starters, see <ref id="auth-pam"> and configure the PAM-enabled
service to use the backend you have chosen. This is done by editing
the files under <file>/etc/pam.d/</file> for your service and modify
the
<example>
auth    required        pam_unix_auth.so shadow nullok use_first_pass
</example>
to, for example, ldap: 
<example>
auth    required        pam_ldap.so
</example>

<!-- FIXME: check if this i right (jfs) -->

<p>In the case of LDAP directories, some services provide LDAP schemas
to be included in your directory that need to be included in order to
use LDAP autentication for it. If you are using a relational database,
a useful trick is to use the <em>where</em> clause when configuring
the PAM modules. For example if you have a database with the following
table:

<example>
(user_id,user_name,realname,shell,password,uid,gid,homedir,sys,pop,imap,ftp)
</example>

<p>You can use the last (boolean) values to enable or disable access
to the different services just by inserting the appropiate lines in the following files:

<list>
<item><file>/etc/pam.d/imap</file>:<tt>where=imap=1</tt>.

<item><file>/etc/pam.d/qpopper</file>:<tt>where=pop=1</tt>.

<item><file>/etc/nss-mysql*.conf</file>:<tt>users.where_clause = user.sys = 1;</tt>.

<item><file>/etc/proftpd.conf</file>:<tt> SQLWhereClause "ftp=1"
</tt>.

</list>


<sect id="vulnerable-system">My system is vulnerable! (are you sure?)

<sect1 id="vulnasses-false-positive">Vulnerability assesment scanner X says my Debian system is vulnerable!

<p>Many vulnerability assessment scanners give false positives of
Debian systems since they only use version checks to determine if a
given software is vulnerable, but do not really test the security
vulnerability itself. Since Debian does not change software versions
when fixing a package (many times the fix made for newer releases is
backported) some tools tend to think that an updated Debian system is
vulnerable to things it's not really vulnerable to.

<p>If you think your system is up to date with security patches, you
might want to use the cross references to security vulnerabilities
databases published with the DSAs (see <ref id="dsa">) to weed out
false positivies if the tool you are using includes CVE references.


<sect1>I've seen an attack on my system logs: am I compromised?

<p>A trace of an attack does not always mean that you've been cracked
into, you should take the usual steps to determine if the system is
compromised (see <ref id="after-compromise">). Also notice that sometimes,
the fact that you see the attacks in the log might mean you system is
already vulnerable to it (a determined attacker might have used some
other besides the ones you have seen, however).

<sect1>I have found strange 'MARKs' in my logs: Am I compromised?

<p>You might find the following in your system logs. If your system
does not have a lot of load (and services) they probably be one of the
few appearing in your logs:

<example>
Dec 30 07:33:36 debian -- MARK --
Dec 30 07:53:36 debian -- MARK --
Dec 30 08:13:36 debian -- MARK --
</example>

<p>This does not indicate any cand of compromise, and users changing
between Debian releases might find it strange. It is, a matter of fact
an indication of <prgn>syslogd</prgn> running properly.
From <manref section="8" name="syslogd">:

<example>
       -m interval
              The syslogd logs a mark timestamp  regularly.   The
              default interval between two -- MARK -- lines is 20
              minutes.  This can be  changed  with  this  option.
              Setting the interval to zero turns it off entirely.
</example>

<sect1>I found users doing 'su' in my logs: Am I compromised?
<p>You might find lines in your logs like:
<example>
 Apr  1 09:25:01 server su[30315]: + ??? root-nobody
 Apr  1 09:25:01 server PAM_unix[30315]: (su) session opened for user nobody by (uid=0)
</example>
<p>Don't worry too much, check out if this is due to a job running through the cron
(usually <file>/etc/cron.daily/find</file> or <prgn>logrotate</prgn>):

<example>
$ grep 25 /etc/crontab
25 6    * * *   root    test -e /usr/sbin/anacron || run-parts --report
/etc/cron.daily
$ grep nobody /etc/cron.daily/*
find:cd / && updatedb --localuser=nobody 2>/dev/null
</example>

<sect1>I have found 'possible SYN flooding' in my logs: Am I under attack
<p>If you see this in your logs:
<example>
May 1 12:35:25 linux kernel: possible SYN flooding on port X. Sending cookies.
May 1 12:36:25 linux kernel: possible SYN flooding on port X. Sending cookies.
May 1 12:37:25 linux kernel: possible SYN flooding on port X. Sending cookies.
May 1 13:43:11 linux kernel: possible SYN flooding on port X. Sending cookies.
</example>
<p>And you notice a high number of connections to the server:
<example>
linux:~# netstat -ant | grep SYN_RECV | wc -l
   9000
</example>

<p>Is an indication of a denial of service attack that is being done
against your system's X port (there probably is a public service such
as a web server or mail server). You should activate tcp syncookies in
your kernel, see <ref id="tcp-syncookies">. Note, however, that a DoS
attack might flood your network even if you can stop it from crashing
your systems (due to file descriptores being depleted the system might
become unresponsive until the TCP connections timeout), the only
effective way to do this is to ask contact your network provider.

<sect1>I have found strange root sessions in my logs: Am I compromised?
<p>You might see this kind of entries in your <file>/var/log/auth.log</file> file:
<example>
May 2 11:55:02 linux PAM_unix[1477]: (cron) session closed for user root
May 2 11:55:02 linux PAM_unix[1476]: (cron) session closed for user root
May 2 12:00:01 linux PAM_unix[1536]: (cron) session opened for user root by
(uid=0)
May 2 12:00:02 linux PAM_unix[1536]: (cron) session closed for user root
</example>
<p>This is due to a cron entry being executed (in the example, every
five minutes). To determine which program is responsible for this
check entries under: <file>/etc/crontab</file>,
<file>/etc/cron.d</file>, <file>/etc/crond.daily</file> and probably
root's crontab under <file>/var/spool/cron/crontabs</file>.


<sect1>I have suffered a break-in what do I do?
<p>There are several steps you might want to in case of a break-in:
<list>

<item>Check if your system is vulnerable (i.e. if there are new
published vulnerabilities you have not patched yet). If it vulnerable
to remote vulnerabilities the chances that the system is in fact compromised 
increase. Even more if the vulnerability has been known for a while
(since there is usually more activity related to old know vulnerabilities).
FIXME: add a link to SANS's Top 20 vulnerabilities.

<item>Read this document, specially <ref id="after-compromise">.

<item>Ask for assistance. You might use the debian-security@lists.debian.org
to ask for advice on how to recover/patch your system.

<item>notify your local <url id="http://www.cert.org" name="CERT">
(if there is any, if not you might want to consider contacting CERT
directly). This might or might not help you but, at the very least,
it will inform CERT of ongoing attacks, this information is very
valuable to determine the widespread use of tools and attacks used
by the <em>blackhat</em> community.

</list>


<sect1>How can I trace an attack?

<p>Watching the logs (if they have not been changed), using intrusion
detection systems (see <ref id="intrusion-detect">),
<prgn>traceroute</prgn>, <prgn>whois</prgn> and similar tools
(including forensic analysis) you can trace an attack to the source.
The way you should react on this information depends, solely, on your
appropiate security policy, and what <em>you</em> consider an attack
is. Is a remote scan an attack? Is a vulnerability probe an attack?

<sect1>Program X in Debian is vulnerable, what do I do?
<p>Take a moment, first, to see if the vulnerability has been announced
in public security mailing lists (like Bugtraq) or other forums, the
Debian Security Team keeps up to date with this lists, so they might already
be aware of the problem. Do not take any further actions if you see an 
announcement already at <url id="http://security.debian.org">.
<p>If you do not see any of this, please send mail on the affected packages 
as well as a description of the vulnerability as detailed as possible 
(proof of concept code is also ok) to security@debian.org which will get 
you in touch with the security team.

<sect1>The version number for a package indicates that I am still running a vulnerable version!
<p>Instead of upgrading to a new release we backport security fixes to
the version that was shipped in the stable release. The reason we do
this is to make sure that a release changes as little as possible
so things will not change or break unexpectedly as a result of a
security fix. You can check if you are running a secure version of
a package by looking at the package changelog, or comparing its
exact (upstream version -slash- debian release) version number with the
version indicated in the Debian Security Advisory.              

<sect1>Specific software

<sect2>Proftpd is vulnerable to a Denial of Service attack

<p>Add <tt>DenyFilter \*.*/</tt> to your configuration file, for more
information see <url id="http://www.proftpd.org/critbugs.html">.

<sect2>I see quite a lot of open ports after installing Portsentry.

<p>That's just the way Portsentry works, it opens around twenty ports
on unused ports to try to detect port scans. 

<sect id="debian-sec-team-faq">Questions regarding the Debian security team

<!-- FIXME: update from web page -->

<sect1>What is a Debian Security Advisory (DSA) 
<p>It is the information sent by the Debian Security Team (see below) 
informing of a fix of a security related vulnerability available 
for the Debian operating system. Signed DSAs are sent to public mailing lists 
and posted in Debian's web site (both in the front page and in the
<url id="http://www.debian.org/security/" name="security area">).
<p>DSAs include information on the affected package/s, the bug
discovered and where to retrieve the updated packages (and their MD5 sums).

<sect1>The signature on Debian advisories does not verify correctly!

<p>This is most likely a problem on your end. The
   debian-security-announce list has a filter that only allows
   messages with a correct signature from one of the security team
   members to be posted.

<p>Most likely some piece of mail software on your end slightly
   changes the message that breaks the signature. Make sure your
   software does not do any MIME encoding or decoding, or tab/space
   conversions.

<p>Known culprits are fetchmail (with the mimedecode option enabled)
  and formail (from procmail 3.14 only).

<sect1>How are security incidents handled in Debian?
<p>Once the Security Team receives a notification of an incident,
one or more members review it and consider Debian/stable vulnerable
or not.  If our system is vulnerable, it is worked on a fix for the
problem.  The package maintainer is contacted as well, if he didn't
contact the Security Team already.  Finally the fix is tested and
new packages are prepared, which then are compiled on all stable
architectures and uploaded afterwards.  After all this tasks are
done a Debian Security Advisory (DSA) is sent to public mailing lists.

<sect1>How much time will it take Debian to fix vulnerability XXXX?
<p>Analysis of the time it takes the Debian security team
to send an advisory and produce fixed packages once a vulnerability
is known show that it does not take much time for vulnerabilities to
be fixed in the stable distribution.
<p>A report
<url id="http://lists.debian.org/debian-security/2001/debian-security-200112/msg00257.html" name="published in the debian-security mailinglist">
showed that in the year 2001, it took the Debian Security Team an
average of 35 days to fix security-related vulnerabilites. 
However, over 50% of the vulnerabilities where fixed in a 10-days time
frame, and over 15% of them where fixed the <em>same day</em> the advisory was released.
<p>However, when asking this question people tend 
to forget that:
<list>
<item>DSAs are not sent until:
<list>
<item>packages are available for <em>all</em>
architectures supported by Debian (this takes some time for packages
that are part of the system core, specially considering the number of
architectures supported in the stable release).
<item>new packages are thoroughly tested in order to ensure that no
bugs are introduced
</list>
<item>Packages might be available before the DSA is sent (in the
incoming queue or in the mirrors).
<item>Debian is a volunteer-based  project.
<item>there is a "no guarantees" clause, that is part of the license
with which Debian is given.
</list>

<p>If you want to more in depth analysis on the time it takes for the
Security Team to work on vulnerabilities you should consider that the
new DSAs (see <ref id="dsa">) published on the <url id="http://security.debian.org"
name="security website">, and the metadata used to generate them,
includes links to vulnerability databases. You could donwload the
sources of the web server (from the <url id="http://cvs.debian.org"
name="CVS">) or use the HTML pages to determine the time that it takes
for Debian to fix vulnerabilities correlating this data with public
databases.


<sect1 id="sec-unstable">How is security handled for <tt>testing</tt> and <tt>unstable</tt>?
<p>The short answer is: it's not. Testing and unstable are rapidly moving
   targets and the security team does not have the resources needed to
   properly support those. If you want to have a secure (and stable) server
   you are strongly encouraged to stay with stable.

<p><em>However</em>, as a matter of fact, unstable usually gets fixed
really quick since security updates sometimes get they are usually
available upstream faster (other versions, like those in stable need usually
to be backported).

<sect1 id="sec-older">I have an older version of Debian, is it security-supported?

<p>Unfortunately no, the Debian Security Team cannot handle both the
stable release (unofficially also the unstable) and other older
releases. However, you can expect security updated for a limited
period of time (usually several months) just after a new Debian
distribution is released.


<sect1>Why are there no official mirrors for security.debian.org?
<p>A: The purpose of security.debian.org is to make security updates available
   as quickly and easily as possible. Mirrors would add extra complexity
   that is not needed and can cause frustration if they are not up to
   date.

<sect1>I've seen DSA 100 and DSA 102, now where is DSA 101?

<p>Several vendors (mostly of GNU/Linux, but also of BSD derivatives)
   coordinate security advisories for some incidents and agree to a
   particular timeline so that all vendors are able to properly
   determine if they are (or not) vulnerable and create the patchs
   needed.

<p>The Debian Security Team holds, in this case, the numbers before
the advisory can be released, and hence temporarily leaving out one or
more advisories by number.


<sect1>How can I reach the security team?
<p>A: Security information can be sent to security@debian.org, which is read
   by all Debian developers. If you have sensitive information please
   use team@security.debian.org which only the members of the security
   team read. If desired email can be encrypted with the Debian Security
   Contact key (key ID 363CCD95).

<sect1>What different is there between security@debian.org and debian-security@lists.debian.org?

<p>When you send messages to security@debian.org these are sent to the
developers mailing list (debian-private) to which all Debian
developers are subscribed to, posts to this list are kept private
(i.e. are not archived at the public
website). Debian-security@lists.debian.org is a public mailinglist,
open to anyone that wants to subscribe to it, and there are searchable
archives available at the web site.


<sect1>How can I contribute with the Debian security team?
<p>
<list>
<item>By contributing to this document, fixing FIXMEs or providing new content.
Documentation is important and reduces the overload of answering common
issues. Translation of this documentation into other languages is also of great
help.

<item>By packaging applications that are useful for providing/checking security
in/using a Debian system. If you are not a developer, file a <url name="WNPP bug"
id="http://www.debian.org/devel/wnpp/"> and ask for software you think might
be useful and is not currently provided.

<item>Audit applications in Debian or help solve security bugs and report 
issues to security@debian.org. Other projects' work like the 
<url name="Linux Kernel Security Audit Project" id="http://kernel-audit.sourceforge.net/">
or the <url name="Linux Security-Audit Project"
id="http://www.lsap.org/"> increase the security of
Debian GNU/Linux since contributions will eventually help here too.

</list>

<p>In any case, please review each problem before reporting it to
security@debian.org.  If you are able to provide patches, that
would speed up the process.  Do not simply forward bugtraq mails,
since they are received already. Providing additional information,
however, is always a good idea.


<sect1>Who is the Security Team composed of?
<p>The Debian Security Team currently consists of five members and
two secretaries.  The Security Team itself appoints people to join
the team.

<sect1>Does the Debian Security team check every new package in Debian?
<p>No, the Debian security team does not check every new package and neither
is there an automatic (lintian) check in order to detect malicious new
packages, since those checks are rather impossible to detect automatically.
Maintainers, however, are fully responsible for the software that is
introduced in Debian and no software is introduced that is not first
signed by an authorised developers. They are in charge of analysing the
software they maintain and are security-aware.

<appendix id="harden-step">The hardening process step by step

<!--
# I took the liberty to change this from "checklist" to
# "process step by step" because this doesn't really have the
# form of a checklist, and I had added a different sort of
# checklist. The renaming is more to avoid confusion than
# anything else. // era
-->

<p>A procedure is always useful, since it allows you to see the entire
process of hardening the system and enables you to take decisions. A
possible approach for such a procedure in Debian 2.2 GNU/Linux is shown
below. This is a post-installation procedure, for a checklist of
measures to be taken, step by step, during configuration see <ref
id="checklist">. Also, this procedure is (for the moment) more
oriented towards hardening of network services.

<list>

<item>Do an installation of the system (take into account information
in this howto regarding partitioning). After base installation go into
custom install, do not select task packages but select shadow
passwords.

<item>go through <prgn>dselect</prgn> and remove unneeded but selected
packages before doing [I]nstall. Leave the bare minimum software in
the server.

<item>Update all software from latest packages available at
security.debian.org as explained previously in <ref id="security-update">.

<item>implement the suggested issues presented in this manual
regarding user quotas, login definitions and lilo

<item>in order to do a service hardening, make a list of services
currently awake in your system.
<example>
$ ps -aux
$ netstat -pn -l -A inet 
# /usr/sbin/lsof -i | grep LISTEN
</example>

You will need to install <package>lsof-2.2</package> for the third
command to work (run it as root). You should be aware that lsof can
translate the word LISTEN to your locale settings.

<item>in order to remove unnecessary services, first determine how is
it started and which package provides it. You can do this easily by
checking the program that listens in the socket, the following example
will tell you using this tools and <prgn>dpkg</prgn>

<example>
#!/bin/sh
# FIXME: this is quick and dirty; replace with a more robust script snippet
for i in `sudo lsof -i | grep LISTEN | cut -d " " -f 1 |sort -u` ; do
        pack=`dpkg -S $i |grep bin |cut -f 1 -d : | uniq`
        echo "Service $i is installed by $pack";
        init=`dpkg -L $pack |grep init.d/ `
        if [ ! -z "$init" ]; then
                 echo "and is run by $init"
        fi
done
</example>

<item>Once you find unwanted services, remove the package (with
<prgn>dpkg --purge</prgn>) or, if useful but should not be enabled on
startup, use <prgn>update-rc.d</prgn> (see <ref id="disableserv">) in
order to remove them from the system startup.

<item>For inetd services (launched by the superdaemon) you can just
check the enabled services, for example with:

<example>
$ grep -v "^#" /etc/inetd.conf | sort -u
</example>

and disable those not needed by commenting the line that includes
them, removing the package, or using <prgn>update-inetd</prgn>

<item>If you have wrapped services (those using
<prgn>/usr/sbin/tcpd</prgn>) check that the
<file>/etc/hosts.allow</file> and <file>/etc/hosts.deny</file> are
configured according to your service policy.

<item>If possible, and depending on each service, you might want to
limit services when using more than one external interface to listen
only on one of them. For example, if you want internal FTP access make
the FTP daemon listen only on your management interface, not on all
interfaces (i.e, 0.0.0.0:21).

<item>Reboot the machine, or switch it to single user and back to multiuser with 
<example>
$ init 1
(....)
$ init 2
</example>
<item>Check the services now available, and, if necessary, repeat steps above.
<item>Install now the needed services if you have not done so already, and configure
them properly.
<item>Check what users are being used to run available services for example with:
<example>
$ for i in `/usr/sbin/lsof -i |grep LISTEN |cut -d " " -f 1 |sort -u`; do user=`ps -ef |grep $i |grep -v grep |cut -f 1 -d " "` ; echo "Service $i is running as user $user"; done
</example>

and consider changing these services to a given user/group and maybe
also chrooting them for increased security. You can do this by
changing the <file>/etc/init.d</file> scripts, where the service
starts. Most services in Debian use <prgn>start-stop-daemon</prgn> so
you can use the --change-uid option and the --chroot option to setup
those services. Chrooting services is beyond the scope of this
document but a word of warning is necessary: you might need to put all
the files installed by the service package using dpkg -L and the
packages it depends on in the chrooted environment.

<item>Repeat steps above in order to check that only desired services are 
running and that they are run as the desired user/group combination.

<item>Test the installed services in order to see if they work as expected.

<item>Check the system using a vulnerability assessment scanner 
(like <package>nessus</package>) in order to determine vulnerabilities in the 
system (misconfigurations, old services or unneeded services).

<item>Install network intrusion measures and host intrusion measures (like 
<package>snort</package> and <package>logsentry</package>).

<item>Repeat the network scanner step and verify that the intrusion 
detection systems work fine.

</list>

For the truly paranoid, consider also the following:

<list>

<item>Add firewalling capabilities to the system, accepting 
incoming connections only to offered services and limiting 
outgoing connections to those authorized. 

<item>Recheck the installation with a new vulnerability assessment with a network scanner.

<item>Check outgoing connections using a network scanner from the system to a host
outside and verify that unwanted connections do not find their way out.

</list>

<p>FIXME: this procedure considers service hardening but not system
hardening at the user level, include information regarding checking
user permissions, setuid files and freezing changes in the system
using the ext2 filesystem.

<appendix id="checklist">Configuration checklist

<p>This appendix briefly reiterates points from the other sections of
this manual in a condensed checklist format.  This is intended as a
quick summary for someone who has already read the manual.
There are other good checklists available, Kurt Seifried has one
setup based on a course at
<url id="http://seifried.org/security/os/linux/20020324-securing-linux-step-by-step.html" name="Securing Linux Step by Step">.

<!-- FIXME: Add pointer to Unix Security Checklist (CERT) -->

<!-- Order is slightly different from body text. Consider changing text? -->
<!-- (FIXME) -->

<p>FIXME: This is based on v1.4 of the manual and might need to be updated.

<list>
	  <item>Limit physical access and booting capabilities
	      <list>
		<item>Enable BIOS password
		<item>Disable floppy/cdrom/... booting
		    
		<item>Set a LILO or GRUB password (<file>/etc/lilo.conf</file>
			or <file>/boot/grub/menu.lst</file>, respectively);
			check that the LILO or GRUB configuration file is
			read-protected.

		<item>Disallow MBR floppy booting back door by
		    overwriting the MBR (maybe not?)

	      </list>
	      
	  <item>Partitioning
	      <list>
		
		<item>Separate user-writable data, non-system data, and
		    rapidly changing run-time data to their own partitions
		    
		<item>Set <tt>nosuid,noexec,nodev</tt> mount options in
		    <file>/etc/fstab</file> on ext2 partitions such as
		    <file>/tmp</file>.
	      </list>
	      
	  <item>Password hygiene and login security
	      
	      <list>
		<item>Set a good root password
		<item>Enable password shadowing and MD5
		<item>Install and use PAM
		    
		    <list>
		      
		      <item>Add MD5 support to PAM and make sure that
			  (generally speaking) entries in
			<file>/etc/pam.d/</file> files which grant
			  access to the machine have the second field in
			  the pam.d file <!-- or is it third? (FIXME:
			  check) --> set to "requisite" or "required".
			  
		      <item>Tweak <file>/etc/pam.d/login</file> so as to
			  only permit local root logins.

		      <item>Also mark authorized tty:s in
			  <file>/etc/security/access.conf</file> and
			  generally set up this file to limit root
			  logins as much as possible.
			  
		      <item>Add pam_limits.so if you want to set
		      per-user limits
			  
		      <item>Tweak <file>/etc/pam.d/passwd</file>: set
			  minimum length of passwords higher (6
			  characters maybe) and enable md5

		      <item>Add group wheel to <file>/etc/group</file> if
			  desired; add pam_wheel.so group=wheel entry to
			  <file>/etc/pam.d/su</file>
			  
		      <item>For custom per-user controls, use
			  pam_listfile.so entries where appropriate
			  
		      <item>Have an <file>/etc/pam.d/other</file> file and
			  set it up with tight security

		    </list>
		    
		<item>Set up limits in <file>/etc/security/limits.conf</file>
		    (note that <file>/etc/limits</file> is not used
		    if you are using PAM)

		<item>Tighten up <file>/etc/login.defs</file>; also, if you
		    enabled MD5 and/or PAM, make sure you make the
		    corresponding changes here, too
		    
		<item>Disable root ftp access in <file>/etc/ftpusers</file>
		    
		<item>Disable network root login; use <manref
		    name="su" section="1"> or <manref name="sudo"
		    section="1">.  (consider installing
		    <package>sudo</package>)
		    
		<item>Use PAM to enforce additional constraints on logins?

	      </list>

	  <item>Other local security issues
	      <list>
		<item>Kernel tweaks
		    (see <ref id="kernel-conf">)
		    
		<item>Kernel patches
		    (see <ref id="kernel-patches">)
		    
		<item>Tighten up logfile permissions
		    (<file>/var/log/{last,fail}log</file>, Apache logs)
		    
		<item>Verify that setuid checking is enabled
		    in <file>/etc/checksecurity.conf</file>
		    
		<item>Consider making some log files append-only
		    and configuration files immutable
		    using chattr (ext2 filesystems only)



		<item>Set up file integrity (see  <ref
		id="check-integ">).  Install
		<package>debsums</package>
		    
		<item>Consider replacing locate with slocate
		    
		<item>Log everything to a local printer?
		    
		<item>Burn your configuration on a bootable CD and
		boot off that?
		    
		<item>Disable kernel modules?

	      </list>
	      
	  <item>Limit network access
	      <list>

		<item>Install and configure <prgn>ssh</prgn>
		    (suggest PermitRootLogin No in <file>/etc/ssh/sshd_config</file>,
		    PermitEmptyPasswords No;
		    note other suggestions in text also)
		    
		<item>Consider disabling or removing in.telnetd
		    
		<item>Generally, disable gratuitous services in
		<file>/etc/inetd.conf</file> using <tt>update-inetd
		      --disable</tt> (or disable inetd altogether, or use a
		    replacement such as xinetd or rlinetd)
		    
		<item>Disable other gratuitous network services;
		    mail, ftp, DNS, www etc should not be running
		    if you do not need them and monitor them regularly.

		<item>For those services which you do need, do not
		    just use the most common programs, look for more
		    secure versions shipped with Debian (or from other
		    sources).  Whatever you end up running, make sure
		    you understand the risks.

		<item>Set up chroot jails for outside users and daemons.

		<item>Configure firewall and tcpwrappers
		    (i.e. <manref name="hosts_access" section="5">);
		    note trick for <file>/etc/hosts.deny</file> in text.
		    
		<item>If you run ftp, set up your ftpd server
		    to always run chrooted to the user's home directory
		    
		<item>If you run X, disable xhost authentication and
		    go with ssh instead; better yet, disable remote X
		    if you can (add -nolisten tcp to the X command
		    line and turn off XDMCP in
		    <file>/etc/X11/xdm/xdm-config</file> by setting
		    the requestPort to 0)
		    
		<item>Disable outside access to printers
		    
		<item>Tunnel any IMAP or POP sessions through SSL or ssh;
		    install stunnel if you want to provide this service
		    to remote mail users
		    
		<item>Set up a loghost and configure other machines
		    to send logs to this host (<file>/etc/syslog.conf</file>)
		    
		<item>Secure BIND, Sendmail, and other complex daemons
		    (run in a chroot jail; run as a non-root pseudo-user)

		<item>Install snort or a similar logging tool.
		    
		<item>Do without NIS and RPC if you can (disable portmap).
		    
	      </list>

	  <item>Policy issues
	      <list>
		
		<item>Educate users about the whys and hows of your policies.
		    When you have prohibited something which is regularly
		    available on other systems, provide documentation
		    which explains how to accomplish similar results using
		    other, more secure means.

		<item>Prohibit use of protocols which use cleartext passwords
		    (telnet, rsh and friends; ftp, imap, http, ...).
		    
		<item>Prohibit programs which use SVGAlib.
		    
		<item>Use disk quotas.

	      </list>
	      
	  <item>Keep informed about security issues
	      <list>
		
		<item>Subscribe to security mailing lists
		    
		<item>Subscribe to security updates -- add to
		    <file>/etc/apt/sources.list</file> an entry (or
		    entries) for
		    http://security.debian.org/debian-security
		    
		<item>Also remember to periodically run
		<prgn>apt-get update ; apt-get upgrade</prgn>
		(perhaps install as a cron job?) as explained in <ref
		id="security-update">.

	      </list>

	</list>

<appendix id="snort-box">Setting up a stand alone IDS

<p>You can easily setup a Debian dedicated box as an standalone Intrusion
Detection System using <package>snort</package>.

<p>Some guidelines:

<list>
<item>Install a base Debian system and select no additional
packages.

<item>Download and manually (with dpkg) install necessary
packages (see installed packages list below).

<item>Download and install ACID (Analysis Console for
Intrusion Databases).

</list>

<p>ACID is currently packaged for Debian with the <package>acidlab</package>,
it provides a graphical WWW interface to snort's output. 
It can be downloaded from
<url id="http://www.cert.org/kb/acid/">, <url
id="http://acidlab.sourceforge.net"> or <url
id="http://www.andrew.cmu.edu/~rdanyliw/snort/">. You might want to read the 
<url id="http://www.linuxdoc.org/HOWTO/Snort-Statistics-HOWTO/index.html" name="Snort Statistics HOWTO">.


<p>You can setup this system with, at least, two interfaces: one
interface connected to a management lan (to access the results and
maintain he sytem), one interface with no ip-address attached to the
network segment to analyse.

<p>In order to configure the network cards without an ip-address you cannot use the standard's Debian <file>/etc/network/interfaces</file> since the <prgn>ifup</prgn> and <prgn>ifdown</prgn> expect some more information there than it is needed. You have to 
(simple
<tt>ifconfig eth0 up</tt>) 

<p>You need, besides the standard Debian installation, Apache, MySQL
and PHP4 for ACID to work.  Downloaded packages (Note: versions might
vary depending on which Debian distribution you are using, this are
from Debian <em>woody</em> september 2001):

<example>
ACID-0.9.5b9.tar.gz
adduser_3.39_all.deb
apache-common_1.3.20-1_i386.deb
apache_1.3.20-1_i386.deb
debconf_0.9.77_all.deb
dialog_0.9a-20010527-1_i386.deb
fileutils_4.1-2_i386.deb
klogd_1.4.1-2_i386.deb
libbz2-1.0_1.0.1-10_i386.deb
libc6_2.2.3-6_i386.deb
libdb2_2.7.7-8_i386.deb
libdbd-mysql-perl_1.2216-2_i386.deb
libdbi-perl_1.18-1_i386.deb
libexpat1_1.95.1-5_i386.deb
libgdbmg1_1.7.3-27_i386.deb
libmm11_1.1.3-4_i386.deb
libmysqlclient10_3.23.39-3_i386.deb
libncurses5_5.2.20010318-2_i386.deb
libpcap0_0.6.2-1_i386.deb
libpcre3_3.4-1_i386.deb
libreadline4_4.2-3_i386.deb 
libstdc++2.10-glibc2.2_2.95.4-0.010703_i386.deb
logrotate_3.5.4-2_i386.deb
mime-support_3.11-1_all.deb
mysql-client_3.23.39-3_i386.deb
mysql-common_3.23.39-3.1_all.deb
mysql-server_3.23.39-3_i386.deb
perl-base_5.6.1-5_i386.deb
perl-modules_5.6.1-5_all.deb
perl_5.6.1-5_i386.deb
php4-mysql_4.0.6-4_i386.deb
php4_4.0.6-1_i386.deb
php4_4.0.6-4_i386.deb
snort_1.7-9_i386.deb
sysklogd_1.4.1-2_i386.deb
zlib1g_1.1.3-15_i386.deb
</example>

<p>Installed packages (dpkg -l):
<example>
ii  adduser        3.39
ii  ae             962-26
ii  apache         1.3.20-1
ii  apache-common  1.3.20-1
ii  apt            0.3.19
ii  base-config    0.33.2
ii  base-files     2.2.0
ii  base-passwd    3.1.10
ii  bash           2.03-6
ii  bsdutils       2.10f-5.1
ii  console-data   1999.08.29-11.
ii  console-tools  0.2.3-10.3
ii  console-tools- 0.2.3-10.3
ii  cron           3.0pl1-57.2
ii  debconf        0.9.77
ii  debianutils    1.13.3
ii  dialog         0.9a-20010527-
ii  diff           2.7-21
ii  dpkg           1.6.15
ii  e2fsprogs      1.18-3.0
ii  elvis-tiny     1.4-11
ii  fbset          2.1-6
ii  fdflush        1.0.1-5
ii  fdutils        5.3-3   
ii  fileutils      4.1-2   
ii  findutils      4.1-40
ii  ftp            0.10-3.1
ii  gettext-base   0.10.35-13
ii  grep           2.4.2-1
ii  gzip           1.2.4-33
ii  hostname       2.07
ii  isapnptools    1.21-2
ii  joe            2.8-15.2  
ii  klogd          1.4.1-2   
ii  ldso           1.9.11-9   
ii  libbz2-1.0     1.0.1-10
ii  libc6          2.2.3-6
ii  libdb2         2.7.7-8
ii  libdbd-mysql-p 1.2216-2
ii  libdbi-perl    1.18-1
ii  libexpat1      1.95.1-5
ii  libgdbmg1      1.7.3-27
ii  libmm11        1.1.3-4
ii  libmysqlclient 3.23.39-3
ii  libncurses5    5.2.20010318-2
ii  libnewt0       0.50-7  
ii  libpam-modules 0.72-9
ii  libpam-runtime 0.72-9  
ii  libpam0g       0.72-9
ii  libpcap0       0.6.2-1
ii  libpcre3       3.4-1   
ii  libpopt0       1.4-1.1
ii  libreadline4   4.2-3 
ii  libssl09       0.9.4-5   
ii  libstdc++2.10  2.95.2-13 
ii  libstdc++2.10- 2.95.4-0.01070
ii  libwrap0       7.6-4   
ii  lilo           21.4.3-2
ii  locales        2.1.3-18
ii  login          19990827-20
ii  makedev        2.3.1-46.2
ii  mawk           1.3.3-5
ii  mbr            1.1.2-1 
ii  mime-support   3.11-1 
ii  modutils       2.3.11-13.1
ii  mount          2.10f-5.1
ii  mysql-client   3.23.39-3
ii  mysql-common   3.23.39-3.1
ii  mysql-server   3.23.39-3
ii  ncurses-base   5.0-6.0potato1
ii  ncurses-bin    5.0-6.0potato1
ii  netbase        3.18-4  
ii  passwd         19990827-20
ii  pciutils       2.1.2-2
ii  perl           5.6.1-5   
ii  perl-base      5.6.1-5   
ii  perl-modules   5.6.1-5
ii  php4           4.0.6-4   
ii  php4-mysql     4.0.6-4 
ii  ppp            2.3.11-1.4
ii  pppconfig      2.0.5
ii  procps         2.0.6-5   
ii  psmisc         19-2   
ii  pump           0.7.3-2 
ii  sed            3.02-5 
ii  setserial      2.17-16
ii  shellutils     2.0-7
ii  slang1         1.3.9-1  
ii  snort          1.7-9
ii  ssh            1.2.3-9.3
ii  sysklogd       1.4.1-2
ii  syslinux       1.48-2
ii  sysvinit       2.78-4  
ii  tar            1.13.17-2  
ii  tasksel        1.0-10 
ii  tcpd           7.6-4     
ii  telnet         0.16-4potato.1
ii  textutils      2.0-2  
ii  update         2.11-1    
ii  util-linux     2.10f-5.1
ii  zlib1g         1.1.3-15  
</example>

<appendix id="bridge-fw">Setting up a bridge firewall 

<p>This information was contributed by Francois Bayart in order to
help users setup a linux bridge/fireall with the 2.4.x kernel and
<package>iptables</package>. The only features need are the bridge
firewall patch, available at <url name="sourceforge download page"
id="http://bridge.sourceforge.net/download.html">.

<p>For example, if you are using a 2.4.18 kernel you need to download the
<url name="patch" id="http://bridge.sourceforge.net/devel/bridge-nf/bridge-nf-0.0.6-against-2.4.18.diff">
and apply it after downloading the
<package>kernel-source-2.4.1</package> package and then apply the
patch:

<example>
Zipowz:/usr/src# apt-get install kernel-source-2.4.18
Zipowz:/usr/src# cd kernel-source-2.4.18
Zipowz:/usr/src/kernel-source-2.4.18# patch -p1 < ../bridge-nf-0.0.6-against-2.4.18.diff 
patching file include/linux/netfilter.h
patching file include/linux/netfilter_ipv4.h
patching file include/linux/skbuff.h
patching file net/bridge/br.c
patching file net/bridge/br_forward.c
patching file net/bridge/br_input.c
patching file net/bridge/br_netfilter.c
patching file net/bridge/br_private.h
patching file net/bridge/Makefile
patching file net/Config.in
patching file net/core/netfilter.c
patching file net/core/skbuff.c
patching file net/ipv4/ip_output.c
patching file net/ipv4/netfilter/ip_tables.c
patching file net/ipv4/netfilter/ipt_LOG.c
</example>

<p>Now, run the configuration for the kernel (with your favorite
method: make menuconfig, make xconfig ... ). In the section
<em>Networking option</em> enable this options:

<example>
[*] Network packet filtering (replaces ipchains)
[ ]   Network packet filtering debugging (NEW)
<*> 802.1d Ethernet Bridging
[*]   netfilter (firewalling) support (NEW)
</example>

<p>Caution you must disable this if you want can to apply some
firewalling rules else iptables doesn't work.

<example>
[ ]   Network packet filtering debugging (NEW)
</example>

<p>After you must add the correct options in the section <em>IP:
Netfilter Configuration</em>.  Then, compile and install the
kernel. If you want to do it the <em>Debian way</em> install the
<package>kernel-package</package> and run <prgn>make-kpkg</prgn> to
create a new Debian package you can install on your server (or use
it on other systems). One the new kernel is installed and compiled
you need to install <package>bridge-utils</package>.

<p>Now, you can examine two different configurations which show how
configuration can be done once all this steps have been taken.  Both
configurations are shown with a network map and the commands neccesary
to configure the bridge.


<sect>A bridge providing nat and firewall capabilities

<p> The first one uses a bridge as a firewall with network address
translation that protects a server and internal LAN clients.

<example>
Internet ----- router ( 62.3.3.25 ) ----- bridge ( 62.3.3.26 gw 62.3.3.25 / 192.168.0.1 )
                                            |
                                            |
                                            |---- WWW Server ( 62.3.3.27 gw 62.3.3.25 )
                                            |
                                            |
                                           LAN --- Zipowz ( 192.168.0.2 gw 192.168.0.1 )
</example>

<p>This commands show how the bridge can be configured.
<example>
# That create the interface br0
/usr/sbin/brctl addbr br0

# Add the ethernet interface to use with the bridge
/usr/sbin/brctl addif br0 eth0
/usr/sbin/brctl addif br0 eth1

# Just up the interface ethernet
/sbin/ifconfig eth0 0.0.0.0
/sbin/ifconfig eth1 0.0.0.0

# Configure the bridge ethernet
# The bridge will be correct and invisible ( transparent firewall ).
# It's hidden in a traceroute and you keep your real gateway on the 
# other computers. Now if you want you can config a gateway on your 
# bridge and choose it as your new gateway for the other computers.

/sbin/ifconfig br0 62.3.3.26 netmask 255.255.255.248 broadcast 62.3.3.32

# I have added this internal IP to create my NAT 
ip addr add 192.168.0.1/24 dev br0
/sbin/route add default gw 62.3.3.25
</example>

<sect>A bridge providing firewall capabilities

<p>This system is setup as a transparent firewall for a LAN with a
Public IP address space.

<example>
Internet ----- router ( 62.3.3.25 ) ----- bridge ( 62.3.3.26 )
                                            |
                                            |
                                            |---- WWW Server ( 62.3.3.28 gw 62.3.3.25 )
                                            |
                                            |
                                            |---- Mail Server ( 62.3.3.27 gw 62.3.3.25 )
</example>

<p>This commands show how the bridge can be configured.
<example>
# That create the interface br0
/usr/sbin/brctl addbr br0

# Add the ethernet interface to use with the bridge
/usr/sbin/brctl addif br0 eth0
/usr/sbin/brctl addif br0 eth1

# Just up the interface ethernet
/sbin/ifconfig eth0 0.0.0.0
/sbin/ifconfig eth1 0.0.0.0

# Configure the bridge ethernet
# The bridge will be correct and invisible ( transparent firewall ).
# It's hidden in a traceroute and you keep your real gateway on the 
# other computers. Now if you want you can config a gateway on your
# bridge and choose it as your new gateway for the other computers.

/sbin/ifconfig br0 62.3.3.26 netmask 255.255.255.248 broadcast 62.3.3.32
</example>

<p>If you traceroute the Linux Mail Server you don't see the bridge,
if you want to access to the bridge with ssh you must have an gateway
or you must to connect to another server such as the "Mail Server" and
then connect to the bridge through the internal network card.</p>

<sect>Iptables basic rules

<p>This is an example of the basic rules that could be used for
any of these setups.

<example>
iptables -F FORWARD
iptables -P FORWARD DROP
iptables -A FORWARD -s 0.0.0.0/0.0.0.0 -d 0.0.0.0/0.0.0.0 -m state --state INVALID -j DROP
iptables -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT

# Some funny rules but not in a classic Iptables sorry ...
# Limit ICMP 
# iptables -A FORWARD -p icmp -m limit --limit 4/s -j ACCEPT
# Match string, a good simple method to block some VIRUS very Quickly
# iptables -I FORWARD -j DROP -p tcp -s 0.0.0.0/0 -m string --string "cmd.exe"

# Block all MySQL connection just to be sure
iptables -A FORWARD -p tcp -s 0/0 -d 62.3.3.0/24 --dport 3306 -j DROP

# Linux Mail Server Rules
#

# Allow FTP-DATA ( 20 ) , FTP ( 21 ) , SSH ( 22 ) 
iptables -A FORWARD -p tcp -s 0.0.0.0/0 -d 62.3.3.27/32 --dport 20:22 -j ACCEPT

# Allow the Mail Server to connect to the outside
# Note: This *not* needed for the previous connections 
# (remember: stateful filtering) and could be removed.
iptables -A FORWARD -p tcp -s 62.3.3.27/32 -d 0/0 -j ACCEPT

# WWW Server Rules
#

# Allow HTTP ( 80 ) connections with the WWW server
iptables -A FORWARD -p tcp -s 0.0.0.0/0 -d 62.3.3.28/32 --dport 80 -j ACCEPT

# Allow HTTPS ( 443 ) connections with the WWW server
iptables -A FORWARD -p tcp -s 0.0.0.0/0 -d 62.3.3.28/32 --dport 443 -j ACCEPT

# Allow the WWW server to go out
# Note: This *not* needed for the previous connections 
# (remember: stateful filtering) and could be removed.
iptables -A FORWARD -p tcp -s 62.3.3.28/32 -d 0/0 -j ACCEPT
</example>

<appendix id="bind-chuser">Sample script to change the default Bind installation.

<p>This script automates the procedure of changing the name server's default
installation so that it does <em>not</em> run as the superuser. Use with extreme
care since it has not been tested thoroughly. The script will create the user
and groups to be used for the name server.

<example>
#!/bin/sh
# Change the default Debian bind configuration to have it run
# with a non-root user and group.
#
# WARN: This script has not been tested throughly, please
# verify the changes made to the INITD script

# (c) 2002 Javier Fernandez-Sanguino Peña
#
#    This program is free software; you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation; either version 1, or (at your option)
#    any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#     Please see the file `COPYING' for the complete copyright notice.
#

restore() {
# Just in case, restore the system if the changes fail
	echo "WARN: Restoring to the previous setup since I'm unable to properly change it."
	echo "WARN: Please check the $INITDERR script."
	mv $INITD $INITDERR
	cp $INITDBAK $INITD
}


USER=named
GROUP=named
INITD=/etc/init.d/bind
INITDBAK=$INITD.preuserchange
INITDERR=$INITD.changeerror
START="start-stop-daemon --start --quiet --exec /usr/sbin/named -- -g $GROUP -u $USER"
AWKS="awk ' /start-stop-daemon --start/ { print \"$START\"; noprint = 1; }; /\/usr\/sbin\/ndc reload/ { print \"stop; sleep 2; start;\"; noprint = 1; } /\\\\$/ { if ( noprint != 0 ) { noprint = noprint + 1;} } /^.*$/ { if ( noprint != 0 ) { noprint = noprint - 1; } else { print \$0; } } '"

[ `id -u` -ne 0 ] && {
	echo "This program must be run by the root user"
	exit 1
}

RUNUSER=`ps -eo user,fname |grep named |cut -f 1 -d " "`

if [ "$RUNUSER" = "$USER" ] 
then
	echo "WARN: The name server running daemon is already running as $USER"
	echo "ERR:  This script will not many any changes to your setup."
	exit 1
fi
if [ ! -f $INITD ]
then
        echo "ERR:  This system does not have $INITD (which this script tries to change)"
        RUNNING=`ps -eo fname |grep named`
         [ -z "$RUNNING" ] && \
	    echo "ERR:  In fact the name server daemon is not even running (is it installed?)"
         echo "ERR:  No changes will be made to your system"
	exit 1
fi

# Check if named group exists
if [ -z "`grep $GROUP /etc/group`" ] 
then
	echo "Creating group $GROUP:"
	addgroup $GROUP
else
	echo "WARN: Group $GROUP already exists. Will not create it"
fi
# Same for the user
if [ -z "`grep $USER /etc/passwd`" ] 
then
	echo "Creating user $USER:"
	adduser --system --home /home/$USER \
	--no-create-home --ingroup $GROUP \
	--disabled-password --disabled-login $USER
else
	echo "WARN: The user $USER already exists. Will not create it"
fi

# Change the init.d script

# First make a backup (check that there is not already
# one there first)
if [ ! -f $INITDBAK ] 
then
	cp $INITD $INITDBAK
fi

# Then use it to change it
cat $INITDBAK |
eval $AWKS > $INITD

echo "WARN: The script $INITD has been changed, trying to test the changes."
echo "Restarting the named daemon (check for errors here)."

$INITD restart
if [ $? -ne 0 ] 
then
	echo "ERR:  Failed to restart the daemon."
	restore
	exit 1
fi

RUNNING=`ps -eo fname |grep named`
if [ -z "$RUNNING" ] 
then
	echo "ERR:  Named is not running, probably due to a problem with the changes."
	restore
	exit 1
fi

# Check if it's running as expected
RUNUSER=`ps -eo user,fname |grep named |cut -f 1 -d " "`

if [ "$RUNUSER" = "$USER" ] 
then
	echo "All has gone well, named seems to be running now as $USER."
else
	echo "ERR:  The script failed to automatically change the system."
	echo "ERR:  Named is currently running as $RUNUSER."
	restore
	exit 1
fi

exit 0
</example>

<p>The previous script, run on woody's (Debian 3.0) custom's bind will produce the
following initd file after creating the 'named' user and group:

<example>
#!/bin/sh

PATH=/sbin:/bin:/usr/sbin:/usr/bin

test -x /usr/sbin/named || exit 0

start () {
	echo -n "Starting domain name service: named"
	start-stop-daemon --start --quiet \
	    --pidfile /var/run/named.pid --exec /usr/sbin/named 
	echo "."	
}

stop () {
	echo -n "Stopping domain name service: named"
	# --exec doesn't catch daemons running deleted instances of named,
	# as in an upgrade.  Fortunately, --pidfile is only going to hit
	# things from the pidfile.
	start-stop-daemon --stop --quiet  \
	    --pidfile /var/run/named.pid --name named
	echo "."	
}

case "$1" in
    start)
	start
    ;;

    stop)
	stop
    ;;

    restart|force-reload)
	stop
	sleep 2
	start
    ;;
    
    reload)
	/usr/sbin/ndc reload
    ;;

    *)
	echo "Usage: /etc/init.d/bind {start|stop|reload|restart|force-reload}" >&2
	exit 1
    ;;
esac

exit 0
</example>

<appendix id="fw-security-update">Security update protected by a firewall

<p>After doing a standard installation a system might still have
security vulnerabilities, if so, there might be updates available from
Debian for the release. However, if you cannot download the packages
for the upgrade on another system (or mirror security.debian.org
yourself for local use) you need to connect to the Internet to do a
security update.

<p>However, when connecting yourself to the Internet you are exposing
yourself. If one of your local services is vulnerable you might be
compromised even before the update is finished! You might find this
paranoid but, in fact, analysis from the <url
id="http://www.honeynet.org" name="Honeynet Project"> show than
systems can be compromised in less than three days even if the system
is not known publicly (i.e. not published in dns records).

<p>When doing an update on a system not protected by an external
system (a firewall) you can, however, properly configure your local
firewall to only allow the security update itself. See the example
below to see how the local firewall capabilities to provide a
restricted setup in which only connections to security.debian.org are
allowed whileas the rest are logged.

<p>FIXME: add IP address for security.debian.org (since otherwise you
need DNS up to work) on /etc/hosts.

<p>FIXME: test this setup to see if it works properly

<p>FIXME: this will only work with http urls since ftp might need 
the ip_conntrack_ftp module, or use passive mode.

<!-- FIXME: this is probably not needed, after all it is a 
packet inspection fw:
# iptables -A INPUT -s security.debian.org -p 80 -j ACCEPT
-->

<example>
# iptables -F
# iptables -L
Chain INPUT (policy ACCEPT)
target     prot opt source               destination

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination
# iptables -P INPUT DROP
# iptables -P FORWARD DROP
# iptables -P OUTPUT DROP
# iptables -A OUTPUT -d security.debian.org -p 80 -j ACCEPT
# iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
# iptables -A INPUT -p icmp -j ACCEPT
# iptables -A INPUT -j LOG
# iptables -A OUTPUT -j LOG
# iptables -L
Chain INPUT (policy DROP)
target     prot opt source               destination
ACCEPT     all  --  0.0.0.0/0            0.0.0.0/0          state RELATED,ESTABLISHED
ACCEPT     icmp --  0.0.0.0/0            0.0.0.0/0
LOG        all  --  anywhere             anywhere           LOG level warning

Chain FORWARD (policy DROP)
target     prot opt source               destination

Chain OUTPUT (policy DROP)
target     prot opt source               destination
ACCEPT     80   --  anywhere             security.debian.org
LOG        all  --  anywhere             anywhere           LOG level warning
</example>

<appendix id="chroot-ssh-env">Chrooted environment for SSH

<p>You can create a restricted environment for SSH, this is, however,
quite a tough job due to its dependancies and the fact that, unlike
other servers, SSH provides a remote shell to users. Thus, the
applications users will be allowed to use in the environment.  If you
create this file structure in, for example,
<file>/var/chroot/ssh</file> you could start the ssh server chrooted
with:
<example>
# chroot /var/chroot/ssh /sbin/sshd -f /etc/sshd_config
</example>

<sect>Automatically making the environment (i.e. the easy way)

<p>You can make such an environment with <package>makejail</package>
easily since it takes care automatically of tracing the server daemon
(with <prgn>strace</prgn>) and make it run under the restricted environment.

<p>The advantage of such a program for automatic generation of chroot
environments is that it's capable of copying to the chroot environment
any package (even following its dependancies to make sure it's
complete). Providing user applications is, thus, easier.

<p>To setup this environment using makejail's provided examples just do:
<example>
# makejail /usr/share/doc/examples/bind.py
</example>

<p>You have to read the sample file to see what other changes need to
be made to the environment. Some of this changes, such as copying
user's home directories, cannot be automatically. Others, such as
limiting exposure of sensitive by copying only the information on a
given number of users from <file>/etc/shadow</file> or
<file>/etc/group</file> files.

<p>The following sample environment has been (slightly) tested and is
made with the configuration file provided in the package and including
the <package>fileutils</package>:


<example>
.
|-- bin
|   |-- ash
|   |-- bash
|   |-- chgrp
|   |-- chmod
|   |-- chown
|   |-- cp
|   |-- csh -> /etc/alternatives/csh
|   |-- dd
|   |-- df
|   |-- dir
|   |-- fdflush
|   |-- ksh
|   |-- ln
|   |-- ls
|   |-- mkdir
|   |-- mknod
|   |-- mv
|   |-- rbash -> bash
|   |-- rm
|   |-- rmdir
|   |-- sh -> bash
|   |-- sync
|   |-- tcsh
|   |-- touch
|   |-- vdir
|   |-- zsh -> /etc/alternatives/zsh
|   `-- zsh4
|-- dev
|   |-- null
|   |-- ptmx
|   |-- pts
|   |-- ptya0
(...)
|   |-- tty
|   |-- tty0
(...)
|   `-- urandom
|-- etc
|   |-- alternatives
|   |   |-- csh -> /bin/tcsh
|   |   `-- zsh -> /bin/zsh4
|   |-- environment
|   |-- hosts
|   |-- hosts.allow
|   |-- hosts.deny
|   |-- ld.so.conf
|   |-- localtime -> /usr/share/zoneinfo/Europe/Madrid
|   |-- motd
|   |-- nsswitch.conf
|   |-- pam.conf
|   |-- pam.d
|   |   |-- other
|   |   `-- ssh
|   |-- passwd
|   |-- resolv.conf
|   |-- security
|   |   |-- access.conf
|   |   |-- chroot.conf
|   |   |-- group.conf
|   |   |-- limits.conf
|   |   |-- pam_env.conf
|   |   `-- time.conf
|   |-- shadow
|   |-- shells
|   `-- ssh
|       |-- moduli
|       |-- ssh_host_dsa_key
|       |-- ssh_host_dsa_key.pub
|       |-- ssh_host_rsa_key
|       |-- ssh_host_rsa_key.pub
|       `-- sshd_config
|-- home
|   `-- userX
|-- lib
|   |-- ld-2.2.5.so
|   |-- ld-linux.so.2 -> ld-2.2.5.so
|   |-- libc-2.2.5.so
|   |-- libc.so.6 -> libc-2.2.5.so
|   |-- libcap.so.1 -> libcap.so.1.10
|   |-- libcap.so.1.10
|   |-- libcrypt-2.2.5.so
|   |-- libcrypt.so.1 -> libcrypt-2.2.5.so
|   |-- libdl-2.2.5.so
|   |-- libdl.so.2 -> libdl-2.2.5.so
|   |-- libm-2.2.5.so
|   |-- libm.so.6 -> libm-2.2.5.so
|   |-- libncurses.so.5 -> libncurses.so.5.2
|   |-- libncurses.so.5.2
|   |-- libnsl-2.2.5.so
|   |-- libnsl.so.1 -> libnsl-2.2.5.so
|   |-- libnss_compat-2.2.5.so
|   |-- libnss_compat.so.2 -> libnss_compat-2.2.5.so
|   |-- libnss_db-2.2.so
|   |-- libnss_db.so.2 -> libnss_db-2.2.so
|   |-- libnss_dns-2.2.5.so
|   |-- libnss_dns.so.2 -> libnss_dns-2.2.5.so
|   |-- libnss_files-2.2.5.so
|   |-- libnss_files.so.2 -> libnss_files-2.2.5.so
|   |-- libnss_hesiod-2.2.5.so
|   |-- libnss_hesiod.so.2 -> libnss_hesiod-2.2.5.so
|   |-- libnss_nis-2.2.5.so
|   |-- libnss_nis.so.2 -> libnss_nis-2.2.5.so
|   |-- libnss_nisplus-2.2.5.so
|   |-- libnss_nisplus.so.2 -> libnss_nisplus-2.2.5.so
|   |-- libpam.so.0 -> libpam.so.0.72
|   |-- libpam.so.0.72
|   |-- libpthread-0.9.so
|   |-- libpthread.so.0 -> libpthread-0.9.so
|   |-- libresolv-2.2.5.so
|   |-- libresolv.so.2 -> libresolv-2.2.5.so
|   |-- librt-2.2.5.so
|   |-- librt.so.1 -> librt-2.2.5.so
|   |-- libutil-2.2.5.so
|   |-- libutil.so.1 -> libutil-2.2.5.so
|   |-- libwrap.so.0 -> libwrap.so.0.7.6
|   |-- libwrap.so.0.7.6
|   `-- security
|       |-- pam_access.so
|       |-- pam_chroot.so
|       |-- pam_deny.so
|       |-- pam_env.so
|       |-- pam_filter.so
|       |-- pam_ftp.so
|       |-- pam_group.so
|       |-- pam_issue.so
|       |-- pam_lastlog.so
|       |-- pam_limits.so
|       |-- pam_listfile.so
|       |-- pam_mail.so
|       |-- pam_mkhomedir.so
|       |-- pam_motd.so
|       |-- pam_nologin.so
|       |-- pam_permit.so
|       |-- pam_rhosts_auth.so
|       |-- pam_rootok.so
|       |-- pam_securetty.so
|       |-- pam_shells.so
|       |-- pam_stress.so
|       |-- pam_tally.so
|       |-- pam_time.so
|       |-- pam_unix.so
|       |-- pam_unix_acct.so -> pam_unix.so
|       |-- pam_unix_auth.so -> pam_unix.so
|       |-- pam_unix_passwd.so -> pam_unix.so
|       |-- pam_unix_session.so -> pam_unix.so
|       |-- pam_userdb.so
|       |-- pam_warn.so
|       `-- pam_wheel.so
|-- sbin
|   `-- start-stop-daemon
|-- usr
|   |-- bin
|   |   |-- dircolors
|   |   |-- du
|   |   |-- install
|   |   |-- link
|   |   |-- mkfifo
|   |   |-- shred
|   |   |-- touch -> /bin/touch
|   |   `-- unlink
|   |-- lib
|   |   |-- libcrypto.so.0.9.6
|   |   |-- libdb3.so.3 -> libdb3.so.3.0.2
|   |   |-- libdb3.so.3.0.2
|   |   |-- libz.so.1 -> libz.so.1.1.4
|   |   `-- libz.so.1.1.4
|   |-- sbin
|   |   `-- sshd
|   `-- share
|       |-- locale
|       |   `-- es
|       |       |-- LC_MESSAGES
|       |       |   |-- fileutils.mo
|       |       |   |-- libc.mo
|       |       |   `-- sh-utils.mo
|       |       `-- LC_TIME -> LC_MESSAGES
|       `-- zoneinfo
|           `-- Europe
|               `-- Madrid
`-- var
    `-- run
        |-- sshd
        `-- sshd.pid

27 directories, 733 files
</example>

<sect>Patching SSH to enable chroot functionality

<p>Debian's sshd will not allow you to restrict user's movement
through the server since it lacks the Chroot function that the commercial
(sshd2) program has (using 'ChrootGroups' or 'ChrootUsers', see
<manref name="sshd2_config" section="5">). However, there is
a patch available that will allow you to do this, the patch
can be retrieved from
<url id="http://bugs.debian.org/139047" name="Bug report 139047"> or
<url id="http://www.cag.lcs.mit.edu/~raoul/">
(and might be applied in the OpenSSH package in the future). Emanuel
Lacour has ssh packages with this feature at 
<url id="http://debian.home-dn.net/woody/ssh/">, going through
the compilation step is recommended, though.

<p>A description of all the steps needed can be found at <url
id="http://mail.incredimail.com/howto/openssh/"> (almost all is
applicable to Debian even if it talks about RedHat 7.2).  After
applying the patch you just need to modify the
<file>/etc/passwd</file> by changing the home path of the users (with
the special <tt>/./</tt> token):

<example>
joeuser:x:1099:1099:Joe Random User:/home/joe/./:/bin/bash
</example>

<p>This will restrict <em>both</em> remote shell access as well as
remote copy through the ssh channel.

<p>Make sure to have all the needed binaries and libraries in the
chrooted path for users.  These files should be owned by root
to avoid tampering by the user (so as to exit the chrooted jailed).
A sample might include:

<example>
./bin:
total 660
drwxr-xr-x    2 root     root         4096 Mar 18 13:36 .
drwxr-xr-x    8 guest    guest        4096 Mar 15 16:53 ..
-r-xr-xr-x    1 root     root       531160 Feb  6 22:36 bash
-r-xr-xr-x    1 root     root        43916 Nov 29 13:19 ls
-r-xr-xr-x    1 root     root        16684 Nov 29 13:19 mkdir
-rwxr-xr-x    1 root     root        23960 Mar 18 13:36 more
-r-xr-xr-x    1 root     root         9916 Jul 26  2001 pwd
-r-xr-xr-x    1 root     root        24780 Nov 29 13:19 rm
lrwxrwxrwx    1 root     root            4 Mar 30 16:29 sh -> bash

./etc:
total 24
drwxr-xr-x    2 root     root         4096 Mar 15 16:13 .
drwxr-xr-x    8 guest    guest        4096 Mar 15 16:53 ..
-rw-r--r--    1 root     root           54 Mar 15 13:23 group
-rw-r--r--    1 root     root          428 Mar 15 15:56 hosts
-rw-r--r--    1 root     root           44 Mar 15 15:53 passwd
-rw-r--r--    1 root     root           52 Mar 15 13:23 shells

./lib:
total 1848
drwxr-xr-x    2 root     root         4096 Mar 18 13:37 .
drwxr-xr-x    8 guest    guest        4096 Mar 15 16:53 ..
-rwxr-xr-x    1 root     root        92511 Mar 15 12:49 ld-linux.so.2
-rwxr-xr-x    1 root     root      1170812 Mar 15 12:49 libc.so.6
-rw-r--r--    1 root     root        20900 Mar 15 13:01 libcrypt.so.1
-rw-r--r--    1 root     root         9436 Mar 15 12:49 libdl.so.2
-rw-r--r--    1 root     root       248132 Mar 15 12:48 libncurses.so.5
-rw-r--r--    1 root     root        71332 Mar 15 13:00 libnsl.so.1
-rw-r--r--    1 root     root        34144 Mar 15 16:10
libnss_files.so.2
-rw-r--r--    1 root     root        29420 Mar 15 12:57 libpam.so.0
-rw-r--r--    1 root     root       105498 Mar 15 12:51 libpthread.so.0
-rw-r--r--    1 root     root        25596 Mar 15 12:51 librt.so.1
-rw-r--r--    1 root     root         7760 Mar 15 12:59 libutil.so.1
-rw-r--r--    1 root     root        24328 Mar 15 12:57 libwrap.so.0

./usr:
total 16
drwxr-xr-x    4 root     root         4096 Mar 15 13:00 .
drwxr-xr-x    8 guest    guest        4096 Mar 15 16:53 ..
drwxr-xr-x    2 root     root         4096 Mar 15 15:55 bin
drwxr-xr-x    2 root     root         4096 Mar 15 15:37 lib

./usr/bin:
total 340
drwxr-xr-x    2 root     root         4096 Mar 15 15:55 .
drwxr-xr-x    4 root     root         4096 Mar 15 13:00 ..
-rwxr-xr-x    1 root     root        10332 Mar 15 15:55 env
-rwxr-xr-x    1 root     root        13052 Mar 15 13:13 id
-r-xr-xr-x    1 root     root        25432 Mar 15 12:40 scp
-rwxr-xr-x    1 root     root        43768 Mar 15 15:15 sftp
-r-sr-xr-x    1 root     root       218456 Mar 15 12:40 ssh
-rwxr-xr-x    1 root     root         9692 Mar 15 13:17 tty

./usr/lib:
total 852
drwxr-xr-x    2 root     root         4096 Mar 15 15:37 .
drwxr-xr-x    4 root     root         4096 Mar 15 13:00 ..
-rw-r--r--    1 root     root       771088 Mar 15 13:01
libcrypto.so.0.9.6
-rw-r--r--    1 root     root        54548 Mar 15 13:00 libz.so.1
-rwxr-xr-x    1 root     root        23096 Mar 15 15:37 sftp-server
</example>



<sect>Hand-made environment (i.e. the hard way)

<p>It is possible to create an environment doing trial-and-error, by
monitoring the sshd server traces and logfiles in order to determine
the needed files. The following environment, contributed by José Luis
Ledesma, is a sample listing of files in a chroot environment for ssh:
<footnote>
Notice that there are no set-uid files. This makes it more difficult
to remote users to escape the chroot environment. It also prevents,
however, users from changing their passwords since <prgn>passwd</prgn>
cannot modify the files <file>/etc/passwd</file> or
<file>/etc/shadow</file>.
</footnote>

<example>
.:
total 36
drwxr-xr-x 9 root root 4096 Jun 5 10:05 ./
drwxr-xr-x 11 root root 4096 Jun 3 13:43 ../
drwxr-xr-x 2 root root 4096 Jun 4 12:13 bin/
drwxr-xr-x 2 root root 4096 Jun 4 12:16 dev/
drwxr-xr-x 4 root root 4096 Jun 4 12:35 etc/
drwxr-xr-x 3 root root 4096 Jun 4 12:13 lib/
drwxr-xr-x 2 root root 4096 Jun 4 12:35 sbin/
drwxr-xr-x 2 root root 4096 Jun 4 12:32 tmp/
drwxr-xr-x 2 root root 4096 Jun 4 12:16 usr/
./bin:
total 8368
drwxr-xr-x 2 root root 4096 Jun 4 12:13 ./
drwxr-xr-x 9 root root 4096 Jun 5 10:05 ../
-rwxr-xr-x 1 root root 109855 Jun 3 13:45 a2p*
-rwxr-xr-x 1 root root 387764 Jun 3 13:45 bash*
-rwxr-xr-x 1 root root 36365 Jun 3 13:45 c2ph*
-rwxr-xr-x 1 root root 20629 Jun 3 13:45 dprofpp*
-rwxr-xr-x 1 root root 6956 Jun 3 13:46 env*
-rwxr-xr-x 1 root root 158116 Jun 3 13:45 fax2ps*
-rwxr-xr-x 1 root root 104008 Jun 3 13:45 faxalter*
-rwxr-xr-x 1 root root 89340 Jun 3 13:45 faxcover*
-rwxr-xr-x 1 root root 441584 Jun 3 13:45 faxmail*
-rwxr-xr-x 1 root root 96036 Jun 3 13:45 faxrm*
-rwxr-xr-x 1 root root 107000 Jun 3 13:45 faxstat*
-rwxr-xr-x 1 root root 77832 Jun 4 11:46 grep*
-rwxr-xr-x 1 root root 19597 Jun 3 13:45 h2ph*
-rwxr-xr-x 1 root root 46979 Jun 3 13:45 h2xs*
-rwxr-xr-x 1 root root 10420 Jun 3 13:46 id*
-rwxr-xr-x 1 root root 4528 Jun 3 13:46 ldd*
-rwxr-xr-x 1 root root 111386 Jun 4 11:46 less*
-r-xr-xr-x 1 root root 26168 Jun 3 13:45 login*
-rwxr-xr-x 1 root root 49164 Jun 3 13:45 ls*
-rwxr-xr-x 1 root root 11600 Jun 3 13:45 mkdir*
-rwxr-xr-x 1 root root 24780 Jun 3 13:45 more*
-rwxr-xr-x 1 root root 154980 Jun 3 13:45 pal2rgb*
-rwxr-xr-x 1 root root 27920 Jun 3 13:46 passwd*
-rwxr-xr-x 1 root root 4241 Jun 3 13:45 pl2pm*
-rwxr-xr-x 1 root root 2350 Jun 3 13:45 pod2html*
-rwxr-xr-x 1 root root 7875 Jun 3 13:45 pod2latex*
-rwxr-xr-x 1 root root 17587 Jun 3 13:45 pod2man*
-rwxr-xr-x 1 root root 6877 Jun 3 13:45 pod2text*
-rwxr-xr-x 1 root root 3300 Jun 3 13:45 pod2usage*
-rwxr-xr-x 1 root root 3341 Jun 3 13:45 podchecker*
-rwxr-xr-x 1 root root 2483 Jun 3 13:45 podselect*
-r-xr-xr-x 1 root root 82412 Jun 4 11:46 ps*
-rwxr-xr-x 1 root root 36365 Jun 3 13:45 pstruct*
-rwxr-xr-x 1 root root 7120 Jun 3 13:45 pwd*
-rwxr-xr-x 1 root root 179884 Jun 3 13:45 rgb2ycbcr*
-rwxr-xr-x 1 root root 20532 Jun 3 13:45 rm*
-rwxr-xr-x 1 root root 6720 Jun 4 10:15 rmdir*
-rwxr-xr-x 1 root root 14705 Jun 3 13:45 s2p*
-rwxr-xr-x 1 root root 28764 Jun 3 13:46 scp*
-rwxr-xr-x 1 root root 385000 Jun 3 13:45 sendfax*
-rwxr-xr-x 1 root root 67548 Jun 3 13:45 sendpage*
-rwxr-xr-x 1 root root 88632 Jun 3 13:46 sftp*
-rwxr-xr-x 1 root root 387764 Jun 3 13:45 sh*
-rws--x--x 1 root root 744500 Jun 3 13:46 slogin*
-rwxr-xr-x 1 root root 14523 Jun 3 13:46 splain*
-rws--x--x 1 root root 744500 Jun 3 13:46 ssh*
-rwxr-xr-x 1 root root 570960 Jun 3 13:46 ssh-add*
-rwxr-xr-x 1 root root 502952 Jun 3 13:46 ssh-agent*
-rwxr-xr-x 1 root root 575740 Jun 3 13:46 ssh-keygen*
-rwxr-xr-x 1 root root 383480 Jun 3 13:46 ssh-keyscan*
-rwxr-xr-x 1 root root 39 Jun 3 13:46 ssh_europa*
-rwxr-xr-x 1 root root 107252 Jun 4 10:14 strace*
-rwxr-xr-x 1 root root 8323 Jun 4 10:14 strace-graph*
-rwxr-xr-x 1 root root 158088 Jun 3 13:46 thumbnail*
-rwxr-xr-x 1 root root 6312 Jun 3 13:46 tty*
-rwxr-xr-x 1 root root 55904 Jun 4 11:46 useradd*
-rwxr-xr-x 1 root root 585656 Jun 4 11:47 vi*
-rwxr-xr-x 1 root root 6444 Jun 4 11:45 whoami*
./dev:
total 8
drwxr-xr-x 2 root root 4096 Jun 4 12:16 ./
drwxr-xr-x 9 root root 4096 Jun 5 10:05 ../
crw-r--r-- 1 root root 1, 9 Jun 3 13:43 urandom
./etc:
total 208
drwxr-xr-x 4 root root 4096 Jun 4 12:35 ./
drwxr-xr-x 9 root root 4096 Jun 5 10:05 ../
-rw------- 1 root root 0 Jun 4 11:46 .pwd.lock
-rw-r--r-- 1 root root 653 Jun 3 13:46 group
-rw-r--r-- 1 root root 242 Jun 4 11:33 host.conf
-rw-r--r-- 1 root root 857 Jun 4 12:04 hosts
-rw-r--r-- 1 root root 1050 Jun 4 11:29 ld.so.cache
-rw-r--r-- 1 root root 304 Jun 4 11:28 ld.so.conf
-rw-r--r-- 1 root root 235 Jun 4 11:27 ld.so.conf~
-rw-r--r-- 1 root root 88039 Jun 3 13:46 moduli
-rw-r--r-- 1 root root 1342 Jun 4 11:34 nsswitch.conf
drwxr-xr-x 2 root root 4096 Jun 4 12:02 pam.d/
-rw-r--r-- 1 root root 28 Jun 4 12:00 pam_smb.conf
-rw-r--r-- 1 root root 2520 Jun 4 11:57 passwd
-rw-r--r-- 1 root root 7228 Jun 3 13:48 profile
-rw-r--r-- 1 root root 1339 Jun 4 11:33 protocols
-rw-r--r-- 1 root root 274 Jun 4 11:44 resolv.conf
drwxr-xr-x 2 root root 4096 Jun 3 13:43 security/
-rw-r----- 1 root root 1178 Jun 4 11:51 shadow
-rw------- 1 root root 80 Jun 4 11:45 shadow-
-rw-r----- 1 root root 1178 Jun 4 11:48 shadow.old
-rw-r--r-- 1 root root 161 Jun 3 13:46 shells
-rw-r--r-- 1 root root 1144 Jun 3 13:46 ssh_config
-rw------- 1 root root 668 Jun 3 13:46 ssh_host_dsa_key
-rw-r--r-- 1 root root 602 Jun 3 13:46 ssh_host_dsa_key.pub
-rw------- 1 root root 527 Jun 3 13:46 ssh_host_key
-rw-r--r-- 1 root root 331 Jun 3 13:46 ssh_host_key.pub
-rw------- 1 root root 883 Jun 3 13:46 ssh_host_rsa_key
-rw-r--r-- 1 root root 222 Jun 3 13:46 ssh_host_rsa_key.pub
-rw-r--r-- 1 root root 2471 Jun 4 12:15 sshd_config
./etc/pam.d:
total 24
drwxr-xr-x 2 root root 4096 Jun 4 12:02 ./
drwxr-xr-x 4 root root 4096 Jun 4 12:35 ../
lrwxrwxrwx 1 root root 4 Jun 4 12:02 other -> sshd
-rw-r--r-- 1 root root 318 Jun 3 13:46 passwd
-rw-r--r-- 1 root root 546 Jun 4 11:36 ssh
-rw-r--r-- 1 root root 479 Jun 4 12:02 sshd
-rw-r--r-- 1 root root 370 Jun 3 13:46 su
./etc/security:
total 32
drwxr-xr-x 2 root root 4096 Jun 3 13:43 ./
drwxr-xr-x 4 root root 4096 Jun 4 12:35 ../
-rw-r--r-- 1 root root 1971 Jun 3 13:46 access.conf
-rw-r--r-- 1 root root 184 Jun 3 13:46 chroot.conf
-rw-r--r-- 1 root root 2145 Jun 3 13:46 group.conf
-rw-r--r-- 1 root root 1356 Jun 3 13:46 limits.conf
-rw-r--r-- 1 root root 2858 Jun 3 13:46 pam_env.conf
-rw-r--r-- 1 root root 2154 Jun 3 13:46 time.conf
./lib:
total 8316
drwxr-xr-x 3 root root 4096 Jun 4 12:13 ./
drwxr-xr-x 9 root root 4096 Jun 5 10:05 ../
-rw-r--r-- 1 root root 1024 Jun 4 11:51 cracklib_dict.hwm
-rw-r--r-- 1 root root 214324 Jun 4 11:51 cracklib_dict.pwd
-rw-r--r-- 1 root root 11360 Jun 4 11:51 cracklib_dict.pwi
-rwxr-xr-x 1 root root 342427 Jun 3 13:46 ld-linux.so.2*
-rwxr-xr-x 1 root root 4061504 Jun 3 13:46 libc.so.6*
lrwxrwxrwx 1 root root 15 Jun 4 12:11 libcrack.so -> libcrack.so.2.7*
lrwxrwxrwx 1 root root 15 Jun 4 12:11 libcrack.so.2 -> libcrack.so.2.7*
-rwxr-xr-x 1 root root 33291 Jun 4 11:39 libcrack.so.2.7*
-rwxr-xr-x 1 root root 60988 Jun 3 13:46 libcrypt.so.1*
-rwxr-xr-x 1 root root 71846 Jun 3 13:46 libdl.so.2*
-rwxr-xr-x 1 root root 27762 Jun 3 13:46 libhistory.so.4.0*
lrwxrwxrwx 1 root root 17 Jun 4 12:12 libncurses.so.4 -> libncurses.so.4.2*
-rwxr-xr-x 1 root root 503903 Jun 3 13:46 libncurses.so.4.2*
lrwxrwxrwx 1 root root 17 Jun 4 12:12 libncurses.so.5 -> libncurses.so.5.0*
-rwxr-xr-x 1 root root 549429 Jun 3 13:46 libncurses.so.5.0*
-rwxr-xr-x 1 root root 369801 Jun 3 13:46 libnsl.so.1*
-rwxr-xr-x 1 root root 142563 Jun 4 11:49 libnss_compat.so.1*
-rwxr-xr-x 1 root root 215569 Jun 4 11:49 libnss_compat.so.2*
-rwxr-xr-x 1 root root 61648 Jun 4 11:34 libnss_dns.so.1*
-rwxr-xr-x 1 root root 63453 Jun 4 11:34 libnss_dns.so.2*
-rwxr-xr-x 1 root root 63782 Jun 4 11:34 libnss_dns6.so.2*
-rwxr-xr-x 1 root root 205715 Jun 3 13:46 libnss_files.so.1*
-rwxr-xr-x 1 root root 235932 Jun 3 13:49 libnss_files.so.2*
-rwxr-xr-x 1 root root 204383 Jun 4 11:33 libnss_nis.so.1*
-rwxr-xr-x 1 root root 254023 Jun 4 11:33 libnss_nis.so.2*
-rwxr-xr-x 1 root root 256465 Jun 4 11:33 libnss_nisplus.so.2*
lrwxrwxrwx 1 root root 14 Jun 4 12:12 libpam.so.0 -> libpam.so.0.72*
-rwxr-xr-x 1 root root 31449 Jun 3 13:46 libpam.so.0.72*
lrwxrwxrwx 1 root root 19 Jun 4 12:12 libpam_misc.so.0 ->
libpam_misc.so.0.72*
-rwxr-xr-x 1 root root 8125 Jun 3 13:46 libpam_misc.so.0.72*
lrwxrwxrwx 1 root root 15 Jun 4 12:12 libpamc.so.0 -> libpamc.so.0.72*
-rwxr-xr-x 1 root root 10499 Jun 3 13:46 libpamc.so.0.72*
-rwxr-xr-x 1 root root 176427 Jun 3 13:46 libreadline.so.4.0*
-rwxr-xr-x 1 root root 44729 Jun 3 13:46 libutil.so.1*
-rwxr-xr-x 1 root root 70254 Jun 3 13:46 libz.a*
lrwxrwxrwx 1 root root 13 Jun 4 12:13 libz.so -> libz.so.1.1.3*
lrwxrwxrwx 1 root root 13 Jun 4 12:13 libz.so.1 -> libz.so.1.1.3*
-rwxr-xr-x 1 root root 63312 Jun 3 13:46 libz.so.1.1.3*
drwxr-xr-x 2 root root 4096 Jun 4 12:00 security/
./lib/security:
total 668
drwxr-xr-x 2 root root 4096 Jun 4 12:00 ./
drwxr-xr-x 3 root root 4096 Jun 4 12:13 ../
-rwxr-xr-x 1 root root 10067 Jun 3 13:46 pam_access.so*
-rwxr-xr-x 1 root root 8300 Jun 3 13:46 pam_chroot.so*
-rwxr-xr-x 1 root root 14397 Jun 3 13:46 pam_cracklib.so*
-rwxr-xr-x 1 root root 5082 Jun 3 13:46 pam_deny.so*
-rwxr-xr-x 1 root root 13153 Jun 3 13:46 pam_env.so*
-rwxr-xr-x 1 root root 13371 Jun 3 13:46 pam_filter.so*
-rwxr-xr-x 1 root root 7957 Jun 3 13:46 pam_ftp.so*
-rwxr-xr-x 1 root root 12771 Jun 3 13:46 pam_group.so*
-rwxr-xr-x 1 root root 10174 Jun 3 13:46 pam_issue.so*
-rwxr-xr-x 1 root root 9774 Jun 3 13:46 pam_lastlog.so*
-rwxr-xr-x 1 root root 13591 Jun 3 13:46 pam_limits.so*
-rwxr-xr-x 1 root root 11268 Jun 3 13:46 pam_listfile.so*
-rwxr-xr-x 1 root root 11182 Jun 3 13:46 pam_mail.so*
-rwxr-xr-x 1 root root 5923 Jun 3 13:46 pam_nologin.so*
-rwxr-xr-x 1 root root 5460 Jun 3 13:46 pam_permit.so*
-rwxr-xr-x 1 root root 18226 Jun 3 13:46 pam_pwcheck.so*
-rwxr-xr-x 1 root root 12590 Jun 3 13:46 pam_rhosts_auth.so*
-rwxr-xr-x 1 root root 5551 Jun 3 13:46 pam_rootok.so*
-rwxr-xr-x 1 root root 7239 Jun 3 13:46 pam_securetty.so*
-rwxr-xr-x 1 root root 6551 Jun 3 13:46 pam_shells.so*
-rwxr-xr-x 1 root root 55925 Jun 4 12:00 pam_smb_auth.so*
-rwxr-xr-x 1 root root 12678 Jun 3 13:46 pam_stress.so*
-rwxr-xr-x 1 root root 11170 Jun 3 13:46 pam_tally.so*
-rwxr-xr-x 1 root root 11124 Jun 3 13:46 pam_time.so*
-rwxr-xr-x 1 root root 45703 Jun 3 13:46 pam_unix.so*
-rwxr-xr-x 1 root root 45703 Jun 3 13:46 pam_unix2.so*
-rwxr-xr-x 1 root root 45386 Jun 3 13:46 pam_unix_acct.so*
-rwxr-xr-x 1 root root 45386 Jun 3 13:46 pam_unix_auth.so*
-rwxr-xr-x 1 root root 45386 Jun 3 13:46 pam_unix_passwd.so*
-rwxr-xr-x 1 root root 45386 Jun 3 13:46 pam_unix_session.so*
-rwxr-xr-x 1 root root 9726 Jun 3 13:46 pam_userdb.so*
-rwxr-xr-x 1 root root 6424 Jun 3 13:46 pam_warn.so*
-rwxr-xr-x 1 root root 7460 Jun 3 13:46 pam_wheel.so*
./sbin:
total 3132
drwxr-xr-x 2 root root 4096 Jun 4 12:35 ./
drwxr-xr-x 9 root root 4096 Jun 5 10:05 ../
-rwxr-xr-x 1 root root 178256 Jun 3 13:46 choptest*
-rwxr-xr-x 1 root root 184032 Jun 3 13:46 cqtest*
-rwxr-xr-x 1 root root 81096 Jun 3 13:46 dialtest*
-rwxr-xr-x 1 root root 1142128 Jun 4 11:28 ldconfig*
-rwxr-xr-x 1 root root 2868 Jun 3 13:46 lockname*
-rwxr-xr-x 1 root root 3340 Jun 3 13:46 ondelay*
-rwxr-xr-x 1 root root 376796 Jun 3 13:46 pagesend*
-rwxr-xr-x 1 root root 13950 Jun 3 13:46 probemodem*
-rwxr-xr-x 1 root root 9234 Jun 3 13:46 recvstats*
-rwxr-xr-x 1 root root 64480 Jun 3 13:46 sftp-server*
-rwxr-xr-x 1 root root 744412 Jun 3 13:46 sshd*
-rwxr-xr-x 1 root root 30750 Jun 4 11:46 su*
-rwxr-xr-x 1 root root 194632 Jun 3 13:46 tagtest*
-rwxr-xr-x 1 root root 69892 Jun 3 13:46 tsitest*
-rwxr-xr-x 1 root root 43792 Jun 3 13:46 typetest*
./tmp:
total 8
drwxr-xr-x 2 root root 4096 Jun 4 12:32 ./
drwxr-xr-x 9 root root 4096 Jun 5 10:05 ../
./usr:
total 8
drwxr-xr-x 2 root root 4096 Jun 4 12:16 ./
drwxr-xr-x 9 root root 4096 Jun 5 10:05 ../
lrwxrwxrwx 1 root root 7 Jun 4 12:14 bin -> ../bin//
lrwxrwxrwx 1 root root 7 Jun 4 11:33 lib -> ../lib//
lrwxrwxrwx 1 root root 8 Jun 4 12:13 sbin -> ../sbin//
</example>


</book>
