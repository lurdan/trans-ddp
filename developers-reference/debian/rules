#!/usr/bin/make -f
# rules file for sgml-data
#
# I do not use debstd, debhelper, or any of that stuff.
# I believe in stripped down rules files; nothing that is not required
# I believe in readability through abstraction

package		:= developers-reference

# directory abstraction
PREFIX		:= debian/tmp
docdir		:= $(PREFIX)/usr/doc/$(package)
libdir		:= $(PREFIX)/usr/lib/$(package)
sharedir	:= $(PREFIX)/usr/share/$(package)
menudir		:= $(PREFIX)/usr/lib/menu
docbasedir	:= $(PREFIX)/usr/share/doc-base

# tool abstraction
install_file	:= install -o root -g root -m 644 -p
install_program	:= install -o root -g root -m 755 -p
make_directory	:= install -d -o root -g root -m 755
compress	:= gzip -9f

# version abstraction
DEB_VERSION	:= $(shell LC_ALL=C dpkg-parsechangelog | grep ^Version: | sed 's/^Version: *//')
DATE		:= $(shell date +"%Y-%m-%d")

.PHONY: version.ent
version.ent:
	$(checkdir)
	rm -f version.ent
	echo "<!entity version \"$(DEB_VERSION)\">" >> version.ent
	echo "<!entity date    \"$(DATE)\">"        >> version.ent

build:	version.ent
	$(checkdir)
	nsgmls -gues developers-reference.sgml	# check SGML syntax
	debiandoc2html developers-reference.sgml
	debiandoc2text developers-reference.sgml
	touch build

clean:
	$(checkdir)
	rm -f build
	rm -rf developers-reference.html
	rm -f developers-reference.text*
	rm -f developers-reference.lout* lout.li
	rm -f version.ent
	rm -f `find . -name "*~"`
	rm -rf $(PREFIX)
	rm -f debian/files* core debian/substvars

binary-indep:	checkroot build
	$(checkdir)
	rm -rf $(PREFIX)
	$(make_directory) $(PREFIX)/DEBIAN
	$(make_directory) $(docdir)
	$(make_directory) $(libdir)
	$(make_directory) $(sharedir)

	$(install_file) developers-reference.html $(docdir)
	$(install_file) developers-reference.text $(docdir)
	$(install_file) developers-reference.sgml $(docdir)
	$(install_file) debian/copyright $(docdir)
	$(install_file) debian/changelog $(docdir)
	$(install_file) debian/menu $(menudir)/$(package)
	$(install_file) developers-reference.desc $(docbasedir)/$(package)

	# make sure control files are good
	sh -n debian/preinst
	sh -n debian/postinst
	sh -n debian/prerm
	# install the control files
	$(install_script) debian/control debian/postinst debian/prerm \
		$(PREFIX)/DEBIAN/

	# compress docdir (policy)	
	find $(docdir) -type f \( -size +4k -or -iname "change*" \) \
            ! -name "*.html" ! -name "*.gif" \
            ! -name "copyright" | xargs $(compress)

	dpkg-gencontrol -isp
	dpkg --build $(prefix) ..

	# some extra-package files
	debiandoc2ps -pletter -1 developers-reference.sgml
	$(compress) ../developers-reference.ps
	dpkg-distaddfile -fdebian/files developers-reference.ps.gz byhand -
	GZIP=-9v tar czf ../developers-reference.html.tar.gz developers-reference.html
	dpkg-distaddfile -fdebian/files developers-reference.html.tar.gz byhand -
	$(install_file) developers-reference.text ..
	$(compress) developers-reference.text
	dpkg-distaddfile -fdebian/files developers-reference.text.gz byhand -

binary-arch:	checkroot build
	$(checkdir)
# There are no architecture-dependent files to be uploaded
# generated by this package.  If there were any they would be
# made here.

define checkdir
	test -f debian/rules
endef

# Below here is fairly generic really

binary:		binary-indep binary-arch

checkroot:
	$(checkdir)
	test root = "`whoami`"

.PHONY: binary binary-arch binary-indep clean checkroot
