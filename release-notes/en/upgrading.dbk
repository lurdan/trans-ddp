<?xml version='1.0' encoding='utf-8'?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN"
  "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
  <!ENTITY % shareddata   SYSTEM "../release-notes.ent" > %shareddata;
]>

<chapter id="ch-upgrading" lang="en">
<title>Upgrades from Debian &oldrelease; (&oldreleasename;)</title>
<section id="backup">
<title>Preparing for the upgrade</title>
<para>
We suggest that before upgrading you also read the information in <xref
linkend="ch-information"/>.  That chapter covers potential issues not directly
related to the upgrade process but which could still be important to know about
before you begin.
</para>
<section id="data-backup">
<title>Back up any data or configuration information</title>
<para>
Before upgrading your system, it is strongly recommended that you make a full
backup, or at least back up any data or configuration information you can't
afford to lose.  The upgrade tools and process are quite reliable, but a
hardware failure in the middle of an upgrade could result in a severely damaged
system.
</para>
<para>
The main things you'll want to back up are the contents of
<filename>/etc</filename>, <filename>/var/lib/dpkg</filename>,
<filename>/var/lib/apt/extended_states</filename> and the output of
<literal>dpkg --get-selections "*"</literal> (the quotes are important).  If
you use <command>aptitude</command> to manage packages on your system, you
will also want to back up <filename>/var/lib/aptitude/pkgstates</filename>.
</para>
<para>
The upgrade process itself does not modify anything in the
<filename>/home</filename> directory.  However, some applications (e.g.  parts
of the Mozilla suite, and the GNOME and KDE desktop environments) are known to
overwrite existing user settings with new defaults when a new version of the
application is first started by a user.  As a precaution, you may want to make
a backup of the hidden files and directories (<quote>dotfiles</quote>) in users' home
directories.  This backup may help to restore or recreate the old settings.
You may also want to inform users about this.
</para>
<para>
Any package installation operation must be run with superuser privileges, so
either log in as <literal>root</literal> or use <command>su</command> or <command>sudo</command> to
gain the necessary access rights.
</para>
<para>
The upgrade has a few preconditions; you should check them before actually
executing the upgrade.
</para>

</section>

<section id="inform-users">
<title>Inform users in advance</title>
<para>
It's wise to inform all users in advance of any upgrades you're planning,
although users accessing your system via an <command>ssh</command> connection
should notice little during the upgrade, and should be able to continue
working. 
</para>
<para>
If you wish to take extra precautions, back up or unmount the
<filename>/home</filename> partition before upgrading.
</para>
<para>
You will have to do a kernel upgrade when upgrading to &releasename;, so a
reboot will be necessary. 
<!-- Not for Squeeze: 
Typically, this will be done after the upgrade is finished. -->
</para>
</section>

<!-- Based on information/complains from upgrade-reports, such as #602797 -->
<section id="services-downtime">
<title>Prepare for downtime on services</title>

<para>
There might be services that are offered by the system which are associated with packages
that will be included in the upgrade. If this is the case, please note that,
during the upgrade, these services will be stopped while their associated packages 
are being replaced and configured. During this time, these services will not be
available.
</para>

<para>
The precise downtime for these services will vary depending on the number of
packages being upgraded in the system, and it also includes the time the system
administrator answers the configuration questions from different package
upgrades (if any).  Notice that if the upgrade process is left unattended and
the system requests input throughout the upgrade there is a high
possibility of services being unavailable<footnote><para>If the debconf
priority is set to a very high level you might prevent configuration prompts,
but services that rely on default answers that are not applicable to your
system will fail to start.</para></footnote> for a significant period of time.
</para>

<para>
If the system being upgraded provides critical services for your users or the
network<footnote><para>For example: DNS or DHCP services, specially when
there is no redundancy or failover. In the DHCP case end-users might be disconnected 
from the network if the lease time is lower than the time it takes for the
upgrade process to complete.</para></footnote>, you can reduce the downtime if
you do a minimal system upgrade, as described in <xref
linkend="minimal-upgrade"/>, followed by a kernel upgrade and reboot (see <xref
linkend="upgrading-udev"/>), and then upgrade the packages associated with your
critical services. Upgrade these packages  prior to doing the full upgrade
described in <xref linkend="upgrading-full"/>.  This way you can ensure that
these critical services are running and available through the full upgrade
process, and their downtime is reduced.
</para>

</section>

<section id="recovery">
<title>Prepare for recovery</title>
<para>
Because of the many changes in the kernel between &oldreleasename; and
&releasename; regarding drivers, hardware discovery and the naming and ordering
of device files, there is a real risk that you may experience problems
rebooting your system after the upgrade.  A lot of known potential issues are
documented in this and the next chapters of these Release Notes.
</para>
<para>
For that reason it makes sense to ensure that you will be able to recover if
your system should fail to reboot or, for remotely managed systems, fail to
bring up networking.
</para>

<!-- FIXME: Is there a risk in Lenny for this to happen? -->
<!-- Another option would be an automatic reboot to a previous kernel using
Davor Ocelic's testnet script or similar --> 
<para>
If you are upgrading remotely via an <command>ssh</command> link it is highly
recommended that you take the necessary precautions to be able to access the
server through a remote serial terminal.  There is a chance that, after
upgrading the kernel and rebooting, some devices will be renamed (as described
in <xref linkend="device-reorder"/> ) and you will have to fix the system
configuration through a local console.  Also, if the system is rebooted
accidentally in the middle of an upgrade there is a chance you will need to
recover using a local console.
</para>
<!-- FIXME: The next paragraph might not be true for Lenn? -->
<para>
The most obvious thing to try first is to reboot with your old kernel.
However, for various reasons documented elsewhere in this document, this is not
guaranteed to work.
</para>
<para>
If that fails, you will need an alternative way to boot your system so you can
access and repair it.  One option is to use a special rescue image or a Linux
live CD.  After booting from that, you should be able to mount your root file
system and <literal>chroot</literal> into it to investigate and fix the
problem.
</para>

<!-- FIXME: Consider putting this option first, as it should be the
recommended rescue method -->
<para>
Another option we'd like to recommend is to use the <emphasis>rescue
mode</emphasis> of the &releasename; Debian Installer.  The advantage of using the
installer is that you can choose between its many installation methods for one
that best suits your situation.  For more information, please consult the
section <quote>Recovering a Broken System</quote> in chapter 8 of the <ulink
url="&url-install-manual;">Installation
Guide</ulink> and the <ulink
url="&url-wiki;DebianInstaller/FAQ">Debian Installer FAQ</ulink>.
</para>
<section id="recovery-initrd">
<title>Debug shell during boot using initrd</title>
<para>
The <systemitem role="package">initramfs-tools</systemitem> includes a debug
shell<footnote><para> This feature can be disabled by adding the parameter
<literal>panic=0</literal> to your boot parameters.  </para> </footnote> in the
initrds it generates.  If for example the initrd is unable to mount your root
file system, you will be dropped into this debug shell which has basic commands
available to help trace the problem and possibly fix it.
</para>
<para>
Basic things to check are: presence of correct device files in
<filename>/dev</filename>; what modules are loaded (<literal>cat
/proc/modules</literal>); output of <command>dmesg</command> for errors loading
drivers.  The output of <command>dmesg</command> will also show what device
files have been assigned to which disks; you should check that against the
output of <literal>echo $ROOT</literal> to make sure that the root file system
is on the expected device.
</para>
<para>
If you do manage to fix the problem, typing <literal>exit</literal> will quit
the debug shell and continue the boot process at the point it failed.  Of
course you will also need to fix the underlying problem and regenerate the
initrd so the next boot won't fail again.
</para>
</section>

</section>

<section id="upgrade-preparations">
<title>Prepare a safe environment for the upgrade</title>
<para>
The distribution upgrade should be done either locally from a textmode virtual
console (or a directly connected serial terminal), or remotely via an
<command>ssh</command> link. 
</para>
<important>
  <para>
  If you are using some VPN services (such as <systemitem
  role="package">tinc</systemitem>) they might not be available
  throughout the upgrade process. Please see 
  <xref linkend="services-downtime"/>.
  </para>
</important>
<para>
In order to gain extra safety margin when upgrading remotely, we suggest that
you run upgrade processes in the virtual console provided by the
<command>screen</command> program, which enables safe reconnection and ensures
the upgrade process is not interrupted even if the remote connection process
fails.
</para>
<important>
  <para>
    You should <emphasis>not</emphasis> upgrade using <command>telnet</command>,
    <command>rlogin</command>, <command>rsh</command>, or from an X
    session managed by <command>xdm</command>, <command>gdm</command>
    or <command>kdm</command> etc on the machine you are upgrading.
    That is because each of those services may well be terminated
    during the upgrade, which can result in an
    <emphasis>inaccessible</emphasis> system that is only half-upgraded.
    Use of the GNOME application <command>update-manager</command> is
    <emphasis>strongly discouraged</emphasis> for upgrades to new releases, as
    this tool relies on the desktop session remaining active.
  </para>
</important>

<programlisting condition="fixme">
TODO: surely gdm/kdm are sane?
(vorlon) haha, no, gdm is not; I had that thought, and tested a gdm
         restart on my live session ;)
</programlisting>

</section>

</section>

<section id="system-status">
<title>Checking system status</title>
<para>
The upgrade process described in this chapter has been designed for upgrades
from <quote>pure</quote> &oldreleasename; systems without third-party packages.
For the greatest reliability of the
upgrade process, you may wish to remove third-party packages from your system
before you begin upgrading.
</para>
<para>
Direct upgrades from Debian releases older than &oldrelease; (&oldreleasename;)
are not supported.
Please follow the instructions in the <ulink
url="http://www.debian.org/releases/&oldreleasename;/releasenotes">Release
Notes for &debian; &oldrelease;</ulink> to upgrade to &oldrelease; first.
</para>
<para>
This procedure also assumes your system has been updated to the latest point
release of &oldreleasename;.  If you have not done this or are unsure, follow the
instructions in <xref linkend="old-upgrade"/>.
</para>

<section id="review-actions">
<title>Review actions pending in package manager</title>
<para>
In some cases, the use of <command>apt-get</command> for installing packages
instead of <command>aptitude</command> might make <command>aptitude</command>
consider a package as <quote>unused</quote> and schedule it for removal.  In general, you
should make sure the system is fully up-to-date and <quote>clean</quote> before proceeding
with the upgrade.
</para>
<para>
Because of this you should review if there are any pending actions in the
package manager <command>aptitude</command>.  If a package is scheduled for
removal or update in the package manager, it might negatively impact the
upgrade procedure.  Note that correcting this is only possible if your
<filename>sources.list</filename> still points to <emphasis>&oldreleasename;</emphasis>
and not to <emphasis>stable</emphasis> or <emphasis>&releasename;</emphasis>; see <xref
linkend="old-sources"/>.
</para>
<para>
To perform this review, launch <command>aptitude</command> in <quote>visual mode</quote> and
press <keycap>g</keycap> (<quote>Go</quote>).  If it shows any actions, you should review them and either fix
them or implement the suggested actions.  If no actions are suggested you will
be presented with a message saying <quote>No packages are scheduled to be installed,
removed, or upgraded</quote>.
</para>
</section>

<section id="disable-apt-pinning">
<title>Disabling APT pinning</title>
<para>
If you have configured APT to install certain packages from a distribution
other than stable (e.g.  from testing), you may have to change your APT pinning
configuration (stored in <filename>/etc/apt/preferences</filename>) to allow
the upgrade of packages to the versions in the new stable release.  Further
information on APT pinning can be found in <citerefentry>
<refentrytitle>apt_preferences</refentrytitle> <manvolnum>5</manvolnum>
</citerefentry>.
</para>
</section>

<section id="package-status">
<title>Checking packages status</title>
<para>
Regardless of the method used for upgrading, it is recommended that you check
the status of all packages first, and verify that all packages are in an
upgradable state.  The following command will show any packages which have a
status of Half-Installed or Failed-Config, and those with any error status.
</para>
<screen>
# dpkg --audit
</screen>
<para>
You could also inspect the state of all packages on your system using
<command>dselect</command>, <command>aptitude</command>, or with commands such
as
</para>
<screen>
# dpkg -l | pager
</screen>
<para>
or
</para>
<screen>
# dpkg --get-selections "*" &gt; ~/curr-pkgs.txt
</screen>
<para>
It is desirable to remove any holds before upgrading.  If any package that is
essential for the upgrade is on hold, the upgrade will fail.
</para>
<para>
Note that <command>aptitude</command> uses a different method for registering
packages that are on hold than <command>apt-get</command> and
<command>dselect</command>.  You can identify packages on hold for
<command>aptitude</command> with
</para>
<screen>
# aptitude search "~ahold" 
</screen>
<para>
If you want to check which packages you had on hold for
<command>apt-get</command>, you should use
</para>
<screen>
# dpkg --get-selections | grep hold
</screen>
<para>
If you changed and recompiled a package locally, and didn't rename it or put an
epoch in the version, you must put it on hold to prevent it from being
upgraded.
</para>
<para>
The <quote>hold</quote> package state for <command>apt-get</command> can be changed using:
</para>
<screen>
# echo <replaceable>package_name</replaceable> hold | dpkg --set-selections
</screen>
<para>
Replace <literal>hold</literal> with <literal>install</literal> to unset the
<quote>hold</quote> state.
</para>
<para>
If there is anything you need to fix, it is best to make sure your
<filename>sources.list</filename> still refers to &oldreleasename; as explained in <xref
linkend="old-sources"/>.
</para>
</section>

<section id="proposed-updates">
  <title>The proposed-updates section</title>
  <para>
    If you have listed the <literal>proposed-updates</literal> section
    in your <filename>/etc/apt/sources.list</filename> file, you
    should remove it from that file before attempting to upgrade your
    system.  This is a precaution to reduce the likelihood of
    conflicts.
  </para>
</section>

<!-- FIXME: REVIEW for Squeeze this was written for Lenny - drop? (jfs) -->
<section id="userbackports">
<title>Unofficial sources and backports</title>
<para>
If you have any non-Debian packages on your system, you should be aware that
these may be removed during the upgrade because of conflicting dependencies.
If these packages were installed by adding an extra package archive in your
<filename>/etc/apt/sources.list</filename>, you should check if that archive
also offers packages compiled for &releasename; and change the source line accordingly
at the same time as your source lines for Debian packages.
</para>
<para>
Some users may have unofficial backported <quote>newer</quote> versions of packages that
<emphasis>are</emphasis> in Debian installed on their &oldreleasename; system.  Such
packages are most likely to cause problems during an upgrade as they may result
in file conflicts<footnote><para> Debian's package management system normally
does not allow a package to remove or replace a file owned by another package
unless it has been defined to replace that package.  </para> </footnote>.
<xref linkend="trouble"/> has some information on how to deal with file
conflicts if they should occur.
</para>

</section>

</section>

<section id="upgrade-process">
<title>Preparing sources for APT</title>
<para>
Before starting the upgrade you must set up <systemitem
role="package">apt</systemitem>'s configuration file for package lists,
<filename>/etc/apt/sources.list</filename>.
</para>
<para>
<systemitem role="package">apt</systemitem> will consider all packages that can
be found via any <quote><literal>deb</literal></quote> line, and install the package with the
highest version number, giving priority to the first line in the
file (thus where you have multiple mirror locations, you'd typically first name a local
hard disk, then <acronym>CD-ROM</acronym>s, and then HTTP/FTP mirrors).
</para>

<para>
A release can often be referred to both by its codename (e.g.
<literal>&oldreleasename;</literal>, <literal>&releasename;</literal>) and by
its status name (i.e. <literal>oldstable</literal>, <literal>stable</literal>,
<literal>testing</literal>, <literal>unstable</literal>).  Referring to
a release by its codename has the advantage that you will never be surprised by
a new release and for this reason is the approach taken here.  It does of
course mean that you will have to watch out for release announcements yourself.
If you use the status name instead, you will just see loads of updates for
packages available as soon as a release has happened.
</para>

<section id="network">
<title>Adding APT Internet sources</title>
<para>
The default configuration is set up for installation from main Debian Internet
servers, but you may wish to modify <filename>/etc/apt/sources.list</filename>
to use other mirrors, preferably a mirror that is network-wise closest to you.
</para>
<para>
Debian HTTP or FTP mirror addresses can be found at <ulink
url="&url-debian-mirrors;"></ulink> (look at the <quote>list of Debian
mirrors</quote> section).  HTTP mirrors are generally speedier than FTP mirrors.
</para>
<para>
For example, suppose your closest Debian mirror is
<literal>&url-debian-mirror-eg;</literal>.  When inspecting that
mirror with a web browser or FTP program, you will notice that the main
directories are organized like this:
</para>
<programlisting>
&url-debian-mirror-eg;/debian/dists/&releasename;/main/binary-&architecture;/...
&url-debian-mirror-eg;/debian/dists/&releasename;/contrib/binary-&architecture;/...
</programlisting>
<para>
To use this mirror with <systemitem role="package">apt</systemitem>, you add this line to your
<filename>sources.list</filename> file:
</para>
<programlisting>deb &url-debian-mirror-eg;/debian &releasename; main contrib</programlisting>
<para>
Note that the `<literal>dists</literal>' is added implicitly, and the arguments
after the release name are used to expand the path into multiple directories.
</para>
<para>
After adding your new sources, disable the previously existing
<quote><literal>deb</literal></quote> lines in <filename>sources.list</filename> by placing a
hash sign (<literal>#</literal>) in front of them.
</para>
</section>

<section id="localmirror">
<title>Adding APT sources for a local mirror</title>
<para>
Instead of using HTTP or FTP package mirrors, you may wish to modify
<filename>/etc/apt/sources.list</filename> to use a mirror on a local disk
(possibly mounted over <acronym>NFS</acronym>).
</para>
<para>
For example, your package mirror may be under
<filename>/var/ftp/debian/</filename>, and have main directories like this:
</para>
<programlisting>
/var/ftp/debian/dists/&releasename;/main/binary-&architecture;/...
/var/ftp/debian/dists/&releasename;/contrib/binary-&architecture;/...
</programlisting>
<para>
To use this with <systemitem role="package">apt</systemitem>, add this line to your
<filename>sources.list</filename> file:
</para>
<programlisting>deb file:/var/ftp/debian &releasename; main contrib</programlisting>
<para>
Note that the `<literal>dists</literal>' is added implicitly, and the arguments
after the release name are used to expand the path into multiple directories.
</para>
<para>
After adding your new sources, disable the previously existing
<quote><literal>deb</literal></quote> lines in <filename>sources.list</filename> by placing a
hash sign (<literal>#</literal>) in front of them.
</para>
</section>

<section id="cdroms">
<title>Adding APT source from CD-ROM or DVD</title>
<para>
If you want to use CDs <emphasis>only</emphasis>, comment out the existing
<quote><literal>deb</literal></quote> lines in <filename>/etc/apt/sources.list</filename> by
placing a hash sign (<literal>#</literal>) in front of them.
</para>
<para>
Make sure there is a line in <filename>/etc/fstab</filename> that enables
mounting your CD-ROM drive at the <filename>/cdrom</filename> mount point (the
exact <filename>/cdrom</filename> mount point is required for
<command>apt-cdrom</command>).  For example, if <filename>/dev/hdc</filename>
is your CD-ROM drive, <filename>/etc/fstab</filename> should contain a line
like:
</para>
<programlisting>
/dev/hdc /cdrom auto defaults,noauto,ro 0 0
</programlisting>
<para>
Note that there must be <emphasis>no spaces</emphasis> between the words
<literal>defaults,noauto,ro</literal> in the fourth field.
</para>
<para>
To verify it works, insert a CD and try running
</para>
<screen>
# mount /cdrom    # this will mount the CD to the mount point
# ls -alF /cdrom  # this should show the CD's root directory
# umount /cdrom   # this will unmount the CD
</screen>
<para>
Next, run:
</para>
<screen>
# apt-cdrom add
</screen>
<para>
for each Debian Binary CD-ROM you have, to add the data about each CD to APT's
database.
</para>
</section>

</section>

<section id="upgradingpackages">
<title>Upgrading packages</title>
<para>
The recommended way to upgrade from previous &debian; releases is to
use the package management tool <command>apt-get</command>.  In previous
releases, <command>aptitude</command> was recommended for this purpose, but
recent versions of <command>apt-get</command> provide equivalent
functionality and also have shown to more consistently give the desired
upgrade results.
</para>
<para>
Don't forget to mount all needed partitions (notably the root and
<filename>/usr</filename> partitions) read-write, with a command like:
</para>
<screen>
# mount -o remount,rw /<replaceable>mountpoint</replaceable>
</screen>
<para>
Next you should double-check that the APT source entries (in
<filename>/etc/apt/sources.list</filename>) refer either to
<quote><literal>&releasename;</literal></quote> or to <quote><literal>stable</literal></quote>.  There should not be
any sources entries pointing to &oldreleasename;.
<note>
  <para>
    Source lines for a CD-ROM might sometimes refer to
    <quote><literal>unstable</literal></quote>; although this may be confusing, you
    should <emphasis>not</emphasis> change it.
  </para>
</note>
</para>

<section id="record-session">
<title>Recording the session</title>
<para>
It is strongly recommended that you use the <command>/usr/bin/script</command>
program to record a transcript of the upgrade session.  Then if a problem
occurs, you will have a log of what happened, and if needed, can provide exact
information in a bug report.  To start the recording, type:
</para>
<screen>
# script -t 2&gt;~/upgrade-&releasename;<replaceable>step</replaceable>.time -a ~/upgrade-&releasename;<replaceable>step</replaceable>.script
</screen>
<para>
or similar. If you have to rerun the typescript (e.g. if you have to reboot the
system) use different <replaceable>step</replaceable> values to indicate which
step of the upgrade you are logging. Do not put the typescript file in a
temporary directory such as <filename>/tmp</filename> or
<filename>/var/tmp</filename> (files in those directories may be deleted during
the upgrade or during any restart).
</para>
<para>
The typescript will also allow you to review information that has scrolled
off-screen.  If you are at the system's console, just switch to VT2 (using
<keycombo action='simul'><keycap>Alt</keycap><keycap>F2</keycap></keycombo>)
and, after logging in, use
<literal>less -R ~root/upgrade-&releasename;.script</literal> to view
the file.
</para>
<para>
After you have completed the upgrade, you can stop <command>script</command> by
typing <literal>exit</literal> at the prompt.
</para>

<programlisting condition="fixme">
TODO: (jfs) Could mention the script I provided in #400725 which is useful if
you have not dumped the timing file
</programlisting>

<para>
If you have used the <emphasis>-t</emphasis> switch for
<command>script</command> you can use the <command>scriptreplay</command>
program to replay the whole session:
</para>
<screen>
# scriptreplay ~/upgrade-&releasename;.time ~/upgrade-&releasename;.script
</screen>
</section>

<section id="updating-lists">
<title>Updating the package list</title>
<para>
First the list of available packages for the new release needs to be fetched.
This is done by executing:
</para>
<screen>
# apt-get update
</screen>
</section>

<section id="sufficient-space">
<title>Make sure you have sufficient space for the upgrade</title>
<para>
You have to make sure before upgrading your system that you have sufficient
hard disk space when you start the full system upgrade described in <xref
linkend="upgrading-full"/>.  First, any package needed for installation that
is fetched from the network is stored in
<filename>/var/cache/apt/archives</filename> (and the
<filename>partial/</filename> subdirectory, during download), so you must make
sure you have enough space on the file system partition that holds
<filename>/var/</filename> to temporarily download the packages that will be
installed in your system.  After the download, you will probably need more
space in other file system partitions in order to both install upgraded
packages (which might contain bigger binaries or more data) and new packages
that will be pulled in for the upgrade.  If your system does not have
sufficient space you might end up with an incomplete upgrade that might be
difficult to recover from.
</para>
<para>
<command>apt-get</command> can show you detailed information of the disk
space needed for the installation.  Before executing the upgrade, you can see
this estimate by running:
</para>
<screen>
# apt-get -o APT::Get::Trivial-Only=true dist-upgrade
[ ... ]
XXX upgraded, XXX newly installed, XXX to remove and XXX not upgraded.
Need to get xx.xMB of archives. 
After this operation, AAAMB of additional disk space will be used.
</screen>
<note>
<para>
Running this command at the beginning of the upgrade process
may give an error, for the reasons described in the next sections.  In that
case you will need to wait until you've done the minimal system upgrade as in
<xref linkend="minimal-upgrade"/> and upgraded your kernel
before running this command to estimate the disk
space.
</para>
</note>

<para>
If you do not have enough space for the upgrade, <command>apt-get</command>
will warn you with a message like this:
</para>
<screen>
E: You don't have enough free space in /var/cache/apt/archives/.
</screen>

<para>In this situation, make sure you free up space
beforehand.  You can:
</para>
<itemizedlist>
<listitem>
<para>
Remove packages that have been previously downloaded for installation (at
<filename>/var/cache/apt/archives</filename>).  Cleaning up the package cache by
running <command>apt-get clean</command> will remove all previously downloaded
package files.
</para>
</listitem>
<listitem>
<para>
Remove forgotten packages.  If you have
<systemitem role="package">popularity-contest</systemitem> installed, you can use
<command>popcon-largest-unused</command> to list the packages you do not use
that occupy the most space. You can also use
<command>deborphan</command> or <command>debfoster</command> to find obsolete
packages (see <xref linkend="obsolete"/> ).  Alternatively you can start
<command>aptitude</command> in <quote>visual mode</quote> and find obsolete packages under
<quote>Obsolete and Locally Created Packages</quote>.
</para>
</listitem>
<listitem>
<para>
Remove packages that take up too much space and are not currently
needed (you
can always reinstall them after the upgrade).  You can list the packages that
take up the most disk space with <command>dpigs</command> (available in the
<systemitem role="package">debian-goodies</systemitem> package) or with
<command>wajig</command> (running <literal>wajig size</literal>).
</para>
<para>
You can list packages that take up most of the disk space with
<systemitem role="package">aptitude</systemitem>.  Start
<command>aptitude</command> in <quote>visual mode</quote>,
select <menuchoice><guimenu>Views</guimenu><guimenuitem>New Flat Package
List</guimenuitem></menuchoice>, press <keycap>l</keycap> and enter
<literal>~i</literal>, press <keycap>S</keycap> and enter
<literal>~installsize</literal>, then it will give you nice list to work
with. 
</para>
</listitem>
<listitem>
<para>
  Remove translations and localization files from the system if they
  are not needed.  You can install the <systemitem
  role="package">localepurge</systemitem> package and configure it so
  that only a few selected locales are kept in the system. This will
  reduce the disk space consumed at
  <filename>/usr/share/locale</filename>.
</para>
</listitem>
<listitem>
<para>
   Temporarily move to another system, or permanently remove, system logs
   residing under <filename>/var/log/</filename>.
</para>
</listitem>

<listitem>
  <para>
    Use a temporary <filename>/var/cache/apt/archives</filename>: You
    can use a temporary cache directory from another filesystem
    (<acronym>USB</acronym> storage device, temporary hard disk,
    filesystem already in use, ...)
  </para>
  <note>
    <para>
      Do not use an <acronym>NFS</acronym> mount as the network
      connection could be interrupted during the upgrade.
    </para>
  </note>
    <para>
  For example, if you have a <acronym>USB</acronym> drive mounted on <filename>/media/usbkey</filename>:
  <orderedlist>
    <listitem>
      <para>
	remove the packages that have been previously downloaded for
	installation:

	<screen># apt-get clean</screen>
      </para>
    </listitem>
    <listitem>
      <para>
	copy the directory
	<filename>/var/cache/apt/archives</filename> to the
	<acronym>USB</acronym> drive:

	<screen># cp -ax /var/cache/apt/archives /media/usbkey/</screen>
      </para>
    </listitem>
    <listitem>
      <para>
	mount the temporary cache directory on the current one:

	<screen># mount --bind /media/usbkey/archives /var/cache/apt/archives</screen>
      </para>
    </listitem>
    <listitem>
      <para>
	after the upgrade, restore the original
	<filename>/var/cache/apt/archives</filename> directory:

	<screen># umount /media/usbkey/archives</screen>
      </para>
    </listitem>
    <listitem>
      <para>
	remove the remaining <filename>/media/usbkey/archives</filename>.
      </para>
    </listitem>
  </orderedlist>
  You can create the temporary cache directory on whatever filesystem
  is mounted on your system.
  </para>
  </listitem>

<listitem>
  <para>
    Do a minimal upgrade of the system (see <xref linkend="minimal-upgrade"/>)
    or partial upgrades of the system followed by a full upgrade.
    This will make it possible to upgrade the system partially, and
    allow you to clean the package cache before the full upgrade.
  </para>
</listitem>

</itemizedlist>


<para>
Note that in order to safely remove packages, it is advisable to switch your
<filename>sources.list</filename> back to &oldreleasename; as described in <xref
linkend="old-sources"/>.
</para>
</section>

<section arch="i386">
  <title>Kernel flavour selection</title>
  <para>
    Debian's <literal>686</literal> kernel configuration has been replaced by
    the <literal>686-pae</literal> configuration, which uses PAE
    (<quote>Physical Address Extension</quote>).  If your computer is currently
    running the <literal>686</literal> configuration but does not have
    PAE, you will need to switch to the <literal>486</literal> configuration
    instead.  You can check whether your computer has PAE by running:
    <screen>
      grep -q '^flags.*\bpae\b' /proc/cpuinfo &amp;&amp; echo yes || echo no</screen>
    If it does not (i.e. the above command outputs <literal>no</literal>), you
    should install <systemitem role="package">linux-image-486</systemitem> and
    then remove <systemitem role="package">linux-image-686</systemitem> and/or
    <systemitem role="package">linux-image-2.6-686</systemitem> if they are
    currently installed.
  </para>

</section>

<section id="minimal-upgrade">
<title>Minimal system upgrade</title>
<para>
In some cases, doing the full upgrade (as described below) directly might
remove large numbers of packages that you will want to keep.  We therefore
recommend a two-part upgrade process, first a minimal upgrade to overcome these
conflicts, then a full upgrade as described in <xref
linkend="upgrading-full"/>. 
</para>
<para>
To do this first, run:
</para>
<screen>
# apt-get upgrade
</screen>
<para>
This has the effect of upgrading those packages which can be upgraded without
requiring any other packages to be removed or installed.
</para>

<para>
The minimal system upgrade can also be useful when the system is tight on space
and a full upgrade cannot be run due to space constrains.
</para>

</section>

<!-- For more information See BTS #571255 and #602397 -->
<!-- NOTE (jfs-2010-11-06) Upgrade tests for Squeeze have shown
that this is not absolutely required, users could do a dist-upgrade
and then reboot. This is, however, the recommended path to be on the 
safe side -->
<section id="upgrading-udev">
<title>Upgrading the kernel and udev</title>
<para>
The <systemitem role="package">udev</systemitem> version in &releasename;
requires a kernel of version 2.6.26 or newer with the
<literal>CONFIG_SYSFS_DEPRECATED</literal> option disabled and the
<literal>CONFIG_INOTIFY_USER</literal> and
<literal>CONFIG_SIGNALFD</literal> options enabled.  Because the standard
Debian kernels in &oldreleasename; (version 2.6.26) have
<literal>CONFIG_SYSFS_DEPRECATED</literal> enabled, and the <systemitem
role="package">udev</systemitem> version in &oldreleasename; will not
provide all the functionality expected by the latest kernels, special care
must be taken when upgrading to avoid putting your system in an unbootable
state.
</para>
<para>
Booting the 2.6.26 kernel from &oldreleasename; with the <systemitem
role="package">udev</systemitem> from &releasename; may result in a failure
to correctly assign names to network devices, and will also fail to apply
certain additional permissions to block devices (such as access by the
<literal>disk</literal> group). 
The software itself will appear to be working, but some rules
(for example, network-based rules) will not be loaded properly.
It is therefore strongly recommended that
you upgrade the kernel on its own at this point, to ensure a compatible
kernel is available before upgrading <systemitem
role="package">udev</systemitem>.
</para>
<!-- FIXME: Review if we have to upgrade the kernel *and* udev
at the same time here -->
<para>
To proceed with this kernel upgrade, run:
</para>
<screen>
# apt-get install linux-image-2.6-<replaceable>flavor</replaceable>
</screen>
<para>
See <xref linkend="kernel-metapackage"/> for help in determining which flavor
of kernel package you should install.
</para>
<para>
The move of some firmware to separate packages in the non-free archive means
that it may be necessary to install additional firmware packages after
upgrading to the new kernel to support some hardware. Some hardware that was
operating correctly before the upgrade might fail to work once the kernel is
upgraded. Look out for warning messages from the kernel install or initramfs
generation scripts, and make sure the necessary firmware packages are
installed.
</para>
<!-- TODO technical details useful at
http://raphaelhertzog.com/2011/03/14/missing-firmware-in-debian-learn-how-to-deal-with-the-problem/ 

Point to it or copy here? --> 
<para arch="i386;amd64">
Users of the <systemitem role="package">grub</systemitem> bootloader should
make sure that <command>update-grub</command> is run as part of the kernel
upgrade, or run it manually.
</para>
<para>
Immediately after upgrading the kernel, you should also install
the new <systemitem role="package">udev</systemitem> to minimize the risk of
other incompatibilities caused by using the old udev with a new kernel
<footnote><para>There are also known incompatibilities between the old kernel
and the new <systemitem role="package">udev</systemitem>. If you find
issues after the reboot with the new kernel you will have to downgrade the 
<systemitem role="package">udev</systemitem> in order 
to use the old one.</para></footnote>. 
You can do this by running:
</para>
<!-- TODO (2010-11-6): Needs to be tested, maybe the ugprade to udev might not
work due to the preinst checks introduced by the maintainer -->
<screen>
# apt-get install udev
</screen>

<para>
You should reboot the system 
<footnote><para>If you are logging the upgrade as described in
<xref linkend="upgradingpackages"/>, please, use <command>script</command> again
to log the next steps of the upgrade after the reboot in order to log the
result of the actions described in <xref linkend="upgrading-full"/>.
</para></footnote>
once you have upgraded both the kernel and  <systemitem role="package">udev</systemitem>.
</para>

</section>


<section id="upgrading-full">
<title>Upgrading the system</title>
<para>
Once you have taken the previous steps, you are now ready to continue
with the main part of the upgrade.  Execute:
</para>
<screen>
# apt-get dist-upgrade
</screen>
  <note>
    <para>
      The upgrade process for other releases recommended the
      use of <command>aptitude</command> for the upgrade. This
      tool is not recommended for upgrades from &oldreleasename; to
      &releasename;.
    </para>
  </note>
<para>
This will perform a complete upgrade of the system, i.e.  install the newest
available versions of all packages, and resolve all possible dependency changes
between packages in different releases.  If necessary, it will install some new
packages (usually new library versions, or renamed packages), and remove any
conflicting obsoleted packages.
</para>
<para>
When upgrading from a set of CD-ROMs (or DVDs), you will be asked to insert specific CDs
at several points during the upgrade.  You might have to insert the same CD
multiple times; this is due to inter-related packages that have been spread out
over the CDs.
</para>
<para>
New versions of currently installed packages that cannot be upgraded without
changing the install status of another package will be left at their current
version (displayed as <quote>held back</quote>).  This can be resolved by either using
<command>aptitude</command> to choose these packages for installation or by
trying <literal>apt-get -f install
<replaceable>package</replaceable></literal>.
</para>
</section>

</section>

<section id="trouble">
<title>Possible issues during upgrade</title>

<para>
The following sections describe known issues that might appear
during an upgrade to &releasename;.
</para>

<section arch="amd64" id="ia32libs">
<title>Transitioning from ia32-libs to multiarch</title>
<para>
Debian &release; now features multiarch, which allows one to install packages
from different architectures on the same system. The
<systemitem role="package">ia32-libs</systemitem> is now a transitional
package to make use of this new functionality. If you have
<systemitem role="package">ia32-libs</systemitem> installed, you need to
enable multiarch before upgrading this package. Otherwise APT will output
the following message:
<screen>
The following packages have unmet dependencies:
 ia32-libs : Depends: ia32-libs-i386 but it is not installable
E: Broken packages
</screen>
</para>

<para>
In order to allow installation of i386 packages on an amd64 system,
execute the following commands:
<screen>
# dpkg --add-architecture i386
# apt-get update
</screen>
</para>
</section>

<section id="cryptoloop">
<title>cryptoloop support not included in the &releasename; Linux kernel</title>
<para>
Support for cryptoloop has been dropped from the Linux kernel packages
included in Debian &release;.  Existing installations using cryptoloop need to
be transitioned to dm-crypt before the upgrade.
</para>
</section>

<section id="expected-removals">
<title>Expected removals</title>
<para>
The upgrade process to &releasename; might ask for removal of
packages in the system. The precise list of packages will vary depending on the
set of packages that you have installed.  These release notes give general
advice on these removals, but if in doubt, it is recommended that you examine
the package removals proposed by each method before proceeding.
</para>

<!-- FIXME: This needs to be reviewed based on real upgrade logs (jfs) -->
<!-- Alternative, another source of information is the UDD
'not-in-testing' page: http://udd.debian.org/bapase.cgi?t=testing -->
<para>
Some common packages that are expected to be removed include:
<systemitem role="package">autofs</systemitem> (replaced by
<systemitem role="package">autofs5</systemitem>),
<systemitem role="package">dhcp3</systemitem> (replaced by
<systemitem role="package">isc-dhcp</systemitem>),
<systemitem role="package">madwifi-source</systemitem>,
<systemitem role="package">python-setuptools</systemitem> and
<systemitem role="package">python2.4</systemitem> (replaced by
<systemitem role="package">python2.6</systemitem>).

For more information about packages obsoleted in &releasename;, see <xref
linkend="obsolete"/>.
</para>

</section>

<section id="apt-error-operation">
<title>Errors running aptitude or apt-get</title>
<para>
If an operation using <command>aptitude</command>, <command>apt-get</command>,
or <command>dpkg</command> fails with the error
</para>
<!-- TODO (jfs): Review the message, it has changed in apt-get to
"Dynamic MMap ran out of room. Please increase the size of APT::Cache-Limit. "
"Current value: %lu. (man 5 apt.conf)" -->
<screen>
E: Dynamic MMap ran out of room
</screen>
<para>
the default cache space is insufficient.  You can solve this by either removing
or commenting lines you don't need in
<filename>/etc/apt/sources.list</filename> or increasing the cache size.
The cache size can be increased by setting <literal>APT::Cache-Limit</literal>
in <filename>/etc/apt/apt.conf</filename>.  The following command will set it
to a value that should be sufficient for the upgrade:
</para>
<screen>
# echo 'APT::Cache-Limit "12500000";' &gt;&gt; /etc/apt/apt.conf
</screen>
<para>
This assumes that you do not yet have this variable set in that file.
</para>

</section>

<section id="conflicts-loops">
<title>Conflicts or Pre-Depends loops</title>

<para>
Sometimes it's necessary to enable the <literal>APT::Force-LoopBreak</literal>
option in APT to be able to temporarily remove an essential package due to a
Conflicts/Pre-Depends loop.  <command>apt-get</command> will alert you of this
and abort the upgrade.  You can work around this by specifying the option <literal>-o
APT::Force-LoopBreak=1</literal> on the <command>apt-get</command> command
line.
</para>
<para>
It is possible that a system's dependency structure can be so corrupt as to
require manual intervention.  Usually this means using
<command>apt-get</command> or
</para>
<screen>
# dpkg --remove <replaceable>package_name</replaceable>
</screen>
<para>
to eliminate some of the offending packages, or
</para>
<screen>
# apt-get -f install
# dpkg --configure --pending
</screen>
<para>
In extreme cases you might have to force re-installation with a command like
</para>
<screen>
# dpkg --install <replaceable>/path/to/package_name.deb</replaceable>
</screen>

</section>

<section id="file-conflicts">
<title>File conflicts</title>

<para>
File conflicts should not occur if you upgrade from a <quote>pure</quote> &oldreleasename; system, but
can occur if you have unofficial backports installed.  A file conflict will
result in an error like:
</para>
<screen>
Unpacking <replaceable>&lt;package-foo&gt;</replaceable> (from <replaceable>&lt;package-foo-file&gt;</replaceable>) ...
dpkg: error processing <replaceable>&lt;package-foo&gt;</replaceable> (--install):
 trying to overwrite `<replaceable>&lt;some-file-name&gt;</replaceable>',
 which is also in package <replaceable>&lt;package-bar&gt;</replaceable>
dpkg-deb: subprocess paste killed by signal (Broken pipe)
 Errors were encountered while processing:
 <replaceable>&lt;package-foo&gt;</replaceable>
</screen>
<para>
You can try to solve a file conflict by forcibly removing the package mentioned
on the <emphasis>last</emphasis> line of the error message:
</para>
<screen>
# dpkg -r --force-depends <replaceable>package_name</replaceable>
</screen>
<para>
After fixing things up, you should be able to resume the upgrade by repeating
the previously described <command>apt-get</command> commands.
</para>

</section>

<section id="configuration-changes">
<title>Configuration changes</title>

<para>
During the upgrade, you will be asked questions regarding the configuration
or re-configuration of several packages.  When you are asked if any file in
the <filename>/etc/init.d</filename> directory, or the
<filename>/etc/manpath.config</filename> file should be replaced by the
package maintainer's version, it's usually necessary to answer `yes' to
ensure system consistency.  You can always revert to the old versions, since
they will be saved with a <literal>.dpkg-old</literal> extension.
</para>
<para>
If you're not sure what to do, write down the name of the package or file and
sort things out at a later time.  You can search in the typescript file to
review the information that was on the screen during the upgrade.
</para>
</section>

<section id="console-change">
<title>Change of session to console</title>
<para>
If you are running the upgrade using the system's local console you
might find that at some points during the upgrade the console is shifted over
to a different view and you lose visibility of the upgrade
process.  For example, this will happen in desktop systems when
<command>gdm</command> is restarted.
</para>
<para>
To recover the console where the upgrade was running you will have to use
<keycombo action='simul'><keycap>Ctrl</keycap><keycap>Alt</keycap><keycap>F1</keycap></keycombo>
to switch back to the virtual terminal 1 if in the graphical startup screen or
use <keycombo action='simul'><keycap>Alt</keycap><keycap>F1</keycap></keycombo>
if in the local text-mode console. Replace F1 with the function key with the
same number of the virtual terminal the upgrade was running in. You can also
use <keycombo action='simul'><keycap>Alt</keycap><keycap>Left Arrow</keycap></keycombo> or
<keycombo action='simul'><keycap>Alt</keycap><keycap>Right
Arrow</keycap></keycombo> to switch between the different text-mode terminals.
</para>
</section>

<section id="package-specific-issues">
<title>Special care for specific packages</title>
<para>
In most cases, packages should upgrade smoothly between &oldreleasename;
and &releasename;.  There are a small number of cases where some intervention
may be required, either before or during the upgrade; these are detailed
below on a per-package basis.
</para>
<section id="issues-evolution">
<title>Evolution</title>
<para>
Evolution (the GNOME Desktop mail client) has been updated from version
<literal>2.22</literal> to <literal>2.30</literal>. This changes the
storage format used by the package for local data and there is a
possibility of data loss if the upgrade is performed whilst <systemitem
role="package">evolution</systemitem> is running. Exiting the
application itself may not be sufficient, as various related components
will continue to run in the background. To avoid any potential issues,
it is recommended that you completely exit your desktop environment
before beginning the upgrade to &releasename;.    
</para>
<para>
As part of the upgrade process, <systemitem
role="package">evolution</systemitem> will check whether any related
processes are running and will recommend that they be closed. A
secondary check for processes will then be performed; if necessary, a
choice will be offered between allowing the remaining processes to be
killed or aborting the upgrade in order to resolve the situation by
hand.
</para>
</section>
</section>
<!-- End of 'trouble' section -->
</section>

<!-- TODO: need to be reviewed with information from http://bugs.debian.org/cgi-bin/bugreport.cgi?bug=571255 -->
<section id="newkernel">
<title>Upgrading your kernel and related packages</title>
<para>
This section explains how to upgrade your kernel and identifies potential
issues related to this upgrade.  You can either install one of the <systemitem
role="package">linux-image-*</systemitem> packages provided by Debian, or
compile a customized kernel from source.
</para>
<para>
Note that a lot of information in this section is based on the assumption that
you will be using one of the modular Debian kernels, together with <systemitem
role="package">initramfs-tools</systemitem> and <systemitem
role="package">udev</systemitem>.  If you choose to use a custom kernel that
does not require an initrd or if you use a different initrd generator, some of
the information may not be relevant for you.
</para>
<section id="kernel-metapackage">
<title>Installing the kernel metapackage</title>
<para>
When you dist-upgrade from &oldreleasename; to &releasename;, it is strongly recommended that you
install a new linux-image-2.6-* metapackage.  This package may be installed
automatically by the dist-upgrade process.  You can verify this by running:
</para>
<screen>
# dpkg -l "linux-image*" | grep ^ii
</screen>
<para>
If you do not see any output, then you will need to install a new linux-image
package by hand.  To see a list of available linux-image-2.6 metapackages, run:
</para>
<screen>
# apt-cache search linux-image-2.6- | grep -v transition
</screen>

<!-- FIXME: Review the Example for Squeeze -->
<para>
If you are unsure about which package to select, run <literal>uname
-r</literal> and look for a package with a similar name.  For example, if you
see '<literal>2.6.26-2-686</literal>', it is recommended that you install
<systemitem role="package">linux-image-2.6-686</systemitem>.  You may also
use <command>apt-cache</command> to see a long description of each package
in order to help choose the best one available.  For example:
</para>
<screen>
# apt-cache show linux-image-2.6-686
</screen>
<para>
You should then use <literal>apt-get install</literal> to install it.  Once
this new kernel is installed you should reboot at the next available
opportunity to get the benefits provided by the new kernel version.
</para>
<para>
For the more adventurous there is an easy way to compile your own custom
kernel on &debian;. Install the <systemitem
role="package">kernel-package</systemitem> tool and read the documentation in
<filename>/usr/share/doc/kernel-package</filename>. Alternatively,
you can also use the kernel sources, provided in the <systemitem
role="package">linux-source-2.6</systemitem> package. You can make use of the
<literal>deb-pkg</literal> target available in the sources' makefile for
building a binary package. There are some differences in these two approaches,
please consult the respective package's documentation.
</para>
<para>
If possible, it is to your advantage to upgrade the kernel package separately
from the main <literal>dist-upgrade</literal> to reduce the chances of a
temporarily non-bootable system.
Note that this should only be done after the
minimal upgrade process described in <xref linkend="minimal-upgrade"/>.
</para>
</section>

<!-- FIXME: REVIEW for Squeeze this was written for Lenny - drop? (jfs) -->
<section id="device-reorder">
<title>Device enumeration reordering</title>
<para>
In &oldreleasename; and later, a new kernel mechanism for hardware discovery
may change the order in which devices are discovered on your system on each
boot, affecting the device names assigned to them.  For example, if you have
two network adapters that are associated with two different drivers, the
devices eth0 and eth1 refer to may be swapped.
</para>
<para>
For network devices, this reordering is normally avoided by the definitions
at <filename>/etc/udev/rules.d/70-persistent-net.rules</filename> for
<systemitem role="package">udev</systemitem>.  Since these rules were
already in place in &oldreleasename;, no additional action should be
required when upgrading to &releasename; to get the benefit of stable
network device names.  Please note, however, that this udev mechanism means
that a given network device name is tied to a particular piece of hardware;
if you, for instance, exchange ethernet adapters in a deployed &releasename;
system, the new adapter will get a new interface name instead of using the
existing one.  To reuse an existing device name for new hardware, you will
need to delete the associated entry from
<filename>/etc/udev/rules.d/70-persistent-net.rules</filename>.
</para>
</section>

<!-- FIXME: REVIEW for Squeeze this was written for Lenny - drop? (jfs) -->
<section id="boot-timing">
<title>Boot timing issues</title>
<para>
If an initrd created with <systemitem
role="package">initramfs-tools</systemitem> is used to boot the system, in some
cases the creation of device files by <systemitem
role="package">udev</systemitem> can happen too late for the boot scripts to
act on.
</para>
<para>
The usual symptoms are that the boot will fail because the root file system
cannot be mounted and you are dropped into a debug shell. But if you
check afterwards, all devices that are needed are present in
<filename>/dev</filename>. This has been observed in cases where the root file
system is on a <acronym>USB</acronym> disk or on <acronym>RAID</acronym>, especially if <acronym>LILO</acronym><indexterm><primary>LILO</primary></indexterm> is used.
</para>
<para>
A workaround for this issue is to use the boot parameter
<literal>rootdelay=<replaceable>9</replaceable></literal>.  The value for the
timeout (in seconds) may need to be adjusted.
</para>
</section>

</section>

<!--
No tasks left in this section, so comment the whole thing out.
-->
<section id="nownownow" condition="fixme">
<title>Things to do before rebooting</title>
<para>
When <literal>apt-get dist-upgrade</literal> has finished, the <quote>formal</quote> upgrade
is complete, but there are some other things that should be taken care of
<emphasis>before</emphasis> the next reboot.
</para>

<!-- FIXME: Probably dropable since lilo is no longer setup in Lenny -->
<programlisting condition="fixme">
There is probably no need at all to run lilo manually on upgrade anymore,
/etc/kernel/postinst.d/zz-lilo runs lilo unconditionally on kernel upgrade;
but don't throw this all away until the lilo maintainers confirm this
isn't required on upgrade for the second-stage bootloader.
</programlisting>

<!-- FIXME: REVIEW for Squeeze this was written for Lenny - drop? (jfs) -->
<section arch="i386;amd64" id="rerunlilo" condition="fixme">
<title>Rerun lilo</title>
<para>
If you are using <systemitem role="package">lilo</systemitem> as your
bootloader (it is the default bootloader for some installations of &oldreleasename;) it is
strongly recommended that you rerun <command>lilo</command> after the
upgrade.  The <systemitem role="package">lilo</systemitem> package will
offer to do this for you as part of the upgrade, but if you decline or don't
see the prompt, you should run lilo by hand:
</para>
<screen>
# /sbin/lilo
</screen>
<para>
Notice this is needed even if you did not upgrade your system's kernel, as
<command>lilo</command>'s second stage will change due to the package upgrade.
</para>
<para>
Also, review the contents of your <filename>/etc/kernel-img.conf</filename> and
make sure that you have <literal>do_bootloader = Yes</literal> in it.  That
way the bootloader will always be rerun after a kernel upgrade.
</para>
<para>
If you encounter any issues when running <command>lilo</command>, review the
symbolic links in <filename>/</filename> or <filename>/boot</filename> to
<filename>vmlinuz</filename> and <filename>initrd</filename> and the
contents of your <filename>/etc/lilo.conf</filename> for discrepancies.
</para>
<para>
If you forgot to rerun <command>lilo</command> before the reboot or the system
is accidentally rebooted before you could do this manually, your system might
fail to boot.  Instead of the lilo prompt, you will only see
<literal>LI</literal> when booting the system<footnote><para> For more
information on <command>lilo</command>'s boot error codes please see <ulink
url="http://tldp.org/HOWTO/Bootdisk-HOWTO/a1483.html">The Linux Bootdisk
HOWTO</ulink>.  </para> </footnote>.  See <xref linkend="recovery"/> for
information on how to recover from this.
</para>
</section>

<!-- FIXME: REVIEW for Squeeze this was written for Lenny - drop? (jfs) -->
<section id="mdadm" condition="fixme">
<title>Upgrading mdadm</title>
<programlisting condition="fixme">TODO: Remove for lenny?</programlisting>
<para>
mdadm now needs a configuration file to assemble MD arrays (<acronym>RAID</acronym>) from the
initial ramdisk and during the system initialisation sequence.  Please make
sure to read and act upon the instructions in
<filename>/usr/share/doc/mdadm/README.upgrading-2.5.3.gz</filename> after the
package has been upgraded <emphasis role="strong">and before you
reboot</emphasis>.  The latest version of this file is available at <ulink
url="http://svn.debian.org/wsvn/pkg-mdadm/mdadm/trunk/debian/README.upgrading-2.5.3?op=file"></ulink>;
please consult it in case of problems.
</para>
</section>

</section>

<section id="boot-hangs" condition="fixme">
  <title>System boot hangs on <literal>Waiting for root file
  system</literal></title>
  <subtitle>Procedure to recover from <filename>/dev/hda</filename>
  that became <filename>/dev/sda</filename></subtitle>

  <para>
    Some users have reported that an upgrade could cause the kernel
    not to find the system root partition after a system reboot.
  </para>

  <para>
    In such case, the system boot will hang on the following message:
    <screen>Waiting for root file system ...</screen>
    and after a few seconds a bare busybox prompt will appear.
  </para>

  <para>
    This problem can occur when the upgrade of the kernel introduces
    the use of the new generation of <acronym>IDE</acronym>
    drivers. The <acronym>IDE</acronym> disk naming convention for the
    old drivers was <literal>hda</literal>, <literal>hdb</literal>,
    <literal>hdc</literal>, <literal>hdd</literal>. The new drivers
    will name the same disks respectively <literal>sda</literal>,
    <literal>sdb</literal>, <literal>sdc</literal>,
    <literal>sdd</literal>.
  </para>
  <para>
    The problem appears when the upgrade does
    not generate a new <filename>/boot/grub/menu.lst</filename> file
    to take the new naming convention into account. During the boot,
    Grub will pass a system root partition to the kernel that the
    kernel doesn't find. It can also appear when mounting filesystems 
    if the <filename>/etc/fstab</filename> has not been updated accordingly.
    Although the upgrade process to &releasename; should cover both situations
    automatically.
  </para>

  <para>
    If you have encountered this problem after upgrading, jump to
    <xref linkend="how-to-recover"/>. To avoid the problem before
    upgrading, read ahead.
  </para>

  <section id="avoid-problems-before-upgrading">
    <title>How to avoid the problem before upgrading</title>

    <para>
      One can avoid this problem entirely by using an identifier for
      the root filesystem that does not change from one boot to the
      next. There are two possible methods for doing this - labeling
      the filesystem, or using the filesystem's universally unique
      identifier (<acronym>UUID</acronym>). These methods are
      supported in Debian since the etch release.
    </para>

    <para>
      The two approaches have advantages and disadvantages. The
      labeling approach is more readable, but there may be problems
      if another filesystem on your machine has the same label. The
      <acronym>UUID</acronym> approach is uglier, but having two clashing <acronym>UUID</acronym>s is highly
      unlikely.
    </para>

    <para>
      For the examples below we assume the root filesystem is on
      <filename>/dev/hda6</filename>. We also assume your system has a
      working udev installation and ext2 or ext3 filesystems.
    </para>

    <para>
      To implement the labeling approach:
      <orderedlist>
	<listitem>
	  <para>
	    Label the filesystem (the name must be &lt; 16 characters)
	    by running the command:
	    <command>e2label /dev/hda6 rootfilesys</command>
	  </para>
	</listitem>
	<listitem>
	  <para>
	    Edit <filename>/boot/grub/menu.lst</filename> and change the line:
	    <programlisting># kopt=root=/dev/hda6 ro</programlisting>
	    to
	    <programlisting># kopt=root=LABEL=rootfilesys ro</programlisting>
	    <note>
	      <para>
		Do not remove the <literal>#</literal> at the start of
		the line, it needs to be there.
	      </para>
	    </note>
	  </para>
	</listitem>
	<listitem>
	  <para>
	    Update the <literal>kernel</literal> lines in
	    <filename>menu.lst</filename> by running the command
	    <command>update-grub</command>.
	  </para>
	</listitem>
	<listitem>
	  <para>
	    Edit <filename>/etc/fstab</filename> and change the line
	    that mounts the <filename>/</filename> partition, e.g.:

	    <programlisting>/dev/hda6     /     ext3  defaults,errors=remount-ro 0 1</programlisting>

	    to

	    <programlisting>LABEL=rootfilesys     /     ext3  defaults,errors=remount-ro 0 1</programlisting>

	    The change that matters here is the first column, you
	    don't need to modify the other columns of this line.
	  </para>
	</listitem>
      </orderedlist>
    </para>

    <para>
      To implement the <acronym>UUID</acronym> approach:
      <orderedlist>
	<listitem>
	  <para>
	    Find out the universally unique identifier of your filesystem by issuing:
	    <command>ls -l /dev/disk/by-uuid | grep hda6</command>. You can also use <command>blkid /dev/hda6</command>.

	  </para>
        
	  <para>
            If you list the contents in <filename>/dev/disk/by-uuid</filename>,
            you should get a line similar to this one:
	    <screen>lrwxrwxrwx 1 root root 24 2008-09-25 08:16 d0dfcc8a-417a-41e3-ad2e-9736317f2d8a -> ../../hda6</screen>
          </para>
          <!-- TODO: Put the output of vol_id instead, since this is *before* the upgrade -->
          <para>
          If you use <command>blkid</command>, you should get an output similar to this one:
          <screen>/dev/hda6: UUID="d0dfcc8a-417a-41e3-ad2e-9736317f2d8a" TYPE="ext3"</screen>
          </para>

          <para>
	    The <acronym>UUID</acronym> is the name of the symbolic
	    link pointing to <filename>/dev/hda6</filename> i.e.:
	    <literal>d0dfcc8a-417a-41e3-ad2e-9736317f2d8a</literal>.
	    <note>
	      <para>
		Your filesystem <acronym>UUID</acronym>
		will be a different string.
	      </para>
	    </note>
	  </para>
	</listitem>
	<listitem>
	  <para>
	    Edit <filename>/boot/grub/menu.lst</filename> and change the line:
	    <programlisting># kopt=root=/dev/hda6 ro</programlisting>
	    to use UUID instead:
	    <programlisting># kopt=root=UUID=d0dfcc8a-417a-41e3-ad2e-9736317f2d8 ro</programlisting>
	    <note>
	      <para>
		Do not remove the <literal>#</literal> at the start of
		the line, it needs to be there.
	      </para>
	    </note>
	  </para>
	</listitem>
	<listitem>
	  <para>
	    Update the <literal>kernel</literal> lines in
	    <filename>menu.lst</filename> by running the command
	    <command>update-grub</command>.
	  </para>
	</listitem>
	<listitem>
	  <para>
	    Edit <filename>/etc/fstab</filename> and change the line that mounts the <filename>/</filename> partition, e.g.:

	    <programlisting>/dev/hda6     /     ext3  defaults,errors=remount-ro 0 1</programlisting>

	    to

	    <programlisting>UUID=d0dfcc8a-417a-41e3-ad2e-9736317f2d8  /  ext3  defaults,errors=remount-ro 0 1</programlisting>

	    The change that matters here is the first column, you
	    don't need to modify the other columns of this line.
	  </para>
	</listitem>
      </orderedlist>
    </para>
  </section>

<!-- FIXME: This section might not be relevant anymore for Squeeze
  but could be turned into a generic section on how to recover from
  issues -->
  <section id="how-to-recover">
    <title>How to recover from the problem after the upgrade</title>

    <section id="solution1">
      <title>Solution 1</title>
      <para>
	This is applicable when Grub shows you the menu interface for
	selecting the entry you want to boot from. If such a menu does
	not appear, try pressing the <keycap>Esc</keycap> key before the
	kernel boots in order to make it appear.  If you can't get
	into this menu, try <xref linkend="solution2"/> or <xref
	linkend="solution3"/>.
      </para>

<!-- FIXME: If kept for Squeeze adjust the kernel version to that of Lenny -->
      <orderedlist>
	<listitem>
	  <para>
	    In the Grub menu, highlight the entry you want to boot
	    from. Press the <keycap>e</keycap> key to edit the options
	    related to this entry. You will see something like:

	    <screen>root (hd0,0)
kernel /vmlinuz-2.6.32-5-686 root=/dev/hda6 ro
initrd /initrd.img-2.6.32-5-686</screen>
	  </para>
	</listitem>
	<listitem>
	  <para>
	    Highlight the line

	    <screen>kernel /vmlinuz-2.6.32-5-686 root=/dev/hda6 ro</screen>

	    press the <keycap>e</keycap> key and replace
	    <literal>hd<replaceable>X</replaceable></literal> with
	    <literal>sd<replaceable>X</replaceable></literal>
	    (<varname>X</varname> being the letter
	    <literal>a</literal>, <literal>b</literal>,
	    <literal>c</literal> or <literal>d</literal> depending of
	    your system). In my example the line becomes:

	    <screen>kernel /vmlinuz-2.6.32-5-686 root=/dev/sda6 ro</screen>

	    Then press <keycap>Enter</keycap> to save the
	    modification. If other lines show
	    <literal>hd<replaceable>X</replaceable></literal>, change
	    these line too. Don't modify the entry similar to
	    <literal>root (hd0,0)</literal>.  Once all modifications
	    are done, press the <keycap>b</keycap> key. And your system
	    should now boot as usual.
	  </para>
	</listitem>
	<listitem>
	  <para>
	    Now that your system has booted, you need to fix this
	    issue permanently.  Jump to <xref
	    linkend="avoid-problems-before-upgrading"/> and apply one
	    of the two proposed procedures.
	  </para>
	</listitem>
      </orderedlist>
    </section>

    <section id="solution2">
      <title>Solution 2</title>

      <para>
	Boot from &debian; installation media
	(<acronym>CD</acronym>/<acronym>DVD</acronym>) and when
	prompted, pick <literal>rescue</literal> to launch rescue
	mode. Select your language, location, and keyboard mapping; then let it
	configure the network (no matter whether it succeeds or not). After a
	while, you should be asked to select the partition you want
	to use as root file system. The proposed choices will look
	something like:

	<screen>/dev/sda1
/dev/sda2
/dev/sda5
/dev/sda6</screen>
      </para>

      <para>
	If you know which partition is your root file system, choose
	the appropriate one. If you don't, just try with the first. If it
	complains about an invalid root file system partition, try the
	next one, and so on. Trying one after the other shouldn't harm
	your partitions and if you have only one operating system installed on
	your disks, you should easily find the right root file system
	partition. If you have many operating systems installed on your disks,
	it would be better to know exactly which is the right
	partition.
      </para>

      <para>
	Once you have chosen a partition, you will be offered a range
	of options. Pick the option of executing a shell in the
	selected partition. If it complains that it cannot do that
	then try with another partition.
      </para>

      <para>
	Now you should have shell access as user <literal>root</literal> on your root
	file system mounted on <filename>/target</filename>. You need access
	to the contents of the <filename>/boot</filename>, <filename>/sbin</filename>
	and <filename>/usr</filename> directories on your hard disk,
	which should now be available under
	<filename>/target/boot</filename>,
	<filename>/target/sbin</filename> and
	<filename>/target/usr</filename>. If these
	directories need to be mounted from other partitions, do so
	(see <filename>/etc/fstab</filename> if you have no idea of
	which partition to mount).
      </para>

      <para>
	Jump to <xref linkend="avoid-problems-before-upgrading"/> and
	apply one of the two proposed procedures to fix the problem
	permanently. Then type <literal>exit</literal> to leave the
	rescue shell and select <literal>reboot</literal> for
	rebooting the system as usual (don't forget to remove the
	bootable media).
      </para>
    </section>

    <section id="solution3">
      <title>Solution 3</title>

      <orderedlist>
	<listitem>
	  <para>
	    Boot from your favorite LiveCD distribution, such as Debian Live,
	    Knoppix, or Ubuntu Live.
	  </para>
	</listitem>
	<listitem>
	  <para>
	    Mount the partition where your <filename>/boot</filename>
	    directory is. If you don't know which one it is, use the
	    output of the command <command>dmesg</command> to find
	    whether your disk is known as <literal>hda</literal>,
	    <literal>hdb</literal>, <literal>hdc</literal>,
	    <literal>hdd</literal> or <literal>sda</literal>,
	    <literal>sdb</literal>, <literal>sdc</literal>,
	    <literal>sdd</literal>. Once you know which disk to work
	    on, for example <literal>sdb</literal>, issue the
	    following command to see the partition table of the disk
	    and to find the right partition:
            <command>fdisk -l /dev/sdb</command>
	  </para>
	</listitem>
	<listitem>
	  <para>
	    Assuming that you have mounted the right partition under
	    <filename>/mnt</filename> and that this partition contains
	    the <filename>/boot</filename> directory and its content,
	    edit the <filename>/mnt/boot/grub/menu.lst</filename>
	    file.
	  </para>
	  <para>
	    Find the section similar to:
	    <programlisting>## ## End Default Options ##

title           Debian GNU/Linux, kernel 2.6.32-5-686
root            (hd0,0)
kernel          /vmlinuz-2.6.32-5-686 root=/dev/hda6 ro
initrd          /initrd.img-2.6.32-5-686

title           Debian GNU/Linux, kernel 2.6.32-5-686 (single-user mode)
root            (hd0,0)
kernel          /vmlinuz-2.6.32-5-686 root=/dev/hda6 ro single
initrd          /initrd.img-2.6.32-5-686

### END DEBIAN AUTOMAGIC KERNELS LIST</programlisting>

	    and replace every <literal>hda</literal>,
	    <literal>hdb</literal>, <literal>hdc</literal>,
	    <literal>hdd</literal> with
	    <literal>sda</literal>, <literal>sdb</literal>,
	    <literal>sdc</literal>, <literal>sdd</literal>, as appropriate.  Don't
	    modify the line similar to:

	    <programlisting>root            (hd0,0)</programlisting>
	  </para>
	</listitem>
	<listitem>
	  <para>
	    Reboot the system, remove the LiveCD and your system
	    should boot correctly.
	  </para>
	</listitem>
	<listitem>
	  <para>
	    When it has booted, apply one of the two proposed
	    procedures under <xref
	    linkend="avoid-problems-before-upgrading"/> to fix the
	    problem permanently.
	  </para>
	</listitem>
      </orderedlist>
    </section>
  </section>
</section>

<section id="for-next">
<title>Preparing for the next release</title>
<para>
After the upgrade there are several things you can do to prepare for the next
release.
</para>
<itemizedlist>
<listitem>
<para>
Remove obsolete and unused packages as described in <xref linkend="obsolete"/>.
You should review which configuration files they use and consider purging
the packages to remove their configuration files.
</para>
</listitem>
</itemizedlist>

<section id="update-grub" arch="amd64;i386">
<title>Upgrade to GRUB 2</title>
<para>
During the upgrade, you will normally have been offered the option to
"chainload" GRUB 2: that is, to keep GRUB Legacy as the primary boot loader
but to add an option to it to load GRUB 2 and then start your &debian;
system from that.  This allows you to verify that GRUB 2 works on your
system before committing to use it permanently.
</para>
<para>
Once you have confirmed that GRUB 2 works, you should switch to using it
properly: the chainloading setup is only intended to be used temporarily.
You can do this by running <command>upgrade-from-grub-legacy</command>.
</para>
<para>
The GRUB Manual has <ulink
url="http://www.gnu.org/software/grub/manual/grub.html#Changes-from-GRUB-Legacy">more
information</ulink> on the changes between GRUB Legacy and GRUB 2, some of
which may require changes to complex configurations.  If you have not modified
your boot loader configuration, you should not need to do anything further.
</para>

</section>

</section>

<section id="deprecated">
<title>Deprecated components</title>
<para>
With the next release of &debian; &nextrelease; (codenamed
&nextreleasename;) some features will be deprecated. Users
will need to migrate to other alternatives to prevent
trouble when updating to &nextrelease;.
</para>

<para>
This includes the following features:
</para>

<itemizedlist>
	<listitem>
		<para>
		</para>
	</listitem>
</itemizedlist>

</section>

<section id="obsolete">
<title>Obsolete packages</title>
<para>
Introducing several thousand new packages, &releasename; also retires and omits more
than four thousand old packages that were in &oldreleasename;.  It provides no upgrade path
for these obsolete packages.  While nothing prevents you from continuing to use
an obsolete package where desired, the Debian project will usually discontinue
security support for it a year after &releasename;'s release<footnote><para> Or for as
long as there is not another release in that time frame.  Typically only two
stable releases are supported at any given time.  </para> </footnote>, and will
not normally provide other support in the meantime.  Replacing them with
available alternatives, if any, is recommended.
</para>
<para>
There are many reasons why packages might have been removed from the
distribution: they are no longer maintained upstream; there is no longer a
Debian Developer interested in maintaining the packages; the functionality they
provide has been superseded by different software (or a new version); or they
are no longer considered suitable for &releasename; due to bugs in them.  In the latter
case, packages might still be present in the <quote>unstable</quote> distribution.
</para>
<para>
Detecting which packages in an updated system are <quote>obsolete</quote> is easy since the
package management front-ends will mark them as such.  If you are using
<command>aptitude</command>, you will see a listing of these packages in the
<quote>Obsolete and Locally Created Packages</quote> entry.  <command>dselect</command>
provides a similar section but the listing it presents might differ.
</para>
<para>
Also, if you have used <command>aptitude</command> or
<command>apt-get</command> to manually install packages in &oldreleasename;
it will have kept track of those packages you manually installed and will be
able to mark as obsolete those packages pulled in by dependencies alone which
are no longer needed if a package has been removed.
<command>aptitude</command> and <systemitem role="package">apt</systemitem>,
unlike <command>deborphan</command>, will not mark for removal packages that
you manually installed, as opposed to those that were automatically
installed through dependencies.  To remove automatically installed packages
that are no longer used, run:
</para>
<screen>
# apt-get autoremove
</screen>
<para>
There are additional tools you can use to find obsolete packages such as
<command>deborphan</command>, <command>debfoster</command> or
<command>cruft</command>.  <command>deborphan</command> is highly recommended,
although it will (in default mode) only report obsolete libraries: packages in
the <quote><literal>libs</literal></quote> or <quote><literal>oldlibs</literal></quote> sections that are not used by any other packages.  Do not
blindly remove the packages these tools present, especially if you are using
aggressive non-default options that are prone to produce false positives.  It
is highly recommended that you manually review the packages suggested for
removal (i.e.  their contents, size and description) before you remove them.
</para>
<para>
The <ulink url="&url-bts;">Debian Bug Tracking System</ulink>
often provides additional information on why the package was removed.  You
should review both the archived bug reports for the package itself and the
archived bug reports for the <ulink
url="&url-bts;cgi-bin/pkgreport.cgi?pkg=ftp.debian.org&amp;archive=yes">ftp.debian.org
pseudo-package</ulink>.
</para>
<!-- FIXME: Review for Squeeze - more obsolete packages probably need to be listed here -->
<!-- TODO: 
Use the following reources for more information:

 - http://alioth.debian.org/~spaillard/udd-release-notes-src-with-RM

 - http://www.klabs.be/~fpiat/linux/comp-dist2/squeeze/
(alternatively)
 - Use the change-release information and sort by popcon 
-->
<para>
  The list of obsolete packages includes:
  <itemizedlist>
    <listitem>
      <para>
	<systemitem role="package">mysql-5.1</systemitem>, successor is
	<systemitem role="package">mysql-5.5</systemitem>.
      </para>
    </listitem>
    <listitem>
      <para>
	<systemitem role="package">python2.5</systemitem>, successor is
	<systemitem role="package">python2.7</systemitem>.
      </para>
    </listitem>
    <listitem>
      <para>
	<systemitem role="package">portmap</systemitem>, successor is
	<systemitem role="package">rpcbind</systemitem>.
      </para>
    </listitem>
    <listitem>
      <para>
	<systemitem role="package">sun-java6</systemitem>, successor is
	<systemitem role="package">openjdk-7</systemitem>.
      </para>
    </listitem>
    <listitem>
      <para>
	<systemitem role="package">gdm</systemitem>, successor is
	<systemitem role="package">gdm3</systemitem>.
      </para>
    </listitem>
    <listitem>
      <para>
	<systemitem role="package">mpich</systemitem>, successors are
	<systemitem role="package">openmpi</systemitem> and <systemitem
	  role="package">mpich2</systemitem>.
      </para>
    </listitem>
    <listitem>
      <para>
	<systemitem role="package">compiz</systemitem>.
      </para>
    </listitem>
    <listitem>
      <para>
      Some of Xorg's video drivers are no longer available in 
      &releasename; and are obsolete. This includes 
      <systemitem role="package">xserver-xorg-video-nv</systemitem> and
      <systemitem role="package">xserver-xorg-video-radeonhd</systemitem>.
      They might be removed through the upgrade. Users should install
      <systemitem role="package">xserver-xorg-video-all</systemitem>
      instead.
      </para>
    </listitem>
    <listitem>
      <para>
      Most Kolab packages, providing groupware server, have been removed. This
      includes
      <systemitem role="package">kolab-cyrus-imapd</systemitem>,
      <systemitem role="package">kolab-webadmin</systemitem>,
      <systemitem role="package">kolabd</systemitem>,
      <systemitem role="package">libkolab-perl</systemitem>,
      <systemitem role="package">php-kolab-filter</systemitem> and
      <systemitem role="package">php-kolab-freebusy</systemitem>.
      As of 2012, Kolab is in a major rewrite and may get shipped with a later Debian release as the
      <systemitem role="package">kolab</systemitem> package.
      </para>
    </listitem>
  </itemizedlist>
</para>

<section id="dummy">
<title>Dummy packages</title>
<para>
Some packages from &oldreleasename; have been split into several packages in &releasename;, often
to improve system maintainability.  To ease the upgrade path in such cases,
&releasename; often provides <quote>dummy</quote> packages: empty packages that have the same name as
the old package in &oldreleasename; with dependencies that cause the new packages to be
installed.  These <quote>dummy</quote> packages are considered obsolete packages after the
upgrade and can be safely removed.
</para>
<para>
Most (but not all) dummy packages' descriptions indicate their purpose.
Package descriptions for dummy packages are not uniform, however, so you might
also find <command>deborphan</command> with the
<literal>--guess-<replaceable>*</replaceable></literal> options (e.g.
<literal>--guess-dummy</literal>) useful to detect them in your system.  Note
that some dummy packages are not intended to be removed after an upgrade but
are, instead, used to keep track of the current available version of a program
over time.
</para>
</section>

</section>

</chapter>
