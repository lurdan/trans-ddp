<!-- CVS revision of original english document "1.27"  -->

<chapt id="gateway">Construyendo una puerta de enlace en Debian

<p> &debian; permite tener una puerta de enlace (gateway)
multipropósito, con NAT, mail, DHCP, caché DNS, caché proxy HTTP, CVS,
NFS y servicios Samba para una red local doméstica.  Véase <url
id="&netfilterhome;" name="Netfilter"> donde se explican diversos temas
sobre la configuración de redes.

<sect>Configuración de la red
<p>

<sect1 id="ip-class">Configuración de la puerta de enlace
<p>
Una LAN utiliza direcciones IP dentro de los rangos que se detallan para
evitar interferencias con las direcciones IP de Internet.
<example>
Clase A: 10.0.0.0                    con máscara 255.0.0.0
Clase B: 172.16.0.0 - 172.31.0.0     con máscara 255.255.0.0
Clase C: 192.168.0.0 - 192.168.255.0 con máscara 255.255.255.0
</example>
<p>
Para la configuración IP, &debian; utiliza el archivo
<file>/etc/network/interfaces</file>.
<p>
Por ejemplo, si <file>eth0</file> se conecta a Internet con una
dirección IP proporcionada por DHCP y <file>eth1</file> se conecta a una
LAN, el archivo <file>/etc/network/interfaces</file> se configura de la
siguiente manera (para Woody o una versión posterior):
<example>
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet dhcp

auto eth1
iface eth1 inet static
address 192.168.1.1
network 192.168.1.0
netmask 255.255.255.0
broadcast 192.168.1.255
</example>
Ejecute el siguiente comando para actualizar la configuración de red
teniendo en cuenta el archivo <file>/etc/network/interfaces</file>
nuevo:
<example>
# /etc/init.d/networking restart
</example>
Recordar: el archivo <file>interfaces</file> en Woody o versiones posteriores
no es compatible con la de Potato.
<p>
En Potato si se utiliza una tarjeta de red PCMCIA es necesario
configurar la red mediante <file>/etc/pcmcia/network.opts</file>.  En
Woody el problema ya ha sido solucionado.
<p>
En caso de duda, analice la salida de los siguientes comandos:
<example>
# ifconfig
# cat /proc/pci
# cat /proc/interrupts
# dmesg|more
</example>
A veces, las conexiones DSL (¿PPPoE?) poseen problemas de MTU.  Consulte
el <url id="&dsl-howto;" name="DSL-HOWTO"> del LDP.  Si tiene problemas
con determinados sitios web, consulte <ref id="killecn">.
</sect1>

<sect1 id="ip-check">Puntos principales de la configuración de red
<p>
Conjunto de programas típicos:
<example>
# apt-get install nfs samba dhcpd dhcp-client bind squid procmail fetchmail 
# apt-get install ssh cvs
</example>
<p>
A continuación consulte los siguientes archivos:
<example>
/etc/init.d/dhcpd       (editar para servir sólo a LAN = eth1)
/etc/host.allow         (ALL: 192.168.0.0/16 127.0.0.0/8) para NFS
/etc/exports            (Necesario para NFS)
/etc/bind/db.192.168.1  (añadir)
/etc/bind/db.lan        (añadir)
/etc/bind/named.conf    (editar)
/etc/resolve.conf       (editar)
/etc/hosts
/etc/dhcpd.conf         (editar para LAN = eth1)
/etc/dhclient.conf      (editar para forzar DNS local)
/etc/samba/smb.conf
/etc/exim/exim.conf
/etc/mailname
/etc/aliases
/etc/squid.conf         (añadir las direcciones IP de todas las máquinas de la
LAN)
</example>
<prgn>bind</prgn> crea un caché DNS local y transforma la máquina local en
servidor DNS.  Consulte el archivo <file>/etc/resolve.conf</file>:
<example>
nameserver 127.0.0.1
search lan.aokiconsulting.com
</example>
</sect1>

<sect id="netfilter">Configuración de netfilter
<p>
El proyecto netfilter/iptables es un sistema de firewall para Linux 2.4 y
posteriores.  Véase <url id="&netfilterhome;" name="Netfilter"> donde se
explican diversos temas sobre la configuración de redes.

<sect1 id="netfilter-basics">Pricipios básicos de netfilter
<p>
Netfilter procesa los paquetes mediante 5 cadenas incorporadas: 
PREROUTING, INPUT, FORWARD, OUTPUT, y POSTROUTING.
<example>
                decisión de
interfaz        enrutado                                     interfaz
IN ------> PRE ---> ------> FORWARD -----> ----> POST -----> OUT
           ROUTING  \       filter       /       ROUTING     
           DNAT     |       tracking     ^       SNAT
           REDIRECT |                    |       MASQUERADE
                    v                    |
                  INPUT                OUTPUT
                    | filtro             ^ filtro,DNAT 
                    v                    |
                    \--&gt; Proceso Local --/
                            programas del espacio de usuario
</example>

<sect1 id="netfilter-table">Tabla netfilter
<p>
Los paquetes son procesados por cada cadena según la siguiente
tabla.
<list compact>
<item>filter (filtro de paquetes, predeterminado)
<list compact>
<item>INPUT (para los paquetes que llegan a la máquina)
<item>FORWARD (para los paquetes encaminados por la máquina)
<item>OUTPUT (para los paquetes generados localmente).
</list>
<item>nat (Network Address Translation o Traducción de Direcciones de Red)
<list compact>
<item>PREROUTING (para modificar los paquetes tan pronto lleguen)
<item>OUTPUT (para modificar los paquetes generados localmente antes de
encaminarlos)
<item>POSTROUTING (para modificar los paquetes a punto de salir)
</list>
<item>mangle (mutilación de direcciones de red, efectiva a partir de la versión
2.4.18)
<list compact>
<item>las 5 cadenas incluidas.
</list>
</list>

<sect1 id="netfilter-target">Objetivos de Netfilter
<p>
Las reglas de firewall poseen diversos objetivos:
<list compact>
<item>los 4 objetivos básicos:
<list compact>
<item>ACCEPT significa dejar pasar el paquete.
<item>DROP significa descartar el paquete.  
<item>QUEUE significa pasar al paquete al espacio de usuario (si es soportado
por el kernel).
<item>RETURN significa detener el paso en la cadena y continuar con la regla
siguiente de la cadena anterior.  
</list>
<item>otros objetivos:
<list compact>
<item>LOG activa los registros del kernel.
<item>REJECT reenvía un paquete con error y descarta el paquete.
<item>SNAT modifica la dirección de origen del paquete y se usa
únicamente en la cadena POSTROUTING (tabla nat únicamente)
<example compact>
--to-source  ipaddr[-ipaddr][:port-port]
</example>
<item>MASQUERADE es lo mismo que SNAT pero para direcciones IP asignadas
en forma dinámica (conexión telefónica). (tabla nat únicamente)
<example compact>
--to-ports port[-port]
</example>
<item>DNAT modifica la dirección de destino del paquete y se usa en las cadenas 
  PREROUTING, OUTPUT y las cadenas definidas por el usuario que se llaman 
  únicamente desde dichas cadenas (tabla nat únicamente)
<example compact>
--to-destination ipaddr[-ipaddr][:port-port]
</example>
<item>REDIRECT modifica la dirección IP de destino para enviar el paquete a la
propia máquina.
<example compact>
--to-ports port[-port]
</example>
</list>
</list>

<sect1 id="netfilter-command">El comando netfilter
<p>
Los comandos básicos de <prgn>iptables</prgn> son:
<example compact>
iptables -N <var>cadena</var>                   # crear una <var>cadena</var>

iptables -A <var>cadena</var> \                 # añadir regla a la <var>cadena</var>
         -t <var>tabla</var> \                  # usar <var>tabla</var> (filtro, nat, mangle)
         -p <var>protocolo</var> \              # tcp, udp, icmp, or all,
         -s <var>dirección-fuente[/mask]</var> \
         --sport <var>puerto[:port]</var> \     # puerto de origen si -p es tcp o udp
         -d <var>dirección-destino[/mask]</var> \
         --dport <var>puerto[:port]</var> \     # puerto de destino si -p es tcp o udp
         -j <var>objetivo</var> \               # qué hacer si coincide
         -i <var>nombre-interfaz-entrada</var> \# para INPUT,  FORWARD, PREROUTING
         -o <var>nombre-interfaz-salida</var>   # para FORWARD, OUTPUT, POSTROUTING
</example>

<sect1 id="ip-masq">Enmascaramiento IP
<p>
Las máquinas de una LAN pueden acceder a los recursos de Internet a
través de una puerta de enlace que utiliza enmascaramiento IP (NAT)
compartiendo una única dirección IP accesible desde el exterior
<example>
# apt-get install ipmasq
</example>
Aplique las reglas de ejemplo para mejorar la protección
<prgn>ipmasq</prgn>.  Consulte
<file>/usr/share/doc/ipmasq/examples/stronger/README</file>.  Para el
paquete kernel-image-2.4 de Debian asegúrese de cargar los módulos
adecuados.  Véase <ref id="kernel-net"> para efectuar la correspondiente
configuración.
<p>
Para el paquete kernel-image-2.2 de Debian, edite de la siguiente manera
<file>Z92timeouts.rul</file> en
<file>/etc/masq/rules</file> para asegurar una conexión
más duradera con sitios distantes (conveniente para mensajes de correo
grandes, etc.):
<example>
# tcp, tcp-fin, udp
# 2hr, 10 seg, 160 seg - predeterminado
# 1 día, 10 min, 10 min - modificación
$IPCHAINS -M -S 86400 600 600
</example>
Asimismo, si se accede a la red mediante una tarjeta de red PCMCIA,
<prgn>ipmasq</prgn> necesita iniciarce desde
<file>/etc/pcmcia/network.opts</file>.  Consulte
<file>/usr/share/doc/ipmasq/ipmasq.txt.gz</file>.
</sect1>


<sect1 id="ip-redirect">Redireccionar una conexión SMTP (2.4)
<p>
Supongamos que tiene una PC portátil configurada para otro entorno de red y que
desea usar su programa de correo sin tener que reconfigurarla. 
<p>
Añadiendo  las siguientes reglas mediante el comando <prgn>iptables</prgn>
en la puerta de enlace, la conexión SMTP será redirigida hacia ella.
<example>
# iptables -t nat -A PREROUTING -s 192.168.1.0/24 -j REDIRECT \
           -p tcp --dport smtp --to-port 25 # smtp=25, INPUT se encuentra abierta
</example>
Para el redireccionamiento de un conjunto de reglas más complejo
considere instalar el paquete <package>ipmasq</package> y agregue
<url id="&examples;" name="M30redirect.def"> en el directorio
<file>/etc/ipmasq/rules/</file>.

</sect>

<sect>Administrando múltiples conexiones de red
<p>
[FIXME] Política de encaminamiento (por Phil Brutsche
<email>pbrutsch@tux.creighton.edu</email>):
Ver el <url id="&iproute;" name="iproute manual"> para más detalles.  El
control de tráfico (tc) puede ser también interesante.
<p>
Entorno:
<example>
eth0: 192.168.1.2/24; gateway 192.168.1.1
eth1: 10.0.0.2/24; gateway 10.0.0.1
Sin enmascaramiento en esta máquina.
</example>
Algo de magia:
<enumlist compact>
<item>ip rule add from 192.168.1.2 lookup 1
<item>ip rule add from 10.0.0.2 lookup 2
<item>ip route add to default via 10.0.0.1 metric 0
<item>ip route add to default via 192.168.1.1 metric 1
<item>ip route add table 1 to 192.168.1.0/24 via eth0
<item>ip route add table 1 to 10.0.0.2/24 via eth1
<item>ip route add table 1 to default via 192.168.1.1
<item>ip route add table 2 to 192.168.1.0/24 via eth0
<item>ip route add table 2 to 10.0.0.2/24 via eth1
<item>ip route add table 2 to default via 10.0.0.2
</enumlist>
<p>
[FIXME] Nunca hice esto.  ¿Cómo configurar una conexión telefónica como
respaldo de una conexión rápida y automática?  Por favor, envíenme un parche :)
</sect>


</chapt>
