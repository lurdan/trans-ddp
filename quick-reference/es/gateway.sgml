<!-- CVS revision of this document "$Revision: 1.4 $"  -->
<!-- CVS revision of original english document "1.23"  -->

<chapt id="gateway"> Building a gateway with a &debian; system

<p>
&debian; offers an all-purpose gateway machine, which handles NAT,
mail, DHCP, DNS cache, http proxy cache, CVS, NFS, and Samba services
for a home LAN system.

<sect>Network configuration
<p>

<sect1 id="ip-class">Host configuration for the gateway
<p>
The LAN uses IP addresses for the following private network range to avoid IP
address collision with the Internet.
<example>
Class A: 10.0.0.0                    with mask 255.0.0.0
Class B: 172.16.0.0 - 172.31.0.0     with mask 255.255.0.0
Class C: 192.168.0.0 - 192.168.255.0 with mask 255.255.255.0
</example>
<p>
&debian; uses <file>/etc/network/interfaces</file> for IP configuration.
<p>
For example, if <file>eth0</file> connects to the Internet with a
DHCP-provided IP address and <file>eth1</file> connects to the LAN,
<file>/etc/network/interfaces</file> is set as following (Woody or later):
<example>
auto eth0
iface eth0 inet dhcp

auto eth1
iface eth1 inet static
address 192.168.1.1
network 192.168.1.0
netmask 255.255.255.0
broadcast 192.168.1.255
</example>
Issue the following command to update the networking configuration to the
new <file>/etc/network/interfaces</file>:
<example>
# /etc/init.d/networking restart
</example>
Reminder: The <file>interfaces</file> file in Woody or later releases is
not compatible with Potato.
<p>
If the system uses a PCMCIA NIC, one needs to set up the network through
<file>/etc/pcmcia/network.opts</file> instead.
<p>
Check the output of the following if in doubt:
<example>
# ifconfig
# cat /proc/pci
# cat /proc/interrupts
# dmesg|more
</example>
Sometimes, DSL (PPPoE?) has MTU issues.  Refer to the LDP
<url id="&dsl-howto;" name="DSL-HOWTO">.
</sect1>

<sect1>IP-masquerade
<p>
Machines on the LAN can access Internet resources through a gateway
which runs IP-masquerade (NAT).
<example>
# apt-get install ipmasq
</example>
Apply example rules to strengthen the <prgn>ipmasq</prgn> protection.
See <file>/usr/share/doc/ipmasq/examples/stronger/README</file>.
<!-- Now upstream is current
Updated scripts here:
<url id="&debian-reference;examples/"
name="A80firewall.def I80firewall.def O80firewall.def">.
-->
For Debian kernel-image-2.4, make sure to load the proper modules.  See
<ref id="kernel-net">.
<p>
For Debian kernel-image-2.2, edit <file>Z92timeouts.rul</file> in
<file>/etc/masq/rules</file> as follows:
<example>
# tcp, tcp-fin, udp
# 2hr, 10 sec, 160 sec - default
# 1 day, 10 min, 10 min - longer example
$IPCHAINS -M -S 86400 600 600
</example>
Also, if the network is accessed through a PCMCIA NIC, <prgn>ipmasq</prgn>
needs to be started from <file>/etc/pcmcia/network.opts</file>.  Read
<file>/usr/share/doc/ipmasq/ipmasq.txt.gz</file>.
</sect1>

<sect1>Network configuration checkpoints
<p>
Typical set of programs:
<example>
# apt-get install nfs samba dhcpd dhcp-client bind squid procmail fetchmail 
# apt-get install ssh cvs
</example>
<p>
Then check the following files:
<example>
/etc/init.d/dhcpd       (edit to serve only LAN = eth1)
/etc/host.allow         (ALL: 192.168.0.0/16 127.0.0.0/8) for NFS
/etc/exports            (Need this for NFS)
/etc/bind/db.192.168.1  (add)
/etc/bind/db.lan        (add)
/etc/bind/named.conf    (edit)
/etc/resolve.conf       (edit)
/etc/hosts
/etc/dhcpd.conf         (edit for LAN = eth1)
/etc/dhclient.conf      (edit to force local DNS)
/etc/samba/smb.conf
/etc/exim/exim.conf
/etc/mailname
/etc/aliases
/etc/squid.conf         (add all LAN host IP as allowed)
</example>
<prgn>bind</prgn> creates a local cache DNS server and changes DNS to
localhost.  Check <file>/etc/resolve.conf</file>:
<example>
nameserver 127.0.0.1
search lan.aokiconsulting.com
</example>
</sect1>

</sect>

<sect>Manage multiple net connections
<p>
[FIXME] Policy routing (by Phil Brutsche pbrutsch@tux.creighton.edu):
See the <url id="&iproute;" name="iproute manual"> for
details.  Traffic control (tc) may also be interesting.
<p>
Environment:
<example>
eth0: 192.168.1.2/24; gateway 192.168.1.1
eth1: 10.0.0.2/24; gateway 10.0.0.1
No masquerading on this machine.
</example>
Special magic:
<example>
# ip rule add from 192.168.1.2 lookup 1
# ip rule add from 10.0.0.2 lookup 2
# ip route add to default via 10.0.0.1 metric 0
# ip route add to default via 192.168.1.1 metric 1
# ip route add table 1 to 192.168.1.0/24 via eth0
# ip route add table 1 to 10.0.0.2/24 via eth1
# ip route add table 1 to default via 192.168.1.1
# ip route add table 2 to 192.168.1.0/24 via eth0
# ip route add table 2 to 10.0.0.2/24 via eth1
# ip route add table 2 to default via 10.0.0.2
</example>
[FIXME] I've never done this.  How to setup dialup as backup to a fast
connection?
</sect>


</chapt>
