<!-- CVS revision of this document "$Revision: 1.5 $"  -->
<!-- CVS revision of original english document "1.34"  -->

<chapt id="gateway"> Tworzenie bramy sieciowej z systemem &debian;

<p>
&debian; oferuje oprogramowanie ogólnego przeznaczenia do uruchomienia
bramki sieciowej, która obs³uguje NAT, pocztê, DHCP, buforowanie DNS, 
buforowanie zapytañ HTTP (proxy), CVS, NFS i zasoby Samba dla domowej sieci 
lokalnej. Przeczytaj <url id="&netfilterhome;" name="Netfilter">, gdzie
jest opisanych wiele problemów z konfiguracj± sieci.

<sect>Konfiguracja sieci
<p>

<sect1 id="ip-class">Konfiguracja stacji sieciowej przeznaczonej na bramê
<p>
Sieæ lokalna u¿ywa adresów IP z puli prywatnych adresów sieciowych po to,
by zapobiec kolizjom adresów z tymi u¿ywanymi w Internecie.
<example>
Klasa A: 10.0.0.0                    z mask± 255.0.0.0
Klasa B: 172.16.0.0 - 172.31.0.0     z mask± 255.255.0.0
Klasa C: 192.168.0.0 - 192.168.255.0 z mask± 255.255.255.0
</example>
<p>
&debian; u¿ywa pliku <file>/etc/network/interfaces</file> do konfiguracji IP.
<p>
Na przyk³ad, je¶li <file>eth0</file> ³±czy Ciê z Internetem z wykorzystaniem
adresu IP pobieranego przez DHCP, a <file>eth1</file> ³±czy Ciê z sieci±
lokaln± (LAN), plik <file>/etc/network/interfaces</file> wygl±da nastêpuj±co
(w przypadku Woodiego lub nowszej dystrybucji):
<example>
auto eth0
iface eth0 inet dhcp

auto eth1
iface eth1 inet static
address 192.168.1.1
network 192.168.1.0
netmask 255.255.255.0
broadcast 192.168.1.255
</example>
Wprowad¼ poni¿sze polecenie, by uaktualniæ konfiguracjê sieciow± u¿ywaj±c
nowego pliku <file>/etc/network/interfaces</file>:
<example>
# /etc/init.d/networking restart
</example>
Pamiêtaj: Plik <file>/etc/network/interfaces</file> z Woodiego (i pó¼niejszych
wersji) nie jest kompatybilny z podobnym plikiem z Potato. (Taka sama sytuacja
mo¿e zaistnieæ miêdzy Woody a Sarge.)
<p>
Je¶li system u¿ywa karty sieciowej PCMCIA, nale¿y skonfigurowaæ sieæ
w pliku <file>/etc/pcmcia/network.opts</file> (dotyczy tylko Potato).
W Woodym ten problem zosta³ rozwi±zany.
<p>
Je¶li nie jeste¶ pewien, przyjrzyj siê wynikowi poni¿szych poleceñ:
<example>
# ifconfig
# cat /proc/pci
# cat /proc/interrupts
# dmesg|more
</example>
<p>
Wiele nowych us³ug ADSL korzysta do po³±czeñ z PPPoE. Instalator Woodiego
nie posiada menu dla PPPoE ale ma wszelkie potrzebne do tego pakietu, np.
<package>pppoe</package> i <package>pppoeconf</package>. By ³atwo 
skonfigurowaæ po³±czenie podczas procesu instalacji uruchom 
<prgn>pppoeconf</prgn>. Czasami przy po³±czeniu DSL (PPPoE) trzeba
zainteresowaæ siê tematem MTU. Szczegó³owe informacje znajduj± siê w LDP 
<url id="&dsl-howto;" name="DSL-HOWTO">. 
<p>
Je¶li masz problemy z niektórymi stronami, zobacz <ref id="killecn">.
</sect1>

<sect1 id="ip-check">Lista &ldquor;do zrobienia&rdquor; konfiguracji sieci
<p>
Typowy zestaw programów:
<example>
# apt-get install nfs samba dhcpd dhcp-client bind squid procmail fetchmail 
# apt-get install ssh cvs
</example>
<p>
Nastêpnie przyjrzyj siê nastêpuj±cym plikom:
<example>
/etc/init.d/dhcpd       (zmodyfikuj, by mieæ tylko LAN = eth1)
/etc/host.allow         (ALL: 192.168.0.0/16 127.0.0.0/8) dla NFS
/etc/exports            (potrzebny dla NFS)
/etc/bind/db.192.168.1  (dodaj)
/etc/bind/db.lan        (dodaj)
/etc/bind/named.conf    (zmodyfikuj)
/etc/resolv.conf        (zmodyfikuj)
/etc/hosts
/etc/dhcpd.conf         (zmodyfikuj dla LAN = eth1)
/etc/dhclient.conf      (zmodyfikuj by wymusiæ lokalny DNS)
/etc/samba/smb.conf
/etc/exim/exim.conf
/etc/mailname
/etc/aliases
/etc/squid.conf         (dodaj adresy IP wszystkich dozwolonych hostów)
</example>
<prgn>bind</prgn> tworzy lokalny serwer buforuj±cy DNS i zmienia adres serwera
DNS na localhost. Przyjrzyj siê plikowi <file>/etc/resolv.conf</file>:
<example>
nameserver 127.0.0.1
search lan.aokiconsulting.com
</example>
</sect1>

<sect id="netfilter">Konfiguracja Netfilter
<p>
Projekt netfilter/iptables jest podsystemem ¶ciany ogniowej dla
Linuksa 2.4 i nowszych.
Udaj siê na stronê <url id="&netfilterhome;" name="Netfilter">, gdzie
opisano i wyja¶niono wiele zagadnieñ dotycz±cych konfiguracji sieciowej.

<sect1 id="netfilter-basics">Netfilter - podstawy
<p>
Netfilter przetwarza pakiety przy u¿yciu piêciu wbudowanych ³añcuchów:
PREROUTING, INPUT, FORWARD, OUTPUT i POSTROUTING.
<example>
                decyzja
                routingu
IN ------> PRE ---> ------> FORWARD -----> ----> POST -----> OUT
interfejs  ROUTING  \       ¶ledzenie    /       ROUTING     interfejs
           DNAT     |       po³±czeñ     ^       SNAT
           REDIRECT |                    |      MASQUERADE
                    v                    |
                  INPUT                OUTPUT
                    | filtrowanie        ^ filtrowanie,DNAT
                    v                    |
                    \--&gt; Lokalny Proces--/
                            program przestrzeni u¿ytkownika
</example>

<sect1 id="netfilter-table">Tablice Netfilter 
<p>
Pakiety s± przetwarzane w ka¿dym ³añcuchu w poszczególnych tablicach.
<list compact>
<item>filter (filtrowanie pakietów, domy¶lna)
<list compact>
<item>INPUT (tylko dla pakietów wchodz±cych do hosta)
<item>FORWARD (tylko dla pakietów przekazywanych przez hosta)
<item>OUTPUT (tylko dla lokalnie generowanych pakietów).
</list>
<item>nat (network address translation - translacja adresów sieciowych)
<list compact>
<item>PREROUTING (do zmiany zawarto¶ci pakietów podczas ich wej¶cia)
<item>OUTPUT (do zmiany zawarto¶ci pakietów generowanych lokalnie, przed 
routingiem)
<item>POSTROUTING (do zmiany zawarto¶ci pakietów, gdy wychodz± one z hosta)
</list>
<item>mangle (network address mangling, sprawne tylko w j±drach nowszych ni¿
2.4.18)
<list compact>
<item>wszystkie 5 wbudowanych ³añcuchów.
</list>
</list>

<sect1 id="netfilter-target">Cele Netfilter
<p>
Regu³y ¶ciany ogniowej maj± wiele celów (miejsc przeznaczenia):
<list compact>
<item>4 podstawowe cele:
<list compact>
<item>ACCEPT przepuszcza pakiet (zezwala na dostêp).
<item>DROP po cichu odrzuca pakiet (nie informuje o tym nikogo).  
<item>QUEUE przekazuje pakiet programowi dzia³aj±cemu w przestrzeni
  u¿ytkownika (je¶li jest to obs³ugiwane przez j±dro).
<item>RETURN zatrzymuje przetwarzanie danego ³añcucha i wznawia
  przetwarzanie w nastêpnej regu³ce poprzedniego (z którego nast±pi³o
  wywo³anie) ³añcucha.
</list>
<item>rozszerzone cele:
<list compact>
<item>LOG w³±cza logowanie j±dra.
<item>REJECT zwraca informacjê o b³êdzie nadawcy i odrzuca pakiet.
<item>SNAT zmienia adres ¼ród³owy pakietu i jest u¿ywany tylko w ³añcuchu
  POSTROUTING (tablica nat).
<example compact>
--to-source  ipaddr[-ipaddr][:port-port]
</example>
<item>MASQUERADE dzia³a tak samo jak SNAT, ale jest przeznaczona dla po³±czeñ
  z dynamicznie przypisywanym numerem IP (po³±czenie modemowe) (tablica nat).
<example compact>
--to-ports port[-port]
</example>
<item>DNAT zmienia adres docelowy pakietu, jest u¿ywany w ³añcuchach
  PREROUTING i OUTPUT oraz w zdefiniowanych przez u¿ytkownika ³añcuchach,
  które s± wywo³ywane z dwóch powy¿szych ³añcuchów (tablica nat).
<example compact>
--to-destination ipaddr[-ipaddr][:port-port]
</example>
<item>REDIRECT zmienia adres docelowy tak, by pakiet otrzyma³ komputer,
  na którym dzia³a ogniomurek (czyli ten komputer).
<example compact>
--to-ports port[-port]
</example>
</list>
</list>

<sect1 id="netfilter-command">Polecenia Netfiltera
<p>
Podstawowe polecenia <prgn>iptables</prgn>:
<example compact>
iptables -N <var>³añcuch</var>                   # tworzy <var>³añcuch</var>

iptables -A <var>³añcuch</var> \                 # dodaje regu³kê do <var>³añcuch</var>
         -t <var>tablica</var> \                 # w <var>tablica</var> (filter, nat, mangle)
         -p <var>protokó³</var> \                # tcp, udp, icmp lub all
         -s <var>adres-¼ród³owy[/maska]</var> \
         --sport <var>port[:port]</var> \        # port ¼ród³owy, je¶li -p jest tcp lub udp
         -d <var>adres-docelowy[/maska]</var> \
         --dport <var>port[:port]</var> \        # port docelowy, je¶li -p jest tcp lub udp
         -j <var>cel</var> \                     # co zrobiæ, je¶li regu³ka pasuje
         -i <var>interfejs-wej¶ciowy</var> \     # dla INPUT,  FORWARD, PREROUTING
         -o <var>interfejs-wyj¶ciowy</var>       # dla FORWARD, OUTPUT, POSTROUTING
</example>

<sect1 id="ip-masq">Maskarada IP
<p>
Komputery w sieci lokalnej mog± mieæ dostêp do Internetu przez bramkê
sieciow±, na której dzia³a maskarada IP (NAT) dziel±c pojedynczy, osi±galny
z zewn±trz adres IP.
<example>
# apt-get install ipmasq
</example>
Zastosuj przyk³adowe regu³y, by zwiêkszyæ zabezpieczenia <prgn>ipmasq</prgn>.
Przeczytaj <file>/usr/share/doc/ipmasq/examples/stronger/README</file>.
W przypadku debianowego kernel-image-2.4 upewnij siê, ¿e za³adowa³e¶
odpowiednie modu³y. Opis potrzebnej konfiguracji jest w
<ref id="kernel-net">.
<p>
W przypadku debianowego kernel-image-2.2, modyfikuj plik
<file>Z92timeouts.rul</file> w katalogu
<file>/etc/masq/rules</file> tak, jak pokazano poni¿ej, by zapewniæ d³u¿sze
po³±czenia ze zdalnymi serwerami (dobre dla du¿ych listów elektronicznych, itp.):
<example>
# tcp, tcp-fin, udp
# 2hr, 10 sec, 160 sec - domy¶lnie
# 1 day, 10 min, 10 min - przyk³ad d³u¿szego czasu ¿ycia
$IPCHAINS -M -S 86400 600 600
</example>
Równie¿ je¶li sieæ jest osi±galna przez kartê PCMCIA, <prgn>ipmasq</prgn>
musi byæ wystartowane z pliku
<file>/etc/pcmcia/network.opts</file>. Przeczytaj plik
<file>/usr/share/doc/ipmasq/ipmasq.txt.gz</file>.
</sect1>


<sect1 id="ip-redirect">Przekierowanie po³±czeñ SMTP (2.4)
<p>
Za³ó¿my, ¿e masz notebooka, który jest tak skonfigurowany, ¿e u¿ywa
ró¿nych ¶rodowisk sieciowych i chcesz u¿ywaæ swojego agenta (serwer)
poczty bez potrzeby ci±g³ej zmiany jego konfiguracji.
<p>
Dodaj±c poni¿sz± regu³kê <prgn>iptables</prgn> na bramce sieciowej przekierujesz
po³±czenia SMTP do komputera pe³ni±cego funkcjê bramki.
<example>
# iptables -t nat -A PREROUTING -s 192.168.1.0/24 -j REDIRECT \
           -p tcp --dport smtp --to-port 25 # smtp=25, INPUT is open
</example>
Je¶li oczekujesz dok³adniejszych zestawów regu³ek, rozwa¿ zainstalowanie
pakietu <package>ipmasq</package> i dodanie 
<url id="&examples;" name="M30redirect.def"> do katalogu
<file>/etc/ipmasq/rules/</file>.

</sect>

<sect>Zarz±dzanie wieloma po³±czeniami z sieci±
<p>
[FIXME] Routing rozszerzony (policy routing) (autor: Phil Brutsche
<email>pbrutsch@tux.creighton.edu</email>):
Zobacz <url id="&iproute;" name="iproute manual">, je¶li interesuj±
Ciê szczegó³y. Kszta³towanie ruchu (tc, ang. Traffic control) mo¿e
byæ równie interesuj±ce.
<p>
¦rodowisko:
<example>
eth0: 192.168.1.2/24; brama 192.168.1.1
eth1: 10.0.0.2/24; brama 10.0.0.1
Brak maskarady na tym komputerze.
</example>
Magiczne zaklêcia:
<enumlist compact>
<item>ip rule add from 192.168.1.2 lookup 1
<item>ip rule add from 10.0.0.2 lookup 2
<item>ip route add to default via 10.0.0.1 metric 0
<item>ip route add to default via 192.168.1.1 metric 1
<item>ip route add table 1 to 192.168.1.0/24 via eth0
<item>ip route add table 1 to 10.0.0.2/24 via eth1
<item>ip route add table 1 to default via 192.168.1.1
<item>ip route add table 2 to 192.168.1.0/24 via eth0
<item>ip route add table 2 to 10.0.0.2/24 via eth1
<item>ip route add table 2 to default via 10.0.0.2
</enumlist>
<p>
[FIXME] Nigdy tego nie robi³em. Jak ustawiæ po³±czenie wdzwaniane jako
po³±czenie zapasowe szybkiego ³±cza, u¿ywaj±c w³a¶ciwo¶ci automatycznego
³±czenia na ¿±danie? Wy¶lij ³atkê tutaj :)
</sect>


</chapt>
