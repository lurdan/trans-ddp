<!-- CVS revision of this document "$Revision: 1.7 $"  -->
<!-- CVS revision of original english document "1.18"  -->
<chapt id="gateway">Costruire un gateway con &debian; 
<p>
&debian; offre gli strumenti per costruire un gateway multiuso,
in grado di padroneggiare NAT, posta, DHCP, DNS cache, http proxy
cache, CVS, NFS, e Samba per una LAN casalinga.

<sect>Configurazione di rete
<p>

<sect1 id="ip-class">Configurazione dell'host
<p>
Una LAN usa gli indirizzi IP per la seguente rete privata, per evitare
interferenze con gli indirizzi IP provenienti da Internet.
<example>
Classe A: 10.0.0.0                    con mask 255.0.0.0
Classe B: 172.16.0.0 - 172.31.0.0     con mask 255.255.0.0
Classe C: 192.168.0.0 - 192.168.255.0 con mask 255.255.255.0
</example>
<p>
Per la configurazione IP, Debian usa <file>/etc/network/interfaces</file>.
<p>
Per esempio, se <file>eth0</file> si connette ad Internet tramite un
indirizzo IP fornito da DHCP e <file>eth1</file> si connette alla LAN,
<file>/etc/network/interfaces</file> sarà impostato come segue
[WOODY]:
<example>
auto eth0
iface eth0 inet dhcp

auto eth1
iface eth1 inet static
address 192.168.1.1
network 192.168.1.0
netmask 255.255.255.0
broadcast 192.168.1.255
</example>
Date il seguente comando per aggiornare la configurazione di rete
sulla base di un nuovo <file>/etc/network/interfaces</file>:
<example>
# /etc/init.d/networking restart
</example>
Ricorda: il file "interfaces" di "woody" non è compatibile con "potato".
<p>
Se il sistema utilizza una PC card di rete, l'impostazione di rete avviene
tramite <file>/etc/pcmcia/network.opts</file> instead.
<p>
Se avete dubbi, controllate l'ouput dei seguenti comandi:
<example>
# ifconfig
# cat /proc/pci
# cat /proc/interrupts
# dmesg|more
</example>
</sect1>

<sect1>IP-masquerade
<p>
Le macchine in una LAN possono accedere all'esterno attraverso un
gateway su cui gira IP-masquerade (NAT).
<example>
# apt-get install ipmasq
</example>
Applicate le "rules" come da esempio per rafforzare la protezione di "ipmasq".  
Vedere <file>/usr/share/doc/ipmasq/examples/stronger/README</file>.
<!-- Upstream is current
Script aggiornati qui:
<url id="http://qref.sourceforge.net/quick/examples/"
name="A80firewall.def I80firewall.def O80firewall.def">.
-->
Per la kernel-image-2.4 Debian, assicuratevi di caricare i
moduli. Vedere <ref id="kernel-net">.
<p>
Per la kernel-image-2.2 Debian, modificate Z92timeouts.rul in
/etc/masq/rules come segue:
<example>
# tcp, tcp-fin, udp
# 2hr, 10 sec, 160 sec - default
# 1 day, 10 min, 10 min - più lungo, per esempio
$IPCHAINS -M -S 86400 600 600
</example>
In più, se la rete è raggiunta tramite una PC card di rete, ipmasq
deve essere lanciato da /etc/pcmcia/network.opts. (leggete
/usr/share/doc/ipmasq/ipmasq.txt.gz)
</sect1>

<sect1>Punti principali di una configurazione di rete
<p>
Programmi necessari per una installazione tipica:
<example>
# apt-get install nfs samba dhcpd dhcp-client bind squid procmail fetchmail 
# apt-get install ssh cvs
</example>
<p>
Controllate, poi, i files seguenti:
<example>
/etc/init.d/dhcpd       (modificare per servire solo LAN = eth1)
/etc/host.allow         (ALL: 192.168.0.0/16 127.0.0.0/8) per NFS
/etc/exports            (Necessario per NFS)
/etc/bind/db.192.168.1  (aggiungere)
/etc/bind/db.lan        (aggiungere)
/etc/bind/named.conf    (modificare)
/etc/resolv.conf       (modificare)
/etc/hosts
/etc/dhcpd.conf         (modificare per LAN = eth1)
/etc/dhclient.conf      (modificare per forzare DNS locale)
/etc/samba/smb.conf
/etc/exim/exim.conf
/etc/mailname
/etc/aliases
/etc/squid.conf         (aggiungere tutti gli IP degli host della LAN 
come autorizzati)
</example>
Bind crea un server locale DNS cache e modifica il DNS a localhost.
Check <file>/etc/resolv.conf</file>:
<example>
nameserver 127.0.0.1
search lan.aokiconsulting.com
</example>
</sect1>

</sect>

<sect>Gestione di connessioni multiple di rete
<p>
[DA CORREGGERE] Regole di routing: (da Phil Brutsche
pbrutsch@tux.creighton.edu) Vedere <url
id="http://ds9a.nl/2.4Routing/" name="Manuale iproute"> per
dettagli. Il traffic control (tc) potrebbe anche risultare
interessante.
<p>
L'ambiente:
<example>
eth0: 192.168.1.2/24; gateway 192.168.1.1
eth1: 10.0.0.2/24; gateway 10.0.0.1
Nessun masquerading su questa macchina.
</example>
Alcune magie:
<example>
# ip rule add from 192.168.1.2 lookup 1
# ip rule add from 10.0.0.2 lookup 2
# ip route add to default via 10.0.0.1 metric 0
# ip route add to default via 192.168.1.1 metric 1
# ip route add table 1 to 192.168.1.0/24 via eth0
# ip route add table 1 to 10.0.0.2/24 via eth1
# ip route add table 1 to default via 192.168.1.1
# ip route add table 2 to 192.168.1.0/24 via eth0
# ip route add table 2 to 10.0.0.2/24 via eth1
# ip route add table 2 to default via 10.0.0.2
</example>
[DA CORREGGERE] Non l'ho mai fatto personalmente. Come impostare una
connessione dialup come riserva di una connessione veloce?
</sect>

<sect>Programmi di gestione posta
<p>
La configurazione della posta si divide in tre fasi:
<list>
<item>MTA: exim
<item>MUA: mutt
<item>Utilities: procmail, fetchmail, mail,...
</list>

<sect1>Mail transport agent (Exim)
<p>
Uare exim come mail transfer agent (MTA). Configurazione:
<example>
/etc/exim/exim.conf     "eximconfig" per crearlo e modificarlo
/etc/inetd.conf         decommentate smtp per lanciare exim come demone
/etc/email-addresses    Aggiunta una lista di indirizzi di partenza fasulli
verificare il filtro usando exim -brw, -bf, -bF, -bV, ... etc.
</example>
</sect1>

<sect1>Raccolta di tutti gli indirizzi e-mail inesistenti (Exim)
<p>
In /etc/exim/exim.conf [WOODY], aggiungete nella sezione DIRECTORS
alla fine, (dopo localuser: director) un indirizzatore (director) che
raccolga tutti gli indirizzi che gli indirizzatori precedenti non sono
in grado di risolvere (Secondo Miquel van Smoorenburg):
<example>
catchall:
  driver = smartuser
    new_address = webmaster@mydomain.com
</example>
<p>
Se si desidera avere maggiori dettagli per ogni dominio virtuale,
ecc., aggiungete la seguente riga alla fine di exim.conf (Secondo me,
non ancora testato):
<example>
*@yourdomain.com ${lookup{$1}lsearch*{/etc/email-addresses} \
        {$value}fail} T
</example>
Poi aggiungete in /etc/email-adresses la voce "*"
</sect1>

<sect1>Mail user agent (Mutt)
<p>
Usare mutt come mail user agent (MUA) in combinazione con vim.
Personalizzatelo tramite "~/.muttrc":
<example>
# usa il modo visuale e "gq" per riformattare le citazioni
set editor="vim -c 'set tw=72 et ft=mail'"
#
# impostazione degli header, presa direttamente dal manuale 
("Sven's Draconian header weeding")
#
ignore *
unignore from: date subject to cc
unignore user-agent x-mailer
hdr_order from subject to cc date user-agent x-mailer
auto_view application/msword
....
</example>
Aggiungete i seguenti a /etc/mailcap:
<example>
text/html; lynx -force_html %s; needsterminal;
application/msword; /usr/bin/antiword '%s'; copiousoutput;
description="Microsoft Word Text"; nametemplate=%s.doc
</example>
Così M$ Word .doc può essere letto (Non testato.) 
</sect1>

<sect1>Utilità per la posta (fetchmail)
<p>
"fetchmail" viene eseguito in modalità demone e raccoglie la posta
dagli account POP3 del vostro provider smistandoli nel sistema locale
di posta. Configurazione:
<example>
/etc/init.d/fetchmail   vedere sotto per lo script
/etc/rc?.d/???fetchmail lancia update-rc.d fetchmail defaults 30
/etc/fetchmailrc        file di configurazione (chown 600, posseduto 
da fetchmail)
/etc/init.d/fetchmail
</example>
<p>
Le informazioni su come lanciare fetchmail come demone da uno script
init.d in potato risultano confuse (in woody ciò dovrebbe essere stato
risolto).
<url id="examples/" name="/etc/init.d/fetchmail and /etc/fetchmailrc">
<p>
Se i vostri header di posta sono infestati da ^M per colpa del mailer
del vostro provider, aggiungete 'stripcr' alle opzioni in
~/.fetchmailrc:
<example>
options fetchall no keep stripcr
</example>
</sect1>

<sect1>Utilità per la posta (procmail)
<p>
Procmail è il sistema locale di consegna/filtro della posta. Per ogni
account si deve creare un file "~/.procmailrc".
<url id="examples/" name="Per i dettagli vedere i miei esempi.">
</sect1>

</sect>

</chapt>
