#!/usr/bin/make -f
# Sample debian/rules that uses debhelper.
# GNU copyright 1997 to 1999 by Joey Hess.

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

# This is the debhelper compatibility version to use.
export DH_COMPAT=3
export LC_ALL=C

MANUAL1 := reference
MANUAL2 := quick-reference
LANGS1 := en fr it pt-br es de
LANGS2 := en fr it pt-br es de
BUILD_TYPE := package
ENTFILES1 := $(foreach lang,$(LANGS1),$(MANUAL1).$(lang).ent)
ENTFILES2 := $(foreach lang,$(LANGS2),$(MANUAL2).$(lang).ent)
ENTFILES := $(ENTFILES1) $(ENTFILES2)

$(MANUAL1).%.ent:
	echo "<!entity language \"$*\">"        > $@
	echo "<!entity % lang-$* \"INCLUDE\">" >> $@
	echo "<!entity docversion \"$(shell \
		LC_ALL=C \
		dpkg-parsechangelog | \
		sed -n 's/^Version: *//p')\">" >> $@
	echo "<!entity docdate \"$(shell \
		bin/getdocdate -p $*)\">"      >> $@
	echo "<!entity % f-ref   \"INCLUDE\">" >> $@ 
	echo "<!entity % q-ref   \"IGNORE\">"  >> $@ 


$(MANUAL2).%.ent:
	echo "<!entity language \"$*\">"        > $@
	echo "<!entity % lang-$* \"INCLUDE\">" >> $@
	echo "<!entity docversion \"$(shell \
		LC_ALL=C \
		dpkg-parsechangelog | \
		sed -n 's/^Version: *//p')\">" >> $@
	echo "<!entity docdate \"$(shell \
		bin/getdocdate -p $*)\">"      >> $@
	# if "Debian Quick Reference" (20 page max)
	echo "<!entity % f-ref   \"IGNORE\">"  >> $@ 
	echo "<!entity % q-ref   \"INCLUDE\">" >> $@


configure: configure-stamp
configure-stamp: $(ENTFILES)
	dh_testdir
	# Do nothing
	touch configure-stamp


build: build-stamp

build-stamp: configure-stamp 
	dh_testdir
	# Add here commands to compile the package.
	$(MAKE) "MANUAL1=$(MANUAL1)" "LANGS1=$(LANGS1)" \
	        "MANUAL2=$(MANUAL2)" "LANGS2=$(LANGS2)" \
	        "BUILD_TYPE=$(BUILD_TYPE)" html txt pdf ps
	touch build-stamp

clean:
	dh_testdir
	dh_testroot
	rm -f build-stamp configure-stamp
	# Add here commands to clean up after the build process.
	-$(MAKE) "MANUAL1=$(MANUAL1)" "LANGS1=$(LANGS1)" \
	 "MANUAL2=$(MANUAL2)" "LANGS2=$(LANGS2)" \
	 "BUILD_TYPE=$(BUILD_TYPE)" clean
	-cd $(CURDIR)/debian/ ; for xx in \
	debian-reference \
	debian-reference-common ; do \
	rm -f $${xx}.README.Debian ; done

	-cd $(CURDIR)/debian/ ; for xx in $(LANGS1) ; do \
	rm -f debian-reference-$${xx}.README.Debian \
	      debian-reference-$${xx}.dirs \
	      deian-reference-$${xx}.doc-base; \
	done

	-cd $(CURDIR)/debian/ ; for xx in $(LANGS2) ; do \
	rm -f quick-reference-$${xx}.README.Debian \
	      quick-reference-$${xx}.dirs \
	      quick-reference-$${xx}.doc-base; \
	done

	dh_clean

refresh: clean
	dh_testdir
	dh_testroot
# 	cvs -d :ext:osamu@cvs.qref.sf.net:/cvsroot/qref up
#	cvs -d :pserver:anonymous@cvs.qref.sf.net:/cvsroot/qref up

new:    clean
#	rm ../debian-refernce
#	cvs -d :ext:osamu@cvs.qref.sf.net:/cvsroot/qref export -d ../debian-reference -D tomorrow qref
#	cvs -d :pserver:anonymous@cvs.qref.sf.net:/cvsroot/qref up

install: build
	dh_testdir
	dh_testroot
	dh_clean -k
	dh_installdirs

	# Add here commands to install the package into debian/debian-reference-??.
	$(MAKE) LANGS1=en "LANGS2=" "MANUAL1=$(MANUAL1)" "MANUAL2=$(MANUAL2)" \
	    "BUILD_TYPE=$(BUILD_TYPE)" \
	    PUBLISHDIR=$(CURDIR)/debian/debian-reference-common/usr/share/doc/Debian \
	    publish-examples
	test -d $(CURDIR)/debian/debian-reference-common/usr/bin \
	   || install -d -m 755 $(CURDIR)/debian/debian-reference-common/usr/bin
	install -m 755 --preserve-timestamps debian-reference \
	    $(CURDIR)/debian/debian-reference-common/usr/bin/debian-reference

	$(MAKE) LANGS1=en "MANUAL1=$(MANUAL1)" "BUILD_TYPE=$(BUILD_TYPE)" \
	    PUBLISHDIR=$(CURDIR)/debian/debian-reference-en/usr/share/doc/Debian \
	    publish-html1 publish-txt1 publish-ps1 publish-pdf1

	$(MAKE) LANGS1=fr "MANUAL1=$(MANUAL1)" "BUILD_TYPE=$(BUILD_TYPE)" \
	    PUBLISHDIR=$(CURDIR)/debian/debian-reference-fr/usr/share/doc/Debian \
	    publish-html1 publish-txt1 publish-ps1 publish-pdf1

	$(MAKE) LANGS1=it "MANUAL1=$(MANUAL1)" "BUILD_TYPE=$(BUILD_TYPE)" \
	    PUBLISHDIR=$(CURDIR)/debian/debian-reference-it/usr/share/doc/Debian \
	    publish-html1 publish-txt1 publish-ps1 publish-pdf1

	$(MAKE) LANGS1=es "MANUAL1=$(MANUAL1)" "BUILD_TYPE=$(BUILD_TYPE)" \
	    PUBLISHDIR=$(CURDIR)/debian/debian-reference-es/usr/share/doc/Debian \
	    publish-html1 publish-txt1 publish-ps1 publish-pdf1

	$(MAKE) LANGS1=de "MANUAL1=$(MANUAL1)" "BUILD_TYPE=$(BUILD_TYPE)" \
	    PUBLISHDIR=$(CURDIR)/debian/debian-reference-de/usr/share/doc/Debian \
	    publish-html1 publish-txt1 publish-ps1 publish-pdf1

	$(MAKE) LANGS1=pt-br "MANUAL1=$(MANUAL1)" "BUILD_TYPE=$(BUILD_TYPE)" \
	    PUBLISHDIR=$(CURDIR)/debian/debian-reference-pt-br/usr/share/doc/Debian \
	    publish-html1 publish-txt1 publish-ps1 publish-pdf1

	$(MAKE) LANGS2=en "MANUAL2=$(MANUAL2)" "BUILD_TYPE=$(BUILD_TYPE)" \
	    PUBLISHDIR=$(CURDIR)/debian/quick-reference-en/usr/share/doc/Debian \
	    publish-html2 publish-txt2 publish-ps2 publish-pdf2

	$(MAKE) LANGS2=fr "MANUAL2=$(MANUAL2)" "BUILD_TYPE=$(BUILD_TYPE)" \
	    PUBLISHDIR=$(CURDIR)/debian/quick-reference-fr/usr/share/doc/Debian \
	    publish-html2 publish-txt2 publish-ps2 publish-pdf2

	$(MAKE) LANGS2=it "MANUAL2=$(MANUAL2)" "BUILD_TYPE=$(BUILD_TYPE)" \
	    PUBLISHDIR=$(CURDIR)/debian/quick-reference-it/usr/share/doc/Debian \
	    publish-html2 publish-txt2 publish-ps2 publish-pdf2

	$(MAKE) LANGS2=es "MANUAL2=$(MANUAL2)" "BUILD_TYPE=$(BUILD_TYPE)" \
	    PUBLISHDIR=$(CURDIR)/debian/quick-reference-es/usr/share/doc/Debian \
	    publish-html2 publish-txt2 publish-ps2 publish-pdf2

	$(MAKE) LANGS2=de "MANUAL2=$(MANUAL2)" "BUILD_TYPE=$(BUILD_TYPE)" \
	    PUBLISHDIR=$(CURDIR)/debian/quick-reference-de/usr/share/doc/Debian \
	    publish-html2 publish-txt2 publish-ps2 publish-pdf2

	$(MAKE) LANGS2=pt-br "MANUAL2=$(MANUAL2)" "BUILD_TYPE=$(BUILD_TYPE)" \
	    PUBLISHDIR=$(CURDIR)/debian/quick-reference-pt-br/usr/share/doc/Debian \
	    publish-html2 publish-txt2 publish-ps2 publish-pdf2

#	copy README.Debian for all the packages
	cd $(CURDIR)/debian/ ; for xx in \
	debian-reference debian-reference-common ; do \
	cp README.Debian.all $${xx}.README.Debian ; done
	cd $(CURDIR)/debian/ ; for xx in $(LANGS1) ; do \
	cp README.Debian.all debian-reference-$${xx}.README.Debian ; done
	cd $(CURDIR)/debian/ ; for xx in $(LANGS2) ; do \
	cp README.Debian.all quick-reference-$${xx}.README.Debian ; done

	cd $(CURDIR)/debian/ ; for xx in $(LANGS1) ; do \
	case $$xx in \
	en) LANG="English" ;;  \
	de) LANG="German" ;;   \
	fr) LANG="French" ;;   \
	fi) LANG="Finnish" ;;  \
	es) LANG="Spanish" ;;  \
	it) LANG="Italian" ;;  \
	ja) LANG="Japanese" ;; \
	pt-br) LANG="Portuguese (Brazil)" ;; \
	esac ; \
	sed  -e "s/@@/$$xx/" \
	<debian-reference.dirs.all  >debian-reference-$${xx}.dirs ; \
	sed  -e "s/@@/$$xx/" -e "s/@LANG@/$$LANG/" \
	<debian-reference.doc-base.all  >debian-reference-$${xx}.doc-base ; \
	done

	cd $(CURDIR)/debian/ ; for xx in $(LANGS2) ; do \
	case $$xx in \
	en) LANG="English" ;;  \
	de) LANG="German" ;;   \
	fr) LANG="French" ;;   \
	fi) LANG="Finnish" ;;  \
	es) LANG="Spanish" ;;  \
	it) LANG="Italian" ;;  \
	ja) LANG="Japanese" ;; \
	pt-br) LANG="Portuguese (Brazil)" ;; \
	esac ; \
	sed  -e "s/@@/$$xx/" \
	<quick-reference.dirs.all  >quick-reference-$${xx}.dirs ; \
	sed  -e "s/@@/$$xx/" -e "s/@LANG@/$$LANG/" \
	<quick-reference.doc-base.all  >quick-reference-$${xx}.doc-base ; \
	done

# Build architecture-independent files here.
binary-indep: build install
	dh_testdir
	dh_testroot
#	dh_installdebconf	
#	dh_movefiles
	dh_installdocs
	dh_installexamples
	dh_installmenu
#	dh_installlogrotate
#	dh_installemacsen
#	dh_installpam
#	dh_installmime
#	dh_installinit
	dh_installcron
	dh_installman -p debian-reference-common debian-reference.1
	dh_installinfo
#	dh_undocumented
	dh_installchangelogs 
	dh_link
	dh_strip
	dh_compress
	dh_fixperms
#	dh_makeshlibs
	dh_installdeb
#	dh_perl
	dh_shlibdeps
	dh_gencontrol
	dh_md5sums
	dh_builddeb

# Build architecture-dependent files here.
binary-arch: build install

binary: binary-indep binary-arch

.PHONY: build clean binary-indep binary-arch binary install configure refresh
