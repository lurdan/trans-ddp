<!-- CVS revision of this document "$Revision: 1.12 $"  -->
<!-- CVS revision of original english document "1.34"  -->

<chapt id="gateway">Aufsetzen eines Gateway mit einem &debian;-System

<p>
&debian; ermöglicht einen Universal Gateway, der mit NAT, Mail, DHCP, DNS
Cache, HTTP Proxy Cache, CVS, NFS und Samba Diensten für das eigene LAN
System umgehen kann. Man vergleiche <url id="&netfilterhome;"
name="Netfilter">, wo viele Netzwerkkonfigurationen aufgeführt sind.

<sect>Netzwerkkonfiguration
<p>

<sect1 id="ip-class">Rechnerkonfiguration des Gateway
<p>
Das LAN nutzt IP Adressen eines der folgenden privaten Netzwerkbereiche, um
IP Adresskollisionen mit dem Internet zu vermeiden.
<example>
Klasse A: 10.0.0.0                    mit Maske 255.0.0.0
Klasse B: 172.16.0.0 - 172.31.0.0     mit Maske 255.255.0.0
Klasse C: 192.168.0.0 - 192.168.255.0 mit Maske 255.255.255.0
</example>
<p>
&debian; verwendet <file>/etc/network/interfaces</file> für die IP
Konfiguration.
<p>
Wenn zum Beispiel <file>eth0</file> eine Verbindung zum Internet mit einer
durch DHCP bereitgestellten IP Adresse ist und <file>eth1</file> das LAN
anbindet, so sieht <file>/etc/network/interfaces</file> (bei Woody oder
neuer) wie folgt aus:
<example>
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet dhcp

auto eth1
iface eth1 inet static
address 192.168.1.1
network 192.168.1.0
netmask 255.255.255.0
broadcast 192.168.1.255
</example>
Führen Sie das folgende Kommando aus, um die neue Netzwerkkonfiguration in 
<file>/etc/network/interfaces</file> zu aktivieren:
<example>
# /etc/init.d/networking restart
</example>
Zur Erinnerung: Die <file>/etc/network/interfaces</file> Datei in Woody und
nachfolgenden Ausgaben ist mit Potato nicht kompatibel. (Die selbe Situation
kann zwischen Woody und Sarge entstehen.)
<p>
Wird eine PCMCIA NIC (Netzwerkkarte) genutzt, muss das Netzwerk in Potato
durch <file>/etc/pcmcia/network.opts</file> spezifiziert werden.
Im Woody System wurde dieses Problem gelöst.
<p>
Im Zweifel sollten die Ausgaben folgender Kommandos geprüft werden:
<example>
# ifconfig
# cat /proc/pci
# cat /proc/interrupts
# dmesg | more
</example>
<p>
Viele neue ADSL Dienstleister nutzen PPPoE für IP Verbindungen. Das Woody
Installationsprogramm hat kein Menü für PPPoE, enthält aber alle benötigten
Pakete, d.h. <package>pppoe</package> und <package>pppoeconf</package>.
Starten Sie <prgn>pppoeconf</prgn> in der Konsole für ein einfaches
Einrichten während der Installation.
Manchmal gibt es bei DSL (PPPoE) MTU bezogene Probleme. Vergleichen Sie das
LDP <url id="&dsl-howto;" name="DSL-HOWTO">.
<p>
Haben Sie Probleme mit einigen Webseiten, schauen Sie in <ref id="killecn">.
</sect1>

<sect1 id="low-ppp">PPP
<p>
Dieser Abschnitt muss noch übersetzt werden. Eventuell ist
<file>&f-ppp-readme;</file> hilfreich ...
</sect1>

<sect1 id="ip-check">Anhaltspunkte zur Netzwerkkonfiguration
<p>
Typische Programme:
<example>
# apt-get install nfs samba dhcpd dhcp-client bind squid procmail
# apt-get install fetchmail ssh cvs
</example>
<p>
Überprüfen Sie die folgenden Dateien:
<example>
/etc/init.d/dhcpd      (so bearbeiten, dass nur LAN bedient wird)
/etc/host.allow        (ALL: 192.168.0.0/16 127.0.0.0/8) für NFS
/etc/exports           (nötig für NFS)
/etc/bind/db.192.168.1 (hinzufügen)
/etc/bind/db.lan       (hinzufügen)
/etc/bind/named.conf   (bearbeiten)
/etc/resolv.conf       (bearbeiten)
/etc/hosts
/etc/dhcpd.conf        (bearbeiten für LAN = eth1)
/etc/dhclient.conf     (bearbeiten zum Erzwingen von lokalen DNS)
/etc/samba/smb.conf
/etc/exim/exim.conf
/etc/mailname
/etc/aliases
/etc/squid.conf        (hinzufügen aller IPs der LAN Rechner)
</example>
<prgn>bind</prgn> erzeugt einen lokalen Cache DNS Server und ändert DNS zu
localhost. Überprüfen Sie <file>/etc/resolv.conf</file>:
<example>
nameserver 127.0.0.1
search lan.aokiconsulting.com
</example>
</sect1>

<sect id="netfilter">Netfilter Konfiguration
<p>
Das netfilter/iptables Projekt ist ein Firewall System für Linux 2.4 und
neuer. In <url id="&netfilterhome;" name="Netfilter"> werden viele
Netzwerkkonfigurationen erklärt.

<sect1 id="netfilter-basics">Grundlagen von netfilter
<p>
Netfilter bearbeitet Pakete unter Verwendung von fünf eingebauten Ketten: 
PREROUTING, INPUT, FORWARD, OUTPUT und POSTROUTING.
<example>
                routing
                Entscheidung
IN ------> PRE ---> ------> FORWARD -----> ----> POST -----> OUT
Interface  ROUTING  \       Filter       /       ROUTING Interface
           DNAT     |       Verfolgung   ^       SNAT
           REDIRECT |                    |       MASQUERADE
                    v                    |
                  INPUT                OUTPUT
                    | Filter             ^ Filter,DNAT 
                    v                    |
                    \--&gt; lokaler Prozess --/
                         Userspace Programme
</example>

<sect1 id="netfilter-table">Netfilter Tabelle
<p>
Pakete werden von jeder eingebauten Kette unter Verwendung der folgenden
Tabellen verarbeitet.
<list compact>
<item>filter (Paketfilter, Standard)
<list compact>
<item>INPUT (für Pakete die im Rechner ankommen)
<item>FORWARD (für Pakete die durch den Rechner geleitet werden)
<item>OUTPUT (für lokal erzeugte Pakete).
</list>
<item>nat (network address translation, Netzwerk-Adress-Übersetzung)
<list compact>
<item>PREROUTING (für das Ändern eingehender Pakete)
<item>OUTPUT (für das Ändern lokal erzeugter Pakete vor der Weiterleitung)
<item>POSTROUTING (für das Ändern ausgehender Pakete)
</list>
<item>mangle (network address mangling, geeignet erst nach 2.4.18)
<list compact>
<item>alle fünf eingebauten Ketten.
</list>
</list>

<sect1 id="netfilter-target">Netfilter Ziele
<p>
Firewall Regeln haben verschiedene Ziele:
<list compact>
<item>vier Basisziele:
<list compact>
<item>ACCEPT bedeutet, dass das Paket durchgelassen wird.
<item>DROP bedeutet, dass das Paket durchfällt.  
<item>QUEUE bedeutet, dass das Paket den Userspace passiert (falls vom Kernel
      unterstützt).
<item>RETURN bedeutet, dass das Durchlaufen dieser Kette beendet wird und
      mit der nächsten Regel der vorherigen (aufrufenden) Kette fortgefahren
      wird.  
</list>
<item>erweiterte Ziele:
<list compact>
<item>LOG aktiviert Kernel logging.
<item>REJECT sendet ein Fehlerpaket zurück und lässt das Paket fallen.
<item>SNAT ändert die Quelladresse des Paketes und wird nur in der
      POSTROUTING Kette verwendet. (nur nat Tabelle)
<example compact>
--to-source ipaddr[-ipaddr][:Port-Port]
</example>
<item>MASQUERADE ist das selbe wie SNAT aber für dynamisch vergebene IP 
      (dialup) Verbindungen. (nur nat Tabelle)
<example compact>
--to-ports Port[-Port]
</example>
<item>DNAT ändert die Zieladresse des Pakets und wird in den PREROUTING und
      OUTPUT, sowie benutzerdefinierten Ketten die nur von solchen aufgerufen
      wurden, verwendet. (nur nat Tabelle)
<example compact>
--to-destination ipaddr[-ipaddr][:Port-Port]
</example>
<item>REDIRECT ändert die Ziel IP Adresse, um das Paket zum aktuellen Rechner
      zu senden.
<example compact>
--to-ports Port[-Port]
</example>
</list>
</list>

<sect1 id="netfilter-command">Netfilter Kommandos
<p>
Die grundlegenden Kommandos von <prgn>iptables</prgn> sind:
<example compact>
iptables -N <var>Kette</var>        # erzeuge eine <var>Kette</var>

iptables -A <var>Kette</var> \      # füge Regel zur <var>Kette</var> hinzu
 -t <var>Tabelle</var> \            # verwende <var>Tabelle</var> (filter, nat, mangle)
 -p <var>Protokoll</var> \          # tcp, udp, icmp oder all
 -s <var>Quelladresse[/Maske]</var> \
 --sport <var>Port[:Port]</var> \   # Quellport, falls -p tcp oder udp ist
 -d <var>Zieladresse[/Maske]</var> \
 --dport <var>Port[:Port]</var> \   # Zielport, falls -p tcp oder udp ist
 -j <var>Ziel</var> \               # was tun, wenn es passt
 -i <var>in-interface-name</var> \  # für INPUT,  FORWARD, PREROUTING
 -o <var>out-interface-name</var>   # für FORWARD, OUTPUT, POSTROUTING
</example>

<sect1 id="ip-masq">IP-Masquerading
<p>
Maschinen im LAN können auf Internet Ressourcen mittels eines Gateway
zugreifen, welcher IP-Masquerading (NAT) durchführt, indem eine einzelne
extern zugängliche IP Adresse geteilt wird.
<example>
# apt-get install ipmasq
</example>
Wenden Sie die Beispielregeln an, um den <prgn>ipmasq</prgn> Schutz zu
verstärken. Vergleichen Sie
<file>/usr/share/doc/ipmasq/examples/stronger/README</file>.
Stellen Sie beim Debian kernel-image-2.4 sicher, dass die richtigen Module
geladen werden. Die nötigen Konfigurationen sind in <ref id="kernel-net">
zu finden.
<p>
Für Debian kernel-image-2.2, müssen Sie <file>Z92timeouts.rul</file> in
<file>/etc/masq/rules</file> wie folgt editieren, um eine längere Verbindung
zu entfernten Seiten sicherzustellen (gut für große E-Mails, etc.):
<example>
# tcp, tcp-fin, udp
# 2 h, 10 sek, 160 sek - Standard
# 1 d, 10 min, 10 min - größeres Beispiel
$IPCHAINS -M -S 86400 600 600
</example>
Wird auf das Netzwerk mittels einer PCMCIA Netzwerkkarte zugegriffen, so muss
<prgn>ipmasq</prgn> von <file>/etc/pcmcia/network.opts</file> gestartet
werden. Lesen Sie dazu <file>/usr/share/doc/ipmasq/ipmasq.txt.gz</file>.
</sect1>


<sect1 id="ip-redirect">Umleiten von SMTP Verbindungen (2.4)
<p>
Angenommen, Sie haben ein Notebook, welches konfiguriert ist, andere LAN
Umgebungen zu nutzen und Sie möchten Ihren Mail User Agent auf dem Notebook
ohne Rekonfiguration nutzen. 
<p>
Das Hinzufügen der folgenden Regeln mittels des <prgn>iptables</prgn>
Kommandos zum Gateway leitet die SMTP Verbindung zum Gateway um.
<example>
# iptables -t nat -A PREROUTING -s 192.168.1.0/24 -j REDIRECT \
       -p tcp --dport smtp --to-port 25 # smtp=25, INPUT ist offen
</example>
Für gründlichere Umleitungsregeln sollte das <package>ipmasq</package> Paket
installiert und <file><url id="&examples;" name="M30redirect.def"></file>
zum <file>/etc/ipmasq/rules/</file> Verzeichnis hinzugefügt werden.

</sect>

<sect>Handhaben verschiedener Netzverbindungen
<p>
[FIXME] Policy routing (von Phil Brutsche
<email>pbrutsch@tux.creighton.edu</email>):
Vergleichen Sie das <url id="&iproute;" name="Iproute Manual"> für Details.
Traffic Control (tc) mag auch interessant sein.
<p>
Umgebung:
<example>
eth0: 192.168.1.2/24; Gateway 192.168.1.1
eth1: 10.0.0.2/24; Gateway 10.0.0.1
Kein Masquerading auf dieser Maschine.
</example>
Spezielle Werte:
<enumlist compact>
<item>ip rule add from 192.168.1.2 lookup 1
<item>ip rule add from 10.0.0.2 lookup 2
<item>ip route add to default via 10.0.0.1 metric 0
<item>ip route add to default via 192.168.1.1 metric 1
<item>ip route add table 1 to 192.168.1.0/24 via eth0
<item>ip route add table 1 to 10.0.0.2/24 via eth1
<item>ip route add table 1 to default via 192.168.1.1
<item>ip route add table 2 to 192.168.1.0/24 via eth0
<item>ip route add table 2 to 10.0.0.2/24 via eth1
<item>ip route add table 2 to default via 10.0.0.2
</enumlist>
<p>
[FIXME] Ich habe dies niemals durchgeführt. Wie kann eine dialup Verbindung
als Backup zu einer schnellen Verbindung mit automatischer Einwahl genutzt
werden? Bitte senden Sie einen Patch :)
</sect>

<sect id="net-router">Building a gateway router
<p>
Wird in Kürze eingefügt...

<sect1 id="trigger-pcmcia">Network configuration and PCMCIA
<p>
Wird in Kürze eingefügt...
</sect1>
</sect>

</chapt>
